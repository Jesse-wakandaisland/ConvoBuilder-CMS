<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Multi-Window Environment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        :root {
            --taskbar-height: 40px;
            --taskbar-bg: rgba(40, 40, 40, 0.8);
            --notification-bg: rgba(40, 40, 40, 0.9);
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden; /* Prevent scrolling of the main page */
            touch-action: none; /* Prevent browser handling of touch gestures */
        }

        /* Canvas */
        canvas {
            display: block;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - var(--taskbar-height));
            position: absolute;
            z-index: 0;
        }

        /* Create window button */
        .create-window-button {
            z-index: 999;
            position: relative;
            background-color: rgba(167,179,167,0.56);
            backdrop-filter: blur(10px);
            font-family: 'Alegreya Sans', sans-serif;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-left-radius: 20px;
            background-image: linear-gradient(to right, #ee0979 0%, #ff6a00 100%);
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            font-size: 19px;
            box-shadow: 0px -27px 27px -5px rgba(250,249,249,0.76) inset;
            margin: 5px;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
        }

        /* Create window button (hover) */
        .create-window-button:hover, .create-window-button:active {
            border-bottom-right-radius: 20px;
            box-shadow: -16px -6px 28px 4px #f2f69b;
            background-image: linear-gradient(to right, #cac531 0%, #f3f9a7 100%);
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            font-weight: 700;
            font-size: 16px;
            background-color: rgba(188,239,188,0.87);
        }

        /* Window container */
        .window-container {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 400px;
            height: 300px;
            background-color: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top-left-radius: 10px !important;
            border-top-right-radius: 10px !important;
            border-bottom-left-radius: 20px !important;
            border-bottom-right-radius: 20px !important;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 1;
            user-select: none;
            backdrop-filter: blur(5px);
            transform: translate(0, 0); /* For hardware acceleration */
        }

        .window-container:focus-within {
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 100, 255, 0.4);
        }

        /* Window header */
        .window-container .window-header {
            background-color: rgba(224,224,224,0.1);
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .window-header.no-drag {
            cursor: default;
        }

        /* Window title */
        .window-container .window-header h3 {
            font-family: 'Alegreya', sans-serif;
            font-weight: bold;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
            color: #fff;
            font-size: 16px;
        }

        /* Window controls */
        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            color: #fff;
            transition: background-color 0.2s;
        }

        .window-controls button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Window content */
        .window-container .window-content {
            flex-grow: 1;
            overflow: hidden;
            border-style: none;
            display: flex;
        }

        /* Window iframe */
        .window-container .window-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        /* Resize handle */
        .window-container .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 20px;
            background-image: linear-gradient(to right, #bc4e9c 0%, #f80759 100%);
            z-index: 2;
        }

        .window-container .resize-handle:hover,
        .window-container .resize-handle:active {
            transform: scale(1.3);
            background-image: linear-gradient(to right, #fc4a1a 0%, #f7b733 100%);
        }

        /* Window states */
        .window-container.minimized {
            width: 200px;
            height: auto;
            cursor: default;
            position: absolute;
            bottom: var(--taskbar-height);
            top: auto;
            transform: translateY(0);
            transition: transform 0.3s;
        }

        .window-container.maximized {
            width: 100% !important;
            height: calc(100% - var(--taskbar-height)) !important;
            top: 0 !important;
            left: 0 !important;
            border-radius: 0 !important;
        }

        .window-container.minimized .window-content,
        .window-container.minimized .resize-handle {
            display: none;
        }

        /* Popup */
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(30, 30, 30, 0.9);
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        #popup iframe {
            width: 400px;
            height: 450px;
            border: none;
            border-radius: 5px;
        }

        /* Close button for popup */
        #popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 10001;
        }

        /* Taskbar */
        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--taskbar-height);
            background-color: var(--taskbar-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.4);
            z-index: 5000;
            backdrop-filter: blur(10px);
        }

        #taskbar-left {
            display: flex;
            align-items: center;
        }

        #taskbar-center {
            display: flex;
            align-items: center;
            flex-grow: 1;
            justify-content: center;
            gap: 5px;
            overflow-x: auto;
            padding: 0 10px;
        }

        #taskbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Window buttons in taskbar */
        .taskbar-window-button {
            padding: 5px 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .taskbar-window-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .taskbar-window-button.active {
            background-color: rgba(0, 120, 255, 0.5);
        }

        /* Clock */
        #clock {
            color: white;
            font-size: 16px;
            font-weight: 500;
            padding: 0 10px;
        }

        /* Toggle buttons in taskbar */
        .toggle-button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .toggle-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .toggle-button.active {
            color: #4CAF50;
        }

        /* Notification panel */
        #notification-panel {
            position: fixed;
            bottom: var(--taskbar-height);
            right: 0;
            width: 300px;
            max-height: 0;
            background-color: var(--notification-bg);
            border-top-left-radius: 10px;
            box-shadow: -2px -2px 10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: max-height 0.3s;
            z-index: 4999;
            backdrop-filter: blur(10px);
        }

        #notification-panel.open {
            max-height: 400px;
        }

        #notification-header {
            padding: 10px;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }

        #clear-notifications {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 14px;
        }

        #notification-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
        }

        .notification-item {
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
            color: white;
            font-size: 14px;
            animation: fadeIn 0.3s forwards;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-message {
            color: rgba(255, 255, 255, 0.8);
        }

        .notification-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            text-align: right;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main content area */
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - var(--taskbar-height));
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            z-index: 1;
        }

        /* Container for launcher buttons */
        #launcher-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            margin-top: 30px;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            max-width: 100%;
            overflow-x: auto;
            z-index: 10;
        }

        /* Media queries */
        @media (max-width: 768px) {
            #launcher-container {
                flex-direction: column;
                align-items: center;
            }
            
            .window-container {
                min-width: 300px;
                min-height: 200px;
            }
            
            #popup iframe {
                width: 300px;
                height: 400px;
            }
        }

        @media (min-width: 1200px) {
            .window-container .window-header h3 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Main desktop area -->
    <div id="desktop">
        <!-- Container for launcher buttons -->
        <div id="launcher-container">
            <button class="create-window-button" data-url="https://cr8aideploy.s3.cubbit.eu/ConvoBuilder%20basic%20CMS.html">CMS Admin (lite)</button>
            <button class="create-window-button" data-url="https://convobuilder-deploy.s3.cubbit.eu/main%2Fmain.html">Quick CMS</button>
            <button class="create-window-button" data-url="https://cr8aideploy.s3.cubbit.eu/Convo-main.html">Learn more!</button>
        </div>
    </div>

    <!-- Animation canvas -->
    <canvas id="background-canvas"></canvas>

    <!-- Taskbar -->
    <div id="taskbar">
        <div id="taskbar-left">
            <button id="start-button" class="toggle-button">
                <i class="fas fa-th"></i>
            </button>
        </div>
        <div id="taskbar-center">
            <!-- Window buttons will be added here dynamically -->
        </div>
        <div id="taskbar-right">
            <button id="toggle-animation" class="toggle-button" title="Toggle Background Animation">
                <i class="fas fa-film"></i>
            </button>
            <button id="notification-toggle" class="toggle-button" title="Notifications">
                <i class="fas fa-bell"></i>
            </button>
            <div id="clock">00:00:00</div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notification-panel">
        <div id="notification-header">
            <span>Notifications</span>
            <button id="clear-notifications">Clear All</button>
        </div>
        <div id="notification-list">
            <!-- Notifications will be added here dynamically -->
        </div>
    </div>

    <!-- Pop-up container for Typebot -->
    <div id="popup">
        <button id="popup-close"><i class="fas fa-times"></i></button>
        <iframe id="typebot-iframe" src="https://typebot.co/builder-cr8-os-sq98nu2"></iframe>
    </div>

    <script>
    
        // ================ GLOBAL VARIABLES ================
        let windowCount = 0;
        let animationPaused = false;
        let activeWindowId = null;
        
        // ================ UTILITY FUNCTIONS ================
        
        // Format time for clock display
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        // Generate a unique ID
        function generateId() {
            return 'id-' + Math.random().toString(36).substr(2, 9);
        }
        
        // ================ NOTIFICATION SYSTEM ================
        
        // Add a notification
        function addNotification(title, message) {
            const notificationList = document.getElementById('notification-list');
            const id = generateId();
            
            const notificationItem = document.createElement('div');
            notificationItem.classList.add('notification-item');
            notificationItem.id = id;
            
            const now = new Date();
            const timeString = formatTime(now);
            
            notificationItem.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-time">${timeString}</div>
            `;
            
            notificationList.prepend(notificationItem);
            
            // Show notification indicator
            document.getElementById('notification-toggle').classList.add('active');
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                const notification = document.getElementById(id);
                if (notification) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(10px)';
                    setTimeout(() => notification.remove(), 300);
                    
                    // If no more notifications, remove indicator
                    if (notificationList.children.length <= 1) {
                        document.getElementById('notification-toggle').classList.remove('active');
                    }
                }
            }, 30000);
        }
        
        // ================ WINDOW MANAGEMENT ================
        
        // Create a new window
        function createWindow(url, title) {
            windowCount++;
            const windowId = `window-${windowCount}`;
            
            const windowContainer = document.createElement('div');
            windowContainer.classList.add('window-container');
            windowContainer.id = windowId;
            windowContainer.style.zIndex = windowCount + 100;
            
            const windowHeader = document.createElement('div');
            windowHeader.classList.add('window-header');
            
            const windowTitle = document.createElement('h3');
            windowTitle.classList.add('window-title');
            windowTitle.textContent = title || `Window ${windowCount}`;
            
            const windowControls = document.createElement('div');
            windowControls.classList.add('window-controls');
            windowControls.innerHTML = `
                <button class="minimize-btn" title="Minimize"><i class="fas fa-window-minimize"></i></button>
                <button class="maximize-btn" title="Maximize"><i class="fas fa-window-maximize"></i></button>
                <button class="duplicate-btn" title="Duplicate"><i class="far fa-copy"></i></button>
                <button class="close-btn" title="Close"><i class="fas fa-times"></i></button>
            `;
            
            windowHeader.appendChild(windowTitle);
            windowHeader.appendChild(windowControls);
            
            const windowContent = document.createElement('div');
            windowContent.classList.add('window-content');
            
            const iframe = document.createElement('iframe');
            iframe.classList.add('window-iframe');
            iframe.src = url;
            iframe.setAttribute('allowfullscreen', 'true');
            windowContent.appendChild(iframe);
            
            const resizeHandle = document.createElement('div');
            resizeHandle.classList.add('resize-handle');
            
            windowContainer.appendChild(windowHeader);
            windowContainer.appendChild(windowContent);
            windowContainer.appendChild(resizeHandle);
            document.body.appendChild(windowContainer);
            
            // Add to taskbar
            addWindowToTaskbar(windowId, title || `Window ${windowCount}`);
            
            // Set as active window
            setActiveWindow(windowId);
            
            // Position randomly within safe bounds
            const maxX = window.innerWidth - 400;
            const maxY = window.innerHeight - 300 - document.getElementById('taskbar').offsetHeight;
            const randomX = Math.max(10, Math.floor(Math.random() * maxX));
            const randomY = Math.max(10, Math.floor(Math.random() * maxY));
            windowContainer.style.left = randomX + 'px';
            windowContainer.style.top = randomY + 'px';
            
            // Event Listeners
            makeDraggable(windowContainer, windowHeader);
            makeResizable(windowContainer, resizeHandle);
            
            // Window controls
            setupWindowControls(windowContainer, windowId, url, title);
            
            // Add notification
            addNotification('Window Created', `"${title || `Window ${windowCount}`}" has been opened.`);
            
            return windowContainer;
        }
        
        
        // Add window to taskbar
        function addWindowToTaskbar(windowId, title) {
            const taskbarCenter = document.getElementById('taskbar-center');
            
            const taskbarButton = document.createElement('div');
            taskbarButton.classList.add('taskbar-window-button');
            taskbarButton.setAttribute('data-window-id', windowId);
            taskbarButton.textContent = title;
            
            taskbarButton.addEventListener('click', function() {
                const windowElement = document.getElementById(windowId);
                if (windowElement) {
                    if (windowElement.classList.contains('minimized')) {
                        windowElement.classList.remove('minimized');
                        windowElement.querySelector('.window-header').classList.remove('no-drag');
                    }
                    setActiveWindow(windowId);
                }
            });
            
            taskbarCenter.appendChild(taskbarButton);
        }
        
        // Set active window
        function setActiveWindow(windowId) {
            // Update previous active window
            if (activeWindowId && activeWindowId !== windowId) {
                const prevWindow = document.getElementById(activeWindowId);
                if (prevWindow) {
                    const prevTaskbarButton = document.querySelector(`.taskbar-window-button[data-window-id="${activeWindowId}"]`);
                    if (prevTaskbarButton) {
                        prevTaskbarButton.classList.remove('active');
                    }
                }
            }
            
            // Set new active window
            activeWindowId = windowId;
            const activeWindow = document.getElementById(windowId);
            if (activeWindow) {
                bringWindowToFront(activeWindow);
                
                // Update taskbar
                const taskbarButton = document.querySelector(`.taskbar-window-button[data-window-id="${windowId}"]`);
                if (taskbarButton) {
                    taskbarButton.classList.add('active');
                }
            }
        }
        
        // Setup window controls
        function setupWindowControls(windowContainer, windowId, url, title) {
            // Close button
            windowContainer.querySelector('.close-btn').addEventListener('click', function() {
                // Remove from taskbar
                const taskbarButton = document.querySelector(`.taskbar-window-button[data-window-id="${windowId}"]`);
                if (taskbarButton) {
                    taskbarButton.remove();
                }
                
                // Remove window
                windowContainer.remove();
                
                // Add notification
                addNotification('Window Closed', `"${title || windowId}" has been closed.`);
            });
            
            // Minimize
            windowContainer.querySelector('.minimize-btn').addEventListener('click', function() {
                const isMinimized = windowContainer.classList.toggle('minimized');
                windowContainer.querySelector('.window-header').classList.toggle('no-drag', isMinimized);
                
                // Update taskbar
                const taskbarButton = document.querySelector(`.taskbar-window-button[data-window-id="${windowId}"]`);
                if (taskbarButton) {
                    taskbarButton.classList.toggle('active', !isMinimized);
                }
                
                if (isMinimized && activeWindowId === windowId) {
                    activeWindowId = null;
                }
            });
            
            // Maximize
            windowContainer.querySelector('.maximize-btn').addEventListener('click', function() {
                const isMaximized = windowContainer.classList.toggle('maximized');
                windowContainer.querySelector('.window-header').classList.toggle('no-drag', isMaximized);
                
                if (isMaximized) {
                    windowContainer.dataset.prevPos = `${windowContainer.style.top},${windowContainer.style.left},${windowContainer.style.width},${windowContainer.style.height}`;
                    windowContainer.style.top = '0';
                    windowContainer.style.left = '0';
                } else if (windowContainer.dataset.prevPos) {
                    const [top, left, width, height] = windowContainer.dataset.prevPos.split(',');
                    if (top && left) {
                        windowContainer.style.top = top;
                        windowContainer.style.left = left;
                    }
                    if (width && height) {
                        windowContainer.style.width = width;
                        windowContainer.style.height = height;
                    }
                }
            });
            
            // Duplicate
            windowContainer.querySelector('.duplicate-btn').addEventListener('click', function() {
                createWindow(url, title);
            });
            
            // Set active on click
            windowContainer.addEventListener('mousedown', function() {
                setActiveWindow(windowId);
            });
            
            windowContainer.addEventListener('touchstart', function() {
                setActiveWindow(windowId);
            });
        }
        
        // Bring window to front
        function bringWindowToFront(windowContainer) {
            let maxZ = 100; // Base z-index
            document.querySelectorAll('.window-container').forEach(otherWindow => {
                const z = parseInt(window.getComputedStyle(otherWindow).zIndex, 10) || 0;
                if (z > maxZ) {
                    maxZ = z;
                }
            });
            windowContainer.style.zIndex = maxZ + 1;
        }
        
        // ================ DRAG AND RESIZE FUNCTIONALITY ================
        
        // Make element draggable
        function makeDraggable(element, handle) {
            let offsetX, offsetY, isDragging = false;
            
            // Mouse events
            handle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', endDrag);
            
            // Touch events
            handle.addEventListener('touchstart', startDragTouch);
            document.addEventListener('touchmove', dragMoveTouch);
            document.addEventListener('touchend', endDrag);
            
            function startDrag(e) {
                if (element.classList.contains('minimized') || element.classList.contains('maximized')) {
                    return;
                }
                
                e.preventDefault();
                isDragging = true;
                offsetX = e.clientX - element.getBoundingClientRect().left;
                offsetY = e.clientY - element.getBoundingClientRect().top;
                
                // Disable iframe interaction during drag
                if (element.querySelector('.window-iframe')) {
                    element.querySelector('.window-iframe').style.pointerEvents = 'none';
                }
            }
            
            function startDragTouch(e) {
                if (element.classList.contains('minimized') || element.classList.contains('maximized')) {
                    return;
                }
                
                isDragging = true;
                const touch = e.touches[0];
                offsetX = touch.clientX - element.getBoundingClientRect().left;
                offsetY = touch.clientY - element.getBoundingClientRect().top;
                
                // Disable iframe interaction during drag
                if (element.querySelector('.window-iframe')) {
                    element.querySelector('.window-iframe').style.pointerEvents = 'none';
                }
            }
            
            function dragMove(e) {
                if (!isDragging) return;
                
                const x = e.clientX - offsetX;
                const y = e.clientY - offsetY;
                
                // Prevent from going out of bounds
                const maxX = window.innerWidth - element.offsetWidth;
                const maxY = window.innerHeight - element.offsetHeight - document.getElementById('taskbar').offsetHeight;
                element.style.left = Math.min(Math.max(0, x), maxX) + 'px';
                element.style.top = Math.min(Math.max(0, y), maxY) + 'px';
            }
            
            function dragMoveTouch(e) {
                if (!isDragging) return;
                
                const touch = e.touches[0];
                const x = touch.clientX - offsetX;
                const y = touch.clientY - offsetY;
                
                // Prevent from going out of bounds
                const maxX = window.innerWidth - element.offsetWidth;
                const maxY = window.innerHeight - element.offsetHeight - document.getElementById('taskbar').offsetHeight;
                element.style.left = Math.min(Math.max(0, x), maxX) + 'px';
                element.style.top = Math.min(Math.max(0, y), maxY) + 'px';
            }
            
            function endDrag() {
                isDragging = false;
                
                // Re-enable iframe interaction
                if (element.querySelector('.window-iframe')) {
                    element.querySelector('.window-iframe').style.pointerEvents = 'auto';
                }
            }
        }
        
        // Make element resizable
        function makeResizable(element, handle) {
            let startX, startY, startWidth, startHeight;
            let isResizing = false;
            
            // Mouse events
            handle.addEventListener('mousedown', startResize);
            document.addEventListener('mousemove', resizeMove);
            document.addEventListener('mouseup', endResize);
            
            // Touch events
            handle.addEventListener('touchstart', startResizeTouch);
            document.addEventListener('touchmove', resizeMoveTouch);
            document.addEventListener('touchend', endResize);
            
            function startResize(e) {
                e.preventDefault();
                e.stopPropagation();
                
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
                startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
                
                // Disable iframe interaction during resize
                if (element.querySelector('.window-iframe')) {
                    element.querySelector('.window-iframe').style.pointerEvents = 'none';
                }
            }
            
            function startResizeTouch(e) {
                e.stopPropagation();
                
                isResizing = true;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
                startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
                
                // Disable iframe interaction during resize
                if (element.querySelector('.window-iframe')) {
                    element.querySelector('.window-iframe').style.pointerEvents = 'none';
                }
            }
            
            function resizeMove(e) {
                if (!isResizing) return;
                
                const width = startWidth + e.clientX - startX;
                const height = startHeight + e.clientY - startY;
                
                // Enforce minimum and maximum size
                const minWidth = 300;
                const minHeight = 200;
                const maxWidth = window.innerWidth - element.offsetLeft;
                const maxHeight = window.innerHeight - element.offsetTop - document.getElementById('taskbar').offsetHeight;
                
                element.style.width = Math.min(Math.max(minWidth, width), maxWidth) + 'px';
                element.style.height = Math.min(Math.max(minHeight, height), maxHeight) + 'px';
            }
            
            function resizeMoveTouch(e) {
                if (!isResizing) return;
                
                const touch = e.touches[0];
                const width = startWidth + touch.clientX - startX;
                const height = startHeight + touch.clientY - startY;
                
                // Enforce minimum and maximum size
                const minWidth = 300;
                const minHeight = 200;
                const maxWidth = window.innerWidth - element.offsetLeft;
                const maxHeight = window.innerHeight - element.offsetTop - document.getElementById('taskbar').offsetHeight;
                
                element.style.width = Math.min(Math.max(minWidth, width), maxWidth) + 'px';
                element.style.height = Math.min(Math.max(minHeight, height), maxHeight) + 'px';
            }
            
            function endResize() {
                isResizing = false;
                
                // Re-enable iframe interaction
                if (element.querySelector('.window-iframe')) {
                    element.querySelector('.window-iframe').style.pointerEvents = 'auto';
                }
            }
        }
        
        // ================ ANIMATION BACKGROUND ================
        
        // Canvas and animation variables
        const canvas = document.getElementById('background-canvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId = null;
        
        // Resize canvas to fit window
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - document.getElementById('taskbar').offsetHeight;
        }
        
        // Initialize animation variables
        let r = 1;
        const e = (t = 1, e = 0) => e + (t - e) * Math.random();
        const i = (t, e = 0, i = 1) => t < e ? e : t > i ? i : t;
        const a = (t = 1, e = 0) => (r ^= r << 13, r ^= r >>> 17, r ^= r << 5, e + (t - e) * Math.abs(r % 1e9) / 1e9);
        
        class Color {
            constructor(t = 1, e = 1, i = 1, r = 1) {
                this.r = t, this.g = e, this.b = i, this.a = r
            }
            copy() {
                return new Color(this.r, this.g, this.b, this.a)
            }
            add(t) {
                return new Color(this.r + t.r, this.g + t.g, this.b + t.b, this.a + t.a)
            }
            subtract(t) {
                return new Color(this.r - t.r, this.g - t.g, this.b - t.b, this.a - t.a)
            }
            multiply(t) {
                return new Color(this.r * t.r, this.g * t.g, this.b * t.b, this.a * t.a)
            }
            divide(t) {
                return new Color(this.r / t.r, this.g / t.g, this.b / t.b, this.a / t.a)
            }
            scale(t, e = t) {
                return new Color(this.r * t, this.g * t, this.b * t, this.a * e)
            }
            clamp() {
                return new Color(i(this.r), i(this.g), i(this.b), i(this.a))
            }
            lerp(t, e) {
                return this.add(t.subtract(this).scale(i(e)))
            }
            setHSLA(t = 0, e = 0, i = 1, r = 1) {
                const a = i < .5 ? i * (1 + e) : i + e - i * e,
                      o = 2 * i - a,
                      l = (t, e, i) => (i = (i % 1 + 1) % 1) < 1 / 6 ? t + 6 * (e - t) * i : i < .5 ? e : i < 2 / 3 ? t + (e - t) * (2 / 3 - i) * 6 : t;
                return this.r = l(o, a, t + 1 / 3), this.g = l(o, a, t), this.b = l(o, a, t - 1 / 3), this.a = r, this
            }
            mutate(t = .05, e = 0) {
                return new Color(this.r + a(t, -t), this.g + a(t, -t), this.b + a(t, -t), this.a + a(e, -e)).clamp()
            }
            rgba() {
                return `rgba(${Math.floor(255*this.r)},${Math.floor(255*this.g)},${Math.floor(255*this.b)},${this.a})`
            }
        }
        
        // Animation variables
        let seed, hue, color1, color2, timeOffset, colorMix, waveFactor, waveType, lineType, starCount;
        let frameCount = 0;
        let lastTime = 0;
        
        // Reset animation parameters
        function resetAnimation() {
            seed = Math.floor(e(1e9));
            hue = e();
            color1 = (new Color()).setHSLA(hue, e(), e(.5));
            color2 = (new Color()).setHSLA(hue + e(.3, .7), e(), e(.8, .2));
            timeOffset = e(1e3);
            colorMix = e() < 0.5 ? true : false;
            waveFactor = e(12, 1) * (e() < .5 ? 1 : -1);
            waveType = e() < .5;
            lineType = e() < .5;
            starCount = e() < .03 ? 0 : 1 + e() ** 2 * 5 | 0;
            r = seed;
        }
        
        // Initialize animation
        resetAnimation();
        
        // Animation loop
        function animate(timestamp) {
            if (animationPaused) {
                return;
            }
            
            animationFrameId = requestAnimationFrame(animate);
            
            // Limit to 60fps
            if (timestamp < lastTime + 1000 / 60) {
                return;
            }
            
            lastTime = Math.max(lastTime + 1000 / 60, timestamp);
            const time = frameCount++ / 60;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set random seed
            r = seed;
            
            // Calculate base height for animation
            const baseHeight = 600 + a(300);
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, baseHeight);
            gradient.addColorStop(0, color1.rgba());
            gradient.addColorStop(1, color2.rgba());
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars
            ctx.globalCompositeOperation = "lighter";
            for (let i = 0; i < 4000; i++) {
                const size = a(2, 1);
                const starColor = (new Color()).setHSLA(a(), a() ** 3, a() ** 2);
                const x = (a(canvas.width) + a(9) * time) % (canvas.width + 20) - 10;
                const y = a(baseHeight);
                ctx.fillStyle = starColor.rgba();
                ctx.fillRect(x, y, size, size);
            }
            
            // Reset composite operation
            ctx.globalCompositeOperation = "source-over";
            
            // Draw stars/planets
            if (starCount) {
                const tempSeed = r;
                for (let layer = 2; layer--;) {
                    r = tempSeed;
                    ctx.globalCompositeOperation = layer ? "source-over" : "lighter";
                    
                    for (let s = 0; s < starCount; s++) {
                        const radius = s ? a() ** 2 * 5 + 9 : a() ** 3 * 30 + 20;
                        const starColor = (new Color()).setHSLA(a(), a(), a(.5, 1));
                        const x = a(canvas.width);
                        const y = a(baseHeight - 300);
                        
                        if (layer) {
                            const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
                            gradient.addColorStop(0, starColor.rgba());
                            gradient.addColorStop(0.8, starColor.mutate(.3).rgba());
                            gradient.addColorStop(1, starColor.mutate(.3).scale(1, 0).rgba());
                            ctx.fillStyle = gradient;
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        } else {
                            const gradient = ctx.createRadialGradient(x, y, 0, x, y, 400 * radius);
                            gradient.addColorStop(0, starColor.scale(.3, 1).rgba());
                            gradient.addColorStop(0.1, starColor.scale(.1, 1).rgba());
                            gradient.addColorStop(1, starColor.scale(0, 1).rgba());
                            ctx.fillStyle = gradient;
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                    }
                }
                ctx.globalCompositeOperation = "source-over";
            }
            
            // Draw light lines
            const lineDirection = a() > .5 ? -1 : 1;
            for (let l = lineType ? 100 : 20; l--;) {
                const lineWidth = a(4, 1);
                const speed = a(99, lineType ? 19 : 9);
                const lineColor = (new Color()).setHSLA(a(), a() ** 7, a(1, .5));
                
                const maxWidth = canvas.width + 1000;
                const maxHeight = baseHeight + 1000;
                
                const xSpeed = !lineType || a() < .02 ? a(-99, 99) : (speed + a(-10, 10)) * lineDirection;
                const x = (a(maxWidth) + time * xSpeed) % maxWidth - 500;
                const y = (a(maxHeight) + time * speed) % maxHeight - 500;
                
                const tailLength = a(.5, 3);
                const tailX = x - tailLength * xSpeed;
                const tailY = y - tailLength * speed;
                
                const glowColor = (new Color()).setHSLA(a(), a() ** 9, a(.1, .5));
                const glowGradient = ctx.createLinearGradient(x, y, tailX, tailY);
                glowGradient.addColorStop(0, glowColor.rgba());
                glowGradient.addColorStop(1, glowColor.scale(1, 0).rgba());
                
                ctx.globalCompositeOperation = "lighter";
                ctx.lineWidth = lineWidth;
                ctx.strokeStyle = glowGradient;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(tailX, tailY);
                ctx.stroke();
                
                ctx.globalCompositeOperation = "source-over";
                ctx.fillStyle = lineColor.rgba();
                ctx.beginPath();
                ctx.arc(x, y, lineWidth / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
            }
            
            // Draw wavy terrain
            let terrainColor = colorMix ? (new Color(.1, .1, .1)) : (new Color(.9, .9, .9));
            
            for (let layer = 0; ++layer < 8;) {
                const scale = a(.3, 1);
                let angle = 0;
                let pos = 0;
                
                // Calculate wave parameters
                let wavePos = layer * layer * 1000 + time * waveFactor * (layer - 1) ** 2;
                let waveIndex = Math.floor(wavePos);
                let waveFrac = wavePos % 1 - 1;
                let yOffset = baseHeight - 250 + layer * layer * 13;
                
                ctx.beginPath();
                
                // Generate wave points
                for (let x = 3000; x--;) {
                    let wave = 10 * Math.sin((++waveIndex + timeOffset) ** 2);
                    
                    if (Math.abs(wave) < 1) {
                        angle = wave * (waveType ? 3 : 1.5) * scale;
                    }
                    
                    pos += angle -= pos / 2000;
                    ctx.lineTo((x + waveFrac - 1) * layer, pos * layer ** .7 / 2 + yOffset);
                }
                
                // Calculate terrain color
                const layerColor = terrainColor.lerp(color1, 1 - .2 * layer);
                const terrainGradient = ctx.createLinearGradient(0, yOffset - 100, 0, yOffset + 300);
                terrainGradient.addColorStop(0, layerColor.clamp().rgba());
                terrainGradient.addColorStop(1, layerColor.subtract(new Color(1, 1, 1, 0)).mutate(.4).clamp().rgba());
                
                terrainColor = terrainColor.mutate(a() ** 2 * .3);
                
                // Complete the path
                ctx.lineTo(0, canvas.height);
                ctx.lineTo(canvas.width, canvas.height);
                ctx.fillStyle = terrainGradient;
                ctx.fill();
            }
        }
        
        // Toggle animation
        function toggleAnimation() {
            animationPaused = !animationPaused;
            
            document.getElementById('toggle-animation').classList.toggle('active', animationPaused);
            
            if (animationPaused) {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                addNotification('Background Animation', 'Animation has been paused.');
            } else {
                resetAnimation();
                animationFrameId = requestAnimationFrame(animate);
                addNotification('Background Animation', 'Animation has been resumed.');
            }
        }
        
        // ================ TYPEBOT INTEGRATION ================
        
        // Function to create a new button
        function createNewButton(url, title) {
            const newButton = document.createElement('button');
            newButton.classList.add('create-window-button');
            newButton.setAttribute('data-url', url);
            newButton.textContent = title;
            document.getElementById('launcher-container').appendChild(newButton);
            
            addNotification('New Button', `A new button "${title}" has been created.`);
        }
        
        // Function to close the pop-up
        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }
        
        // ================ EVENT LISTENERS ================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Start animation
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            animate(0);
            
            // Update clock
            function updateClock() {
                const clockElement = document.getElementById('clock');
                const now = new Date();
                clockElement.textContent = formatTime(now);
            }
            
            // Update clock every second
            updateClock();
            setInterval(updateClock, 1000);
            
            // Toggle animation
            document.getElementById('toggle-animation').addEventListener('click', toggleAnimation);
            
            // Toggle notification panel
            document.getElementById('notification-toggle').addEventListener('click', function() {
                const panel = document.getElementById('notification-panel');
                panel.classList.toggle('open');
            });
            
            // Clear notifications
            document.getElementById('clear-notifications').addEventListener('click', function() {
                document.getElementById('notification-list').innerHTML = '';
                document.getElementById('notification-toggle').classList.remove('active');
            });
            
            // Popup close button
            document.getElementById('popup-close').addEventListener('click', closePopup);
            
            // Event listener for buttons (including dynamically created ones)
            document.addEventListener('click', function(event) {
                const button = event.target.closest('.create-window-button');
                if (button) {
                    const url = button.getAttribute('data-url');
                    const title = button.textContent;
                    if (url) {
                        createWindow(url, title);
                    }
                }
            });
            
            // Event listener for messages from the Typebot iframe
            window.addEventListener('message', function(event) {
                if (event.data.type === 'createButton') {
                    createNewButton(event.data.url, event.data.title);
                    closePopup();
                    addNotification('Typebot', 'Successfully created a new button from Typebot.');
                }
            }, false);
            
            // Show the pop-up after 2 seconds
            setTimeout(function() {
                document.getElementById('popup').style.display = 'block';
                addNotification('Welcome', 'Welcome to the Multi-Window Environment! Typebot has been opened.');
            }, 2000);
            
            // Show initial welcome notification
            addNotification('System', 'Multi-Window Environment initialized. Click on the buttons to open windows.');
        });
        
    </script>
    
    <script>/**
 * cr8OS - Advanced Window Environment Features
 * This script adds 20 advanced features to the multi-window environment
 * Simply add this via a script tag after your main script
 */

const cr8OS = (function() {
    // Private variables
    let settings = {
        theme: 'default',
        snapThreshold: 20,
        enableSnapping: true,
        enableGrouping: true,
        enableKeyboardShortcuts: true,
        enableContextMenus: true,
        enableAnimations: true,
        enableWidgets: true,
        enableVirtualDesktops: true,
        enableAccessibility: true,
        saveState: true,
        sessionStorageKey: 'cr8OS-state',
        defaultTransparency: 1,
        currentWorkspace: 0,
        workspaces: ['Main', 'Work', 'Media', 'Social'],
        templates: {
            'browser': { width: 800, height: 600, icon: 'fa-globe' },
            'notepad': { width: 400, height: 500, icon: 'fa-sticky-note' },
            'terminal': { width: 600, height: 400, icon: 'fa-terminal' },
            'media': { width: 640, height: 480, icon: 'fa-play' },
            'chat': { width: 380, height: 500, icon: 'fa-comments' }
        },
        categories: ['Productivity', 'Media', 'Social', 'Development', 'System'],
        searchEnabled: true
    };

    let state = {
        windows: {},
        groups: {},
        widgets: [],
        tabs: {},
        history: {},
        pinnedWindows: [],
        windowsInCurrentWorkspace: [],
        windowCategories: {},
        contextMenuOpen: false,
        activeGroup: null,
        searchIndex: {},
        voiceCommandActive: false,
        shareSessionActive: false,
        draggedFile: null,
        windowAnimationsInProgress: 0
    };

    let themes = {
        'default': {
            '--window-bg': 'rgba(25, 25, 25, 0.8)',
            '--window-border': '1px solid rgba(255, 255, 255, 0.2)',
            '--window-header': 'rgba(30, 30, 30, 0.9)',
            '--window-text': '#fff',
            '--taskbar-bg': 'rgba(20, 20, 20, 0.8)',
            '--accent-color': '#3498db',
            '--accent-hover': '#2980b9',
            '--notification-bg': 'rgba(30, 30, 30, 0.9)'
        },
        'light': {
            '--window-bg': 'rgba(240, 240, 240, 0.9)',
            '--window-border': '1px solid rgba(0, 0, 0, 0.1)',
            '--window-header': 'rgba(220, 220, 220, 0.9)',
            '--window-text': '#333',
            '--taskbar-bg': 'rgba(230, 230, 230, 0.9)',
            '--accent-color': '#4CAF50',
            '--accent-hover': '#388E3C',
            '--notification-bg': 'rgba(245, 245, 245, 0.95)'
        },
        'dark': {
            '--window-bg': 'rgba(15, 15, 15, 0.9)',
            '--window-border': '1px solid rgba(70, 70, 70, 0.3)',
            '--window-header': 'rgba(20, 20, 20, 0.95)',
            '--window-text': '#eee',
            '--taskbar-bg': 'rgba(10, 10, 10, 0.9)',
            '--accent-color': '#9C27B0',
            '--accent-hover': '#7B1FA2',
            '--notification-bg': 'rgba(20, 20, 20, 0.95)'
        },
        'neon': {
            '--window-bg': 'rgba(10, 10, 25, 0.85)',
            '--window-border': '1px solid rgba(120, 50, 255, 0.5)',
            '--window-header': 'rgba(20, 10, 40, 0.9)',
            '--window-text': '#fff',
            '--taskbar-bg': 'rgba(15, 10, 30, 0.9)',
            '--accent-color': '#F50057',
            '--accent-hover': '#C51162',
            '--notification-bg': 'rgba(15, 10, 35, 0.95)'
        },
        'terminal': {
            '--window-bg': 'rgba(0, 10, 0, 0.9)',
            '--window-border': '1px solid rgba(0, 200, 0, 0.4)',
            '--window-header': 'rgba(0, 20, 0, 0.95)',
            '--window-text': '#0f0',
            '--taskbar-bg': 'rgba(0, 15, 0, 0.9)',
            '--accent-color': '#00E676',
            '--accent-hover': '#00C853',
            '--notification-bg': 'rgba(0, 20, 0, 0.95)'
        }
    };

    // Keyboard mapping
    const keyboardShortcuts = {
        'Alt+Tab': 'cycleWindows',
        'Alt+Shift+Tab': 'cycleWindowsReverse',
        'Alt+`': 'cycleWindowsOfSameType',
        'Ctrl+Alt+S': 'toggleSnapping',
        'Ctrl+Alt+G': 'toggleGrouping',
        'Ctrl+Alt+T': 'cycleThemes',
        'Ctrl+Alt+ArrowRight': 'nextWorkspace',
        'Ctrl+Alt+ArrowLeft': 'prevWorkspace',
        'Ctrl+Alt+D': 'minimizeAll',
        'Ctrl+Alt+A': 'restoreAll',
        'Ctrl+Alt+P': 'togglePin',
        'Ctrl+Alt+F': 'searchWindows',
        'Ctrl+Alt+V': 'toggleVoiceCommands',
        'Ctrl+Alt+1': 'workspace1',
        'Ctrl+Alt+2': 'workspace2',
        'Ctrl+Alt+3': 'workspace3',
        'Ctrl+Alt+4': 'workspace4',
        'F11': 'toggleFullscreen',
        'Escape': 'closeMenu'
    };

    // ================ FEATURE 1: WINDOW SNAPPING ================
    
    function initWindowSnapping() {
        document.addEventListener('mousemove', handleWindowSnapping);
        document.addEventListener('touchmove', handleWindowSnappingTouch);

        // Enhance existing windows
        document.querySelectorAll('.window-container').forEach(window => {
            enableWindowSnapping(window);
        });
    }

    function enableWindowSnapping(windowEl) {
        if (!windowEl.dataset.snapEnabled) {
            windowEl.dataset.snapEnabled = "true";
            
            // Store original window position when starting drag
            const header = windowEl.querySelector('.window-header');
            if (header) {
                const originalMousedown = header.onmousedown;
                header.onmousedown = function(e) {
                    if (originalMousedown) originalMousedown.call(this, e);
                    windowEl.dataset.originalPos = `${windowEl.style.left}|${windowEl.style.top}|${windowEl.style.width}|${windowEl.style.height}`;
                };
            }
        }
    }

    function handleWindowSnapping(e) {
        if (!settings.enableSnapping) return;
        
        const draggingWindow = document.querySelector('.window-container.dragging');
        if (!draggingWindow) return;
        
        const threshold = settings.snapThreshold;
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const taskbarHeight = document.getElementById('taskbar')?.offsetHeight || 0;
        
        const rect = draggingWindow.getBoundingClientRect();
        let snapped = false;
        
        // Snap to screen edges
        if (rect.left < threshold) {
            // Left edge
            if (rect.top < threshold) {
                // Top-left corner
                snapWindow(draggingWindow, 0, 0, viewportWidth / 2, (viewportHeight - taskbarHeight) / 2);
                snapped = true;
            } else if (viewportHeight - rect.bottom < threshold + taskbarHeight) {
                // Bottom-left corner
                snapWindow(draggingWindow, 0, (viewportHeight - taskbarHeight) / 2, viewportWidth / 2, (viewportHeight - taskbarHeight) / 2);
                snapped = true;
            } else if (rect.top < threshold * 2 && rect.height > viewportHeight / 3) {
                // Left half
                snapWindow(draggingWindow, 0, 0, viewportWidth / 2, viewportHeight - taskbarHeight);
                snapped = true;
            }
        } else if (viewportWidth - rect.right < threshold) {
            // Right edge
            if (rect.top < threshold) {
                // Top-right corner
                snapWindow(draggingWindow, viewportWidth / 2, 0, viewportWidth / 2, (viewportHeight - taskbarHeight) / 2);
                snapped = true;
            } else if (viewportHeight - rect.bottom < threshold + taskbarHeight) {
                // Bottom-right corner
                snapWindow(draggingWindow, viewportWidth / 2, (viewportHeight - taskbarHeight) / 2, viewportWidth / 2, (viewportHeight - taskbarHeight) / 2);
                snapped = true;
            } else if (rect.top < threshold * 2 && rect.height > viewportHeight / 3) {
                // Right half
                snapWindow(draggingWindow, viewportWidth / 2, 0, viewportWidth / 2, viewportHeight - taskbarHeight);
                snapped = true;
            }
        } else if (rect.top < threshold) {
            // Top edge
            snapWindow(draggingWindow, 0, 0, viewportWidth, (viewportHeight - taskbarHeight) / 2);
            snapped = true;
        } else if (viewportHeight - rect.bottom < threshold + taskbarHeight) {
            // Bottom edge
            snapWindow(draggingWindow, 0, (viewportHeight - taskbarHeight) / 2, viewportWidth, (viewportHeight - taskbarHeight) / 2);
            snapped = true;
        }
        
        // Snap to other windows
        if (!snapped) {
            document.querySelectorAll('.window-container').forEach(otherWindow => {
                if (otherWindow === draggingWindow || otherWindow.classList.contains('minimized')) return;
                
                const otherRect = otherWindow.getBoundingClientRect();
                
                // Snap to horizontal edges
                if (Math.abs(rect.right - otherRect.left) < threshold) {
                    // Right to left
                    draggingWindow.style.left = (otherRect.left - rect.width) + 'px';
                    snapped = true;
                } else if (Math.abs(rect.left - otherRect.right) < threshold) {
                    // Left to right
                    draggingWindow.style.left = otherRect.right + 'px';
                    snapped = true;
                }
                
                // Snap to vertical edges
                if (Math.abs(rect.bottom - otherRect.top) < threshold) {
                    // Bottom to top
                    draggingWindow.style.top = (otherRect.top - rect.height) + 'px';
                    snapped = true;
                } else if (Math.abs(rect.top - otherRect.bottom) < threshold) {
                    // Top to bottom
                    draggingWindow.style.top = otherRect.bottom + 'px';
                    snapped = true;
                }
            });
        }
        
        if (snapped) {
            addNotification('Window Snapping', 'Window snapped to position');
        }
    }

    function handleWindowSnappingTouch(e) {
        // Similar to handleWindowSnapping but for touch events
        if (!settings.enableSnapping) return;
        
        const draggingWindow = document.querySelector('.window-container.dragging');
        if (!draggingWindow || !e.touches[0]) return;
        
        // Convert touch event to mouse-like coordinates and call the regular handler
        const touchEvent = {
            clientX: e.touches[0].clientX,
            clientY: e.touches[0].clientY
        };
        
        handleWindowSnapping(touchEvent);
    }

    function snapWindow(windowEl, left, top, width, height) {
        if (settings.enableAnimations) {
            animateWindow(windowEl, {
                left: left + 'px',
                top: top + 'px',
                width: width + 'px',
                height: height + 'px'
            });
        } else {
            windowEl.style.left = left + 'px';
            windowEl.style.top = top + 'px';
            windowEl.style.width = width + 'px';
            windowEl.style.height = height + 'px';
        }
    }

    function toggleSnapping() {
        settings.enableSnapping = !settings.enableSnapping;
        addNotification('Window Snapping', 
            settings.enableSnapping ? 'Window snapping enabled' : 'Window snapping disabled');
        saveSettings();
    }

    // ================ FEATURE 2: WINDOW GROUPING ================
    
    function initWindowGrouping() {
        // Add group controls to windows
        document.querySelectorAll('.window-container').forEach(window => {
            enableWindowGrouping(window);
        });
        
        document.addEventListener('mouseup', finishGrouping);
        document.addEventListener('touchend', finishGrouping);
    }

    function enableWindowGrouping(windowEl) {
        if (!windowEl.dataset.groupEnabled) {
            windowEl.dataset.groupEnabled = "true";
            
            const controls = windowEl.querySelector('.window-controls');
            if (controls) {
                const groupBtn = document.createElement('button');
                groupBtn.className = 'group-btn';
                groupBtn.title = 'Group with another window';
                groupBtn.innerHTML = '<i class="fas fa-object-group"></i>';
                
                groupBtn.addEventListener('click', function() {
                    startGrouping(windowEl);
                });
                
                // Insert before the close button
                controls.insertBefore(groupBtn, controls.querySelector('.close-btn'));
            }
        }
    }

    function startGrouping(windowEl) {
        if (!settings.enableGrouping) return;
        
        // Visual indication that we're in grouping mode
        windowEl.classList.add('grouping-source');
        document.body.classList.add('grouping-active');
        
        // Temporarily disable window dragging
        const header = windowEl.querySelector('.window-header');
        if (header) header.style.pointerEvents = 'none';
        
        state.groupingSourceWindow = windowEl;
        
        addNotification('Window Grouping', 'Click on another window to form a group');
        
        // Add event listeners for target selection
        document.querySelectorAll('.window-container').forEach(win => {
            if (win !== windowEl && !win.classList.contains('minimized')) {
                win.classList.add('grouping-target');
                
                win.addEventListener('click', groupingTargetClickHandler);
            }
        });
        
        // Cancel grouping on escape key
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                cancelGrouping();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    function groupingTargetClickHandler(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (state.groupingSourceWindow) {
            const targetWindow = this;
            createWindowGroup(state.groupingSourceWindow, targetWindow);
        }
        
        finishGrouping();
    }

    function createWindowGroup(sourceWindow, targetWindow) {
        const groupId = 'group-' + Date.now();
        
        // Create group if it doesn't exist
        if (!state.groups[groupId]) {
            state.groups[groupId] = {
                id: groupId,
                windows: [],
                active: true,
                position: {
                    left: Math.min(
                        parseInt(sourceWindow.style.left) || 0,
                        parseInt(targetWindow.style.left) || 0
                    ),
                    top: Math.min(
                        parseInt(sourceWindow.style.top) || 0,
                        parseInt(targetWindow.style.top) || 0
                    )
                }
            };
        }
        
        // Add windows to group if not already in it
        [sourceWindow, targetWindow].forEach(win => {
            if (!win.dataset.groupId) {
                win.dataset.groupId = groupId;
                win.classList.add('window-grouped');
                
                // Store relative position within group
                const relX = (parseInt(win.style.left) || 0) - state.groups[groupId].position.left;
                const relY = (parseInt(win.style.top) || 0) - state.groups[groupId].position.top;
                win.dataset.groupPosition = `${relX},${relY}`;
                
                state.groups[groupId].windows.push(win.id);
            }
        });
        
        // Update visual indication
        updateGroupIndicators(groupId);
        
        addNotification('Window Grouping', 'Windows have been grouped. They will now move together.');
    }

    function updateGroupIndicators(groupId) {
        const group = state.groups[groupId];
        if (!group) return;
        
        // Add visual indicators to each window in the group
        group.windows.forEach(windowId => {
            const win = document.getElementById(windowId);
            if (win) {
                // Add group indicator if not already present
                if (!win.querySelector('.group-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'group-indicator';
                    indicator.innerHTML = '<i class="fas fa-link"></i>';
                    win.appendChild(indicator);
                    
                    // Tooltip
                    indicator.title = `Grouped with ${group.windows.length - 1} other window(s)`;
                }
            }
        });
    }

    function finishGrouping() {
        if (state.groupingSourceWindow) {
            // Clean up grouping mode
            document.querySelectorAll('.grouping-source, .grouping-target').forEach(el => {
                el.classList.remove('grouping-source', 'grouping-target');
                
                // Remove temporary event handlers
                el.removeEventListener('click', groupingTargetClickHandler);
            });
            
            // Re-enable dragging
            const header = state.groupingSourceWindow.querySelector('.window-header');
            if (header) header.style.pointerEvents = '';
            
            state.groupingSourceWindow = null;
            document.body.classList.remove('grouping-active');
        }
    }

    function cancelGrouping() {
        finishGrouping();
        addNotification('Window Grouping', 'Grouping cancelled');
    }

    function moveGroupedWindows(sourceWindow, deltaX, deltaY) {
        if (!settings.enableGrouping) return;
        
        const groupId = sourceWindow.dataset.groupId;
        if (!groupId) return;
        
        const group = state.groups[groupId];
        if (!group) return;
        
        group.windows.forEach(windowId => {
            const win = document.getElementById(windowId);
            if (win && win !== sourceWindow && !win.classList.contains('minimized')) {
                const left = (parseInt(win.style.left) || 0) + deltaX;
                const top = (parseInt(win.style.top) || 0) + deltaY;
                
                win.style.left = `${left}px`;
                win.style.top = `${top}px`;
            }
        });
        
        // Update group position
        group.position.left = (parseInt(sourceWindow.style.left) || 0);
        group.position.top = (parseInt(sourceWindow.style.top) || 0);
    }

    function ungroupWindow(windowEl) {
        const groupId = windowEl.dataset.groupId;
        if (!groupId) return;
        
        // Remove window from group
        const group = state.groups[groupId];
        if (group) {
            // Filter out this window
            group.windows = group.windows.filter(id => id !== windowEl.id);
            
            // If group has less than 2 windows, disband it
            if (group.windows.length < 2) {
                // Ungroup the last window
                if (group.windows.length === 1) {
                    const lastWindow = document.getElementById(group.windows[0]);
                    if (lastWindow) {
                        lastWindow.dataset.groupId = '';
                        lastWindow.classList.remove('window-grouped');
                        
                        // Remove indicator
                        const indicator = lastWindow.querySelector('.group-indicator');
                        if (indicator) indicator.remove();
                    }
                }
                
                // Remove group
                delete state.groups[groupId];
            } else {
                // Update indicators for remaining windows
                updateGroupIndicators(groupId);
            }
        }
        
        // Clean up this window
        windowEl.dataset.groupId = '';
        windowEl.dataset.groupPosition = '';
        windowEl.classList.remove('window-grouped');
        
        // Remove indicator
        const indicator = windowEl.querySelector('.group-indicator');
        if (indicator) indicator.remove();
        
        addNotification('Window Grouping', 'Window removed from group');
    }

    function toggleGrouping() {
        settings.enableGrouping = !settings.enableGrouping;
        addNotification('Window Grouping', 
            settings.enableGrouping ? 'Window grouping enabled' : 'Window grouping disabled');
        saveSettings();
    }

    // ================ FEATURE 3: CUSTOM THEMES AND COLOR SCHEMES ================
    
    function initThemeSystem() {
        createThemeControls();
        applyTheme(settings.theme);
    }

    function createThemeControls() {
        // Add theme selector to taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const themeButton = document.createElement('button');
            themeButton.className = 'toggle-button theme-toggle';
            themeButton.innerHTML = '<i class="fas fa-palette"></i>';
            themeButton.title = 'Change theme';
            
            themeButton.addEventListener('click', showThemeSelector);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(themeButton, clock);
            } else {
                taskbarRight.appendChild(themeButton);
            }
        }
    }

    function showThemeSelector() {
        // Create theme selector
        const selector = document.createElement('div');
        selector.className = 'theme-selector';
        selector.innerHTML = `
            <div class="theme-selector-header">
                <h3>Select Theme</h3>
                <button class="theme-close-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="theme-selector-content"></div>
        `;
        
        // Add theme options
        const content = selector.querySelector('.theme-selector-content');
        Object.keys(themes).forEach(themeName => {
            const themeOption = document.createElement('div');
            themeOption.className = 'theme-option';
            themeOption.classList.toggle('active', themeName === settings.theme);
            
            // Create color preview using the theme colors
            const colors = themes[themeName];
            const colorPreview = document.createElement('div');
            colorPreview.className = 'theme-color-preview';
            
            // Create color squares for each main color
            const previewColors = [
                colors['--window-bg'], 
                colors['--window-header'],
                colors['--accent-color'],
                colors['--taskbar-bg']
            ];
            
            previewColors.forEach(color => {
                const colorSquare = document.createElement('div');
                colorSquare.className = 'theme-color-square';
                colorSquare.style.backgroundColor = color;
                colorPreview.appendChild(colorSquare);
            });
            
            themeOption.appendChild(colorPreview);
            
            // Theme name
            const nameEl = document.createElement('div');
            nameEl.className = 'theme-name';
            nameEl.textContent = themeName.charAt(0).toUpperCase() + themeName.slice(1);
            themeOption.appendChild(nameEl);
            
            // Add click handler
            themeOption.addEventListener('click', () => {
                applyTheme(themeName);
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.toggle('active', opt === themeOption);
                });
            });
            
            content.appendChild(themeOption);
        });
        
        // Add close handler
        selector.querySelector('.theme-close-btn').addEventListener('click', () => {
            selector.classList.add('closing');
            setTimeout(() => selector.remove(), 300);
        });
        
        // Add to body and animate in
        document.body.appendChild(selector);
        setTimeout(() => selector.classList.add('open'), 10);
        
        // Close when clicking outside
        document.addEventListener('mousedown', function closeThemeSelector(e) {
            if (!selector.contains(e.target) && !e.target.classList.contains('theme-toggle')) {
                selector.classList.add('closing');
                setTimeout(() => selector.remove(), 300);
                document.removeEventListener('mousedown', closeThemeSelector);
            }
        });
    }

    function applyTheme(themeName) {
        if (!themes[themeName]) {
            console.error(`Theme "${themeName}" not found`);
            return;
        }
        
        // Set CSS variables
        const themeColors = themes[themeName];
        for (const [property, value] of Object.entries(themeColors)) {
            document.documentElement.style.setProperty(property, value);
        }
        
        // Update settings
        settings.theme = themeName;
        saveSettings();
        
        addNotification('Theme Changed', `Applied theme: ${themeName}`);
    }

    function cycleThemes() {
        const themeNames = Object.keys(themes);
        const currentIndex = themeNames.indexOf(settings.theme);
        const nextIndex = (currentIndex + 1) % themeNames.length;
        applyTheme(themeNames[nextIndex]);
    }

    function addCustomTheme(name, colors) {
        if (themes[name]) {
            console.warn(`Theme "${name}" already exists. Overwriting.`);
        }
        
        themes[name] = colors;
        saveSettings();
        
        addNotification('Custom Theme', `Theme "${name}" has been added`);
    }

    // ================ FEATURE 4: SESSION PERSISTENCE ================
    
    function initSessionPersistence() {
        if (!settings.saveState) return;
        
        // Load saved windows and state
        loadSession();
        
        // Set up auto-save
        window.addEventListener('beforeunload', saveSession);
    }

    function saveSession() {
        if (!settings.saveState) return;
        
        const sessionData = {
            windows: [],
            groups: state.groups,
            settings: settings,
            theme: settings.theme,
            workspace: settings.currentWorkspace
        };
        
        // Save windows
        document.querySelectorAll('.window-container').forEach(win => {
            if (!win.classList.contains('system-window')) {
                sessionData.windows.push({
                    id: win.id,
                    left: win.style.left,
                    top: win.style.top,
                    width: win.style.width,
                    height: win.style.height,
                    title: win.querySelector('.window-title')?.textContent,
                    url: win.querySelector('.window-iframe')?.src,
                    minimized: win.classList.contains('minimized'),
                    maximized: win.classList.contains('maximized'),
                    groupId: win.dataset.groupId || null,
                    category: win.dataset.category || null,
                    transparency: win.style.opacity || 1,
                    pinned: state.pinnedWindows.includes(win.id),
                    workspace: parseInt(win.dataset.workspace) || 0
                });
            }
        });
        
        // Save to local storage
        localStorage.setItem(settings.sessionStorageKey, JSON.stringify(sessionData));
    }

    function loadSession() {
        const savedData = localStorage.getItem(settings.sessionStorageKey);
        if (!savedData) return;
        
        try {
            const sessionData = JSON.parse(savedData);
            
            // Restore settings
            Object.assign(settings, sessionData.settings);
            
            // Restore theme
            if (sessionData.theme) {
                applyTheme(sessionData.theme);
            }
            
            // Restore groups
            if (sessionData.groups) {
                state.groups = sessionData.groups;
            }
            
            // Restore workspace
            if (typeof sessionData.workspace === 'number') {
                settings.currentWorkspace = sessionData.workspace;
                updateWorkspaceDisplay();
            }
            
            // Restore windows
            if (sessionData.windows && Array.isArray(sessionData.windows)) {
                // Clear existing windows first
                document.querySelectorAll('.window-container:not(.system-window)').forEach(win => {
                    win.remove();
                });
                
                // Recreate saved windows
                sessionData.windows.forEach(winData => {
                    // Only restore windows for current workspace
                    if (winData.workspace === settings.currentWorkspace || winData.pinned) {
                        const win = createWindow(winData.url, winData.title);
                        if (win) {
                            win.id = winData.id;
                            win.style.left = winData.left;
                            win.style.top = winData.top;
                            win.style.width = winData.width;
                            win.style.height = winData.height;
                            
                            if (winData.minimized) {
                                win.classList.add('minimized');
                                win.querySelector('.window-header')?.classList.add('no-drag');
                            }
                            
                            if (winData.maximized) {
                                win.classList.add('maximized');
                                win.querySelector('.window-header')?.classList.add('no-drag');
                            }
                            
                            if (winData.groupId) {
                                win.dataset.groupId = winData.groupId;
                                win.classList.add('window-grouped');
                            }
                            
                            if (winData.category) {
                                win.dataset.category = winData.category;
                                addWindowToCategory(win, winData.category);
                            }
                            
                            if (winData.transparency) {
                                win.style.opacity = winData.transparency;
                            }
                            
                            if (winData.pinned) {
                                state.pinnedWindows.push(win.id);
                                pinWindow(win);
                            }
                            
                            win.dataset.workspace = winData.workspace;
                        }
                    }
                });
                
                // Restore group indicators
                Object.keys(state.groups).forEach(updateGroupIndicators);
            }
            
            addNotification('Session Restored', 'Your windows and settings have been restored');
            
        } catch (err) {
            console.error('Error loading session:', err);
            addNotification('Error', 'Failed to restore session');
        }
    }

    function clearSavedSession() {
        localStorage.removeItem(settings.sessionStorageKey);
        addNotification('Session Cleared', 'Saved session data has been cleared');
    }

    function toggleSessionPersistence() {
        settings.saveState = !settings.saveState;
        addNotification('Session Persistence', 
            settings.saveState ? 'Session persistence enabled' : 'Session persistence disabled');
        saveSettings();
    }

    // ================ FEATURE 5: KEYBOARD SHORTCUTS ================
    
    function initKeyboardShortcuts() {
        if (!settings.enableKeyboardShortcuts) return;
        
        document.addEventListener('keydown', handleKeyboardShortcut);
        
        // Create keyboard shortcut helper
        createKeyboardShortcutHelper();
    }

    function handleKeyboardShortcut(e) {
        if (!settings.enableKeyboardShortcuts) return;
        
        // Ignore when typing in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        // Build shortcut key string
        let shortcut = '';
        if (e.ctrlKey) shortcut += 'Ctrl+';
        if (e.altKey) shortcut += 'Alt+';
        if (e.shiftKey) shortcut += 'Shift+';
        shortcut += e.key;
        
        // Check if shortcut exists
        const action = keyboardShortcuts[shortcut];
        if (action && typeof cr8OS[action] === 'function') {
            e.preventDefault();
            cr8OS[action]();
        }
    }

    function createKeyboardShortcutHelper() {
        // Create help button in taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const helpButton = document.createElement('button');
            helpButton.className = 'toggle-button keyboard-help-toggle';
            helpButton.innerHTML = '<i class="fas fa-keyboard"></i>';
            helpButton.title = 'Keyboard shortcuts';
            
            helpButton.addEventListener('click', showKeyboardShortcutHelper);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(helpButton, clock);
            } else {
                taskbarRight.appendChild(helpButton);
            }
        }
    }

    function showKeyboardShortcutHelper() {
        // Create help window
        const helpWindow = document.createElement('div');
        helpWindow.className = 'window-container system-window keyboard-help-window';
        helpWindow.style.width = '500px';
        helpWindow.style.height = '400px';
        helpWindow.style.left = '50%';
        helpWindow.style.top = '50%';
        helpWindow.style.transform = 'translate(-50%, -50%)';
        helpWindow.style.zIndex = '10000';
        
        helpWindow.innerHTML = `
            <div class="window-header">
                <h3 class="window-title">Keyboard Shortcuts</h3>
                <div class="window-controls">
                    <button class="close-btn" title="Close"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="window-content keyboard-shortcuts-content">
                <table class="shortcuts-table">
                    <thead>
                        <tr>
                            <th>Shortcut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(keyboardShortcuts).map(([key, action]) => `
                            <tr>
                                <td class="shortcut-key">${key}</td>
                                <td>${formatActionName(action)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="shortcuts-footer">
                    <button class="toggle-shortcuts-btn">
                        ${settings.enableKeyboardShortcuts ? 'Disable' : 'Enable'} Keyboard Shortcuts
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(helpWindow);
        
        // Add event handlers
        helpWindow.querySelector('.close-btn').addEventListener('click', () => {
            helpWindow.remove();
        });
        
        helpWindow.querySelector('.toggle-shortcuts-btn').addEventListener('click', () => {
            toggleKeyboardShortcuts();
            helpWindow.remove();
        });
    }

    function formatActionName(action) {
        return action
            .replace(/([A-Z])/g, ' $1') // Add space before capital letters
            .replace(/^./, str => str.toUpperCase()); // Capitalize first letter
    }

    function toggleKeyboardShortcuts() {
        settings.enableKeyboardShortcuts = !settings.enableKeyboardShortcuts;
        addNotification('Keyboard Shortcuts', 
            settings.enableKeyboardShortcuts ? 'Keyboard shortcuts enabled' : 'Keyboard shortcuts disabled');
        saveSettings();
    }

    // Window cycling functions
    function cycleWindows() {
        const windows = Array.from(document.querySelectorAll('.window-container:not(.minimized)'));
        if (windows.length < 2) return;
        
        let activeIndex = windows.findIndex(w => w.id === activeWindowId);
        let nextIndex = (activeIndex + 1) % windows.length;
        
        setActiveWindow(windows[nextIndex].id);
    }

    function cycleWindowsReverse() {
        const windows = Array.from(document.querySelectorAll('.window-container:not(.minimized)'));
        if (windows.length < 2) return;
        
        let activeIndex = windows.findIndex(w => w.id === activeWindowId);
        let nextIndex = (activeIndex - 1 + windows.length) % windows.length;
        
        setActiveWindow(windows[nextIndex].id);
    }

    function cycleWindowsOfSameType() {
        const activeWindow = document.getElementById(activeWindowId);
        if (!activeWindow) return;
        
        const activeUrl = activeWindow.querySelector('.window-iframe')?.src;
        if (!activeUrl) return;
        
        // Get all windows with the same URL
        const sameTypeWindows = Array.from(document.querySelectorAll('.window-container:not(.minimized)')).filter(w => {
            return w.querySelector('.window-iframe')?.src === activeUrl;
        });
        
        if (sameTypeWindows.length < 2) return;
        
        let activeIndex = sameTypeWindows.findIndex(w => w.id === activeWindowId);
        let nextIndex = (activeIndex + 1) % sameTypeWindows.length;
        
        setActiveWindow(sameTypeWindows[nextIndex].id);
    }

    // ================ FEATURE 6: ADVANCED WINDOW CONTROLS ================
    
    function initAdvancedWindowControls() {
        // Add advanced controls to existing windows
        document.querySelectorAll('.window-container').forEach(window => {
            enhanceWindowControls(window);
        });
    }

    function enhanceWindowControls(windowEl) {
        const controls = windowEl.querySelector('.window-controls');
        if (!controls) return;
        
        // Don't add twice
        if (windowEl.dataset.enhancedControls) return;
        windowEl.dataset.enhancedControls = "true";
        
        // Add pin button
        const pinBtn = document.createElement('button');
        pinBtn.className = 'pin-btn';
        pinBtn.title = 'Pin window (stays visible across workspaces)';
        pinBtn.innerHTML = '<i class="fas fa-thumbtack"></i>';
        
        pinBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            togglePinWindow(windowEl);
        });
        
        // Add transparency control
        const transparencyBtn = document.createElement('button');
        transparencyBtn.className = 'transparency-btn';
        transparencyBtn.title = 'Adjust transparency';
        transparencyBtn.innerHTML = '<i class="fas fa-adjust"></i>';
        
        transparencyBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            showTransparencyControl(windowEl);
        });
        
        // Add to info menu button
        const infoBtn = document.createElement('button');
        infoBtn.className = 'info-btn';
        infoBtn.title = 'Window information';
        infoBtn.innerHTML = '<i class="fas fa-info-circle"></i>';
        
        infoBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            showWindowInfo(windowEl);
        });
        
        // Insert buttons at appropriate positions
        controls.insertBefore(infoBtn, controls.firstChild);
        controls.insertBefore(transparencyBtn, controls.firstChild);
        controls.insertBefore(pinBtn, controls.firstChild);
        
        // Add style classes if pinned
        if (state.pinnedWindows.includes(windowEl.id)) {
            pinWindow(windowEl);
        }
    }

    function togglePinWindow(windowEl) {
        if (state.pinnedWindows.includes(windowEl.id)) {
            // Unpin window
            state.pinnedWindows = state.pinnedWindows.filter(id => id !== windowEl.id);
            windowEl.classList.remove('window-pinned');
            windowEl.querySelector('.pin-btn')?.classList.remove('active');
            
            addNotification('Window Unpinned', 'Window will no longer appear on all workspaces');
        } else {
            // Pin window
            state.pinnedWindows.push(windowEl.id);
            pinWindow(windowEl);
            
            addNotification('Window Pinned', 'Window will now appear on all workspaces');
        }
    }

    function pinWindow(windowEl) {
        windowEl.classList.add('window-pinned');
        const pinBtn = windowEl.querySelector('.pin-btn');
        if (pinBtn) pinBtn.classList.add('active');
    }

    function showTransparencyControl(windowEl) {
        // Create transparency slider
        const currentTransparency = parseFloat(windowEl.style.opacity) || 1;
        
        const control = document.createElement('div');
        control.className = 'transparency-control';
        control.innerHTML = `
            <div class="transparency-slider-container">
                <input type="range" class="transparency-slider" min="0.2" max="1" step="0.05" value="${currentTransparency}">
                <span class="transparency-value">${Math.round(currentTransparency * 100)}%</span>
            </div>
            <button class="transparency-close"><i class="fas fa-check"></i></button>
        `;
        
        // Position near the button
        const btn = windowEl.querySelector('.transparency-btn');
        const btnRect = btn.getBoundingClientRect();
        
        control.style.top = (btnRect.bottom + 5) + 'px';
        control.style.left = (btnRect.left - 100) + 'px';
        
        windowEl.appendChild(control);
        
        // Add event listeners
        const slider = control.querySelector('.transparency-slider');
        const valueDisplay = control.querySelector('.transparency-value');
        
        slider.addEventListener('input', function() {
            const value = parseFloat(this.value);
            windowEl.style.opacity = value;
            valueDisplay.textContent = Math.round(value * 100) + '%';
        });
        
        control.querySelector('.transparency-close').addEventListener('click', function() {
            control.remove();
        });
        
        // Close when clicking outside
        document.addEventListener('mousedown', function closeTransparency(e) {
            if (!control.contains(e.target) && e.target !== btn) {
                control.remove();
                document.removeEventListener('mousedown', closeTransparency);
            }
        });
    }

    function showWindowInfo(windowEl) {
        const title = windowEl.querySelector('.window-title')?.textContent || 'Untitled Window';
        const url = windowEl.querySelector('.window-iframe')?.src || 'No URL';
        const rect = windowEl.getBoundingClientRect();
        const groupId = windowEl.dataset.groupId || 'None';
        const category = windowEl.dataset.category || 'Uncategorized';
        const workspace = parseInt(windowEl.dataset.workspace) || settings.currentWorkspace;
        const workspaceName = settings.workspaces[workspace] || 'Unknown';
        
        const infoWindow = document.createElement('div');
        infoWindow.className = 'window-info-popup';
        infoWindow.innerHTML = `
            <h3>Window Information</h3>
            <table>
                <tr><td>Title:</td><td>${title}</td></tr>
                <tr><td>URL:</td><td>${url}</td></tr>
                <tr><td>Position:</td><td>${Math.round(rect.left)}x${Math.round(rect.top)}</td></tr>
                <tr><td>Size:</td><td>${Math.round(rect.width)}x${Math.round(rect.height)}</td></tr>
                <tr><td>Group:</td><td>${groupId}</td></tr>
                <tr><td>Category:</td><td>${category}</td></tr>
                <tr><td>Workspace:</td><td>${workspaceName}</td></tr>
            </table>
            <div class="window-info-actions">
                <button class="window-info-close">Close</button>
                ${!windowEl.dataset.category ? `<button class="assign-category-btn">Assign Category</button>` : ''}
            </div>
        `;
        
        // Position near the button
        const btn = windowEl.querySelector('.info-btn');
        const btnRect = btn.getBoundingClientRect();
        
        infoWindow.style.top = (btnRect.bottom + 5) + 'px';
        infoWindow.style.left = (btnRect.left - 150) + 'px';
        
        document.body.appendChild(infoWindow);
        
        // Add event listeners
        infoWindow.querySelector('.window-info-close').addEventListener('click', function() {
            infoWindow.remove();
        });
        
        const categoryBtn = infoWindow.querySelector('.assign-category-btn');
        if (categoryBtn) {
            categoryBtn.addEventListener('click', function() {
                showCategorySelector(windowEl);
                infoWindow.remove();
            });
        }
        
        // Close when clicking outside
        document.addEventListener('mousedown', function closeInfo(e) {
            if (!infoWindow.contains(e.target) && e.target !== btn) {
                infoWindow.remove();
                document.removeEventListener('mousedown', closeInfo);
            }
        });
    }

    function showCategorySelector(windowEl) {
        const selector = document.createElement('div');
        selector.className = 'category-selector';
        selector.innerHTML = `
            <h3>Select Category</h3>
            <div class="category-list">
                ${settings.categories.map(cat => `
                    <div class="category-option">${cat}</div>
                `).join('')}
            </div>
            <button class="category-close">Cancel</button>
        `;
        
        document.body.appendChild(selector);
        
        // Add event listeners
        selector.querySelectorAll('.category-option').forEach(option => {
            option.addEventListener('click', function() {
                const category = this.textContent;
                addWindowToCategory(windowEl, category);
                selector.remove();
            });
        });
        
        selector.querySelector('.category-close').addEventListener('click', function() {
            selector.remove();
        });
        
        // Position in center
        selector.style.top = '50%';
        selector.style.left = '50%';
        selector.style.transform = 'translate(-50%, -50%)';
    }

    function addWindowToCategory(windowEl, category) {
        windowEl.dataset.category = category;
        
        // Store in state
        if (!state.windowCategories[category]) {
            state.windowCategories[category] = [];
        }
        
        if (!state.windowCategories[category].includes(windowEl.id)) {
            state.windowCategories[category].push(windowEl.id);
        }
        
        // Add visual indicator
        if (!windowEl.querySelector('.category-indicator')) {
            const indicator = document.createElement('div');
            indicator.className = 'category-indicator';
            indicator.textContent = category;
            windowEl.appendChild(indicator);
        } else {
            windowEl.querySelector('.category-indicator').textContent = category;
        }
        
        addNotification('Category Assigned', `Window added to category: ${category}`);
    }

    // ================ FEATURE 7: INTEGRATED SEARCH ================
    
    function initWindowSearch() {
        if (!settings.searchEnabled) return;
        
        createSearchInterface();
        buildSearchIndex();
    }

    function buildSearchIndex() {
        state.searchIndex = {};
        
        document.querySelectorAll('.window-container').forEach(window => {
            const id = window.id;
            const title = window.querySelector('.window-title')?.textContent || '';
            const url = window.querySelector('.window-iframe')?.src || '';
            
            // Store searchable content
            state.searchIndex[id] = {
                title: title.toLowerCase(),
                url: url.toLowerCase(),
                category: (window.dataset.category || '').toLowerCase()
            };
        });
    }

    function createSearchInterface() {
        // Add search button to taskbar
        const taskbarLeft = document.getElementById('taskbar-left');
        if (!taskbarLeft) return;
        
        const searchBtn = document.createElement('button');
        searchBtn.className = 'toggle-button search-btn';
        searchBtn.innerHTML = '<i class="fas fa-search"></i>';
        searchBtn.title = 'Search windows';
        
        searchBtn.addEventListener('click', showSearchBar);
        
        taskbarLeft.appendChild(searchBtn);
    }

    function showSearchBar() {
        // Don't create multiple search bars
        if (document.querySelector('.window-search-bar')) return;
        
        const searchBar = document.createElement('div');
        searchBar.className = 'window-search-bar';
        searchBar.innerHTML = `
            <input type="text" class="search-input" placeholder="Search windows...">
            <div class="search-results"></div>
        `;
        
        document.body.appendChild(searchBar);
        
        // Focus input
        const input = searchBar.querySelector('.search-input');
        input.focus();
        
        // Add event listeners
        input.addEventListener('input', performSearch);
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchBar.remove();
            } else if (e.key === 'ArrowDown') {
                focusNextSearchResult();
                e.preventDefault();
            } else if (e.key === 'ArrowUp') {
                focusPrevSearchResult();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                selectFocusedSearchResult();
                e.preventDefault();
            }
        });
        
        // Close when clicking outside
        document.addEventListener('mousedown', function closeSearch(e) {
            if (!searchBar.contains(e.target) && !e.target.classList.contains('search-btn')) {
                searchBar.remove();
                document.removeEventListener('mousedown', closeSearch);
            }
        });
    }

    function performSearch() {
        const query = this.value.toLowerCase().trim();
        const resultsContainer = document.querySelector('.search-results');
        
        // Clear previous results
        resultsContainer.innerHTML = '';
        
        if (!query) return;
        
        // Rebuild index to ensure it's up to date
        buildSearchIndex();
        
        // Search in index
        const results = [];
        
        for (const [windowId, content] of Object.entries(state.searchIndex)) {
            // Check if window exists
            const windowEl = document.getElementById(windowId);
            if (!windowEl) continue;
            
            // Skip minimized windows in different workspaces
            if (windowEl.classList.contains('minimized') && 
                parseInt(windowEl.dataset.workspace) !== settings.currentWorkspace && 
                !state.pinnedWindows.includes(windowId)) {
                continue;
            }
            
            // Search in title, URL and category
            const titleMatch = content.title.includes(query);
            const urlMatch = content.url.includes(query);
            const categoryMatch = content.category.includes(query);
            
            if (titleMatch || urlMatch || categoryMatch) {
                results.push({
                    id: windowId,
                    title: windowEl.querySelector('.window-title')?.textContent || 'Untitled',
                    score: (titleMatch ? 3 : 0) + (urlMatch ? 1 : 0) + (categoryMatch ? 2 : 0),
                    matches: {
                        title: titleMatch,
                        url: urlMatch,
                        category: categoryMatch
                    }
                });
            }
        }
        
        // Sort by score
        results.sort((a, b) => b.score - a.score);
        
        // Show results
        if (results.length > 0) {
            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.dataset.windowId = result.id;
                
                // Highlight matching parts
                let title = result.title;
                if (result.matches.title) {
                    title = highlightMatches(title, query);
                }
                
                resultItem.innerHTML = `
                    <div class="search-result-title">${title}</div>
                    <div class="search-result-meta">
                        ${result.matches.category ? `<span class="search-result-category">${document.getElementById(result.id).dataset.category || ''}</span>` : ''}
                    </div>
                `;
                
                resultItem.addEventListener('click', function() {
                    focusWindow(result.id);
                    document.querySelector('.window-search-bar').remove();
                });
                
                resultsContainer.appendChild(resultItem);
            });
        } else {
            resultsContainer.innerHTML = '<div class="search-no-results">No windows found</div>';
        }
    }

    function highlightMatches(text, query) {
        const regex = new RegExp('(' + query + ')', 'gi');
        return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function focusNextSearchResult() {
        const results = document.querySelectorAll('.search-result-item');
        if (results.length === 0) return;
        
        const focused = document.querySelector('.search-result-item.focused');
        
        if (!focused) {
            // Focus first result
            results[0].classList.add('focused');
        } else {
            // Find index of currently focused result
            const currentIndex = Array.from(results).indexOf(focused);
            focused.classList.remove('focused');
            
            // Focus next or wrap to first
            const nextIndex = (currentIndex + 1) % results.length;
            results[nextIndex].classList.add('focused');
        }
    }

    function focusPrevSearchResult() {
        const results = document.querySelectorAll('.search-result-item');
        if (results.length === 0) return;
        
        const focused = document.querySelector('.search-result-item.focused');
        
        if (!focused) {
            // Focus last result
            results[results.length - 1].classList.add('focused');
        } else {
            // Find index of currently focused result
            const currentIndex = Array.from(results).indexOf(focused);
            focused.classList.remove('focused');
            
            // Focus previous or wrap to last
            const prevIndex = (currentIndex - 1 + results.length) % results.length;
            results[prevIndex].classList.add('focused');
        }
    }

    function selectFocusedSearchResult() {
        const focused = document.querySelector('.search-result-item.focused');
        if (focused) {
            focusWindow(focused.dataset.windowId);
            document.querySelector('.window-search-bar').remove();
        }
    }

    function focusWindow(windowId) {
        const windowEl = document.getElementById(windowId);
        if (!windowEl) return;
        
        // Restore if minimized
        if (windowEl.classList.contains('minimized')) {
            windowEl.classList.remove('minimized');
            windowEl.querySelector('.window-header')?.classList.remove('no-drag');
        }
        
        // Set as active window
        setActiveWindow(windowId);
        
        // Ensure it's visible in current workspace
        if (parseInt(windowEl.dataset.workspace) !== settings.currentWorkspace && 
            !state.pinnedWindows.includes(windowId)) {
            windowEl.dataset.workspace = settings.currentWorkspace;
        }
    }

    function searchWindows() {
        showSearchBar();
    }

    // ================ FEATURE 8: TABBED INTERFACE ================
    
    function initTabbedWindows() {
        // Add the ability to convert windows to tabbed mode
        document.querySelectorAll('.window-container').forEach(window => {
            enableTabbedMode(window);
        });
    }

    function enableTabbedMode(windowEl) {
        if (windowEl.dataset.tabbedEnabled) return;
        windowEl.dataset.tabbedEnabled = "true";
        
        const controls = windowEl.querySelector('.window-controls');
        if (!controls) return;
        
        // Add tab button
        const tabBtn = document.createElement('button');
        tabBtn.className = 'tab-btn';
        tabBtn.title = 'Convert to tabbed window';
        tabBtn.innerHTML = '<i class="fas fa-folder"></i>';
        
        tabBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            convertToTabbedWindow(windowEl);
        });
        
        // Insert before close button
        controls.insertBefore(tabBtn, controls.querySelector('.close-btn'));
    }

    function convertToTabbedWindow(windowEl) {
        if (windowEl.classList.contains('tabbed-window')) return;
        
        // Create unique tab group ID
        const tabGroupId = 'tabs-' + Date.now();
        windowEl.dataset.tabGroupId = tabGroupId;
        windowEl.classList.add('tabbed-window');
        
        // Store the current content as the first tab
        const iframe = windowEl.querySelector('.window-iframe');
        const title = windowEl.querySelector('.window-title')?.textContent || 'Tab 1';
        const url = iframe?.src || '';
        
        // Initialize tab state
        state.tabs[tabGroupId] = {
            activeTab: 0,
            tabs: [{
                id: 'tab-' + Date.now(),
                title: title,
                url: url
            }]
        };
        
        // Create tab bar
        createTabBar(windowEl, tabGroupId);
        
        // Update window controls
        updateTabbedWindowControls(windowEl);
        
        addNotification('Tabbed Window', 'Window converted to tabbed mode');
    }

    function createTabBar(windowEl, tabGroupId) {
        // Create tab bar if it doesn't exist
        if (!windowEl.querySelector('.window-tab-bar')) {
            const tabBar = document.createElement('div');
            tabBar.className = 'window-tab-bar';
            
            // Add new tab button
            const newTabBtn = document.createElement('button');
            newTabBtn.className = 'new-tab-btn';
            newTabBtn.innerHTML = '<i class="fas fa-plus"></i>';
            newTabBtn.addEventListener('click', function() {
                addNewTab(windowEl, tabGroupId);
            });
            
            tabBar.appendChild(newTabBtn);
            
            // Insert after header
            const header = windowEl.querySelector('.window-header');
            if (header) {
                header.parentNode.insertBefore(tabBar, header.nextSibling);
            }
        }
        
        // Update tabs
        updateTabBar(windowEl, tabGroupId);
    }

    function updateTabBar(windowEl, tabGroupId) {
        const tabBar = windowEl.querySelector('.window-tab-bar');
        if (!tabBar) return;
        
        // Get tabs
        const tabGroup = state.tabs[tabGroupId];
        if (!tabGroup) return;
        
        // Clear existing tabs (except new tab button)
        const newTabBtn = tabBar.querySelector('.new-tab-btn');
        tabBar.innerHTML = '';
        tabBar.appendChild(newTabBtn);
        
        // Add tab for each item
        tabGroup.tabs.forEach((tab, index) => {
            const tabEl = document.createElement('div');
            tabEl.className = 'window-tab';
            tabEl.classList.toggle('active-tab', index === tabGroup.activeTab);
            tabEl.dataset.tabIndex = index;
            
            tabEl.innerHTML = `
                <span class="tab-title">${tab.title}</span>
                <button class="tab-close"><i class="fas fa-times"></i></button>
            `;
            
            // Add click handler to activate tab
            tabEl.addEventListener('click', function(e) {
                if (!e.target.classList.contains('tab-close') && !e.target.closest('.tab-close')) {
                    activateTab(windowEl, tabGroupId, index);
                }
            });
            
            // Add close handler
            tabEl.querySelector('.tab-close').addEventListener('click', function(e) {
                e.stopPropagation();
                closeTab(windowEl, tabGroupId, index);
            });
            
            // Insert before new tab button
            tabBar.insertBefore(tabEl, newTabBtn);
        });
    }

    function updateTabbedWindowControls(windowEl) {
        // Replace tab button with untab button
        const tabBtn = windowEl.querySelector('.tab-btn');
        if (tabBtn) {
            tabBtn.title = 'Convert to normal window';
            tabBtn.innerHTML = '<i class="fas fa-folder-minus"></i>';
            
            // Replace click handler
            const newTabBtn = tabBtn.cloneNode(true);
            tabBtn.parentNode.replaceChild(newTabBtn, tabBtn);
            
            newTabBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                convertToNormalWindow(windowEl);
            });
        }
    }

    function activateTab(windowEl, tabGroupId, tabIndex) {
        const tabGroup = state.tabs[tabGroupId];
        if (!tabGroup || tabIndex >= tabGroup.tabs.length) return;
        
        // Update active tab
        tabGroup.activeTab = tabIndex;
        
        // Update iframe src
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe) {
            iframe.src = tabGroup.tabs[tabIndex].url;
        }
        
        // Update window title
        const titleEl = windowEl.querySelector('.window-title');
        if (titleEl) {
            titleEl.textContent = tabGroup.tabs[tabIndex].title;
        }
        
        // Update tab bar
        updateTabBar(windowEl, tabGroupId);
    }

    function addNewTab(windowEl, tabGroupId) {
        // Show URL prompt
        const url = prompt('Enter URL for new tab:', 'https://');
        if (!url) return;
        
        const tabGroup = state.tabs[tabGroupId];
        if (!tabGroup) return;
        
        // Add new tab
        const newTab = {
            id: 'tab-' + Date.now(),
            title: 'New Tab',
            url: url
        };
        
        tabGroup.tabs.push(newTab);
        tabGroup.activeTab = tabGroup.tabs.length - 1;
        
        // Update iframe and title
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe) {
            iframe.src = url;
        }
        
        // Update tab bar
        updateTabBar(windowEl, tabGroupId);
        
        addNotification('New Tab', 'Added new tab to window');
    }

    function closeTab(windowEl, tabGroupId, tabIndex) {
        const tabGroup = state.tabs[tabGroupId];
        if (!tabGroup || tabGroup.tabs.length <= 1) return;
        
        // Remove tab
        tabGroup.tabs.splice(tabIndex, 1);
        
        // Update active tab if needed
        if (tabIndex === tabGroup.activeTab) {
            tabGroup.activeTab = Math.max(0, tabIndex - 1);
            
            // Update iframe and title
            const iframe = windowEl.querySelector('.window-iframe');
            if (iframe) {
                iframe.src = tabGroup.tabs[tabGroup.activeTab].url;
            }
            
            const titleEl = windowEl.querySelector('.window-title');
            if (titleEl) {
                titleEl.textContent = tabGroup.tabs[tabGroup.activeTab].title;
            }
        } else if (tabIndex < tabGroup.activeTab) {
            // Adjust active tab index if we removed a tab before it
            tabGroup.activeTab--;
        }
        
        // Update tab bar
        updateTabBar(windowEl, tabGroupId);
    }

    function convertToNormalWindow(windowEl) {
        const tabGroupId = windowEl.dataset.tabGroupId;
        if (!tabGroupId) return;
        
        // Remove tab bar
        const tabBar = windowEl.querySelector('.window-tab-bar');
        if (tabBar) {
            tabBar.remove();
        }
        
        // Update window controls
        const tabBtn = windowEl.querySelector('.tab-btn');
        if (tabBtn) {
            tabBtn.title = 'Convert to tabbed window';
            tabBtn.innerHTML = '<i class="fas fa-folder"></i>';
            
            // Replace click handler
            const newTabBtn = tabBtn.cloneNode(true);
            tabBtn.parentNode.replaceChild(newTabBtn, tabBtn);
            
            newTabBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                convertToTabbedWindow(windowEl);
            });
        }
        
        // Clean up
        windowEl.classList.remove('tabbed-window');
        delete windowEl.dataset.tabGroupId;
        
        addNotification('Window Mode', 'Window converted to normal mode');
    }

    // ================ FEATURE 9: WINDOW HISTORY NAVIGATION ================
    
    function initWindowHistory() {
        // Add navigation controls to windows
        document.querySelectorAll('.window-container').forEach(window => {
            addNavigationControls(window);
        });
    }

    function addNavigationControls(windowEl) {
        if (windowEl.dataset.navigationEnabled) return;
        windowEl.dataset.navigationEnabled = "true";
        
        const contentEl = windowEl.querySelector('.window-content');
        if (!contentEl) return;
        
        // Create navigation bar
        const navBar = document.createElement('div');
        navBar.className = 'window-nav-bar';
        navBar.innerHTML = `
            <button class="nav-back-btn" title="Back"><i class="fas fa-arrow-left"></i></button>
            <button class="nav-forward-btn" title="Forward"><i class="fas fa-arrow-right"></i></button>
            <button class="nav-refresh-btn" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            <div class="nav-address-bar">
                <input type="text" class="nav-url-input" placeholder="URL">
                <button class="nav-go-btn"><i class="fas fa-arrow-right"></i></button>
            </div>
        `;
        
        // Add navigation bar above content
        contentEl.parentNode.insertBefore(navBar, contentEl);
        
        // Initialize history for this window
        const windowId = windowEl.id;
        state.history[windowId] = {
            urls: [],
            currentIndex: -1
        };
        
        // Get initial URL
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe && iframe.src) {
            addToHistory(windowId, iframe.src);
            navBar.querySelector('.nav-url-input').value = iframe.src;
        }
        
        // Add event listeners
        navBar.querySelector('.nav-back-btn').addEventListener('click', function() {
            navigateBack(windowEl);
        });
        
        navBar.querySelector('.nav-forward-btn').addEventListener('click', function() {
            navigateForward(windowEl);
        });
        
        navBar.querySelector('.nav-refresh-btn').addEventListener('click', function() {
            refreshWindow(windowEl);
        });
        
        const urlInput = navBar.querySelector('.nav-url-input');
        const goBtn = navBar.querySelector('.nav-go-btn');
        
        const navigateToUrl = function() {
            let url = urlInput.value.trim();
            
            // Add protocol if missing
            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
                urlInput.value = url;
            }
            
            if (url) {
                navigateTo(windowEl, url);
            }
        };
        
        goBtn.addEventListener('click', navigateToUrl);
        
        urlInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                navigateToUrl();
            }
        });
        
        // Listen for iframe load events to update history
        iframe.addEventListener('load', function() {
            const url = iframe.src;
            if (url) {
                // Only add to history if this is a new navigation (not from history)
                if (!state.history[windowId].isNavigatingHistory) {
                    addToHistory(windowId, url);
                }
                state.history[windowId].isNavigatingHistory = false;
                
                // Update URL input
                urlInput.value = url;
                
                // Update window title if possible
                updateWindowTitle(windowEl, url);
            }
        });
    }

    function addToHistory(windowId, url) {
        const history = state.history[windowId];
        if (!history) return;
        
        // If we're not at the end of the history, remove future entries
        if (history.currentIndex < history.urls.length - 1) {
            history.urls = history.urls.slice(0, history.currentIndex + 1);
        }
        
        // Add new URL to history
        history.urls.push(url);
        history.currentIndex = history.urls.length - 1;
        
        // Update navigation buttons
        updateNavButtons(windowId);
    }

    function navigateBack(windowEl) {
        const windowId = windowEl.id;
        const history = state.history[windowId];
        if (!history || history.currentIndex <= 0) return;
        
        // Move back in history
        history.currentIndex--;
        const url = history.urls[history.currentIndex];
        
        // Flag that we're navigating from history
        history.isNavigatingHistory = true;
        
        // Update iframe
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe) {
            iframe.src = url;
        }
        
        // Update URL input
        const urlInput = windowEl.querySelector('.nav-url-input');
        if (urlInput) {
            urlInput.value = url;
        }
        
        // Update buttons
        updateNavButtons(windowId);
    }

    function navigateForward(windowEl) {
        const windowId = windowEl.id;
        const history = state.history[windowId];
        if (!history || history.currentIndex >= history.urls.length - 1) return;
        
        // Move forward in history
        history.currentIndex++;
        const url = history.urls[history.currentIndex];
        
        // Flag that we're navigating from history
        history.isNavigatingHistory = true;
        
        // Update iframe
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe) {
            iframe.src = url;
        }
        
        // Update URL input
        const urlInput = windowEl.querySelector('.nav-url-input');
        if (urlInput) {
            urlInput.value = url;
        }
        
        // Update buttons
        updateNavButtons(windowId);
    }

    function navigateTo(windowEl, url) {
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe) {
            iframe.src = url;
        }
    }

    function refreshWindow(windowEl) {
        const iframe = windowEl.querySelector('.window-iframe');
        if (iframe) {
            iframe.src = iframe.src;
        }
    }

    function updateNavButtons(windowId) {
        const windowEl = document.getElementById(windowId);
        if (!windowEl) return;
        
        const history = state.history[windowId];
        if (!history) return;
        
        // Update back button
        const backBtn = windowEl.querySelector('.nav-back-btn');
        if (backBtn) {
            backBtn.disabled = history.currentIndex <= 0;
            backBtn.classList.toggle('disabled', history.currentIndex <= 0);
        }
        
        // Update forward button
        const forwardBtn = windowEl.querySelector('.nav-forward-btn');
        if (forwardBtn) {
            forwardBtn.disabled = history.currentIndex >= history.urls.length - 1;
            forwardBtn.classList.toggle('disabled', history.currentIndex >= history.urls.length - 1);
        }
    }

    function updateWindowTitle(windowEl, url) {
        // Try to get title from iframe
        const iframe = windowEl.querySelector('.window-iframe');
        if (!iframe) return;
        
        try {
            // Wait for iframe to load
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const title = iframeDoc.title;
                    
                    if (title) {
                        const titleEl = windowEl.querySelector('.window-title');
                        if (titleEl) {
                            titleEl.textContent = title;
                        }
                        
                        // Update tab title if in a tabbed window
                        const tabGroupId = windowEl.dataset.tabGroupId;
                        if (tabGroupId) {
                            const tabGroup = state.tabs[tabGroupId];
                            if (tabGroup && tabGroup.activeTab >= 0) {
                                tabGroup.tabs[tabGroup.activeTab].title = title;
                                updateTabBar(windowEl, tabGroupId);
                            }
                        }
                    }
                } catch (e) {
                    // Cross-origin error, use URL as title
                    const titleEl = windowEl.querySelector('.window-title');
                    if (titleEl) {
                        try {
                            const urlObj = new URL(url);
                            titleEl.textContent = urlObj.hostname;
                        } catch (e) {
                            titleEl.textContent = url;
                        }
                    }
                }
            }, 1000);
        } catch (e) {
            console.error('Error updating window title:', e);
        }
    }

    // ================ FEATURE 10: FILE DRAG AND DROP SUPPORT ================
    
    function initFileDragDrop() {
        // Add drag and drop zone to body
        const dropZone = document.createElement('div');
        dropZone.className = 'file-drop-zone';
        dropZone.innerHTML = `
            <div class="file-drop-message">
                <i class="fas fa-file-upload"></i>
                <h3>Drop file to open</h3>
            </div>
        `;
        document.body.appendChild(dropZone);
        
        // Listen for drag events on document
        document.addEventListener('dragover', handleDocumentDragOver);
        document.addEventListener('dragleave', handleDocumentDragLeave);
        document.addEventListener('drop', handleDocumentDrop);
        
        // Add file open button to taskbar
        const taskbarLeft = document.getElementById('taskbar-left');
        if (taskbarLeft) {
            const fileBtn = document.createElement('button');
            fileBtn.className = 'toggle-button file-open-btn';
            fileBtn.innerHTML = '<i class="fas fa-folder-open"></i>';
            fileBtn.title = 'Open file';
            
            fileBtn.addEventListener('click', showFileOpenDialog);
            
            taskbarLeft.appendChild(fileBtn);
        }
    }

    function handleDocumentDragOver(e) {
        e.preventDefault();
        document.querySelector('.file-drop-zone').classList.add('active');
    }

    function handleDocumentDragLeave(e) {
        // Only hide if dragging outside document
        if (!e.relatedTarget || e.relatedTarget.tagName === 'HTML') {
            document.querySelector('.file-drop-zone').classList.remove('active');
        }
    }

    function handleDocumentDrop(e) {
        e.preventDefault();
        document.querySelector('.file-drop-zone').classList.remove('active');
        
        // Process dropped files
        if (e.dataTransfer.files.length > 0) {
            handleDroppedFiles(e.dataTransfer.files);
        }
    }

    function handleDroppedFiles(files) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            openFile(file);
        }
    }

    function showFileOpenDialog() {
        // Create hidden file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleDroppedFiles(this.files);
            }
            document.body.removeChild(this);
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
    }

    function openFile(file) {
        state.draggedFile = file;
        
        // Determine file type
        const fileType = file.type;
        
        // Create appropriate window based on file type
        if (fileType.startsWith('image/')) {
            openImageFile(file);
        } else if (fileType === 'application/pdf') {
            openPdfFile(file);
        } else if (fileType.startsWith('text/') || fileType === 'application/json') {
            openTextFile(file);
        } else if (fileType.startsWith('video/')) {
            openVideoFile(file);
        } else if (fileType.startsWith('audio/')) {
            openAudioFile(file);
        } else {
            // Generic file viewer
            showGenericFileInfo(file);
        }
    }

    function openImageFile(file) {
        // Create a URL for the file
        const fileUrl = URL.createObjectURL(file);
        
        // Create viewer window
        const win = createWindow('about:blank', file.name);
        win.dataset.category = 'Media';
        
        // Replace iframe content with image viewer
        const content = win.querySelector('.window-content');
        content.innerHTML = `
            <div class="image-viewer">
                <img src="${fileUrl}" alt="${file.name}">
                <div class="image-controls">
                    <button class="image-zoom-in"><i class="fas fa-search-plus"></i></button>
                    <button class="image-zoom-out"><i class="fas fa-search-minus"></i></button>
                    <button class="image-reset"><i class="fas fa-expand"></i></button>
                    <button class="image-save"><i class="fas fa-download"></i></button>
                </div>
            </div>
        `;
        
        // Add event listeners for controls
        const img = content.querySelector('img');
        let currentZoom = 1;
        
        content.querySelector('.image-zoom-in').addEventListener('click', function() {
            currentZoom *= 1.2;
            img.style.transform = `scale(${currentZoom})`;
        });
        
        content.querySelector('.image-zoom-out').addEventListener('click', function() {
            currentZoom /= 1.2;
            img.style.transform = `scale(${currentZoom})`;
        });
        
        content.querySelector('.image-reset').addEventListener('click', function() {
            currentZoom = 1;
            img.style.transform = `scale(${currentZoom})`;
        });
        
        content.querySelector('.image-save').addEventListener('click', function() {
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = file.name;
            a.click();
        });
        
        addNotification('File Opened', `Opened image: ${file.name}`);
    }

    function openPdfFile(file) {
        // Create a URL for the file
        const fileUrl = URL.createObjectURL(file);
        
        // Create viewer window
        const win = createWindow(fileUrl, file.name);
        win.dataset.category = 'Documents';
        
        addNotification('File Opened', `Opened PDF: ${file.name}`);
    }

    function openTextFile(file) {
        // Create viewer window
        const win = createWindow('about:blank', file.name);
        win.dataset.category = 'Documents';
        
        // Read the file
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = win.querySelector('.window-content');
            content.innerHTML = `
                <div class="text-editor">
                    <div class="editor-toolbar">
                        <button class="editor-save"><i class="fas fa-save"></i> Save</button>
                        <span class="file-info">${file.name} - ${Math.round(file.size / 1024)} KB</span>
                    </div>
                    <textarea class="editor-textarea" spellcheck="false">${e.target.result}</textarea>
                </div>
            `;
            
            // Add save button event
            content.querySelector('.editor-save').addEventListener('click', function() {
                const text = content.querySelector('.editor-textarea').value;
                const blob = new Blob([text], { type: file.type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                a.click();
                URL.revokeObjectURL(url);
            });
        };
        
        reader.readAsText(file);
        
        addNotification('File Opened', `Opened text file: ${file.name}`);
    }

    function openVideoFile(file) {
        // Create a URL for the file
        const fileUrl = URL.createObjectURL(file);
        
        // Create viewer window
        const win = createWindow('about:blank', file.name);
        win.dataset.category = 'Media';
        
        // Replace iframe content with video player
        const content = win.querySelector('.window-content');
        content.innerHTML = `
            <div class="video-player">
                <video controls autoplay>
                    <source src="${fileUrl}" type="${file.type}">
                    Your browser does not support the video tag.
                </video>
                <div class="video-info">
                    <span class="video-filename">${file.name}</span>
                    <span class="video-filesize">${Math.round(file.size / 1024 / 1024 * 10) / 10} MB</span>
                </div>
            </div>
        `;
        
        addNotification('File Opened', `Opened video: ${file.name}`);
    }

    function openAudioFile(file) {
        // Create a URL for the file
        const fileUrl = URL.createObjectURL(file);
        
        // Create viewer window
        const win = createWindow('about:blank', file.name);
        win.dataset.category = 'Media';
        
        // Replace iframe content with audio player
        const content = win.querySelector('.window-content');
        content.innerHTML = `
            <div class="audio-player">
                <div class="audio-waveform" id="waveform-${win.id}"></div>
                <div class="audio-controls">
                    <button class="audio-play"><i class="fas fa-play"></i></button>
                    <button class="audio-pause"><i class="fas fa-pause"></i></button>
                    <button class="audio-stop"><i class="fas fa-stop"></i></button>
                    <div class="audio-progress">
                        <div class="audio-progress-bar"></div>
                    </div>
                    <div class="audio-time">00:00 / 00:00</div>
                </div>
                <div class="audio-info">
                    <span class="audio-filename">${file.name}</span>
                    <span class="audio-filesize">${Math.round(file.size / 1024 / 1024 * 10) / 10} MB</span>
                </div>
            </div>
        `;
        
        // Create audio element
        const audio = new Audio(fileUrl);
        
        // Add event listeners for controls
        const playBtn = content.querySelector('.audio-play');
        const pauseBtn = content.querySelector('.audio-pause');
        const stopBtn = content.querySelector('.audio-stop');
        const progressBar = content.querySelector('.audio-progress-bar');
        const timeDisplay = content.querySelector('.audio-time');
        
        playBtn.addEventListener('click', function() {
            audio.play();
        });
        
        pauseBtn.addEventListener('click', function() {
            audio.pause();
        });
        
        stopBtn.addEventListener('click', function() {
            audio.pause();
            audio.currentTime = 0;
        });
        
        audio.addEventListener('timeupdate', function() {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = progress + '%';
            
            // Update time display
            const currentMin = Math.floor(audio.currentTime / 60);
            const currentSec = Math.floor(audio.currentTime % 60);
            const totalMin = Math.floor(audio.duration / 60) || 0;
            const totalSec = Math.floor(audio.duration % 60) || 0;
            
            timeDisplay.textContent = `${String(currentMin).padStart(2, '0')}:${String(currentSec).padStart(2, '0')} / ${String(totalMin).padStart(2, '0')}:${String(totalSec).padStart(2, '0')}`;
        });
        
        addNotification('File Opened', `Opened audio: ${file.name}`);
    }

    function showGenericFileInfo(file) {
        // Create info window
        const win = createWindow('about:blank', file.name);
        win.dataset.category = 'Documents';
        
        // Replace iframe content with file info
        const content = win.querySelector('.window-content');
        content.innerHTML = `
            <div class="file-info-viewer">
                <div class="file-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div class="file-details">
                    <h2>${file.name}</h2>
                    <table>
                        <tr><td>Type:</td><td>${file.type || 'Unknown'}</td></tr>
                        <tr><td>Size:</td><td>${formatFileSize(file.size)}</td></tr>
                        <tr><td>Last Modified:</td><td>${new Date(file.lastModified).toLocaleString()}</td></tr>
                    </table>
                    <div class="file-actions">
                        <button class="file-save-btn"><i class="fas fa-download"></i> Save</button>
                    </div>
                </div>
            </div>
        `;
        
        // Add save button event
        content.querySelector('.file-save-btn').addEventListener('click', function() {
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        addNotification('File Info', `Opened file info: ${file.name}`);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return Math.round(bytes / 1024 / 1024 * 10) / 10 + ' MB';
        return Math.round(bytes / 1024 / 1024 / 1024 * 100) / 100 + ' GB';
    }

    // ================ FEATURE 11: DESKTOP WIDGETS ================
    
    function initDesktopWidgets() {
        if (!settings.enableWidgets) return;
        
        // Create widget button in taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const widgetBtn = document.createElement('button');
            widgetBtn.className = 'toggle-button widget-toggle';
            widgetBtn.innerHTML = '<i class="fas fa-th-large"></i>';
            widgetBtn.title = 'Widgets';
            
            widgetBtn.addEventListener('click', showWidgetSelector);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(widgetBtn, clock);
            } else {
                taskbarRight.appendChild(widgetBtn);
            }
        }
        
        // Restore any saved widgets
        restoreWidgets();
    }

    function showWidgetSelector() {
        // Create widget selector
        const selector = document.createElement('div');
        selector.className = 'widget-selector';
        selector.innerHTML = `
            <div class="widget-selector-header">
                <h3>Add Widget</h3>
                <button class="widget-selector-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="widget-grid">
                <div class="widget-item" data-widget="clock">
                    <i class="fas fa-clock"></i>
                    <span>Clock</span>
                </div>
                <div class="widget-item" data-widget="weather">
                    <i class="fas fa-cloud-sun"></i>
                    <span>Weather</span>
                </div>
                <div class="widget-item" data-widget="notes">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </div>
                <div class="widget-item" data-widget="calculator">
                    <i class="fas fa-calculator"></i>
                    <span>Calculator</span>
                </div>
                <div class="widget-item" data-widget="calendar">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </div>
                <div class="widget-item" data-widget="system">
                    <i class="fas fa-microchip"></i>
                    <span>System Info</span>
                </div>
            </div>
        `;
        
        document.body.appendChild(selector);
        
        // Add close handler
        selector.querySelector('.widget-selector-close').addEventListener('click', function() {
            selector.remove();
        });
        
        // Add click handlers to widget items
        selector.querySelectorAll('.widget-item').forEach(item => {
            item.addEventListener('click', function() {
                const widgetType = this.dataset.widget;
                addWidget(widgetType);
                selector.remove();
            });
        });
    }

    // Continuation of the cr8OS features

    // ================ FEATURE 11: DESKTOP WIDGETS (continued) ================
    
    function addWidget(type) {
        const widgetId = `widget-${type}-${Date.now()}`;
        
        // Create widget element
        const widget = document.createElement('div');
        widget.className = 'desktop-widget';
        widget.id = widgetId;
        widget.dataset.widgetType = type;
        
        // Set initial position
        widget.style.left = (50 + Math.random() * 100) + 'px';
        widget.style.top = (50 + Math.random() * 100) + 'px';
        
        // Add controls
        widget.innerHTML = `
            <div class="widget-header">
                <div class="widget-title">${getWidgetTitle(type)}</div>
                <div class="widget-controls">
                    <button class="widget-close"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="widget-content"></div>
        `;
        
        document.body.appendChild(widget);
        
        // Add widget to state
        state.widgets.push({
            id: widgetId,
            type: type,
            position: {
                left: widget.style.left,
                top: widget.style.top
            },
            data: {} // Widget-specific data
        });
        
        // Make widget draggable
        makeWidgetDraggable(widget);
        
        // Add close handler
        widget.querySelector('.widget-close').addEventListener('click', function() {
            removeWidget(widgetId);
        });
        
        // Initialize widget content
        initializeWidgetContent(widget, type);
        
        addNotification('Widget Added', `Added ${getWidgetTitle(type)} widget to desktop`);
    }
    
    function getWidgetTitle(type) {
        const titles = {
            'clock': 'Clock',
            'weather': 'Weather',
            'notes': 'Notes',
            'calculator': 'Calculator',
            'calendar': 'Calendar',
            'system': 'System Info'
        };
        
        return titles[type] || 'Widget';
    }
    
    function makeWidgetDraggable(widget) {
        const header = widget.querySelector('.widget-header');
        if (!header) return;
        
        let isDragging = false;
        let offsetX, offsetY;
        
        // Mouse events
        header.addEventListener('mousedown', function(e) {
            isDragging = true;
            offsetX = e.clientX - widget.getBoundingClientRect().left;
            offsetY = e.clientY - widget.getBoundingClientRect().top;
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;
            
            // Prevent from going out of bounds
            const maxX = window.innerWidth - widget.offsetWidth;
            const maxY = window.innerHeight - widget.offsetHeight - document.getElementById('taskbar').offsetHeight;
            
            widget.style.left = Math.min(Math.max(0, x), maxX) + 'px';
            widget.style.top = Math.min(Math.max(0, y), maxY) + 'px';
            
            // Update position in state
            const widgetData = state.widgets.find(w => w.id === widget.id);
            if (widgetData) {
                widgetData.position = {
                    left: widget.style.left,
                    top: widget.style.top
                };
            }
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
        
        // Touch events
        header.addEventListener('touchstart', function(e) {
            isDragging = true;
            const touch = e.touches[0];
            offsetX = touch.clientX - widget.getBoundingClientRect().left;
            offsetY = touch.clientY - widget.getBoundingClientRect().top;
        });
        
        document.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            const touch = e.touches[0];
            const x = touch.clientX - offsetX;
            const y = touch.clientY - offsetY;
            
            // Prevent from going out of bounds
            const maxX = window.innerWidth - widget.offsetWidth;
            const maxY = window.innerHeight - widget.offsetHeight - document.getElementById('taskbar').offsetHeight;
            
            widget.style.left = Math.min(Math.max(0, x), maxX) + 'px';
            widget.style.top = Math.min(Math.max(0, y), maxY) + 'px';
            
            // Update position in state
            const widgetData = state.widgets.find(w => w.id === widget.id);
            if (widgetData) {
                widgetData.position = {
                    left: widget.style.left,
                    top: widget.style.top
                };
            }
        });
        
        document.addEventListener('touchend', function() {
            isDragging = false;
        });
    }
    
    function removeWidget(widgetId) {
        const widget = document.getElementById(widgetId);
        if (widget) {
            widget.remove();
            
            // Remove from state
            state.widgets = state.widgets.filter(w => w.id !== widgetId);
            
            saveWidgets();
        }
    }
    
    function initializeWidgetContent(widget, type) {
        const content = widget.querySelector('.widget-content');
        if (!content) return;
        
        switch (type) {
            case 'clock':
                initClockWidget(widget, content);
                break;
            case 'weather':
                initWeatherWidget(widget, content);
                break;
            case 'notes':
                initNotesWidget(widget, content);
                break;
            case 'calculator':
                initCalculatorWidget(widget, content);
                break;
            case 'calendar':
                initCalendarWidget(widget, content);
                break;
            case 'system':
                initSystemWidget(widget, content);
                break;
        }
    }
    
    function initClockWidget(widget, content) {
        content.innerHTML = `
            <div class="clock-widget">
                <div class="clock-time">00:00:00</div>
                <div class="clock-date">January 1, 2023</div>
                <div class="clock-format">
                    <label>
                        <input type="radio" name="clock-format-${widget.id}" value="12" checked> 12h
                    </label>
                    <label>
                        <input type="radio" name="clock-format-${widget.id}" value="24"> 24h
                    </label>
                </div>
            </div>
        `;
        
        // Find the widget data
        const widgetData = state.widgets.find(w => w.id === widget.id);
        if (widgetData) {
            widgetData.data = widgetData.data || {};
            widgetData.data.format = widgetData.data.format || '12';
            
            // Set the initial format radio button
            const formatBtn = content.querySelector(`input[value="${widgetData.data.format}"]`);
            if (formatBtn) formatBtn.checked = true;
        }
        
        // Update time function
        const updateClock = function() {
            const now = new Date();
            const timeEl = content.querySelector('.clock-time');
            const dateEl = content.querySelector('.clock-date');
            
            if (timeEl && dateEl) {
                // Get selected format
                const format = content.querySelector('input[name="clock-format-' + widget.id + '"]:checked').value;
                
                // Update widget data
                if (widgetData) {
                    widgetData.data.format = format;
                }
                
                // Format time based on selection
                let hours = now.getHours();
                let ampm = '';
                
                if (format === '12') {
                    ampm = hours >= 12 ? ' PM' : ' AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // Convert 0 to 12
                }
                
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                
                timeEl.textContent = hours + ':' + minutes + ':' + seconds + ampm;
                
                // Format date
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateEl.textContent = now.toLocaleDateString(undefined, options);
            }
        };
        
        updateClock();
        
        // Update every second
        const intervalId = setInterval(updateClock, 1000);
        
        // Store interval ID for cleanup
        widget.dataset.intervalId = intervalId;
        
        // Format change event
        content.querySelectorAll('input[name="clock-format-' + widget.id + '"]').forEach(input => {
            input.addEventListener('change', function() {
                updateClock();
                saveWidgets();
            });
        });
    }
    
    function initWeatherWidget(widget, content) {
        content.innerHTML = `
            <div class="weather-widget">
                <div class="weather-search">
                    <input type="text" class="weather-location-input" placeholder="Enter city name">
                    <button class="weather-search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div class="weather-loading">Loading weather data...</div>
                <div class="weather-content" style="display: none;">
                    <div class="weather-header">
                        <div class="weather-location">City</div>
                        <div class="weather-date">Date</div>
                    </div>
                    <div class="weather-body">
                        <div class="weather-icon">
                            <i class="fas fa-cloud"></i>
                        </div>
                        <div class="weather-temp">--</div>
                        <div class="weather-desc">Weather description</div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span class="weather-humidity">--%</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span class="weather-wind">-- km/h</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weather-error" style="display: none;">
                    Could not fetch weather data. Please check the city name.
                </div>
            </div>
        `;
        
        // Find the widget data
        const widgetData = state.widgets.find(w => w.id === widget.id);
        if (widgetData) {
            widgetData.data = widgetData.data || {};
            
            // If we have a saved location, use it
            if (widgetData.data.location) {
                const input = content.querySelector('.weather-location-input');
                if (input) {
                    input.value = widgetData.data.location;
                    fetchWeatherData(widget, widgetData.data.location);
                }
            }
        }
        
        // Add search button event
        const searchBtn = content.querySelector('.weather-search-btn');
        const input = content.querySelector('.weather-location-input');
        
        const performSearch = function() {
            const location = input.value.trim();
            if (location) {
                // Save location to widget data
                if (widgetData) {
                    widgetData.data.location = location;
                    saveWidgets();
                }
                
                fetchWeatherData(widget, location);
            }
        };
        
        if (searchBtn && input) {
            searchBtn.addEventListener('click', performSearch);
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
    }
    
    function fetchWeatherData(widget, location) {
        const content = widget.querySelector('.widget-content');
        if (!content) return;
        
        // Show loading
        content.querySelector('.weather-loading').style.display = 'block';
        content.querySelector('.weather-content').style.display = 'none';
        content.querySelector('.weather-error').style.display = 'none';
        
        // For demo purposes, generate random weather data
        // In a real implementation, this would call a weather API
        setTimeout(() => {
            try {
                const temp = Math.round(Math.random() * 30 + 5);
                const humidity = Math.round(Math.random() * 50 + 30);
                const wind = Math.round(Math.random() * 20 + 5);
                
                const weatherTypes = [
                    { desc: 'Clear sky', icon: 'sun' },
                    { desc: 'Few clouds', icon: 'cloud-sun' },
                    { desc: 'Scattered clouds', icon: 'cloud' },
                    { desc: 'Broken clouds', icon: 'cloud' },
                    { desc: 'Shower rain', icon: 'cloud-showers-heavy' },
                    { desc: 'Rain', icon: 'cloud-rain' },
                    { desc: 'Thunderstorm', icon: 'bolt' },
                    { desc: 'Snow', icon: 'snowflake' },
                    { desc: 'Mist', icon: 'smog' }
                ];
                
                const weather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
                
                // Update UI with weather data
                content.querySelector('.weather-location').textContent = location;
                content.querySelector('.weather-date').textContent = new Date().toLocaleDateString();
                content.querySelector('.weather-icon i').className = 'fas fa-' + weather.icon;
                content.querySelector('.weather-temp').textContent = temp + 'C';
                content.querySelector('.weather-desc').textContent = weather.desc;
                content.querySelector('.weather-humidity').textContent = humidity + '%';
                content.querySelector('.weather-wind').textContent = wind + ' km/h';
                
                // Show weather content
                content.querySelector('.weather-loading').style.display = 'none';
                content.querySelector('.weather-content').style.display = 'block';
                content.querySelector('.weather-error').style.display = 'none';
                
                addNotification('Weather Updated', `Weather data for ${location} has been updated`);
                
            } catch (error) {
                console.error('Error updating weather:', error);
                
                // Show error
                content.querySelector('.weather-loading').style.display = 'none';
                content.querySelector('.weather-content').style.display = 'none';
                content.querySelector('.weather-error').style.display = 'block';
            }
        }, 1000);
    }
    
    function initNotesWidget(widget, content) {
        content.innerHTML = `
            <div class="notes-widget">
                <textarea class="notes-content" placeholder="Enter your notes here..."></textarea>
                <div class="notes-footer">
                    <button class="notes-save"><i class="fas fa-save"></i> Save</button>
                    <button class="notes-clear"><i class="fas fa-trash"></i> Clear</button>
                </div>
            </div>
        `;
        
        // Find the widget data
        const widgetData = state.widgets.find(w => w.id === widget.id);
        if (widgetData) {
            widgetData.data = widgetData.data || {};
            
            // If we have saved notes, load them
            if (widgetData.data.notes) {
                const textarea = content.querySelector('.notes-content');
                if (textarea) {
                    textarea.value = widgetData.data.notes;
                }
            }
        }
        
        // Add event listeners
        const textarea = content.querySelector('.notes-content');
        const saveBtn = content.querySelector('.notes-save');
        const clearBtn = content.querySelector('.notes-clear');
        
        if (textarea && saveBtn && clearBtn) {
            saveBtn.addEventListener('click', function() {
                // Save notes to widget data
                if (widgetData) {
                    widgetData.data.notes = textarea.value;
                    saveWidgets();
                    addNotification('Notes Saved', 'Your notes have been saved');
                }
            });
            
            clearBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all notes?')) {
                    textarea.value = '';
                    if (widgetData) {
                        widgetData.data.notes = '';
                        saveWidgets();
                    }
                    addNotification('Notes Cleared', 'Your notes have been cleared');
                }
            });
        }
    }
    
    function initCalculatorWidget(widget, content) {
        content.innerHTML = `
            <div class="calculator-widget">
                <input type="text" class="calculator-display" readonly>
                <div class="calculator-buttons">
                    <button class="calc-btn calc-clear">C</button>
                    <button class="calc-btn calc-bracket">(</button>
                    <button class="calc-btn calc-bracket">)</button>
                    <button class="calc-btn calc-operator">/</button>
                    <button class="calc-btn calc-number">7</button>
                    <button class="calc-btn calc-number">8</button>
                    <button class="calc-btn calc-number">9</button>
                    <button class="calc-btn calc-operator">*</button>
                    <button class="calc-btn calc-number">4</button>
                    <button class="calc-btn calc-number">5</button>
                    <button class="calc-btn calc-number">6</button>
                    <button class="calc-btn calc-operator">-</button>
                    <button class="calc-btn calc-number">1</button>
                    <button class="calc-btn calc-number">2</button>
                    <button class="calc-btn calc-number">3</button>
                    <button class="calc-btn calc-operator">+</button>
                    <button class="calc-btn calc-number">0</button>
                    <button class="calc-btn calc-decimal">.</button>
                    <button class="calc-btn calc-backspace"><i class="fas fa-backspace"></i></button>
                    <button class="calc-btn calc-equals">=</button>
                </div>
            </div>
        `;
        
        const display = content.querySelector('.calculator-display');
        
        // Add event listeners to buttons
        content.querySelectorAll('.calc-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (this.classList.contains('calc-number') || 
                    this.classList.contains('calc-operator') || 
                    this.classList.contains('calc-decimal') || 
                    this.classList.contains('calc-bracket')) {
                    display.value += this.textContent;
                } else if (this.classList.contains('calc-equals')) {
                    try {
                        // Using Function for safe evaluation (avoiding eval)
                        const result = Function('"use strict"; return (' + display.value + ')')();
                        display.value = result;
                    } catch (e) {
                        display.value = 'Error';
                    }
                } else if (this.classList.contains('calc-clear')) {
                    display.value = '';
                } else if (this.classList.contains('calc-backspace')) {
                    display.value = display.value.slice(0, -1);
                }
            });
        });
    }
    
    function initCalendarWidget(widget, content) {
        // Get current date
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        content.innerHTML = `
            <div class="calendar-widget">
                <div class="calendar-header">
                    <button class="calendar-prev-month"><i class="fas fa-chevron-left"></i></button>
                    <div class="calendar-month-year">
                        <span class="calendar-month">${getMonthName(currentMonth)}</span>
                        <span class="calendar-year">${currentYear}</span>
                    </div>
                    <button class="calendar-next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-days-header">
                    <div class="calendar-day-header">Su</div>
                    <div class="calendar-day-header">Mo</div>
                    <div class="calendar-day-header">Tu</div>
                    <div class="calendar-day-header">We</div>
                    <div class="calendar-day-header">Th</div>
                    <div class="calendar-day-header">Fr</div>
                    <div class="calendar-day-header">Sa</div>
                </div>
                <div class="calendar-days"></div>
            </div>
        `;
        
        // Find the widget data and initialize if needed
        const widgetData = state.widgets.find(w => w.id === widget.id);
        if (widgetData) {
            widgetData.data = widgetData.data || {};
            widgetData.data.month = currentMonth;
            widgetData.data.year = currentYear;
        }
        
        // Generate calendar
        generateCalendarDays(widget, currentMonth, currentYear);
        
        // Add event listeners
        const prevMonthBtn = content.querySelector('.calendar-prev-month');
        const nextMonthBtn = content.querySelector('.calendar-next-month');
        
        if (prevMonthBtn && nextMonthBtn) {
            prevMonthBtn.addEventListener('click', function() {
                navigateCalendarMonth(widget, -1);
            });
            
            nextMonthBtn.addEventListener('click', function() {
                navigateCalendarMonth(widget, 1);
            });
        }
    }
    
    function getMonthName(month) {
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June', 
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        return months[month];
    }
    
    function generateCalendarDays(widget, month, year) {
        const content = widget.querySelector('.widget-content');
        if (!content) return;
        
        const daysContainer = content.querySelector('.calendar-days');
        if (!daysContainer) return;
        
        // Update month/year display
        content.querySelector('.calendar-month').textContent = getMonthName(month);
        content.querySelector('.calendar-year').textContent = year;
        
        // Clear previous days
        daysContainer.innerHTML = '';
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Create empty cells for days before the 1st
        for (let i = 0; i < firstDay; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day empty';
            daysContainer.appendChild(dayCell);
        }
        
        // Get current date for highlighting
        const now = new Date();
        const currentDate = now.getDate();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        // Create cells for days in month
        for (let i = 1; i <= daysInMonth; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = i;
            
            // Highlight current day
            if (i === currentDate && month === currentMonth && year === currentYear) {
                dayCell.classList.add('current-day');
            }
            
            daysContainer.appendChild(dayCell);
        }
    }
    
    function navigateCalendarMonth(widget, delta) {
        const widgetData = state.widgets.find(w => w.id === widget.id);
        if (!widgetData) return;
        
        // Calculate new month and year
        let newMonth = widgetData.data.month + delta;
        let newYear = widgetData.data.year;
        
        if (newMonth < 0) {
            newMonth = 11;
            newYear--;
        } else if (newMonth > 11) {
            newMonth = 0;
            newYear++;
        }
        
        // Update widget data
        widgetData.data.month = newMonth;
        widgetData.data.year = newYear;
        
        // Regenerate calendar
        generateCalendarDays(widget, newMonth, newYear);
        
        saveWidgets();
    }
    
    function initSystemWidget(widget, content) {
        content.innerHTML = `
            <div class="system-widget">
                <div class="system-header">System Information</div>
                <div class="system-info">
                    <div class="system-info-row">
                        <div class="system-info-label">OS:</div>
                        <div class="system-info-value" id="${widget.id}-os">cr8OS</div>
                    </div>
                    <div class="system-info-row">
                        <div class="system-info-label">Browser:</div>
                        <div class="system-info-value" id="${widget.id}-browser"></div>
                    </div>
                    <div class="system-info-row">
                        <div class="system-info-label">Resolution:</div>
                        <div class="system-info-value" id="${widget.id}-resolution"></div>
                    </div>
                    <div class="system-info-row">
                        <div class="system-info-label">Time:</div>
                        <div class="system-info-value" id="${widget.id}-time"></div>
                    </div>
                    <div class="system-info-row">
                        <div class="system-info-label">Active Windows:</div>
                        <div class="system-info-value" id="${widget.id}-windows"></div>
                    </div>
                    <div class="system-info-row">
                        <div class="system-info-label">Memory Usage:</div>
                        <div class="system-info-value">
                            <div class="memory-bar">
                                <div class="memory-bar-fill" id="${widget.id}-memory"></div>
                            </div>
                            <div id="${widget.id}-memory-text"></div>
                        </div>
                    </div>
                </div>
                <div class="system-footer">
                    <button class="system-refresh"><i class="fas fa-sync"></i> Refresh</button>
                </div>
            </div>
        `;
        
        // Update system info
        updateSystemInfo(widget);
        
        // Set interval to update regularly
        const intervalId = setInterval(() => updateSystemInfo(widget), 1000);
        
        // Store interval ID for cleanup
        widget.dataset.intervalId = intervalId;
        
        // Add refresh button event
        const refreshBtn = content.querySelector('.system-refresh');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                updateSystemInfo(widget);
                addNotification('System Info', 'System information refreshed');
            });
        }
    }
    
    function updateSystemInfo(widget) {
        // Get browser info
        const userAgent = navigator.userAgent;
        let browserName = 'Unknown';
        
        if (userAgent.indexOf('Chrome') > -1) browserName = 'Chrome';
        else if (userAgent.indexOf('Firefox') > -1) browserName = 'Firefox';
        else if (userAgent.indexOf('Safari') > -1) browserName = 'Safari';
        else if (userAgent.indexOf('Edge') > -1) browserName = 'Edge';
        else if (userAgent.indexOf('MSIE') > -1 || userAgent.indexOf('Trident') > -1) browserName = 'Internet Explorer';
        
        // Update info
        document.getElementById(`${widget.id}-browser`).textContent = browserName;
        document.getElementById(`${widget.id}-resolution`).textContent = `${window.innerWidth}x${window.innerHeight}`;
        document.getElementById(`${widget.id}-time`).textContent = new Date().toLocaleTimeString();
        
        // Count non-minimized windows
        const windowCount = document.querySelectorAll('.window-container:not(.minimized)').length;
        document.getElementById(`${widget.id}-windows`).textContent = windowCount;
        
        // Simulate memory usage (random for demo)
        const memoryUsage = Math.floor(Math.random() * 40) + 30; // 30-70%
        document.getElementById(`${widget.id}-memory`).style.width = `${memoryUsage}%`;
        document.getElementById(`${widget.id}-memory-text`).textContent = `${memoryUsage}%`;
    }
    
    function saveWidgets() {
        // Save widgets state if session persistence is enabled
        if (settings.saveState) {
            localStorage.setItem('cr8OS-widgets', JSON.stringify(state.widgets));
        }
    }
    
    function restoreWidgets() {
        // Load saved widgets if available
        const savedWidgets = localStorage.getItem('cr8OS-widgets');
        if (savedWidgets) {
            try {
                const widgetsData = JSON.parse(savedWidgets);
                
                // Recreate each widget
                widgetsData.forEach(widgetData => {
                    const type = widgetData.type;
                    const widgetId = widgetData.id;
                    
                    // Create widget element
                    const widget = document.createElement('div');
                    widget.className = 'desktop-widget';
                    widget.id = widgetId;
                    widget.dataset.widgetType = type;
                    
                    // Set position
                    widget.style.left = widgetData.position.left;
                    widget.style.top = widgetData.position.top;
                    
                    // Add controls
                    widget.innerHTML = `
                        <div class="widget-header">
                            <div class="widget-title">${getWidgetTitle(type)}</div>
                            <div class="widget-controls">
                                <button class="widget-close"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="widget-content"></div>
                    `;
                    
                    document.body.appendChild(widget);
                    
                    // Make widget draggable
                    makeWidgetDraggable(widget);
                    
                    // Add close handler
                    widget.querySelector('.widget-close').addEventListener('click', function() {
                        removeWidget(widgetId);
                    });
                    
                    // Initialize widget content
                    initializeWidgetContent(widget, type);
                });
                
                // Store widgets data in state
                state.widgets = widgetsData;
                
                addNotification('Widgets Restored', 'Saved widgets have been restored');
                
            } catch (error) {
                console.error('Error restoring widgets:', error);
            }
        }
    }

    // ================ FEATURE 12: CONTEXT MENUS ================
    
    function initContextMenus() {
        if (!settings.enableContextMenus) return;
        
        // Add context menu handler to desktop
        document.addEventListener('contextmenu', handleContextMenu);
        
        // Add click handler to close context menu
        document.addEventListener('click', closeContextMenu);
    }
    
    function handleContextMenu(e) {
        if (!settings.enableContextMenus) return;
        
        // Prevent default browser context menu
        e.preventDefault();
        
        // Close any existing context menu
        closeContextMenu();
        
        // Determine which context menu to show based on target
        let menuItems = [];
        let menuTitle = 'Menu';
        
        if (e.target.closest('.window-container')) {
            // Window context menu
            const windowEl = e.target.closest('.window-container');
            menuItems = getWindowContextMenuItems(windowEl);
            menuTitle = 'Window Options';
        } else if (e.target.closest('.desktop-widget')) {
            // Widget context menu
            const widget = e.target.closest('.desktop-widget');
            menuItems = getWidgetContextMenuItems(widget);
            menuTitle = 'Widget Options';
        } else {
            // Desktop context menu
            menuItems = getDesktopContextMenuItems();
            menuTitle = 'Desktop Options';
        }
        
        // Create and show context menu
        showContextMenu(e.clientX, e.clientY, menuItems, menuTitle);
        
        state.contextMenuOpen = true;
    }
    
    function getWindowContextMenuItems(windowEl) {
        const items = [
            {
                label: 'Reload Content',
                icon: 'sync',
                action: () => refreshWindow(windowEl)
            },
            {
                label: 'Duplicate Window',
                icon: 'copy',
                action: () => {
                    const url = windowEl.querySelector('.window-iframe')?.src;
                    const title = windowEl.querySelector('.window-title')?.textContent;
                    if (url) createWindow(url, title);
                }
            },
            {
                label: windowEl.classList.contains('maximized') ? 'Restore' : 'Maximize',
                icon: windowEl.classList.contains('maximized') ? 'window-restore' : 'window-maximize',
                action: () => {
                    const maximizeBtn = windowEl.querySelector('.maximize-btn');
                    if (maximizeBtn) maximizeBtn.click();
                }
            },
            { separator: true },
            {
                label: 'Transparency',
                icon: 'adjust',
                submenu: [
                    {
                        label: '100%',
                        action: () => { windowEl.style.opacity = '1.0'; }
                    },
                    {
                        label: '75%',
                        action: () => { windowEl.style.opacity = '0.75'; }
                    },
                    {
                        label: '50%',
                        action: () => { windowEl.style.opacity = '0.5'; }
                    },
                    {
                        label: '25%',
                        action: () => { windowEl.style.opacity = '0.25'; }
                    }
                ]
            },
            {
                label: state.pinnedWindows.includes(windowEl.id) ? 'Unpin Window' : 'Pin Window',
                icon: 'thumbtack',
                action: () => {
                    togglePinWindow(windowEl);
                }
            },
            { separator: true },
            {
                label: 'Show Info',
                icon: 'info-circle',
                action: () => {
                    showWindowInfo(windowEl);
                }
            },
            {
                label: 'Close',
                icon: 'times',
                action: () => {
                    const closeBtn = windowEl.querySelector('.close-btn');
                    if (closeBtn) closeBtn.click();
                }
            }
        ];
        
        return items;
    }
    
    function getWidgetContextMenuItems(widget) {
        const type = widget.dataset.widgetType;
        
        const items = [
            {
                label: 'Refresh Widget',
                icon: 'sync',
                action: () => {
                    initializeWidgetContent(widget, type);
                }
            },
            {
                label: 'Move To Front',
                icon: 'level-up-alt',
                action: () => {
                    let maxZ = 0;
                    document.querySelectorAll('.desktop-widget').forEach(w => {
                        const z = parseInt(window.getComputedStyle(w).zIndex, 10) || 0;
                        if (z > maxZ) maxZ = z;
                    });
                    widget.style.zIndex = (maxZ + 1).toString();
                }
            },
            { separator: true },
            {
                label: 'Remove Widget',
                icon: 'trash',
                action: () => {
                    removeWidget(widget.id);
                }
            }
        ];
        
        return items;
    }
    
    function getDesktopContextMenuItems() {
        const items = [
            {
                label: 'New Window',
                icon: 'window-maximize',
                action: () => {
                    const url = prompt('Enter URL:', 'https://www.example.com');
                    if (url) createWindow(url, 'New Window');
                }
            },
            {
                label: 'Add Widget',
                icon: 'th-large',
                action: () => {
                    showWidgetSelector();
                }
            },
            { separator: true },
            {
                label: 'Theme',
                icon: 'palette',
                submenu: Object.keys(themes).map(themeName => ({
                    label: themeName.charAt(0).toUpperCase() + themeName.slice(1),
                    action: () => applyTheme(themeName)
                }))
            },
            {
                label: 'Workspaces',
                icon: 'desktop',
                submenu: settings.workspaces.map((name, index) => ({
                    label: name,
                    icon: settings.currentWorkspace === index ? 'check' : '',
                    action: () => switchToWorkspace(index)
                }))
            },
            { separator: true },
            {
                label: 'Arrange Windows',
                icon: 'th',
                submenu: [
                    {
                        label: 'Cascade',
                        action: () => arrangeWindowsCascade()
                    },
                    {
                        label: 'Tile Horizontally',
                        action: () => arrangeWindowsTile('horizontal')
                    },
                    {
                        label: 'Tile Vertically',
                        action: () => arrangeWindowsTile('vertical')
                    },
                    {
                        label: 'Minimize All',
                        action: () => minimizeAll()
                    },
                    {
                        label: 'Restore All',
                        action: () => restoreAll()
                    }
                ]
            },
            {
                label: 'Settings',
                icon: 'cog',
                action: () => {
                    showSettingsWindow();
                }
            }
        ];
        
        return items;
    }
    
    function showContextMenu(x, y, items, title) {
        // Create context menu
        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu';
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';
        
        // Add title
        const menuTitle = document.createElement('div');
        menuTitle.className = 'context-menu-title';
        menuTitle.textContent = title;
        contextMenu.appendChild(menuTitle);
        
        // Add menu items
        items.forEach(item => {
            if (item.separator) {
                const separator = document.createElement('div');
                separator.className = 'context-menu-separator';
                contextMenu.appendChild(separator);
            } else {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                
                if (item.submenu) {
                    menuItem.classList.add('has-submenu');
                }
                
                menuItem.innerHTML = `
                    ${item.icon ? `<i class="fas fa-${item.icon}"></i>` : '<span class="icon-placeholder"></span>'}
                    <span class="context-menu-item-label">${item.label}</span>
                    ${item.submenu ? '<i class="fas fa-chevron-right submenu-indicator"></i>' : ''}
                `;
                
                contextMenu.appendChild(menuItem);
                
                if (item.action) {
                    menuItem.addEventListener('click', () => {
                        item.action();
                        closeContextMenu();
                    });
                }
                
                if (item.submenu) {
                    // Handle submenu
                    menuItem.addEventListener('mouseenter', event => {
                        showSubmenu(event.currentTarget, item.submenu);
                    });
                }
            }
        });
        
        // Adjust position if menu would go off screen
        document.body.appendChild(contextMenu);
        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            
            if (menuRect.right > window.innerWidth) {
                contextMenu.style.left = (window.innerWidth - menuRect.width) + 'px';
            }
            
            if (menuRect.bottom > window.innerHeight) {
                contextMenu.style.top = (window.innerHeight - menuRect.height) + 'px';
            }
        }, 0);
    }
    
    function showSubmenu(parentItem, submenuItems) {
        // Remove any existing submenus
        document.querySelectorAll('.context-submenu').forEach(submenu => {
            submenu.remove();
        });
        
        // Create submenu
        const submenu = document.createElement('div');
        submenu.className = 'context-menu context-submenu';
        
        // Add submenu items
        submenuItems.forEach(item => {
            if (item.separator) {
                const separator = document.createElement('div');
                separator.className = 'context-menu-separator';
                submenu.appendChild(separator);
            } else {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                
                menuItem.innerHTML = `
                    ${item.icon ? `<i class="fas fa-${item.icon}"></i>` : '<span class="icon-placeholder"></span>'}
                    <span class="context-menu-item-label">${item.label}</span>
                `;
                
                submenu.appendChild(menuItem);
                
                if (item.action) {
                    menuItem.addEventListener('click', () => {
                        item.action();
                        closeContextMenu();
                    });
                }
            }
        });
        
        // Position submenu to the right of the parent item
        const parentRect = parentItem.getBoundingClientRect();
        submenu.style.left = parentRect.right + 'px';
        submenu.style.top = parentRect.top + 'px';
        
        document.body.appendChild(submenu);
        
        // Adjust position if submenu would go off screen
        setTimeout(() => {
            const submenuRect = submenu.getBoundingClientRect();
            
            if (submenuRect.right > window.innerWidth) {
                // Show submenu to the left instead
                submenu.style.left = (parentRect.left - submenuRect.width) + 'px';
            }
            
            if (submenuRect.bottom > window.innerHeight) {
                submenu.style.top = (window.innerHeight - submenuRect.height) + 'px';
            }
        }, 0);
    }
    
    function closeContextMenu() {
        document.querySelectorAll('.context-menu').forEach(menu => {
            menu.remove();
        });
        
        state.contextMenuOpen = false;
    }
    
    function closeMenu() {
        // Close context menu
        if (state.contextMenuOpen) {
            closeContextMenu();
            return true;
        }
        
        // Close theme selector
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) {
            themeSelector.remove();
            return true;
        }
        
        // Close widget selector
        const widgetSelector = document.querySelector('.widget-selector');
        if (widgetSelector) {
            widgetSelector.remove();
            return true;
        }
        
        // Close search bar
        const searchBar = document.querySelector('.window-search-bar');
        if (searchBar) {
            searchBar.remove();
            return true;
        }
        
        return false;
    }

    // ================ FEATURE 13: WINDOW ANIMATIONS ================
    
    function initWindowAnimations() {
        // Add CSS for animations
        addAnimationStyles();
    }
    
    function addAnimationStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* Window animations */
            @keyframes windowOpen {
                from { transform: scale(0.8); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            @keyframes windowClose {
                from { transform: scale(1); opacity: 1; }
                to { transform: scale(0.8); opacity: 0; }
            }
            
            @keyframes windowMinimize {
                to { transform: scale(0.6) translateY(20px); opacity: 0; }
            }
            
            @keyframes windowRestore {
                from { transform: scale(0.6) translateY(20px); opacity: 0; }
                to { transform: scale(1) translateY(0); opacity: 1; }
            }
            
            .window-container.animating {
                transition: left 0.3s, top 0.3s, width 0.3s, height 0.3s, opacity 0.3s;
            }
            
            .window-container.opening {
                animation: windowOpen 0.3s forwards;
            }
            
            .window-container.closing {
                animation: windowClose 0.3s forwards;
            }
            
            .window-container.minimizing {
                animation: windowMinimize 0.3s forwards;
            }
            
            .window-container.restoring {
                animation: windowRestore 0.3s forwards;
            }
        `;
        
        document.head.appendChild(style);
    }
    
    function animateWindow(windowEl, properties) {
        if (!settings.enableAnimations) {
            // Apply properties immediately without animation
            Object.keys(properties).forEach(prop => {
                windowEl.style[prop] = properties[prop];
            });
            return;
        }
        
        // Add animating class
        windowEl.classList.add('animating');
        
        // Track animation
        state.windowAnimationsInProgress++;
        
        // Apply properties
        Object.keys(properties).forEach(prop => {
            windowEl.style[prop] = properties[prop];
        });
        
        // Remove class after animation completes
        setTimeout(() => {
            windowEl.classList.remove('animating');
            state.windowAnimationsInProgress--;
        }, 300);
    }
    
    function animateWindowOpen(windowEl) {
        if (!settings.enableAnimations) return;
        
        windowEl.classList.add('opening');
        
        setTimeout(() => {
            windowEl.classList.remove('opening');
        }, 300);
    }
    
    function animateWindowClose(windowEl) {
        if (!settings.enableAnimations) {
            windowEl.remove();
            return;
        }
        
        windowEl.classList.add('closing');
        
        setTimeout(() => {
            windowEl.remove();
        }, 300);
    }
    
    function animateWindowMinimize(windowEl) {
        if (!settings.enableAnimations) {
            windowEl.classList.add('minimized');
            return;
        }
        
        windowEl.classList.add('minimizing');
        
        setTimeout(() => {
            windowEl.classList.remove('minimizing');
            windowEl.classList.add('minimized');
        }, 300);
    }
    
    function animateWindowRestore(windowEl) {
        if (!settings.enableAnimations) {
            windowEl.classList.remove('minimized');
            return;
        }
        
        windowEl.classList.remove('minimized');
        windowEl.classList.add('restoring');
        
        setTimeout(() => {
            windowEl.classList.remove('restoring');
        }, 300);
    }

    // ================ FEATURE 14: VIRTUAL DESKTOPS/WORKSPACES ================
    
    function initVirtualDesktops() {
        if (!settings.enableVirtualDesktops) return;
        
        // Add workspace controls to taskbar
        const taskbarLeft = document.getElementById('taskbar-left');
        if (taskbarLeft) {
            const workspaceControl = document.createElement('div');
            workspaceControl.className = 'workspace-control';
            
            workspaceControl.innerHTML = `
                <button class="workspace-prev"><i class="fas fa-chevron-left"></i></button>
                <div class="workspace-indicator"></div>
                <button class="workspace-next"><i class="fas fa-chevron-right"></i></button>
            `;
            
            taskbarLeft.appendChild(workspaceControl);
            
            // Add event listeners
            workspaceControl.querySelector('.workspace-prev').addEventListener('click', prevWorkspace);
            workspaceControl.querySelector('.workspace-next').addEventListener('click', nextWorkspace);
            
            // Initial update
            updateWorkspaceDisplay();
        }
        
        // Set all windows to current workspace if not already set
        document.querySelectorAll('.window-container').forEach(win => {
            if (!win.dataset.workspace) {
                win.dataset.workspace = settings.currentWorkspace;
            }
        });
        
        // Apply current workspace
        applyWorkspaceFilter();
    }
    
    function updateWorkspaceDisplay() {
        const indicator = document.querySelector('.workspace-indicator');
        if (indicator) {
            indicator.innerHTML = '';
            
            // Create indicators for each workspace
            settings.workspaces.forEach((name, index) => {
                const dot = document.createElement('div');
                dot.className = 'workspace-dot';
                dot.classList.toggle('active', index === settings.currentWorkspace);
                dot.title = name;
                
                dot.addEventListener('click', () => {
                    switchToWorkspace(index);
                });
                
                indicator.appendChild(dot);
            });
        }
        
        // Update workspace name in notification
        const workspaceName = settings.workspaces[settings.currentWorkspace] || 'Unknown';
        
        addNotification('Workspace', `Switched to workspace: ${workspaceName}`);
    }
    
    function prevWorkspace() {
        if (!settings.enableVirtualDesktops) return;
        
        const prevIndex = (settings.currentWorkspace - 1 + settings.workspaces.length) % settings.workspaces.length;
        switchToWorkspace(prevIndex);
    }
    
    function nextWorkspace() {
        if (!settings.enableVirtualDesktops) return;
        
        const nextIndex = (settings.currentWorkspace + 1) % settings.workspaces.length;
        switchToWorkspace(nextIndex);
    }
    
    function switchToWorkspace(index) {
        if (index < 0 || index >= settings.workspaces.length) return;
        
        settings.currentWorkspace = index;
        updateWorkspaceDisplay();
        applyWorkspaceFilter();
        saveSettings();
    }
    
    function applyWorkspaceFilter() {
        // Hide windows not in current workspace (except pinned ones)
        document.querySelectorAll('.window-container').forEach(win => {
            const workspace = parseInt(win.dataset.workspace) || 0;
            const isPinned = state.pinnedWindows.includes(win.id);
            
            // Show if in current workspace or pinned
            if (workspace === settings.currentWorkspace || isPinned) {
                win.style.display = '';
            } else {
                win.style.display = 'none';
            }
        });
    }
    
    // Implement workspace keyboard shortcuts
    function workspace1() { switchToWorkspace(0); }
    function workspace2() { switchToWorkspace(1); }
    function workspace3() { switchToWorkspace(2); }
    function workspace4() { switchToWorkspace(3); }

    // ================ FEATURE 15: INTEGRATED CHAT/MESSAGING ================
    
    function initMessagingSystem() {
        // Add chat button to taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const chatBtn = document.createElement('button');
            chatBtn.className = 'toggle-button chat-toggle';
            chatBtn.innerHTML = '<i class="fas fa-comments"></i>';
            chatBtn.title = 'Chat';
            
            chatBtn.addEventListener('click', toggleChatPanel);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(chatBtn, clock);
            } else {
                taskbarRight.appendChild(chatBtn);
            }
        }
        
        // Create chat panel (initially hidden)
        const chatPanel = document.createElement('div');
        chatPanel.className = 'chat-panel';
        chatPanel.innerHTML = `
            <div class="chat-header">
                <h3>Chat</h3>
                <button class="chat-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" placeholder="Type a message...">
                <button class="chat-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        `;
        
        document.body.appendChild(chatPanel);
        
        // Add event listeners
        chatPanel.querySelector('.chat-close').addEventListener('click', () => {
            chatPanel.classList.remove('open');
        });
        
        const chatInput = chatPanel.querySelector('.chat-input');
        const chatSend = chatPanel.querySelector('.chat-send');
        
        const sendMessage = () => {
            const message = chatInput.value.trim();
            if (message) {
                addChatMessage('You', message);
                chatInput.value = '';
                
                // Simulate response after delay
                setTimeout(() => {
                    const responses = [
                        "I'm just a demo chat. I can't actually respond intelligently.",
                        "That's interesting. Tell me more.",
                        "I'm not sure I understand. Could you explain?",
                        "Let me think about that.",
                        "That's a great point!",
                        "I'm sorry, I can't help with that right now."
                    ];
                    
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    addChatMessage('System', response);
                }, 1000);
            }
        };
        
        chatSend.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }
    
    function toggleChatPanel() {
        const chatPanel = document.querySelector('.chat-panel');
        if (chatPanel) {
            chatPanel.classList.toggle('open');
            
            if (chatPanel.classList.contains('open')) {
                chatPanel.querySelector('.chat-input').focus();
            }
        }
    }
    
    function addChatMessage(sender, message) {
        const messagesContainer = document.querySelector('.chat-messages');
        if (!messagesContainer) return;
        
        const messageEl = document.createElement('div');
        messageEl.className = 'chat-message';
        messageEl.classList.add(sender === 'You' ? 'user-message' : 'system-message');
        
        messageEl.innerHTML = `
            <div class="message-sender">${sender}</div>
            <div class="message-content">${message}</div>
            <div class="message-time">${new Date().toLocaleTimeString()}</div>
        `;
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Notify if panel is not open
        if (!document.querySelector('.chat-panel').classList.contains('open')) {
            addNotification('New Message', `${sender}: ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}`);
        }
    }

    // ================ FEATURE 16: VOICE COMMAND INTEGRATION ================
    
    function initVoiceCommands() {
        // Add voice button to taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const voiceBtn = document.createElement('button');
            voiceBtn.className = 'toggle-button voice-toggle';
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.title = 'Voice Commands';
            
            voiceBtn.addEventListener('click', toggleVoiceCommands);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(voiceBtn, clock);
            } else {
                taskbarRight.appendChild(voiceBtn);
            }
        }
    }
    
    function toggleVoiceCommands() {
        state.voiceCommandActive = !state.voiceCommandActive;
        
        const voiceBtn = document.querySelector('.voice-toggle');
        if (voiceBtn) {
            voiceBtn.classList.toggle('active', state.voiceCommandActive);
        }
        
        if (state.voiceCommandActive) {
            startVoiceRecognition();
        } else {
            stopVoiceRecognition();
        }
    }
    
    function startVoiceRecognition() {
        // Show voice feedback UI
        const voiceUI = document.createElement('div');
        voiceUI.className = 'voice-ui';
        voiceUI.innerHTML = `
            <div class="voice-indicator">
                <div class="voice-waves"></div>
                <i class="fas fa-microphone"></i>
            </div>
            <div class="voice-text">Listening...</div>
        `;
        
        document.body.appendChild(voiceUI);
        
        // In a real implementation, would use the Web Speech API
        // For this demo, we'll simulate voice recognition
        
        addNotification('Voice Commands', 'Voice recognition activated');
        
        // Simulate listening
        setTimeout(() => {
            if (state.voiceCommandActive) {
                // Show demo commands
                showVoiceCommandHelp();
            }
        }, 2000);
    }
    
    function stopVoiceRecognition() {
        // Remove voice UI
        const voiceUI = document.querySelector('.voice-ui');
        if (voiceUI) {
            voiceUI.remove();
        }
        
        addNotification('Voice Commands', 'Voice recognition deactivated');
    }
    
    function showVoiceCommandHelp() {
        const helpWindow = document.createElement('div');
        helpWindow.className = 'voice-help-window';
        helpWindow.innerHTML = `
            <div class="voice-help-header">
                <h3>Voice Commands</h3>
                <button class="voice-help-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="voice-help-content">
                <p>Here are some example voice commands you could use:</p>
                <ul>
                    <li>"Open URL [website]"</li>
                    <li>"Maximize window"</li>
                    <li>"Minimize all windows"</li>
                    <li>"Switch to workspace [number]"</li>
                    <li>"Change theme to [theme name]"</li>
                    <li>"Close window"</li>
                    <li>"Show calendar"</li>
                    <li>"What time is it?"</li>
                </ul>
                <p>Note: This is a simulated demo. Real voice recognition would require the Web Speech API integration.</p>
            </div>
        `;
        
        document.body.appendChild(helpWindow);
        
        helpWindow.querySelector('.voice-help-close').addEventListener('click', () => {
            helpWindow.remove();
        });
    }
    
    function processVoiceCommand(command) {
        // This would handle actual voice commands in a real implementation
        // For the demo, it's just a placeholder
        console.log('Processing voice command:', command);
    }

    // ================ FEATURE 17: WINDOW TEMPLATES/PRESETS ================
    
    function initWindowTemplates() {
        // Add a template button to taskbar
        const taskbarLeft = document.getElementById('taskbar-left');
        if (taskbarLeft) {
            const templateBtn = document.createElement('button');
            templateBtn.className = 'toggle-button template-toggle';
            templateBtn.innerHTML = '<i class="fas fa-window-restore"></i>';
            templateBtn.title = 'Window Templates';
            
            templateBtn.addEventListener('click', showTemplateSelector);
            
            taskbarLeft.appendChild(templateBtn);
        }
    }
    
    function showTemplateSelector() {
        // Create template selector
        const selector = document.createElement('div');
        selector.className = 'template-selector';
        selector.innerHTML = `
            <div class="template-selector-header">
                <h3>Window Templates</h3>
                <button class="template-selector-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-grid">
                ${Object.entries(settings.templates).map(([key, template]) => `
                    <div class="template-item" data-template="${key}">
                        <i class="fas ${template.icon ? 'fa-' + template.icon : 'fa-window-maximize'}"></i>
                        <span>${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                        <div class="template-size">${template.width}${template.height}</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        document.body.appendChild(selector);
        
        // Add close handler
        selector.querySelector('.template-selector-close').addEventListener('click', function() {
            selector.remove();
        });
        
        // Add click handlers to template items
        selector.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function() {
                const templateName = this.dataset.template;
                createWindowFromTemplate(templateName);
                selector.remove();
            });
        });
    }
    
    function createWindowFromTemplate(templateName) {
        const template = settings.templates[templateName];
        if (!template) return;
        
        // Create a URL prompt with a default value
        const defaultUrls = {
            'browser': 'https://www.example.com',
            'notepad': 'about:blank',
            'terminal': 'about:blank',
            'media': 'about:blank',
            'chat': 'about:blank'
        };
        
        const url = prompt('Enter URL for this window:', defaultUrls[templateName] || 'https://www.example.com');
        if (!url) return;
        
        // Create window with template properties
        const win = createWindow(url, templateName.charAt(0).toUpperCase() + templateName.slice(1));
        
        // Set size
        win.style.width = template.width + 'px';
        win.style.height = template.height + 'px';
        
        // Center on screen
        const left = (window.innerWidth - template.width) / 2;
        const top = (window.innerHeight - template.height) / 2;
        win.style.left = left + 'px';
        win.style.top = top + 'px';
        
        // Set category
        win.dataset.category = templateName;
        addWindowToCategory(win, templateName.charAt(0).toUpperCase() + templateName.slice(1));
        
        // Special handling for different templates
        switch (templateName) {
            case 'notepad':
                convertToNotepad(win);
                break;
            case 'terminal':
                convertToTerminal(win);
                break;
            case 'media':
                // Media player template would be added here
                break;
            case 'chat':
                // Chat template would be added here
                break;
        }
        
        addNotification('Template Used', `Created window from "${templateName}" template`);
    }
    
    function convertToNotepad(windowEl) {
        const content = windowEl.querySelector('.window-content');
        if (!content) return;
        
        content.innerHTML = `
            <div class="notepad-container">
                <div class="notepad-toolbar">
                    <button class="notepad-new"><i class="fas fa-file"></i> New</button>
                    <button class="notepad-save"><i class="fas fa-save"></i> Save</button>
                    <button class="notepad-open"><i class="fas fa-folder-open"></i> Open</button>
                    <select class="notepad-font-size">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                    </select>
                </div>
                <textarea class="notepad-editor" spellcheck="false"></textarea>
                <div class="notepad-statusbar">
                    <span class="notepad-stats">Lines: 0, Words: 0, Characters: 0</span>
                </div>
            </div>
        `;
        
        // Add event listeners
        const textarea = content.querySelector('.notepad-editor');
        const stats = content.querySelector('.notepad-stats');
        const fontSizeSelect = content.querySelector('.notepad-font-size');
        
        // Update statistics
        const updateStats = () => {
            const text = textarea.value;
            const lines = text.split('\n').length;
            const words = text.split(/\s+/).filter(w => w.length > 0).length;
            const characters = text.length;
            
            stats.textContent = `Lines: ${lines}, Words: ${words}, Characters: ${characters}`;
        };
        
        textarea.addEventListener('input', updateStats);
        
        // Font size change
        fontSizeSelect.addEventListener('change', () => {
            textarea.style.fontSize = fontSizeSelect.value + 'px';
        });
        
        // Button actions
        content.querySelector('.notepad-new').addEventListener('click', () => {
            if (confirm('Clear current text?')) {
                textarea.value = '';
                updateStats();
            }
        });
        
        content.querySelector('.notepad-save').addEventListener('click', () => {
            const text = textarea.value;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'note.txt';
            a.click();
            URL.revokeObjectURL(url);
        });
        
        content.querySelector('.notepad-open').addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.txt,.md,.js,.html,.css';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        textarea.value = e.target.result;
                        updateStats();
                    };
                    reader.readAsText(file);
                }
                document.body.removeChild(fileInput);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
        });
        
        // Set initial font size
        textarea.style.fontSize = fontSizeSelect.value + 'px';
    }
    
    function convertToTerminal(windowEl) {
        const content = windowEl.querySelector('.window-content');
        if (!content) return;
        
        content.innerHTML = `
            <div class="terminal-container">
                <div class="terminal-output"></div>
                <div class="terminal-input-line">
                    <span class="terminal-prompt">user@cr8OS:~$</span>
                    <input type="text" class="terminal-input">
                </div>
            </div>
        `;
        
        // Add terminal functionality
        const output = content.querySelector('.terminal-output');
        const input = content.querySelector('.terminal-input');
        const prompt = content.querySelector('.terminal-prompt');
        
        let currentDir = '~';
        prompt.textContent = `user@cr8OS:${currentDir}$`;
        
        // Add welcome message
        appendToTerminal('Welcome to cr8OS Terminal v1.0', 'system');
        appendToTerminal('Type "help" for a list of commands.', 'system');
        appendToTerminal('', 'blank');
        
        // Focus input
        input.focus();
        
        // Handle commands
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const command = input.value.trim();
                
                // Echo command
                appendToTerminal(`${prompt.textContent} ${command}`, 'command');
                
                // Process command
                processTerminalCommand(command, output, prompt);
                
                // Clear input
                input.value = '';
            }
        });
        
        // Click anywhere to focus input
        content.addEventListener('click', () => {
            input.focus();
        });
    }
    
    function appendToTerminal(text, type) {
        const output = document.querySelector('.terminal-output');
        if (!output) return;
        
        const line = document.createElement('div');
        line.className = 'terminal-line';
        
        if (type === 'blank') {
            // Just add an empty line
            line.innerHTML = '&nbsp;';
        } else {
            line.classList.add(`terminal-${type}`);
            line.textContent = text;
        }
        
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
    }
    
    function processTerminalCommand(command, output, prompt) {
        const args = command.split(' ');
        const cmd = args[0].toLowerCase();
        
        switch (cmd) {
            case 'help':
                appendToTerminal('Available commands:', 'system');
                appendToTerminal('  help - Display this help message', 'system');
                appendToTerminal('  echo [text] - Display text', 'system');
                appendToTerminal('  clear - Clear the terminal', 'system');
                appendToTerminal('  date - Display current date and time', 'system');
                appendToTerminal('  ls - List items in current directory', 'system');
                appendToTerminal('  cd [dir] - Change directory', 'system');
                appendToTerminal('  mkdir [dir] - Create a directory', 'system');
                appendToTerminal('  windows - List open windows', 'system');
                appendToTerminal('  theme [name] - Change theme', 'system');
                appendToTerminal('  exit - Close terminal', 'system');
                break;
                
            case 'echo':
                appendToTerminal(args.slice(1).join(' '), 'output');
                break;
                
            case 'clear':
                output.innerHTML = '';
                break;
                
            case 'date':
                appendToTerminal(new Date().toString(), 'output');
                break;
                
            case 'ls':
                appendToTerminal('Documents  Downloads  Pictures  Music  Videos', 'output');
                break;
                
            case 'cd':
                if (args[1]) {
                    let dir = args[1];
                    if (dir === '~') {
                        prompt.textContent = 'user@cr8OS:~$';
                    } else if (dir === '..') {
                        prompt.textContent = 'user@cr8OS:~$';
                    } else {
                        prompt.textContent = `user@cr8OS:~/${dir}$`;
                    }
                } else {
                    appendToTerminal('Usage: cd [directory]', 'error');
                }
                break;
                
            case 'mkdir':
                if (args[1]) {
                    appendToTerminal(`Directory created: ${args[1]}`, 'output');
                } else {
                    appendToTerminal('Usage: mkdir [directory]', 'error');
                }
                break;
                
            case 'windows':
                const windows = document.querySelectorAll('.window-container');
                if (windows.length === 0) {
                    appendToTerminal('No windows are currently open.', 'output');
                } else {
                    appendToTerminal(`Open windows (${windows.length}):`, 'system');
                    windows.forEach((win, i) => {
                        const title = win.querySelector('.window-title')?.textContent || 'Untitled';
                        appendToTerminal(`  ${i + 1}. ${title}`, 'output');
                    });
                }
                break;
                
            case 'theme':
                if (args[1] && themes[args[1]]) {
                    applyTheme(args[1]);
                    appendToTerminal(`Theme changed to: ${args[1]}`, 'output');
                } else {
                    appendToTerminal('Available themes: ' + Object.keys(themes).join(', '), 'system');
                    appendToTerminal('Usage: theme [name]', 'error');
                }
                break;
                
            case 'exit':
                const terminal = output.closest('.window-container');
                if (terminal) {
                    const closeBtn = terminal.querySelector('.close-btn');
                    if (closeBtn) closeBtn.click();
                }
                break;
                
            case '':
                // Empty command, just add a blank line
                appendToTerminal('', 'blank');
                break;
                
            default:
                appendToTerminal(`Command not found: ${cmd}`, 'error');
                appendToTerminal('Type "help" for a list of commands.', 'system');
        }
    }

    // ================ FEATURE 18: WINDOW ARRANGING ================
    
    function arrangeWindowsCascade() {
        const windows = Array.from(document.querySelectorAll('.window-container:not(.minimized)'));
        if (windows.length === 0) return;
        
        // Get available space
        const taskbarHeight = document.getElementById('taskbar')?.offsetHeight || 0;
        const availableWidth = window.innerWidth;
        const availableHeight = window.innerHeight - taskbarHeight;
        
        // Base size for windows (75% of available space)
        const baseWidth = Math.floor(availableWidth * 0.75);
        const baseHeight = Math.floor(availableHeight * 0.75);
        
        // Offset for cascade effect
        const offsetX = 30;
        const offsetY = 30;
        
        // Position each window
        windows.forEach((win, i) => {
            // Reset size
            win.style.width = baseWidth + 'px';
            win.style.height = baseHeight + 'px';
            
            // Restore if maximized
            if (win.classList.contains('maximized')) {
                win.classList.remove('maximized');
                win.querySelector('.window-header')?.classList.remove('no-drag');
            }
            
            // Calculate position
            const left = Math.min(offsetX * i, availableWidth - baseWidth);
            const top = Math.min(offsetY * i, availableHeight - baseHeight);
            
            // Animate to position
            animateWindow(win, {
                left: left + 'px',
                top: top + 'px',
                width: baseWidth + 'px',
                height: baseHeight + 'px'
            });
            
            // Bring to front
            setTimeout(() => {
                bringWindowToFront(win);
            }, i * 100);
        });
        
        addNotification('Window Arrangement', 'Windows have been arranged in cascade');
    }
    
    function arrangeWindowsTile(direction) {
        const windows = Array.from(document.querySelectorAll('.window-container:not(.minimized)'));
        if (windows.length === 0) return;
        
        // Get available space
        const taskbarHeight = document.getElementById('taskbar')?.offsetHeight || 0;
        const availableWidth = window.innerWidth;
        const availableHeight = window.innerHeight - taskbarHeight;
        
        // Determine grid dimensions based on number of windows
        let cols, rows;
        
        if (direction === 'horizontal') {
            // Prioritize horizontal layout
            rows = Math.min(windows.length, 2);
            cols = Math.ceil(windows.length / rows);
        } else {
            // Prioritize vertical layout
            cols = Math.min(windows.length, 2);
            rows = Math.ceil(windows.length / cols);
        }
        
        // Calculate window dimensions
        const windowWidth = Math.floor(availableWidth / cols);
        const windowHeight = Math.floor(availableHeight / rows);
        
        // Position each window
        windows.forEach((win, i) => {
            // Calculate grid position
            const col = i % cols;
            const row = Math.floor(i / cols);
            
            // Calculate pixel position
            const left = col * windowWidth;
            const top = row * windowHeight;
            
            // Restore if maximized
            if (win.classList.contains('maximized')) {
                win.classList.remove('maximized');
                win.querySelector('.window-header')?.classList.remove('no-drag');
            }
            
            // Animate to position
            animateWindow(win, {
                left: left + 'px',
                top: top + 'px',
                width: windowWidth + 'px',
                height: windowHeight + 'px'
            });
        });
        
        addNotification('Window Arrangement', `Windows tiled ${direction}ly`);
    }
    
    function minimizeAll() {
        const windows = document.querySelectorAll('.window-container:not(.minimized)');
        
        windows.forEach(win => {
            win.classList.add('minimized');
            win.querySelector('.window-header')?.classList.add('no-drag');
            
            // Update taskbar
            const taskbarButton = document.querySelector(`.taskbar-window-button[data-window-id="${win.id}"]`);
            if (taskbarButton) {
                taskbarButton.classList.remove('active');
            }
        });
        
        state.activeWindowId = null;
        
        addNotification('Windows', 'All windows minimized');
    }
    
    function restoreAll() {
        const windows = document.querySelectorAll('.window-container.minimized');
        
        windows.forEach(win => {
            win.classList.remove('minimized');
            win.querySelector('.window-header')?.classList.remove('no-drag');
        });
        
        addNotification('Windows', 'All windows restored');
    }
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                addNotification('Error', `Could not enter fullscreen mode: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // ================ FEATURE 19: SCREEN SHARING ================
    
    function initScreenSharing() {
        // Add share button to taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const shareBtn = document.createElement('button');
            shareBtn.className = 'toggle-button share-toggle';
            shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
            shareBtn.title = 'Share Screen';
            
            shareBtn.addEventListener('click', showShareOptions);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(shareBtn, clock);
            } else {
                taskbarRight.appendChild(shareBtn);
            }
        }
    }
    
    function showShareOptions() {
        // Create share options panel
        const sharePanel = document.createElement('div');
        sharePanel.className = 'share-panel';
        sharePanel.innerHTML = `
            <div class="share-header">
                <h3>Share Options</h3>
                <button class="share-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="share-content">
                <div class="share-option" data-option="screen">
                    <i class="fas fa-desktop"></i>
                    <span>Share Entire Screen</span>
                </div>
                <div class="share-option" data-option="window">
                    <i class="fas fa-window-restore"></i>
                    <span>Share Window</span>
                </div>
                <div class="share-option" data-option="snapshot">
                    <i class="fas fa-camera"></i>
                    <span>Take Screenshot</span>
                </div>
            </div>
        `;
        
        document.body.appendChild(sharePanel);
        
        // Add close handler
        sharePanel.querySelector('.share-close').addEventListener('click', function() {
            sharePanel.remove();
        });
        
        // Add option handlers
        sharePanel.querySelectorAll('.share-option').forEach(option => {
            option.addEventListener('click', function() {
                const shareType = this.dataset.option;
                
                switch (shareType) {
                    case 'screen':
                        simulateScreenShare();
                        break;
                    case 'window':
                        showWindowSelector();
                        break;
                    case 'snapshot':
                        takeScreenshot();
                        break;
                }
                
                sharePanel.remove();
            });
        });
    }
    
    function simulateScreenShare() {
        // In a real implementation, would use the Screen Capture API
        // For the demo, we'll simulate screen sharing
        
        // Create share indicator
        const shareIndicator = document.createElement('div');
        shareIndicator.className = 'share-indicator';
        shareIndicator.innerHTML = `
            <i class="fas fa-desktop"></i>
            <span>Screen sharing active</span>
            <button class="share-stop"><i class="fas fa-stop-circle"></i> Stop</button>
        `;
        
        document.body.appendChild(shareIndicator);
        
        // Add stop handler
        shareIndicator.querySelector('.share-stop').addEventListener('click', function() {
            shareIndicator.remove();
            state.shareSessionActive = false;
            addNotification('Screen Sharing', 'Screen sharing stopped');
        });
        
        state.shareSessionActive = true;
        addNotification('Screen Sharing', 'Screen sharing started');
    }
    
    function showWindowSelector() {
        // Get all windows
        const windows = Array.from(document.querySelectorAll('.window-container:not(.minimized)'));
        if (windows.length === 0) {
            addNotification('Error', 'No windows available to share');
            return;
        }
        
        // Create selector
        const selector = document.createElement('div');
        selector.className = 'window-selector';
        selector.innerHTML = `
            <div class="window-selector-header">
                <h3>Select Window to Share</h3>
                <button class="window-selector-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="window-selector-content"></div>
        `;
        
        // Add windows to selector
        const content = selector.querySelector('.window-selector-content');
        
        windows.forEach(win => {
            const title = win.querySelector('.window-title')?.textContent || 'Untitled';
            
            const windowOption = document.createElement('div');
            windowOption.className = 'window-option';
            windowOption.innerHTML = `
                <div class="window-preview">
                    <i class="fas fa-window-maximize"></i>
                </div>
                <div class="window-title">${title}</div>
            `;
            
            windowOption.addEventListener('click', function() {
                shareWindow(win);
                selector.remove();
            });
            
            content.appendChild(windowOption);
        });
        
        document.body.appendChild(selector);
        
        // Add close handler
        selector.querySelector('.window-selector-close').addEventListener('click', function() {
            selector.remove();
        });
    }
    
    function shareWindow(windowEl) {
        // In a real implementation, would use the Screen Capture API
        // For the demo, we'll simulate window sharing
        
        const title = windowEl.querySelector('.window-title')?.textContent || 'Untitled';
        
        // Create share indicator
        const shareIndicator = document.createElement('div');
        shareIndicator.className = 'share-indicator window-share';
        shareIndicator.innerHTML = `
            <i class="fas fa-window-restore"></i>
            <span>Sharing: ${title}</span>
            <button class="share-stop"><i class="fas fa-stop-circle"></i> Stop</button>
        `;
        
        document.body.appendChild(shareIndicator);
        
        // Add stop handler
        shareIndicator.querySelector('.share-stop').addEventListener('click', function() {
            shareIndicator.remove();
            state.shareSessionActive = false;
            windowEl.classList.remove('window-sharing');
            addNotification('Window Sharing', 'Window sharing stopped');
        });
        
        // Highlight shared window
        windowEl.classList.add('window-sharing');
        
        state.shareSessionActive = true;
        addNotification('Window Sharing', `Started sharing window: ${title}`);
    }
    
    function takeScreenshot() {
        // In a real implementation, would use the Screen Capture API
        // For the demo, we'll simulate taking a screenshot
        
        // Create flash effect
        const flash = document.createElement('div');
        flash.className = 'screenshot-flash';
        document.body.appendChild(flash);
        
        // Remove flash after animation
        setTimeout(() => {
            flash.remove();
            
            // Show screenshot preview
            showScreenshotPreview();
        }, 500);
        
        addNotification('Screenshot', 'Screenshot captured');
    }
    
    function showScreenshotPreview() {
        // Create preview window
        const win = createWindow('about:blank', 'Screenshot');
        win.dataset.category = 'Media';
        
        // Generate a placeholder image (would be a real screenshot in actual implementation)
        const content = win.querySelector('.window-content');
        content.innerHTML = `
            <div class="screenshot-preview">
                <div class="screenshot-image">
                    <img src="/api/placeholder/800/600" alt="Screenshot">
                </div>
                <div class="screenshot-toolbar">
                    <button class="screenshot-save"><i class="fas fa-download"></i> Save</button>
                    <button class="screenshot-copy"><i class="fas fa-copy"></i> Copy</button>
                    <button class="screenshot-share"><i class="fas fa-share-alt"></i> Share</button>
                </div>
            </div>
        `;
        
        // Add button handlers
        content.querySelector('.screenshot-save').addEventListener('click', function() {
            addNotification('Screenshot', 'Screenshot saved (simulated)');
        });
        
        content.querySelector('.screenshot-copy').addEventListener('click', function() {
            addNotification('Screenshot', 'Screenshot copied to clipboard (simulated)');
        });
        
        content.querySelector('.screenshot-share').addEventListener('click', function() {
            addNotification('Screenshot', 'Share dialog opened (simulated)');
        });
    }

    // ================ FEATURE 20: ACCESSIBILITY ENHANCEMENTS ================
    
    function initAccessibility() {
        if (!settings.enableAccessibility) return;
        
        // Add accessibility button to taskbar
        const taskbarRight = document.getElementById('taskbar-right');
        if (taskbarRight) {
            const accessibilityBtn = document.createElement('button');
            accessibilityBtn.className = 'toggle-button accessibility-toggle';
            accessibilityBtn.innerHTML = '<i class="fas fa-universal-access"></i>';
            accessibilityBtn.title = 'Accessibility Options';
            
            accessibilityBtn.addEventListener('click', showAccessibilityOptions);
            
            // Insert before clock
            const clock = document.getElementById('clock');
            if (clock) {
                taskbarRight.insertBefore(accessibilityBtn, clock);
            } else {
                taskbarRight.appendChild(accessibilityBtn);
            }
        }
        
        // Apply any saved accessibility settings
        applyAccessibilitySettings();
    }
    
    function showAccessibilityOptions() {
        // Create accessibility panel
        const panel = document.createElement('div');
        panel.className = 'accessibility-panel';
        panel.innerHTML = `
            <div class="accessibility-header">
                <h3>Accessibility Options</h3>
                <button class="accessibility-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="accessibility-content">
                <div class="accessibility-option">
                    <label>
                        <input type="checkbox" id="acc-high-contrast" ${settings.highContrast ? 'checked' : ''}>
                        High Contrast Mode
                    </label>
                </div>
                <div class="accessibility-option">
                    <label>
                        <input type="checkbox" id="acc-large-text" ${settings.largeText ? 'checked' : ''}>
                        Large Text
                    </label>
                </div>
                <div class="accessibility-option">
                    <label>
                        <input type="checkbox" id="acc-reduce-motion" ${settings.reduceMotion ? 'checked' : ''}>
                        Reduce Motion
                    </label>
                </div>
                <div class="accessibility-option">
                    <label>
                        <input type="checkbox" id="acc-keyboard-nav" ${settings.keyboardNavigation ? 'checked' : ''}>
                        Enhanced Keyboard Navigation
                    </label>
                </div>
                <div class="accessibility-option">
                    <label>Text Size:</label>
                    <input type="range" id="acc-text-size" min="100" max="200" value="${settings.textSizePercent || 100}" step="10">
                    <span id="acc-text-size-value">${settings.textSizePercent || 100}%</span>
                </div>
            </div>
            <div class="accessibility-footer">
                <button class="accessibility-apply">Apply Changes</button>
                <button class="accessibility-reset">Reset to Default</button>
            </div>
        `;
        
        document.body.appendChild(panel);
        
        // Add event listeners
        const textSizeSlider = panel.querySelector('#acc-text-size');
        const textSizeValue = panel.querySelector('#acc-text-size-value');
        
        textSizeSlider.addEventListener('input', function() {
            textSizeValue.textContent = this.value + '%';
        });
        
        // Close handler
        panel.querySelector('.accessibility-close').addEventListener('click', function() {
            panel.remove();
        });
        
        // Apply button
        panel.querySelector('.accessibility-apply').addEventListener('click', function() {
            // Gather settings
            settings.highContrast = panel.querySelector('#acc-high-contrast').checked;
            settings.largeText = panel.querySelector('#acc-large-text').checked;
            settings.reduceMotion = panel.querySelector('#acc-reduce-motion').checked;
            settings.keyboardNavigation = panel.querySelector('#acc-keyboard-nav').checked;
            settings.textSizePercent = parseInt(panel.querySelector('#acc-text-size').value);
            
            // Apply settings
            applyAccessibilitySettings();
            
            // Save settings
            saveSettings();
            
            // Close panel
            panel.remove();
            
            addNotification('Accessibility', 'Accessibility settings updated');
        });
        
        // Reset button
        panel.querySelector('.accessibility-reset').addEventListener('click', function() {
            if (confirm('Reset all accessibility settings to default?')) {
                // Reset to defaults
                settings.highContrast = false;
                settings.largeText = false;
                settings.reduceMotion = false;
                settings.keyboardNavigation = false;
                settings.textSizePercent = 100;
                
                // Update UI
                panel.querySelector('#acc-high-contrast').checked = false;
                panel.querySelector('#acc-large-text').checked = false;
                panel.querySelector('#acc-reduce-motion').checked = false;
                panel.querySelector('#acc-keyboard-nav').checked = false;
                panel.querySelector('#acc-text-size').value = 100;
                panel.querySelector('#acc-text-size-value').textContent = '100%';
                
                // Apply settings
                applyAccessibilitySettings();
                
                // Save settings
                saveSettings();
                
                addNotification('Accessibility', 'Accessibility settings reset to default');
            }
        });
    }
    
    // ================ FEATURE 20: ACCESSIBILITY ENHANCEMENTS (continued) ================
    
    function applyAccessibilitySettings() {
        // Remove existing accessibility classes
        document.body.classList.remove(
            'high-contrast',
            'large-text',
            'reduce-motion'
        );
        
        // Apply selected settings
        if (settings.highContrast) {
            document.body.classList.add('high-contrast');
        }
        
        if (settings.largeText) {
            document.body.classList.add('large-text');
        }
        
        if (settings.reduceMotion) {
            document.body.classList.add('reduce-motion');
            settings.enableAnimations = false;
        } else {
            settings.enableAnimations = true;
        }
        
        // Apply text size
        document.documentElement.style.setProperty('--text-size-factor', settings.textSizePercent / 100);
        
        // Apply keyboard navigation enhancements
        if (settings.keyboardNavigation) {
            enhanceKeyboardNavigation();
        } else {
            disableKeyboardNavigation();
        }
    }
    
    function enhanceKeyboardNavigation() {
        // Add focus indicators to all interactive elements
        const style = document.createElement('style');
        style.id = 'keyboard-nav-styles';
        style.textContent = `
            button:focus, input:focus, select:focus, textarea:focus, [tabindex]:focus {
                outline: 3px solid var(--accent-color, #3498db) !important;
                outline-offset: 2px !important;
            }
            
            .window-container:focus {
                box-shadow: 0 0 0 3px var(--accent-color, #3498db) !important;
            }
        `;
        
        document.head.appendChild(style);
        
        // Make sure all windows are in the tab order
        document.querySelectorAll('.window-container').forEach(win => {
            if (!win.hasAttribute('tabindex')) {
                win.setAttribute('tabindex', '0');
            }
        });
    }
    
    function disableKeyboardNavigation() {
        // Remove focus indicator styles
        const style = document.getElementById('keyboard-nav-styles');
        if (style) {
            style.remove();
        }
    }

    // ================ SETTINGS MANAGEMENT ================
    
    function showSettingsWindow() {
        // Create settings window
        const win = createWindow('about:blank', 'System Settings');
        win.classList.add('system-window');
        win.dataset.category = 'System';
        
        // Replace iframe content with settings UI
        const content = win.querySelector('.window-content');
        content.innerHTML = `
            <div class="settings-container">
                <div class="settings-sidebar">
                    <div class="settings-nav-item active" data-section="general">
                        <i class="fas fa-cog"></i>
                        <span>General</span>
                    </div>
                    <div class="settings-nav-item" data-section="appearance">
                        <i class="fas fa-palette"></i>
                        <span>Appearance</span>
                    </div>
                    <div class="settings-nav-item" data-section="windows">
                        <i class="fas fa-window-maximize"></i>
                        <span>Windows</span>
                    </div>
                    <div class="settings-nav-item" data-section="workspaces">
                        <i class="fas fa-desktop"></i>
                        <span>Workspaces</span>
                    </div>
                    <div class="settings-nav-item" data-section="shortcuts">
                        <i class="fas fa-keyboard"></i>
                        <span>Shortcuts</span>
                    </div>
                    <div class="settings-nav-item" data-section="accessibility">
                        <i class="fas fa-universal-access"></i>
                        <span>Accessibility</span>
                    </div>
                    <div class="settings-nav-item" data-section="about">
                        <i class="fas fa-info-circle"></i>
                        <span>About</span>
                    </div>
                </div>
                <div class="settings-content">
                    <div class="settings-section active" id="settings-general">
                        <h2>General Settings</h2>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-session-persistence" ${settings.saveState ? 'checked' : ''}>
                                Save session on exit
                            </label>
                            <p class="settings-description">Restore windows and settings when you reload the page</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-notifications" ${settings.enableNotifications !== false ? 'checked' : ''}>
                                Enable notifications
                            </label>
                            <p class="settings-description">Show system notifications</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-search" ${settings.searchEnabled ? 'checked' : ''}>
                                Enable search functionality
                            </label>
                            <p class="settings-description">Allow searching for windows and content</p>
                        </div>
                        <div class="settings-option">
                            <button id="clear-session-data" class="settings-button">
                                Clear All Session Data
                            </button>
                            <p class="settings-description">Remove all saved windows and settings from your browser</p>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="settings-appearance">
                        <h2>Appearance</h2>
                        <div class="settings-option">
                            <label>Theme:</label>
                            <select id="setting-theme">
                                ${Object.keys(themes).map(theme => 
                                    `<option value="${theme}" ${settings.theme === theme ? 'selected' : ''}>${theme.charAt(0).toUpperCase() + theme.slice(1)}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-animations" ${settings.enableAnimations ? 'checked' : ''}>
                                Enable animations
                            </label>
                            <p class="settings-description">Use animations for window transitions</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-background-animation" ${!animationPaused ? 'checked' : ''}>
                                Enable background animation
                            </label>
                            <p class="settings-description">Show animated background</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-widgets" ${settings.enableWidgets ? 'checked' : ''}>
                                Enable desktop widgets
                            </label>
                            <p class="settings-description">Allow adding widgets to the desktop</p>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="settings-windows">
                        <h2>Window Settings</h2>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-snapping" ${settings.enableSnapping ? 'checked' : ''}>
                                Enable window snapping
                            </label>
                            <p class="settings-description">Snap windows to screen edges and other windows</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-grouping" ${settings.enableGrouping ? 'checked' : ''}>
                                Enable window grouping
                            </label>
                            <p class="settings-description">Allow grouping windows to move together</p>
                        </div>
                        <div class="settings-option">
                            <label>Snap threshold:</label>
                            <input type="range" id="setting-snap-threshold" min="5" max="50" value="${settings.snapThreshold}" step="5">
                            <span id="snap-threshold-value">${settings.snapThreshold}px</span>
                            <p class="settings-description">Distance for window snapping activation</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-context-menus" ${settings.enableContextMenus ? 'checked' : ''}>
                                Enable context menus
                            </label>
                            <p class="settings-description">Show context menu on right-click</p>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="settings-workspaces">
                        <h2>Workspace Settings</h2>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-virtual-desktops" ${settings.enableVirtualDesktops ? 'checked' : ''}>
                                Enable virtual desktops
                            </label>
                            <p class="settings-description">Allow using multiple workspaces</p>
                        </div>
                        <div class="settings-option">
                            <label>Current workspace:</label>
                            <select id="setting-current-workspace">
                                ${settings.workspaces.map((name, index) => 
                                    `<option value="${index}" ${settings.currentWorkspace === index ? 'selected' : ''}>${name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="settings-option">
                            <label>Workspace names:</label>
                            <div class="workspace-name-editor">
                                ${settings.workspaces.map((name, index) => `
                                    <div class="workspace-name-input">
                                        <input type="text" data-workspace="${index}" value="${name}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="settings-shortcuts">
                        <h2>Keyboard Shortcuts</h2>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-keyboard-shortcuts" ${settings.enableKeyboardShortcuts ? 'checked' : ''}>
                                Enable keyboard shortcuts
                            </label>
                            <p class="settings-description">Use keyboard combinations for window management</p>
                        </div>
                        <div class="shortcuts-list">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>Shortcut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(keyboardShortcuts).map(([key, action]) => `
                                        <tr>
                                            <td>${formatActionName(action)}</td>
                                            <td class="shortcut-key">${key}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="settings-accessibility">
                        <h2>Accessibility Settings</h2>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-accessibility" ${settings.enableAccessibility ? 'checked' : ''}>
                                Enable accessibility features
                            </label>
                            <p class="settings-description">Turn on accessibility enhancements</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-high-contrast" ${settings.highContrast ? 'checked' : ''}>
                                High contrast mode
                            </label>
                            <p class="settings-description">Enhance visual contrast for better readability</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-large-text" ${settings.largeText ? 'checked' : ''}>
                                Large text
                            </label>
                            <p class="settings-description">Increase text size throughout the interface</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-reduce-motion" ${settings.reduceMotion ? 'checked' : ''}>
                                Reduce motion
                            </label>
                            <p class="settings-description">Minimize animations and motion effects</p>
                        </div>
                        <div class="settings-option">
                            <label>
                                <input type="checkbox" id="setting-keyboard-nav" ${settings.keyboardNavigation ? 'checked' : ''}>
                                Enhanced keyboard navigation
                            </label>
                            <p class="settings-description">Improve focus indicators and keyboard controls</p>
                        </div>
                        <div class="settings-option">
                            <label>Text size:</label>
                            <input type="range" id="setting-text-size" min="100" max="200" value="${settings.textSizePercent || 100}" step="10">
                            <span id="text-size-value">${settings.textSizePercent || 100}%</span>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="settings-about">
                        <h2>About cr8OS</h2>
                        <div class="about-content">
                            <div class="about-logo">
                                <i class="fas fa-window-maximize"></i>
                                <span>cr8OS</span>
                            </div>
                            <div class="about-info">
                                <p><strong>Version:</strong> 1.0</p>
                                <p><strong>Created by:</strong> WPWakanda, LLC</p>
                                <p><strong>Description:</strong> A web-based window management system with advanced features</p>
                            </div>
                            <div class="feature-list">
                                <h3>Features:</h3>
                                <ul>
                                    <li>Window management with drag & drop</li>
                                    <li>Window snapping and grouping</li>
                                    <li>Virtual desktops</li>
                                    <li>Themes and customization</li>
                                    <li>Session persistence</li>
                                    <li>Keyboard shortcuts</li>
                                    <li>And many more...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Set up event listeners
        setupSettingsEventListeners(content);
    }
    
    function setupSettingsEventListeners(content) {
        // Navigation
        content.querySelectorAll('.settings-nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // Update active nav item
                content.querySelectorAll('.settings-nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                this.classList.add('active');
                
                // Show corresponding section
                const section = this.dataset.section;
                content.querySelectorAll('.settings-section').forEach(sec => {
                    sec.classList.remove('active');
                });
                content.querySelector(`#settings-${section}`).classList.add('active');
            });
        });
        
        // General settings
        const sessionPersistenceCheck = content.querySelector('#setting-session-persistence');
        if (sessionPersistenceCheck) {
            sessionPersistenceCheck.addEventListener('change', function() {
                settings.saveState = this.checked;
                saveSettings();
            });
        }
        
        const notificationsCheck = content.querySelector('#setting-notifications');
        if (notificationsCheck) {
            notificationsCheck.addEventListener('change', function() {
                settings.enableNotifications = this.checked;
                saveSettings();
            });
        }
        
        const searchCheck = content.querySelector('#setting-search');
        if (searchCheck) {
            searchCheck.addEventListener('change', function() {
                settings.searchEnabled = this.checked;
                saveSettings();
            });
        }
        
        const clearDataBtn = content.querySelector('#clear-session-data');
        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
                    clearAllData();
                    addNotification('Settings', 'All session data has been cleared');
                }
            });
        }
        
        // Appearance settings
        const themeSelect = content.querySelector('#setting-theme');
        if (themeSelect) {
            themeSelect.addEventListener('change', function() {
                applyTheme(this.value);
            });
        }
        
        const animationsCheck = content.querySelector('#setting-animations');
        if (animationsCheck) {
            animationsCheck.addEventListener('change', function() {
                settings.enableAnimations = this.checked;
                saveSettings();
            });
        }
        
        const backgroundAnimationCheck = content.querySelector('#setting-background-animation');
        if (backgroundAnimationCheck) {
            backgroundAnimationCheck.addEventListener('change', function() {
                if (this.checked === animationPaused) {
                    toggleAnimation();
                }
            });
        }
        
        const widgetsCheck = content.querySelector('#setting-widgets');
        if (widgetsCheck) {
            widgetsCheck.addEventListener('change', function() {
                settings.enableWidgets = this.checked;
                saveSettings();
            });
        }
        
        // Window settings
        const snappingCheck = content.querySelector('#setting-snapping');
        if (snappingCheck) {
            snappingCheck.addEventListener('change', function() {
                settings.enableSnapping = this.checked;
                saveSettings();
            });
        }
        
        const groupingCheck = content.querySelector('#setting-grouping');
        if (groupingCheck) {
            groupingCheck.addEventListener('change', function() {
                settings.enableGrouping = this.checked;
                saveSettings();
            });
        }
        
        const snapThreshold = content.querySelector('#setting-snap-threshold');
        const snapThresholdValue = content.querySelector('#snap-threshold-value');
        if (snapThreshold && snapThresholdValue) {
            snapThreshold.addEventListener('input', function() {
                snapThresholdValue.textContent = this.value + 'px';
                settings.snapThreshold = parseInt(this.value);
                saveSettings();
            });
        }
        
        const contextMenusCheck = content.querySelector('#setting-context-menus');
        if (contextMenusCheck) {
            contextMenusCheck.addEventListener('change', function() {
                settings.enableContextMenus = this.checked;
                saveSettings();
            });
        }
        
        // Workspace settings
        const virtualDesktopsCheck = content.querySelector('#setting-virtual-desktops');
        if (virtualDesktopsCheck) {
            virtualDesktopsCheck.addEventListener('change', function() {
                settings.enableVirtualDesktops = this.checked;
                saveSettings();
            });
        }
        
        const currentWorkspaceSelect = content.querySelector('#setting-current-workspace');
        if (currentWorkspaceSelect) {
            currentWorkspaceSelect.addEventListener('change', function() {
                switchToWorkspace(parseInt(this.value));
            });
        }
        
        // Workspace name inputs
        content.querySelectorAll('.workspace-name-input input').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.workspace);
                settings.workspaces[index] = this.value.trim() || `Workspace ${index + 1}`;
                saveSettings();
                updateWorkspaceDisplay();
            });
        });
        
        // Shortcuts settings
        const keyboardShortcutsCheck = content.querySelector('#setting-keyboard-shortcuts');
        if (keyboardShortcutsCheck) {
            keyboardShortcutsCheck.addEventListener('change', function() {
                settings.enableKeyboardShortcuts = this.checked;
                saveSettings();
            });
        }
        
        // Accessibility settings
        const accessibilityCheck = content.querySelector('#setting-accessibility');
        if (accessibilityCheck) {
            accessibilityCheck.addEventListener('change', function() {
                settings.enableAccessibility = this.checked;
                saveSettings();
                applyAccessibilitySettings();
            });
        }
        
        const highContrastCheck = content.querySelector('#setting-high-contrast');
        if (highContrastCheck) {
            highContrastCheck.addEventListener('change', function() {
                settings.highContrast = this.checked;
                saveSettings();
                applyAccessibilitySettings();
            });
        }
        
        const largeTextCheck = content.querySelector('#setting-large-text');
        if (largeTextCheck) {
            largeTextCheck.addEventListener('change', function() {
                settings.largeText = this.checked;
                saveSettings();
                applyAccessibilitySettings();
            });
        }
        
        const reduceMotionCheck = content.querySelector('#setting-reduce-motion');
        if (reduceMotionCheck) {
            reduceMotionCheck.addEventListener('change', function() {
                settings.reduceMotion = this.checked;
                saveSettings();
                applyAccessibilitySettings();
            });
        }
        
        const keyboardNavCheck = content.querySelector('#setting-keyboard-nav');
        if (keyboardNavCheck) {
            keyboardNavCheck.addEventListener('change', function() {
                settings.keyboardNavigation = this.checked;
                saveSettings();
                applyAccessibilitySettings();
            });
        }
        
        const textSizeSlider = content.querySelector('#setting-text-size');
        const textSizeValue = content.querySelector('#text-size-value');
        if (textSizeSlider && textSizeValue) {
            textSizeSlider.addEventListener('input', function() {
                textSizeValue.textContent = this.value + '%';
                settings.textSizePercent = parseInt(this.value);
                applyAccessibilitySettings();
            });
            
            textSizeSlider.addEventListener('change', function() {
                saveSettings();
            });
        }
    }
    
    function clearAllData() {
        // Clear all local storage
        localStorage.removeItem(settings.sessionStorageKey);
        localStorage.removeItem('cr8OS-widgets');
        localStorage.removeItem('cr8OS-settings');
        
        // Reset settings to defaults
        initSettings();
        
        // Apply default theme
        applyTheme('default');
        
        // Remove all non-system windows
        document.querySelectorAll('.window-container:not(.system-window)').forEach(win => {
            win.remove();
        });
        
        // Clear taskbar
        document.getElementById('taskbar-center').innerHTML = '';
        
        // Remove all widgets
        document.querySelectorAll('.desktop-widget').forEach(widget => {
            widget.remove();
        });
        
        state.widgets = [];
    }
    
    function saveSettings() {
        if (settings.saveState) {
            localStorage.setItem('cr8OS-settings', JSON.stringify(settings));
        }
    }
    
    function loadSettings() {
        const savedSettings = localStorage.getItem('cr8OS-settings');
        if (savedSettings) {
            try {
                const parsedSettings = JSON.parse(savedSettings);
                Object.assign(settings, parsedSettings);
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
    }
    
    function initSettings() {
        // Reset to default settings
        settings = {
            theme: 'default',
            snapThreshold: 20,
            enableSnapping: true,
            enableGrouping: true,
            enableKeyboardShortcuts: true,
            enableContextMenus: true,
            enableAnimations: true,
            enableWidgets: true,
            enableVirtualDesktops: true,
            enableAccessibility: true,
            saveState: true,
            sessionStorageKey: 'cr8OS-state',
            defaultTransparency: 1,
            currentWorkspace: 0,
            workspaces: ['Main', 'Work', 'Media', 'Social'],
            templates: {
                'browser': { width: 800, height: 600, icon: 'globe' },
                'notepad': { width: 400, height: 500, icon: 'sticky-note' },
                'terminal': { width: 600, height: 400, icon: 'terminal' },
                'media': { width: 640, height: 480, icon: 'play' },
                'chat': { width: 380, height: 500, icon: 'comments' }
            },
            categories: ['Productivity', 'Media', 'Social', 'Development', 'System'],
            searchEnabled: true,
            highContrast: false,
            largeText: false,
            reduceMotion: false,
            keyboardNavigation: false,
            textSizePercent: 100,
            enableNotifications: true
        };
    }

    // ================ INITIALIZATION ================
    
    function init() {
        // Load CSS
        addStyles();
        
        // Initialize settings
        initSettings();
        loadSettings();
        
        // Initialize features
        initWindowSnapping();
        initWindowGrouping();
        initThemeSystem();
        initSessionPersistence();
        initKeyboardShortcuts();
        initAdvancedWindowControls();
        initWindowSearch();
        initTabbedWindows();
        initWindowHistory();
        initFileDragDrop();
        initDesktopWidgets();
        initContextMenus();
        initWindowAnimations();
        initVirtualDesktops();
        initMessagingSystem();
        initVoiceCommands();
        initWindowTemplates();
        initScreenSharing();
        initAccessibility();
        
        // Apply initial theme
        applyTheme(settings.theme);
        
        // Apply accessibility settings
        applyAccessibilitySettings();
        
        // Enhance existing windows
        document.querySelectorAll('.window-container').forEach(win => {
            enableWindowSnapping(win);
            enableWindowGrouping(win);
            enhanceWindowControls(win);
            enableTabbedMode(win);
            addNavigationControls(win);
        });
        
        // Add welcome notification
        setTimeout(() => {
            addNotification('Welcome', 'cr8OS advanced features are now active');
        }, 1000);
    }
    
    function addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* General styles */
            :root {
                --window-bg: rgba(25, 25, 25, 0.8);
                --window-border: 1px solid rgba(255, 255, 255, 0.2);
                --window-header: rgba(30, 30, 30, 0.9);
                --window-text: #fff;
                --taskbar-bg: rgba(20, 20, 20, 0.8);
                --accent-color: #3498db;
                --accent-hover: #2980b9;
                --notification-bg: rgba(30, 30, 30, 0.9);
                --text-size-factor: 1;
            }
            
            /* Context Menu */
            .context-menu {
                position: fixed;
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                padding: 5px 0;
                min-width: 180px;
                z-index: 10000;
                color: var(--window-text);
            }
            
            .context-menu-title {
                padding: 5px 10px;
                font-weight: bold;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                margin-bottom: 5px;
            }
            
            .context-menu-item {
                padding: 8px 15px;
                display: flex;
                align-items: center;
                cursor: pointer;
                position: relative;
            }
            
            .context-menu-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .context-menu-item i {
                margin-right: 8px;
                width: 16px;
                text-align: center;
            }
            
            .context-menu-item .icon-placeholder {
                width: 16px;
                margin-right: 8px;
                display: inline-block;
            }
            
            .context-menu-separator {
                height: 1px;
                background: rgba(255, 255, 255, 0.1);
                margin: 5px 0;
            }
            
            .context-menu-item.has-submenu .submenu-indicator {
                position: absolute;
                right: 10px;
                font-size: 0.7em;
            }
            
            .context-submenu {
                margin-top: -5px;
            }
            
            /* Group indicators */
            .group-indicator {
                position: absolute;
                top: 5px;
                right: 30px;
                background: var(--accent-color);
                color: white;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                z-index: 10;
            }
            
            .window-grouped {
                box-shadow: 0 0 0 2px var(--accent-color), 0 2px 10px rgba(0, 0, 0, 0.2);
            }
            
            .grouping-source {
                box-shadow: 0 0 0 3px #f39c12, 0 2px 10px rgba(0, 0, 0, 0.2);
            }
            
            .grouping-target {
                position: relative;
            }
            
            .grouping-target::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border: 2px dashed #f39c12;
                pointer-events: none;
                z-index: 10;
                animation: pulse 1.5s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }
            
            body.grouping-active {
                cursor: crosshair;
            }
            
            /* Theme selector */
            .theme-selector {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.9);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 400px;
                padding: 20px;
                color: var(--window-text);
                z-index: 5000;
                opacity: 0;
                transition: opacity 0.3s, transform 0.3s;
            }
            
            .theme-selector.open {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            
            .theme-selector.closing {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            
            .theme-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 10px;
            }
            
            .theme-selector-header h3 {
                margin: 0;
                font-size: 1.2em;
            }
            
            .theme-close-btn {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .theme-selector-content {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .theme-option {
                padding: 15px;
                border-radius: 5px;
                background: rgba(255, 255, 255, 0.05);
                cursor: pointer;
                transition: background 0.2s;
                text-align: center;
            }
            
            .theme-option:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .theme-option.active {
                background: var(--accent-color);
            }
            
            .theme-color-preview {
                display: flex;
                margin-bottom: 10px;
                justify-content: center;
            }
            
            .theme-color-square {
                width: 20px;
                height: 20px;
                margin: 0 3px;
                border-radius: 3px;
            }
            
            /* Transparency controls */
            .transparency-control {
                position: absolute;
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 5px;
                padding: 10px;
                z-index: 1000;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }
            
            .transparency-slider-container {
                display: flex;
                align-items: center;
                margin-right: 10px;
            }
            
            .transparency-slider {
                width: 100px;
                margin-right: 10px;
            }
            
            .transparency-value {
                min-width: 40px;
                text-align: center;
                color: var(--window-text);
            }
            
            .transparency-close {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
            }
            
            /* Window info popup */
            .window-info-popup {
                position: absolute;
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 5px;
                padding: 15px;
                z-index: 1000;
                color: var(--window-text);
                min-width: 300px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }
            
            .window-info-popup h3 {
                margin-top: 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 5px;
            }
            
            .window-info-popup table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
            }
            
            .window-info-popup td {
                padding: 5px;
            }
            
            .window-info-popup td:first-child {
                font-weight: bold;
                width: 40%;
            }
            
            .window-info-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }
            
            .window-info-actions button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
            }
            
            /* Category selector */
            .category-selector {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                padding: 20px;
                z-index: 5000;
                color: var(--window-text);
                width: 300px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            }
            
            .category-selector h3 {
                margin-top: 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 10px;
            }
            
            .category-list {
                margin: 15px 0;
            }
            
            .category-option {
                padding: 10px;
                margin: 5px 0;
                border-radius: 5px;
                background: rgba(255, 255, 255, 0.05);
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .category-option:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .category-close {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 8px 15px;
                cursor: pointer;
                float: right;
            }
            
            .category-indicator {
                position: absolute;
                top: 5px;
                right: 5px;
                background: var(--accent-color);
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.7em;
                pointer-events: none;
            }
            
            /* Search bar */
            .window-search-bar {
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                width: 500px;
                max-width: 90%;
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                z-index: 5000;
            }
            
            .search-input {
                width: 100%;
                padding: 15px;
                font-size: 1.2em;
                background: transparent;
                border: none;
                color: var(--window-text);
                outline: none;
            }
            
            .search-results {
                max-height: 400px;
                overflow-y: auto;
            }
            
            .search-result-item {
                padding: 10px 15px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .search-result-item:hover, .search-result-item.focused {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .search-result-title {
                font-weight: bold;
                margin-bottom: 5px;
                color: var(--window-text);
            }
            
            .search-result-meta {
                font-size: 0.8em;
                color: rgba(255, 255, 255, 0.6);
            }
            
            .search-highlight {
                background-color: rgba(52, 152, 219, 0.3);
                padding: 0 2px;
                border-radius: 2px;
            }
            
            .search-no-results {
                padding: 15px;
                text-align: center;
                color: rgba(255, 255, 255, 0.6);
                font-style: italic;
            }
            
            /* Tabbed Windows */
            .window-tab-bar {
                display: flex;
                overflow-x: auto;
                background: rgba(0, 0, 0, 0.2);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .window-tab {
                padding: 8px 15px;
                display: flex;
                align-items: center;
                min-width: 100px;
                max-width: 200px;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
                position: relative;
                background: rgba(0, 0, 0, 0.2);
                color: var(--window-text);
            }
            
            .window-tab.active-tab {
                background: rgba(52, 152, 219, 0.3);
            }
            
            .tab-title {
                flex-grow: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-size: 0.9em;
            }
            
            .tab-close {
                background: none;
                border: none;
                color: var(--window-text);
                font-size: 0.8em;
                cursor: pointer;
                opacity: 0.7;
                margin-left: 5px;
            }
            
            .tab-close:hover {
                opacity: 1;
            }
            
            .new-tab-btn {
                padding: 8px 15px;
                background: transparent;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .new-tab-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            /* Navigation bar */
            .window-nav-bar {
                display: flex;
                align-items: center;
                background: rgba(0, 0, 0, 0.2);
                padding: 5px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .nav-back-btn, .nav-forward-btn, .nav-refresh-btn {
                background: transparent;
                border: none;
                color: var(--window-text);
                font-size: 0.9em;
                padding: 5px 10px;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            
            .nav-back-btn:hover, .nav-forward-btn:hover, .nav-refresh-btn:hover {
                opacity: 1;
            }
            
            .nav-back-btn.disabled, .nav-forward-btn.disabled {
                opacity: 0.3;
                cursor: default;
            }
            
            .nav-address-bar {
                flex-grow: 1;
                display: flex;
                margin: 0 10px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 3px;
                overflow: hidden;
            }
            
            .nav-url-input {
                flex-grow: 1;
                background: transparent;
                border: none;
                color: var(--window-text);
                padding: 5px 10px;
                outline: none;
            }
            
            .nav-go-btn {
                background: rgba(0, 0, 0, 0.2);
                border: none;
                color: var(--window-text);
                padding: 5px 10px;
                cursor: pointer;
            }
            
            /* File drop zone */
            .file-drop-zone {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(52, 152, 219, 0.3);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }
            
            .file-drop-zone.active {
                opacity: 1;
                pointer-events: auto;
            }
            
            .file-drop-message {
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 10px;
                padding: 30px;
                text-align: center;
                color: var(--window-text);
            }
            
            .file-drop-message i {
                font-size: 3em;
                margin-bottom: 20px;
                color: var(--accent-color);
            }
            
            /* Desktop widgets */
            .desktop-widget {
                position: absolute;
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                min-width: 200px;
                min-height: 150px;
                z-index: 100;
            }
            
            .widget-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 10px;
                background: var(--window-header);
                cursor: move;
            }
            
            .widget-title {
                color: var(--window-text);
                font-weight: bold;
                font-size: 0.9em;
            }
            
            .widget-controls {
                display: flex;
                gap: 5px;
            }
            
            .widget-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            
            .widget-close:hover {
                opacity: 1;
            }
            
            .widget-content {
                padding: 10px;
                color: var(--window-text);
            }
            
            /* Clock widget */
            .clock-widget {
                text-align: center;
                padding: 10px;
            }
            
            .clock-time {
                font-size: 1.5em;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .clock-date {
                margin-bottom: 10px;
                font-size: 0.9em;
            }
            
            .clock-format {
                font-size: 0.8em;
                margin-top: 10px;
                display: flex;
                justify-content: center;
                gap: 15px;
            }
            
            /* Weather widget */
            .weather-widget {
                padding: 10px;
            }
            
            .weather-search {
                display: flex;
                margin-bottom: 10px;
            }
            
            .weather-location-input {
                flex-grow: 1;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                padding: 5px 10px;
                border-radius: 3px;
                color: var(--window-text);
                outline: none;
            }
            
            .weather-search-btn {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                margin-left: 5px;
                cursor: pointer;
            }
            
            .weather-content {
                text-align: center;
            }
            
            .weather-location {
                font-weight: bold;
                font-size: 1.2em;
                margin-bottom: 5px;
            }
            
            .weather-icon {
                font-size: 2em;
                margin: 10px 0;
                color: var(--accent-color);
            }
            
            .weather-temp {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .weather-details {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 10px;
                font-size: 0.9em;
            }
            
            /* Notes widget */
            .notes-widget {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            .notes-content {
                flex-grow: 1;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                padding: 10px;
                color: var(--window-text);
                resize: none;
                outline: none;
                min-height: 100px;
                font-family: inherit;
            }
            
            .notes-footer {
                display: flex;
                justify-content: space-between;
                margin-top: 10px;
                gap: 10px;
            }
            
            .notes-footer button {
                flex-grow: 1;
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
            }
            
            /* Calculator widget */
            .calculator-widget {
                padding: 10px;
            }
            
            .calculator-display {
                width: 100%;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--window-text);
                padding: 10px;
                margin-bottom: 10px;
                text-align: right;
                font-size: 1.2em;
            }
            
            .calculator-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
            }
            
            .calc-btn {
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--window-text);
                padding: 10px;
                cursor: pointer;
                border-radius: 3px;
            }
            
            .calc-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .calc-btn.calc-operator {
                background: rgba(52, 152, 219, 0.3);
            }
            
            .calc-btn.calc-equals {
                background: rgba(46, 204, 113, 0.3);
            }
            
            .calc-btn.calc-clear {
                background: rgba(231, 76, 60, 0.3);
            }
            
            /* Calendar widget */
            .calendar-widget {
                padding: 10px;
            }
            
            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .calendar-prev-month, .calendar-next-month {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                opacity: 0.7;
            }
            
            .calendar-prev-month:hover, .calendar-next-month:hover {
                opacity: 1;
            }
            
            .calendar-month-year {
                text-align: center;
                flex-grow: 1;
            }
            
            .calendar-month {
                font-weight: bold;
                margin-right: 5px;
            }
            
            .calendar-days-header {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                text-align: center;
                font-weight: bold;
                margin-bottom: 5px;
                font-size: 0.8em;
            }
            
            .calendar-days {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
            }
            
            .calendar-day {
                text-align: center;
                padding: 5px;
                border-radius: 3px;
                cursor: pointer;
            }
            
            .calendar-day:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .calendar-day.empty {
                cursor: default;
            }
            
            .calendar-day.current-day {
                background: var(--accent-color);
                color: white;
                font-weight: bold;
            }
            
            /* System widget */
            .system-widget {
                padding: 10px;
            }
            
            .system-header {
                font-weight: bold;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .system-info-row {
                display: flex;
                margin-bottom: 8px;
                font-size: 0.9em;
            }
            
            .system-info-label {
                font-weight: bold;
                width: 120px;
            }
            
            .memory-bar {
                height: 8px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 5px;
                width: 100%;
            }
            
            .memory-bar-fill {
                height: 100%;
                background: var(--accent-color);
                width: 50%;
            }
            
            .system-footer {
                margin-top: 15px;
                text-align: right;
            }
            
            .system-refresh {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
            }
            
            /* Widget selector */
            .widget-selector {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 400px;
                padding: 20px;
                color: var(--window-text);
                z-index: 5000;
            }
            
            .widget-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 10px;
            }
            
            .widget-selector-header h3 {
                margin: 0;
            }
            
            .widget-selector-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .widget-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
            
            .widget-item {
                text-align: center;
                padding: 15px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .widget-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .widget-item i {
                font-size: 2em;
                margin-bottom: 10px;
                color: var(--accent-color);
            }
            
            .widget-item span {
                display: block;
            }
            
            /* Chat panel */
            .chat-panel {
                position: fixed;
                bottom: var(--taskbar-height);
                right: 10px;
                width: 300px;
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px 8px 0 0;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
                z-index: 4000;
                transform: translateY(calc(100% - 40px));
                transition: transform 0.3s;
            }
            
            .chat-panel.open {
                transform: translateY(0);
            }
            
            .chat-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background: var(--window-header);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
            }
            
            .chat-header h3 {
                margin: 0;
                font-size: 1em;
                color: var(--window-text);
            }
            
            .chat-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                opacity: 0.7;
            }
            
            .chat-close:hover {
                opacity: 1;
            }
            
            .chat-messages {
                flex-grow: 1;
                padding: 10px;
                overflow-y: auto;
                max-height: 300px;
                color: var(--window-text);
            }
            
            .chat-message {
                margin-bottom: 10px;
                padding: 8px 12px;
                border-radius: 5px;
                max-width: 80%;
                position: relative;
            }
            
            .chat-message.user-message {
                background: var(--accent-color);
                color: white;
                margin-left: auto;
                border-bottom-right-radius: 0;
            }
            
            .chat-message.system-message {
                background: rgba(255, 255, 255, 0.1);
                margin-right: auto;
                border-bottom-left-radius: 0;
            }
            
            .message-sender {
                font-weight: bold;
                font-size: 0.8em;
                margin-bottom: 3px;
            }
            
            .message-time {
                font-size: 0.7em;
                opacity: 0.7;
                text-align: right;
                margin-top: 3px;
            }
            
            .chat-input-container {
                display: flex;
                padding: 10px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .chat-input {
                flex-grow: 1;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                padding: 8px 12px;
                color: var(--window-text);
                outline: none;
            }
            
            .chat-send {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 8px 12px;
                margin-left: 5px;
                cursor: pointer;
            }
            
            /* Voice UI */
            .voice-ui {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 50%;
                width: 120px;
                height: 120px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                z-index: 5000;
            }
            
            .voice-indicator {
                position: relative;
                width: 80px;
                height: 80px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .voice-waves {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 50%;
                border: 2px solid var(--accent-color);
                animation: pulse 2s infinite;
            }
            
            .voice-ui i {
                font-size: 2em;
                color: var(--accent-color);
            }
            
            .voice-text {
                margin-top: 10px;
                color: var(--window-text);
                font-size: 0.9em;
                text-align: center;
            }
            
            .voice-help-window {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 400px;
                color: var(--window-text);
                z-index: 5001;
                overflow: hidden;
            }
            
            .voice-help-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--window-header);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .voice-help-header h3 {
                margin: 0;
            }
            
            .voice-help-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .voice-help-content {
                padding: 15px;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .voice-help-content ul {
                padding-left: 20px;
            }
            
            .voice-help-content li {
                margin-bottom: 8px;
            }
            
            /* Template selector */
            .template-selector {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 400px;
                padding: 20px;
                color: var(--window-text);
                z-index: 5000;
            }
            
            .template-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 10px;
            }
            
            .template-selector-header h3 {
                margin: 0;
            }
            
            .template-selector-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .template-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .template-item {
                text-align: center;
                padding: 15px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .template-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .template-item i {
                font-size: 2em;
                margin-bottom: 10px;
                color: var(--accent-color);
            }
            
            .template-item span {
                display: block;
                margin-bottom: 5px;
            }
            
            .template-size {
                font-size: 0.8em;
                opacity: 0.7;
            }
            
            /* Share panel */
            .share-panel {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 350px;
                color: var(--window-text);
                z-index: 5000;
                overflow: hidden;
            }
            
            .share-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--window-header);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .share-header h3 {
                margin: 0;
            }
            
            .share-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .share-content {
                padding: 15px;
            }
            
            .share-option {
                display: flex;
                align-items: center;
                padding: 15px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.2s;
                margin-bottom: 10px;
            }
            
            .share-option:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .share-option i {
                font-size: 1.5em;
                margin-right: 15px;
                color: var(--accent-color);
            }
            
            .share-indicator {
                position: fixed;
                bottom: var(--taskbar-height);
                left: 10px;
                background: rgba(231, 76, 60, 0.8);
                color: white;
                padding: 8px 15px;
                border-radius: 5px;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 4000;
            }
            
            .share-indicator.window-share {
                background: rgba(52, 152, 219, 0.8);
            }
            
            .share-indicator i {
                font-size: 1.2em;
            }
            
            .share-stop {
                background: rgba(0, 0, 0, 0.2);
                border: none;
                color: white;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                margin-left: 10px;
            }
            
            .window-selector {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 400px;
                color: var(--window-text);
                z-index: 5001;
                overflow: hidden;
            }
            
            .window-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--window-header);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .window-selector-header h3 {
                margin: 0;
            }
            
            .window-selector-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .window-selector-content {
                padding: 15px;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .window-option {
                display: flex;
                align-items: center;
                padding: 10px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.2s;
                margin-bottom: 10px;
            }
            
            .window-option:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .window-preview {
                width: 50px;
                height: 50px;
                background: rgba(0, 0, 0, 0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 15px;
                border-radius: 3px;
            }
            
            .window-preview i {
                font-size: 1.5em;
                color: var(--accent-color);
            }
            
            .screenshot-flash {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 10000;
                opacity: 0;
                pointer-events: none;
                animation: flash 0.5s forwards;
            }
            
            @keyframes flash {
                0% { opacity: 0; }
                10% { opacity: 1; }
                100% { opacity: 0; }
            }
            
            .window-sharing {
                outline: 3px solid rgba(52, 152, 219, 0.8);
                box-shadow: 0 0 10px rgba(52, 152, 219, 0.8);
                z-index: 1001 !important;
            }
            
            /* Accessibility panel */
            .accessibility-panel {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--window-bg);
                border: var(--window-border);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                width: 400px;
                color: var(--window-text);
                z-index: 5000;
                overflow: hidden;
            }
            
            .accessibility-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--window-header);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .accessibility-header h3 {
                margin: 0;
            }
            
            .accessibility-close {
                background: none;
                border: none;
                color: var(--window-text);
                cursor: pointer;
                font-size: 1.2em;
            }
            
            .accessibility-content {
                padding: 15px;
            }
            
            .accessibility-option {
                margin-bottom: 15px;
            }
            
            .accessibility-option label {
                display: block;
                margin-bottom: 5px;
            }
            
            .accessibility-footer {
                display: flex;
                justify-content: space-between;
                padding: 15px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .accessibility-footer button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 8px 15px;
                cursor: pointer;
            }
            
            .accessibility-footer .accessibility-reset {
                background: rgba(0, 0, 0, 0.2);
            }
            
            /* Settings window */
            .settings-container {
                display: flex;
                height: 100%;
                color: var(--window-text);
            }
            
            .settings-sidebar {
                width: 200px;
                background: rgba(0, 0, 0, 0.2);
                padding: 15px 0;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .settings-nav-item {
                padding: 10px 15px;
                display: flex;
                align-items: center;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .settings-nav-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .settings-nav-item.active {
                background: var(--accent-color);
            }
            
            .settings-nav-item i {
                margin-right: 10px;
                width: 20px;
                text-align: center;
            }
            
            .settings-content {
                flex-grow: 1;
                padding: 20px;
                overflow-y: auto;
            }
            
            .settings-section {
                display: none;
            }
            
            .settings-section.active {
                display: block;
            }
            
            .settings-section h2 {
                margin-top: 0;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .settings-option {
                margin-bottom: 20px;
            }
            
            .settings-description {
                font-size: 0.9em;
                opacity: 0.7;
                margin-top: 5px;
            }
            
            .settings-button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 8px 15px;
                cursor: pointer;
            }
            
            .workspace-name-editor {
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .workspace-name-input input {
                width: 100%;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                padding: 8px;
                color: var(--window-text);
            }
            
            .shortcuts-list {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                margin-top: 10px;
            }
            
            .shortcuts-list table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .shortcuts-list th, .shortcuts-list td {
                padding: 8px 15px;
                text-align: left;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .shortcuts-list th {
                background: rgba(0, 0, 0, 0.2);
            }
            
            .shortcut-key {
                font-family: monospace;
                background: rgba(0, 0, 0, 0.2);
                padding: 2px 5px;
                border-radius: 3px;
            }
            
            .about-content {
                text-align: center;
            }
            
            .about-logo {
                font-size: 2em;
                margin-bottom: 20px;
            }
            
            .about-logo i {
                color: var(--accent-color);
                margin-right: 10px;
            }
            
            .about-info {
                margin-bottom: 20px;
            }
            
            .feature-list {
                text-align: left;
            }
            
            .feature-list ul {
                padding-left: 20px;
            }
            
            .feature-list li {
                margin-bottom: 5px;
            }
            
            /* Terminal styles */
            .terminal-container {
                height: 100%;
                background: #000;
                color: #0f0;
                padding: 10px;
                font-family: monospace;
                display: flex;
                flex-direction: column;
            }
            
            .terminal-output {
                flex-grow: 1;
                overflow-y: auto;
                padding-bottom: 10px;
            }
            
            .terminal-line {
                margin-bottom: 5px;
                white-space: pre-wrap;
                word-break: break-all;
            }
            
            .terminal-system {
                color: #0f0;
            }
            
            .terminal-command {
                color: #fff;
            }
            
            .terminal-output {
                color: #0ff;
            }
            
            .terminal-error {
                color: #f00;
            }
            
            .terminal-input-line {
                display: flex;
                align-items: center;
            }
            
            .terminal-prompt {
                color: #0f0;
                margin-right: 5px;
            }
            
            .terminal-input {
                flex-grow: 1;
                background: transparent;
                border: none;
                color: #fff;
                font-family: monospace;
                outline: none;
            }
            
            /* Image viewer */
            .image-viewer {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .image-viewer img {
                max-width: 100%;
                max-height: calc(100% - 40px);
                object-fit: contain;
                margin: auto;
                transition: transform 0.3s;
            }
            
            .image-controls {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 10px;
                background: rgba(0, 0, 0, 0.2);
            }
            
            .image-controls button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
            }
            
            /* File viewers */
            .text-editor {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .editor-toolbar {
                display: flex;
                align-items: center;
                padding: 10px;
                background: rgba(0, 0, 0, 0.2);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .editor-toolbar button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
                margin-right: 10px;
            }
            
            .file-info {
                margin-left: auto;
                font-size: 0.9em;
                opacity: 0.7;
            }
            
            .editor-textarea {
                flex-grow: 1;
                background: rgba(0, 0, 0, 0.1);
                border: none;
                color: var(--window-text);
                padding: 10px;
                font-family: monospace;
                resize: none;
                outline: none;
            }
            
            /* Video player */
            .video-player {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .video-player video {
                max-width: 100%;
                max-height: calc(100% - 40px);
                margin: auto;
            }
            
            .video-info {
                display: flex;
                justify-content: space-between;
                padding: 10px;
                background: rgba(0, 0, 0, 0.2);
                font-size: 0.9em;
            }
            
            /* Audio player */
            .audio-player {
                padding: 10px;
            }
            
            .audio-waveform {
                height: 100px;
                background: rgba(0, 0, 0, 0.2);
                margin-bottom: 10px;
                border-radius: 3px;
            }
            
            .audio-controls {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .audio-controls button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px 10px;
                cursor: pointer;
            }
            
            .audio-progress {
                flex-grow: 1;
                height: 5px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 3px;
                overflow: hidden;
            }
            
            .audio-progress-bar {
                height: 100%;
                background: var(--accent-color);
                width: 0;
            }
            
            .audio-info {
                display: flex;
                justify-content: space-between;
                font-size: 0.9em;
                opacity: 0.7;
            }
            
            /* File info viewer */
            .file-info-viewer {
                padding: 20px;
                display: flex;
                align-items: center;
            }
            
            .file-icon {
                font-size: 3em;
                margin-right: 20px;
                color: var(--accent-color);
            }
            
            .file-details {
                flex-grow: 1;
            }
            
            .file-details h2 {
                margin-top: 0;
                margin-bottom: 15px;
            }
            
            .file-details table {
                margin-bottom: 20px;
                width: 100%;
            }
            
            .file-details td {
                padding: 5px;
            }
            
            .file-details td:first-child {
                font-weight: bold;
                width: 40%;
            }
            
            .file-actions button {
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 8px 15px;
                cursor: pointer;
            }
            
            /* Workspace control */
            .workspace-control {
                display: flex;
                align-items: center;
                margin-left: 15px;
            }
            
            .workspace-prev, .workspace-next {
                background: none;
                border: none;
                color: var(--window-text);
                font-size: 0.8em;
                cursor: pointer;
                opacity: 0.7;
            }
            
            .workspace-prev:hover, .workspace-next:hover {
                opacity: 1;
            }
            
            .workspace-indicator {
                display: flex;
                gap: 5px;
                margin: 0 10px;
            }
            
            .workspace-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.2);
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .workspace-dot:hover {
                background: rgba(255, 255, 255, 0.4);
            }
            
            .workspace-dot.active {
                background: var(--accent-color);
            }
            
            /* High contrast mode */
            body.high-contrast {
                --window-bg: rgba(0, 0, 0, 0.95);
                --window-border: 2px solid rgba(255, 255, 255, 0.8);
                --window-header: rgba(0, 0, 0, 0.98);
                --window-text: #fff;
                --taskbar-bg: rgba(0, 0, 0, 0.98);
                --accent-color: #ffff00;
                --accent-hover: #ffcc00;
                --notification-bg: rgba(0, 0, 0, 0.98);
            }
            
            body.high-contrast .window-container,
            body.high-contrast .desktop-widget,
            body.high-contrast .context-menu,
            body.high-contrast .widget-selector,
            body.high-contrast .theme-selector,
            body.high-contrast .chat-panel,
            body.high-contrast .voice-ui,
            body.high-contrast .voice-help-window,
            body.high-contrast .accessibility-panel,
            body.high-contrast .window-selector,
            body.high-contrast .share-panel,
            body.high-contrast .template-selector {
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
            }
            
            /* Large text mode */
            body.large-text {
                font-size: 1.2em;
            }
            
            body.large-text .window-title,
            body.large-text .widget-title,
            body.large-text button,
            body.large-text input {
                font-size: 1.1em;
            }
            
            /* Reduce motion */
            body.reduce-motion *,
            body.reduce-motion *::before,
            body.reduce-motion *::after {
                animation-duration: 0.001s !important;
                transition-duration: 0.001s !important;
            }
            
            /* Text size by factor */
            body {
                font-size: calc(1rem * var(--text-size-factor));
            }
        `;
        
        document.head.appendChild(style);
    }

    // Public API
    return {
        // Window management
        createWindow,
        closeWindow: function(windowId) {
            const windowEl = document.getElementById(windowId);
            if (windowEl) {
                const closeBtn = windowEl.querySelector('.close-btn');
                if (closeBtn) closeBtn.click();
            }
        },
        minimizeWindow: function(windowId) {
            const windowEl = document.getElementById(windowId);
            if (windowEl) {
                const minimizeBtn = windowEl.querySelector('.minimize-btn');
                if (minimizeBtn) minimizeBtn.click();
            }
        },
        maximizeWindow: function(windowId) {
            const windowEl = document.getElementById(windowId);
            if (windowEl) {
                const maximizeBtn = windowEl.querySelector('.maximize-btn');
                if (maximizeBtn) maximizeBtn.click();
            }
        },
        focusWindow: function(windowId) {
            setActiveWindow(windowId);
        },
        
        // Window arrangement
        arrangeWindowsCascade,
        arrangeWindowsTile,
        minimizeAll,
        restoreAll,
        
        // Workspace management
        switchToWorkspace,
        prevWorkspace,
        nextWorkspace,
        workspace1,
        workspace2,
        workspace3,
        workspace4,
        
        // Theme management
        applyTheme,
        cycleThemes,
        addCustomTheme,
        
        // Window features
        toggleSnapping,
        toggleGrouping,
        togglePinWindow,
        
        // Search and navigation
        searchWindows,
        
        // Settings
        toggleKeyboardShortcuts,
        toggleSessionPersistence,
        saveSettings,
        showSettingsWindow,
        
        // System functions
        toggleAnimation,
        toggleFullscreen,
        toggleVoiceCommands,
        closeMenu,
        
        // Widgets
        addWidget,
        
        // Initialize the system
        init
    };
})();

// Initialize the system when the DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    cr8OS.init();
});

// Add CSS styles needed for all the advanced features
const cr8OSStyles = document.createElement('style');
cr8OSStyles.textContent = `
    /* Add basic styles for the new window features */
    
    /* Window pin button */
    .pin-btn.active {
        color: var(--accent-color, #3498db);
    }
    
    .window-pinned .pin-btn {
        color: var(--accent-color, #3498db);
    }
    
    /* Taskbar updates */
    #taskbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    #taskbar-left, #taskbar-right {
        display: flex;
        align-items: center;
    }
    
    #taskbar-center {
        flex: 1;
        display: flex;
        justify-content: center;
        overflow-x: auto;
        padding: 0 10px;
    }
    
    .taskbar-window-button {
        padding: 5px 10px;
        margin: 0 2px;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        max-width: 150px;
    }
    
    .taskbar-window-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .taskbar-window-button.active {
        background-color: var(--accent-color, #3498db);
    }
    
    /* Toggle buttons in taskbar */
    .toggle-button {
        background: none;
        border: none;
        color: white;
        font-size: 16px;
        padding: 5px 10px;
        margin: 0 2px;
        cursor: pointer;
        border-radius: 4px;
    }
    
    .toggle-button:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .toggle-button.active {
        color: var(--accent-color, #3498db);
    }
    
    /* Window dragging state */
    .window-container.dragging {
        opacity: 0.8;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
`;

document.head.appendChild(cr8OSStyles);

/**
 * Nara UI - Novel Attire Ranking Algorithm Theme Engine
 * A glass-like UI theme engine that dynamically responds to canvas background movements
 */

const NaraUI = (function() {
    // Private variables
    const state = {
        enabled: true,
        intensity: 0.7,
        reflectionFrequency: 0.3,
        canvasSampleRate: 100, // ms
        glassOpacity: 0.7,
        blurStrength: 10,
        glowStrength: 5,
        accentHue: 210, // Default blue hue
        elementRegistry: new Map(),
        canvasColorData: [],
        animationFrameId: null,
        averageMotion: 0,
        peakMotion: 0,
        motionHistory: [],
        lastSampleTime: 0,
        observer: null,
        initialized: false
    };
    
    // Color extraction and processing util functions
    const colorUtils = {
        // Extract dominant colors from canvas
        extractColorsFromCanvas: function(canvas, samplePoints = 20) {
            if (!canvas || !canvas.getContext) return [];
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Sample points in a grid pattern
            const colors = [];
            const xStep = width / Math.sqrt(samplePoints);
            const yStep = height / Math.sqrt(samplePoints);
            
            for (let x = xStep/2; x < width; x += xStep) {
                for (let y = yStep/2; y < height; y += yStep) {
                    try {
                        const pixel = ctx.getImageData(x, y, 1, 1).data;
                        colors.push({
                            r: pixel[0],
                            g: pixel[1],
                            b: pixel[2],
                            x: x / width,
                            y: y / height
                        });
                    } catch (e) {
                        // Handle potential security errors with cross-origin canvases
                        console.warn("Nara UI: Cannot access canvas data - possible cross-origin restrictions");
                        return [];
                    }
                }
            }
            
            return colors;
        },
        
        // Calculate color brightness (0-1)
        calculateBrightness: function(r, g, b) {
            // Using the perceived brightness formula
            return (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        },
        
        // Calculate color contrast ratio against white
        calculateContrastWithWhite: function(r, g, b) {
            const brightness = this.calculateBrightness(r, g, b);
            const whiteContrast = (brightness + 0.05) / 1.05; // White is 1.0 brightness
            return whiteContrast;
        },
        
        // Calculate contrast ratio against black
        calculateContrastWithBlack: function(r, g, b) {
            const brightness = this.calculateBrightness(r, g, b);
            const blackContrast = 1.05 / (brightness + 0.05); // Black is 0.0 brightness
            return blackContrast;
        },
        
        // Determine if white or black text would be more readable
        getTextColorForBackground: function(r, g, b) {
            const whiteContrast = this.calculateContrastWithWhite(r, g, b);
            const blackContrast = this.calculateContrastWithBlack(r, g, b);
            
            return blackContrast > whiteContrast ? '#000' : '#fff';
        },
        
        // Convert RGB to HSL
        rgbToHsl: function(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                
                h /= 6;
            }
            
            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                l: Math.round(l * 100)
            };
        },
        
        // Calculate average color
        calculateAverageColor: function(colors) {
            if (!colors || colors.length === 0) {
                return { r: 0, g: 0, b: 0 };
            }
            
            let r = 0, g = 0, b = 0;
            
            for (const color of colors) {
                r += color.r;
                g += color.g;
                b += color.b;
            }
            
            r = Math.round(r / colors.length);
            g = Math.round(g / colors.length);
            b = Math.round(b / colors.length);
            
            return { r, g, b };
        },
        
        // Calculate color distance
        colorDistance: function(color1, color2) {
            return Math.sqrt(
                Math.pow(color1.r - color2.r, 2) +
                Math.pow(color1.g - color2.g, 2) +
                Math.pow(color1.b - color2.b, 2)
            );
        },
        
        // Calculate color variance
        calculateColorVariance: function(colors) {
            if (!colors || colors.length <= 1) return 0;
            
            const avgColor = this.calculateAverageColor(colors);
            let totalDistance = 0;
            
            for (const color of colors) {
                totalDistance += this.colorDistance(color, avgColor);
            }
            
            return totalDistance / colors.length;
        }
    };
    
    // Motion detection and processing
    const motionDetector = {
        // Initialize motion detection
        initialize: function() {
            state.motionHistory = Array(10).fill(0);
            state.lastColors = [];
        },
        
        // Detect motion between color samples
        detectMotion: function(newColors) {
            if (!state.lastColors || state.lastColors.length === 0) {
                state.lastColors = newColors;
                return 0;
            }
            
            // Calculate color changes between frames
            const minLength = Math.min(newColors.length, state.lastColors.length);
            let totalMotion = 0;
            
            for (let i = 0; i < minLength; i++) {
                const newColor = newColors[i];
                const lastColor = state.lastColors[i];
                
                // Calculate color difference as motion
                const colorDiff = colorUtils.colorDistance(newColor, lastColor);
                totalMotion += colorDiff;
            }
            
            const avgMotion = totalMotion / minLength;
            
            // Update motion history
            state.motionHistory.shift();
            state.motionHistory.push(avgMotion);
            
            // Update peak motion
            if (avgMotion > state.peakMotion) {
                state.peakMotion = avgMotion;
            } else {
                // Gradually decrease peak to adapt to changing scenes
                state.peakMotion = state.peakMotion * 0.95;
            }
            
            // Update average motion
            state.averageMotion = state.motionHistory.reduce((sum, m) => sum + m, 0) / state.motionHistory.length;
            
            // Store current colors for next comparison
            state.lastColors = newColors;
            
            return avgMotion;
        },
        
        // Get normalized motion (0-1)
        getNormalizedMotion: function() {
            if (state.peakMotion === 0) return 0;
            return Math.min(state.averageMotion / (state.peakMotion * 0.5), 1);
        },
        
        // Check if motion exceeds threshold
        isSignificantMotion: function(threshold = 0.3) {
            return this.getNormalizedMotion() >= threshold;
        }
    };
    
    // Element manager for applying glass effect
    const elementManager = {
        // Register a DOM element for glass effect
        registerElement: function(element, options = {}) {
            if (!element || state.elementRegistry.has(element)) return;
            
            // Default options
            const defaultOptions = {
                glassStrength: 1.0, // 0-1 full glass effect
                reflectionStrength: 1.0, // 0-1 reflection intensity
                reflectionOffset: { x: 0, y: 0 }, // Offset for reflection
                customColors: null, // Override with custom colors
                alwaysOn: false, // Always apply effect regardless of motion
                dynamicTextColor: true, // Change text color based on background
                priority: 0 // Higher priority elements get effects first
            };
            
            const elementOptions = { ...defaultOptions, ...options };
            
            // Add element to registry
            state.elementRegistry.set(element, {
                options: elementOptions,
                originalStyles: {
                    backgroundColor: window.getComputedStyle(element).backgroundColor,
                    boxShadow: window.getComputedStyle(element).boxShadow,
                    color: window.getComputedStyle(element).color,
                    borderColor: window.getComputedStyle(element).borderColor
                },
                reflectionState: 0
            });
            
            // Apply initial glass effect
            this.applyGlassEffect(element);
            
            // Observe element
            if (state.observer) {
                state.observer.observe(element);
            }
        },
        
        // Unregister element
        unregisterElement: function(element) {
            if (!element || !state.elementRegistry.has(element)) return;
            
            // Restore original styles
            const data = state.elementRegistry.get(element);
            element.style.backgroundColor = data.originalStyles.backgroundColor;
            element.style.boxShadow = data.originalStyles.boxShadow;
            
            // If we modified text color, restore it
            if (data.options.dynamicTextColor) {
                element.style.color = data.originalStyles.color;
                element.style.borderColor = data.originalStyles.borderColor;
            }
            
            // Remove backdrop-filter
            element.style.backdropFilter = '';
            element.style.webkitBackdropFilter = '';
            
            // Stop observing
            if (state.observer) {
                state.observer.unobserve(element);
            }
            
            // Remove from registry
            state.elementRegistry.delete(element);
        },
        
        // Apply glass effect to element
        applyGlassEffect: function(element) {
            if (!element || !state.elementRegistry.has(element) || !state.enabled) return;
            
            const data = state.elementRegistry.get(element);
            const options = data.options;
            
            // If element is not visible, skip processing
            if (element.offsetParent === null) return;
            
            // Get element position relative to viewport
            const rect = element.getBoundingClientRect();
            const elementCenterX = (rect.left + rect.right) / 2 / window.innerWidth;
            const elementCenterY = (rect.top + rect.bottom) / 2 / window.innerHeight;
            
            // Get closest colors from canvas samples
            let nearestColors = [];
            const customColors = options.customColors;
            
            if (customColors && Array.isArray(customColors) && customColors.length > 0) {
                // Use custom colors if provided
                nearestColors = customColors;
            } else {
                // Find colors near this element's position
                nearestColors = state.canvasColorData.map(color => {
                    // Calculate distance from element center to this color sample
                    const distance = Math.sqrt(
                        Math.pow(color.x - elementCenterX, 2) +
                        Math.pow(color.y - elementCenterY, 2)
                    );
                    return { ...color, distance };
                })
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5); // Get 5 closest colors
            }
            
            if (nearestColors.length === 0) return;
            
            // Calculate average color for this element
            const avgColor = colorUtils.calculateAverageColor(nearestColors);
            
            // Determine text color based on background
            if (options.dynamicTextColor) {
                const textColor = colorUtils.getTextColorForBackground(avgColor.r, avgColor.g, avgColor.b);
                element.style.color = textColor;
                element.style.borderColor = textColor === '#fff' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';
            }
            
            // Calculate glass effect strength based on motion
            let effectIntensity = options.alwaysOn ? 1 : 
                motionDetector.getNormalizedMotion() * state.intensity;
            
            // Scale by element's glass strength option
            effectIntensity *= options.glassStrength;
            
            // Apply glass effect
            const blurAmount = state.blurStrength * effectIntensity;
            
            // Glass colors slightly adapted to the background
            const glassOpacity = state.glassOpacity;
            const r = avgColor.r;
            const g = avgColor.g;
            const b = avgColor.b;
            
            element.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${glassOpacity * effectIntensity})`;
            element.style.backdropFilter = `blur(${blurAmount}px)`;
            element.style.webkitBackdropFilter = `blur(${blurAmount}px)`; // For Safari
            
            // Update reflection state based on motion
            const shouldReflect = Math.random() < (state.reflectionFrequency * effectIntensity);
            
            if (shouldReflect || options.alwaysOn) {
                // Create reflection/glow effect
                const reflectionStrength = options.reflectionStrength * state.glowStrength * effectIntensity;
                
                // Create dynamic glow based on motion and element position
                const hslColor = colorUtils.rgbToHsl(r, g, b);
                const accentHue = state.accentHue;
                const reflectionHue = (hslColor.h + accentHue) % 360;
                
                // Position for reflection (use offset if provided)
                const offsetX = options.reflectionOffset.x * 100;
                const offsetY = options.reflectionOffset.y * 100;
                
                // Apply reflection with box-shadow and internal gradients
                element.style.boxShadow = `
                    0 0 ${reflectionStrength * 5}px rgba(${r}, ${g}, ${b}, ${0.3 * effectIntensity}),
                    0 0 ${reflectionStrength * 10}px rgba(${r}, ${g}, ${b}, ${0.2 * effectIntensity}),
                    inset 0 0 ${reflectionStrength * 3}px rgba(255, 255, 255, ${0.4 * effectIntensity})
                `;
                
                // Add additional reflection using background-image
                const gradientSize = 200 + (100 * effectIntensity);
                element.style.backgroundImage = `
                    radial-gradient(
                        circle at ${50 + offsetX}% ${50 + offsetY}%, 
                        hsla(${reflectionHue}, 100%, 80%, ${0.2 * effectIntensity}), 
                        transparent ${gradientSize}%
                    )
                `;
                
                // Store reflection state
                data.reflectionState = 1;
            } else if (data.reflectionState > 0) {
                // Gradually fade out reflection
                const fadeSpeed = 0.1;
                data.reflectionState -= fadeSpeed;
                
                if (data.reflectionState <= 0) {
                    data.reflectionState = 0;
                    element.style.boxShadow = '';
                    element.style.backgroundImage = '';
                }
            }
            
            // Update element data
            state.elementRegistry.set(element, data);
        },
        
        // Update all registered elements
        updateAllElements: function() {
            // Sort elements by priority
            const elements = Array.from(state.elementRegistry.entries())
                .sort((a, b) => b[1].options.priority - a[1].options.priority)
                .map(entry => entry[0]);
                
            elements.forEach(element => {
                this.applyGlassEffect(element);
            });
        },
        
        // Auto-register elements matching selectors
        autoRegisterBySelectors: function(selectors, options = {}) {
            if (!selectors) return;
            
            // Convert string to array if needed
            const selectorList = typeof selectors === 'string' ? [selectors] : selectors;
            
            selectorList.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    this.registerElement(element, options);
                });
            });
        }
    };
    
    // Main update cycle
    const updateCycle = {
        // Start the update loop
        start: function() {
            if (state.animationFrameId) return;
            
            const updateLoop = () => {
                const now = performance.now();
                
                // Check if it's time to sample the canvas
                if (now - state.lastSampleTime >= state.canvasSampleRate) {
                    this.updateCanvasData();
                    state.lastSampleTime = now;
                }
                
                // Update glass effects
                elementManager.updateAllElements();
                
                // Continue loop
                state.animationFrameId = requestAnimationFrame(updateLoop);
            };
            
            state.animationFrameId = requestAnimationFrame(updateLoop);
        },
        
        // Stop the update loop
        stop: function() {
            if (state.animationFrameId) {
                cancelAnimationFrame(state.animationFrameId);
                state.animationFrameId = null;
            }
        },
        
        // Update canvas color data for glass effect
        updateCanvasData: function() {
            // Find the canvas element
            const canvas = document.querySelector('canvas');
            if (!canvas) return;
            
            // Extract colors
            const colors = colorUtils.extractColorsFromCanvas(canvas, 30);
            
            // Store for glass effects
            state.canvasColorData = colors;
            
            // Detect motion
            motionDetector.detectMotion(colors);
        }
    };
    
    // Intersection Observer to monitor element visibility
    const createObserver = function() {
        // Only create if supported
        if (!('IntersectionObserver' in window)) return null;
        
        return new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const element = entry.target;
                
                // Skip processing for invisible elements
                if (!entry.isIntersecting) return;
                
                // Process visible elements
                if (state.elementRegistry.has(element)) {
                    elementManager.applyGlassEffect(element);
                }
            });
        }, {
            root: null, // viewport
            rootMargin: '0px',
            threshold: 0.1 // trigger when 10% visible
        });
    };
    
    // Initialize the theme engine
    const initialize = function() {
        if (state.initialized) return;
        
        // Create observer for elements
        state.observer = createObserver();
        
        // Initialize motion detection
        motionDetector.initialize();
        
        // Start update cycle
        updateCycle.start();
        
        // Set up mutation observer to detect new elements
        const mutationObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    // For added nodes that match our auto-register selectors
                    const added = Array.from(mutation.addedNodes).filter(node => 
                        node.nodeType === Node.ELEMENT_NODE);
                    
                    // Handle added elements
                    added.forEach(element => {
                        // Check if element matches known selectors and auto-register
                        // This is simplified - you would maintain a list of selectors to check
                        autoDetectElements(element);
                    });
                }
            });
        });
        
        // Start observing document for element changes
        mutationObserver.observe(document.body, { 
            childList: true, 
            subtree: true 
        });
        
        state.initialized = true;
    };
    
    // Auto-detect and register window and UI elements
    const autoDetectElements = function(rootElement = document.body) {
        // Common window UI element selectors
        const uiSelectors = {
            // Window containers - high priority
            windows: {
                selector: '.window-container',
                options: {
                    glassStrength: 1.0,
                    reflectionStrength: 0.8,
                    dynamicTextColor: false,
                    priority: 10
                }
            },
            // Window headers - highest priority
            headers: {
                selector: '.window-header',
                options: {
                    glassStrength: 1.0,
                    reflectionStrength: 1.0,
                    dynamicTextColor: true,
                    priority: 20
                }
            },
            // Widgets
            widgets: {
                selector: '.desktop-widget',
                options: {
                    glassStrength: 0.9,
                    reflectionStrength: 0.7,
                    dynamicTextColor: false,
                    priority: 5
                }
            },
            // Taskbar
            taskbar: {
                selector: '#taskbar',
                options: {
                    glassStrength: 1.0,
                    reflectionStrength: 0.6,
                    dynamicTextColor: false,
                    alwaysOn: true,
                    priority: 15
                }
            },
            // Context menus
            menus: {
                selector: '.context-menu',
                options: {
                    glassStrength: 0.95,
                    reflectionStrength: 0.6,
                    dynamicTextColor: false,
                    priority: 12
                }
            },
            // Buttons
            buttons: {
                selector: '.create-window-button, .toggle-button',
                options: {
                    glassStrength: 0.8,
                    reflectionStrength: 0.9,
                    dynamicTextColor: true,
                    priority: 8
                }
            },
            // Dialogs and panels
            dialogs: {
                selector: '.theme-selector, .widget-selector, .accessibility-panel, .share-panel',
                options: {
                    glassStrength: 0.9,
                    reflectionStrength: 0.8,
                    dynamicTextColor: false,
                    priority: 15
                }
            },
            // Notification area
            notifications: {
                selector: '#notification-panel, .notification-item',
                options: {
                    glassStrength: 1.0,
                    reflectionStrength: 1.0,
                    dynamicTextColor: true,
                    priority: 18
                }
            }
        };
        
        // Process each selector group
        Object.values(uiSelectors).forEach(({ selector, options }) => {
            let elements;
            
            if (rootElement === document.body) {
                elements = document.querySelectorAll(selector);
            } else {
                // Check if root element itself matches
                if (rootElement.matches(selector)) {
                    elements = [rootElement];
                } else {
                    // Check children
                    elements = rootElement.querySelectorAll(selector);
                }
            }
            
            // Register elements
            elements.forEach(element => {
                elementManager.registerElement(element, options);
            });
        });
    };
    
    // Curry function to efficiently update styles
    const createStyleUpdater = function(element, styleProps) {
        // Return a function that applies multiple styles at once
        return function(values) {
            // Apply each style property with the corresponding value
            styleProps.forEach((prop, index) => {
                if (values[index] !== undefined) {
                    element.style[prop] = values[index];
                }
            });
        };
    };
    
    // Public API
    return {
        // Initialize the theme engine
        init: function(options = {}) {
            // Apply configuration options
            if (options.intensity !== undefined) state.intensity = options.intensity;
            if (options.reflectionFrequency !== undefined) state.reflectionFrequency = options.reflectionFrequency;
            if (options.canvasSampleRate !== undefined) state.canvasSampleRate = options.canvasSampleRate;
            if (options.glassOpacity !== undefined) state.glassOpacity = options.glassOpacity;
            if (options.blurStrength !== undefined) state.blurStrength = options.blurStrength;
            if (options.glowStrength !== undefined) state.glowStrength = options.glowStrength;
            if (options.accentHue !== undefined) state.accentHue = options.accentHue;
            
            // Initialize the system
            initialize();
            
            // Auto-detect and register UI elements
            setTimeout(() => {
                autoDetectElements();
            }, 500);
            
            return this;
        },
        
        // Enable/disable the theme engine
        enable: function(enabled = true) {
            state.enabled = enabled;
            
            if (enabled && !state.initialized) {
                this.init();
            } else if (!enabled) {
                updateCycle.stop();
            } else if (enabled && state.initialized) {
                updateCycle.start();
            }
            
            return this;
        },
        
        // Register a DOM element for glass effect
        register: function(element, options = {}) {
            if (!element) return this;
            
            // Support for multiple elements
            if (Array.isArray(element)) {
                element.forEach(el => elementManager.registerElement(el, options));
            } else if (typeof element === 'string') {
                // Support for selector strings
                document.querySelectorAll(element).forEach(el => 
                    elementManager.registerElement(el, options));
            } else {
                // Single element
                elementManager.registerElement(element, options);
            }
            
            return this;
        },
        
        // Unregister element(s)
        unregister: function(element) {
            if (!element) return this;
            
            if (Array.isArray(element)) {
                element.forEach(el => elementManager.unregisterElement(el));
            } else if (typeof element === 'string') {
                document.querySelectorAll(element).forEach(el => 
                    elementManager.unregisterElement(el));
            } else {
                elementManager.unregisterElement(element);
            }
            
            return this;
        },
        
        // Update registered elements manually
        update: function() {
            if (!state.initialized) return this;
            updateCycle.updateCanvasData();
            elementManager.updateAllElements();
            return this;
        },
        
        // Change theme parameters
        setTheme: function(options = {}) {
            if (options.intensity !== undefined) state.intensity = options.intensity;
            if (options.reflectionFrequency !== undefined) state.reflectionFrequency = options.reflectionFrequency;
            if (options.glassOpacity !== undefined) state.glassOpacity = options.glassOpacity;
            if (options.blurStrength !== undefined) state.blurStrength = options.blurStrength;
            if (options.glowStrength !== undefined) state.glowStrength = options.glowStrength;
            if (options.accentHue !== undefined) state.accentHue = options.accentHue;
            
            // Immediate update
            this.update();
            
            return this;
        },
        
        // Create a preset theme
        createPreset: function(name, options = {}) {
            const presets = {
                intense: {
                    intensity: 1.0,
                    reflectionFrequency: 0.5,
                    glassOpacity: 0.75,
                    blurStrength: 15,
                    glowStrength: 8,
                    accentHue: 210
                },
                subtle: {
                    intensity: 0.5,
                    reflectionFrequency: 0.2,
                    glassOpacity: 0.6,
                    blurStrength: 8,
                    glowStrength: 3,
                    accentHue: 210
                },
                warm: {
                    intensity: 0.7,
                    reflectionFrequency: 0.3,
                    glassOpacity: 0.65,
                    blurStrength: 10,
                    glowStrength: 5,
                    accentHue: 30 // Orange/gold
                },
                cool: {
                    intensity: 0.7,
                    reflectionFrequency: 0.3,
                    glassOpacity: 0.65,
                    blurStrength: 10,
                    glowStrength: 5,
                    accentHue: 240 // Blue/purple
                },
                neon: {
                    intensity: 0.8,
                    reflectionFrequency: 0.4,
                    glassOpacity: 0.6,
                    blurStrength: 12,
                    glowStrength: 15,
                    accentHue: 300 // Magenta
                }
            };
            
            // Save new preset if options provided
            if (name && Object.keys(options).length > 0) {
                presets[name] = { ...options };
            }
            
            return presets;
        },
        
        // Apply preset theme
        applyPreset: function(presetName) {
            const presets = this.createPreset();
            
            if (presets[presetName]) {
                this.setTheme(presets[presetName]);
            }
            
            return this;
        },
        
        // Get current settings
        getSettings: function() {
            return {
                enabled: state.enabled,
                intensity: state.intensity,
                reflectionFrequency: state.reflectionFrequency,
                canvasSampleRate: state.canvasSampleRate,
                glassOpacity: state.glassOpacity,
                blurStrength: state.blurStrength,
                glowStrength: state.glowStrength,
                accentHue: state.accentHue,
                motion: motionDetector.getNormalizedMotion(),
                elementCount: state.elementRegistry.size
            };
        }
    };
})();

/**
 * cr8OS Advanced Menu System
 * A comprehensive menu system that auto-updates based on detected implementations and open windows
 */

const cr8OSMenu = (function() {
    // Private state
    const state = {
        menuOpen: false,
        subMenuOpen: null,
        menuPosition: { x: 0, y: 0 },
        menuElement: null,
        registeredApps: {},
        pinnedApps: [],
        recentApps: [],
        initialized: false,
        categories: {
            system: { icon: 'cog', name: 'System', items: [] },
            productivity: { icon: 'briefcase', name: 'Productivity', items: [] },
            media: { icon: 'photo-video', name: 'Media', items: [] },
            development: { icon: 'code', name: 'Development', items: [] },
            utilities: { icon: 'tools', name: 'Utilities', items: [] },
            games: { icon: 'gamepad', name: 'Games', items: [] },
            social: { icon: 'users', name: 'Social', items: [] }
        }
    };
    
    // Template definitions
    const templates = {
        menuContainer: `
            <div class="cr8OS-menu-container">
                <div class="cr8OS-menu-header">
                    <div class="menu-search">
                        <input type="text" placeholder="Search..." class="menu-search-input">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="menu-user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-name">User</div>
                    </div>
                </div>
                <div class="cr8OS-menu-content">
                    <div class="menu-favorites-section">
                        <h3>Pinned</h3>
                        <div class="menu-pinned-apps"></div>
                    </div>
                    <div class="menu-recent-section">
                        <h3>Recent</h3>
                        <div class="menu-recent-apps"></div>
                    </div>
                    <div class="menu-all-apps-section">
                        <h3>All Apps</h3>
                        <div class="menu-category-tabs"></div>
                        <div class="menu-apps-container"></div>
                    </div>
                </div>
                <div class="cr8OS-menu-footer">
                    <button class="menu-footer-button menu-settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                    <button class="menu-footer-button menu-power">
                        <i class="fas fa-power-off"></i>
                        <span>Power</span>
                    </button>
                </div>
            </div>
        `,
        
        appItem: `
            <div class="menu-app-item" data-app-id="{{id}}">
                <div class="app-icon"><i class="fas fa-{{icon}}"></i></div>
                <div class="app-info">
                    <div class="app-name">{{name}}</div>
                    <div class="app-description">{{description}}</div>
                </div>
                <div class="app-actions">
                    <button class="app-pin-button" title="{{pinTitle}}">
                        <i class="fas fa-{{pinIcon}}"></i>
                    </button>
                    <button class="app-more-button" title="More options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        `,
        
        categoryTab: `
            <button class="menu-category-tab {{active}}" data-category="{{id}}">
                <i class="fas fa-{{icon}}"></i>
                <span>{{name}}</span>
            </button>
        `,
        
        appContextMenu: `
            <div class="app-context-menu">
                <div class="context-menu-item" data-action="run">
                    <i class="fas fa-play"></i>
                    <span>Run</span>
                </div>
                <div class="context-menu-item" data-action="{{pinAction}}">
                    <i class="fas fa-{{pinIcon}}"></i>
                    <span>{{pinText}}</span>
                </div>
                <div class="context-menu-item" data-action="newWindow">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Open in new window</span>
                </div>
                {{adminOption}}
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" data-action="properties">
                    <i class="fas fa-info-circle"></i>
                    <span>Properties</span>
                </div>
            </div>
        `,
        
        appPropertiesDialog: `
            <div class="app-properties-dialog">
                <div class="properties-header">
                    <h3>{{name}} Properties</h3>
                    <button class="properties-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="properties-content">
                    <div class="property-item">
                        <div class="property-label">Name:</div>
                        <div class="property-value">{{name}}</div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">Description:</div>
                        <div class="property-value">{{description}}</div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">Category:</div>
                        <div class="property-value">{{category}}</div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">URL:</div>
                        <div class="property-value">{{url}}</div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">Window Template:</div>
                        <div class="property-value">{{template}}</div>
                    </div>
                </div>
            </div>
        `,
        
        powerMenu: `
            <div class="power-menu">
                <div class="power-menu-item" data-action="restart">
                    <i class="fas fa-redo"></i>
                    <span>Restart</span>
                </div>
                <div class="power-menu-item" data-action="shutdown">
                    <i class="fas fa-power-off"></i>
                    <span>Shutdown</span>
                </div>
                <div class="power-menu-separator"></div>
                <div class="power-menu-item" data-action="lock">
                    <i class="fas fa-lock"></i>
                    <span>Lock</span>
                </div>
                <div class="power-menu-item" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log out</span>
                </div>
            </div>
        `
    };
    
    // Render functions
    const renderUtils = {
        // Render template with data
        renderTemplate: function(template, data) {
            let result = template;
            
            // Replace all placeholders
            Object.keys(data).forEach(key => {
                const value = data[key] !== undefined ? data[key] : '';
                const regex = new RegExp(`{{${key}}}`, 'g');
                result = result.replace(regex, value);
            });
            
            return result;
        },
        
        // Create menu element
        createMenuElement: function() {
            // Create container div
            const menuDiv = document.createElement('div');
            menuDiv.className = 'cr8OS-menu';
            menuDiv.innerHTML = templates.menuContainer;
            
            // Add to body
            document.body.appendChild(menuDiv);
            
            // Store reference
            state.menuElement = menuDiv;
            
            // Add event listeners
            this.setupMenuListeners(menuDiv);
            
            return menuDiv;
        },
        
        // Set up menu event listeners
        setupMenuListeners: function(menuEl) {
            if (!menuEl) return;
            
            // Search input
            const searchInput = menuEl.querySelector('.menu-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim().toLowerCase();
                    filterAppsBySearch(query);
                });
                
                // Focus search input when menu opens
                searchInput.addEventListener('focus', function() {
                    // Select all text
                    this.select();
                });
            }
            
            // Category tabs
            menuEl.querySelectorAll('.menu-category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const category = this.dataset.category;
                    showCategoryApps(category);
                });
            });
            
            // Footer buttons
            const settingsBtn = menuEl.querySelector('.menu-settings');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function() {
                    hideMenu();
                    if (typeof cr8OS !== 'undefined' && cr8OS.showSettingsWindow) {
                        cr8OS.showSettingsWindow();
                    }
                });
            }
            
            // Power button
            const powerBtn = menuEl.querySelector('.menu-power');
            if (powerBtn) {
                powerBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showPowerMenu(this);
                });
            }
            
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (state.menuOpen && !e.target.closest('.cr8OS-menu') && 
                    !e.target.closest('#start-button')) {
                    hideMenu();
                }
            });
            
            // Close menu on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && state.menuOpen) {
                    hideMenu();
                }
            });
        },
        
        // Render app item
        renderAppItem: function(app) {
            const isPinned = state.pinnedApps.includes(app.id);
            
            const appData = {
                id: app.id,
                name: app.name,
                description: app.description || 'No description',
                icon: app.icon || 'window-maximize',
                pinIcon: isPinned ? 'thumbtack' : 'thumbtack',
                pinTitle: isPinned ? 'Unpin from menu' : 'Pin to menu'
            };
            
            return this.renderTemplate(templates.appItem, appData);
        },
        
        // Render category tab
        renderCategoryTab: function(category, id, isActive = false) {
            return this.renderTemplate(templates.categoryTab, {
                id: id,
                name: category.name,
                icon: category.icon,
                active: isActive ? 'active' : ''
            });
        },
        
        // Render app context menu
        renderAppContextMenu: function(app) {
            const isPinned = state.pinnedApps.includes(app.id);
            
            const menuData = {
                pinAction: isPinned ? 'unpin' : 'pin',
                pinIcon: isPinned ? 'thumbtack' : 'thumbtack',
                pinText: isPinned ? 'Unpin from menu' : 'Pin to menu',
                adminOption: app.isAdmin ? `
                    <div class="context-menu-item" data-action="runAsAdmin">
                        <i class="fas fa-user-shield"></i>
                        <span>Run as administrator</span>
                    </div>
                ` : ''
            };
            
            return this.renderTemplate(templates.appContextMenu, menuData);
        },
        
        // Render app properties
        renderAppProperties: function(app) {
            return this.renderTemplate(templates.appPropertiesDialog, {
                name: app.name,
                description: app.description || 'No description',
                category: state.categories[app.category]?.name || 'Uncategorized',
                url: app.url || 'Not specified',
                template: app.template || 'Default'
            });
        },
        
        // Render power menu
        renderPowerMenu: function() {
            return templates.powerMenu;
        }
    };
    
    // Menu interaction functions
    function showMenu(x, y) {
        if (!state.menuElement) {
            state.menuElement = renderUtils.createMenuElement();
        }
        
        // Position the menu
        if (x !== undefined && y !== undefined) {
            state.menuPosition = { x, y };
        }
        
        // Show menu
        state.menuElement.style.display = 'block';
        state.menuOpen = true;
        
        // Update menu content
        updateMenuContent();
        
        // Focus search
        setTimeout(() => {
            const search = state.menuElement.querySelector('.menu-search-input');
            if (search) search.focus();
        }, 100);
    }
    
    function hideMenu() {
        if (!state.menuElement) return;
        
        // Hide menu
        state.menuElement.style.display = 'none';
        state.menuOpen = false;
        
        // Hide any open submenus
        hideSubMenus();
    }
    
    function toggleMenu() {
        if (state.menuOpen) {
            hideMenu();
        } else {
            const button = document.getElementById('start-button');
            if (button) {
                const rect = button.getBoundingClientRect();
                showMenu(rect.left, rect.bottom);
            } else {
                showMenu(0, window.innerHeight);
            }
        }
    }
    
    function hideSubMenus() {
        const submenus = document.querySelectorAll('.app-context-menu, .power-menu');
        submenus.forEach(menu => {
            menu.remove();
        });
        state.subMenuOpen = null;
    }
    
    function updateMenuContent() {
        if (!state.menuElement) return;
        
        // Update categories
        updateCategories();
        
        // Update pinned apps
        updatePinnedApps();
        
        // Update recent apps
        updateRecentApps();
        
        // Show apps for active category
        const activeCategory = state.menuElement.querySelector('.menu-category-tab.active');
        const categoryId = activeCategory ? activeCategory.dataset.category : 'productivity';
        showCategoryApps(categoryId);
        
        // Refresh app listeners
        setupAppListeners();
    }
    
    function updateCategories() {
        const tabsContainer = state.menuElement.querySelector('.menu-category-tabs');
        if (!tabsContainer) return;
        
        // Clear existing tabs
        tabsContainer.innerHTML = '';
        
        // Add tabs for each category
        let isFirst = true;
        Object.entries(state.categories).forEach(([id, category]) => {
            // Only add categories that have apps
            if (category.items.length > 0 || id === 'system') {
                const tabHtml = renderUtils.renderCategoryTab(category, id, isFirst);
                tabsContainer.innerHTML += tabHtml;
                isFirst = false;
            }
        });
        
        // Add event listeners
        tabsContainer.querySelectorAll('.menu-category-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active state
                tabsContainer.querySelectorAll('.menu-category-tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                
                // Show apps for this category
                showCategoryApps(this.dataset.category);
            });
        });
    }
    
    function updatePinnedApps() {
        const pinnedContainer = state.menuElement.querySelector('.menu-pinned-apps');
        if (!pinnedContainer) return;
        
        // Clear existing
        pinnedContainer.innerHTML = '';
        
        // Add pinned apps
        if (state.pinnedApps.length === 0) {
            pinnedContainer.innerHTML = '<div class="no-items-message">No pinned apps. Right-click an app to pin it.</div>';
        } else {
            state.pinnedApps.forEach(appId => {
                const app = state.registeredApps[appId];
                if (app) {
                    pinnedContainer.innerHTML += renderUtils.renderAppItem(app);
                }
            });
        }
    }
    
    function updateRecentApps() {
        const recentContainer = state.menuElement.querySelector('.menu-recent-apps');
        if (!recentContainer) return;
        
        // Clear existing
        recentContainer.innerHTML = '';
        
        // Add recent apps
        if (state.recentApps.length === 0) {
            recentContainer.innerHTML = '<div class="no-items-message">No recent apps</div>';
        } else {
            // Show up to 5 most recent
            const recentToShow = state.recentApps.slice(0, 5);
            recentToShow.forEach(appId => {
                const app = state.registeredApps[appId];
                if (app) {
                    recentContainer.innerHTML += renderUtils.renderAppItem(app);
                }
            });
        }
    }
    
    function showCategoryApps(categoryId) {
        const appsContainer = state.menuElement.querySelector('.menu-apps-container');
        if (!appsContainer) return;
        
        // Clear existing
        appsContainer.innerHTML = '';
        
        // Get category
        const category = state.categories[categoryId];
        if (!category) return;
        
        // Add apps for this category
        if (category.items.length === 0) {
            appsContainer.innerHTML = '<div class="no-items-message">No apps in this category</div>';
        } else {
            category.items.forEach(appId => {
                const app = state.registeredApps[appId];
                if (app) {
                    appsContainer.innerHTML += renderUtils.renderAppItem(app);
                }
            });
        }
        
        // Update category tabs active state
        const tabs = state.menuElement.querySelectorAll('.menu-category-tab');
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.category === categoryId);
        });
        
        // Refresh app listeners
        setupAppListeners();
    }
    
    function filterAppsBySearch(query) {
        if (!query) {
            // If empty, restore default view
            const activeTab = state.menuElement.querySelector('.menu-category-tab.active');
            if (activeTab) {
                showCategoryApps(activeTab.dataset.category);
            } else {
                showCategoryApps('productivity');
            }
            return;
        }
        
        const appsContainer = state.menuElement.querySelector('.menu-apps-container');
        if (!appsContainer) return;
        
        // Clear existing
        appsContainer.innerHTML = '';
        
        // Find matching apps
        const matchingApps = Object.values(state.registeredApps).filter(app => {
            return (
                app.name.toLowerCase().includes(query) ||
                (app.description && app.description.toLowerCase().includes(query)) ||
                (app.tags && app.tags.some(tag => tag.toLowerCase().includes(query)))
            );
        });
        
        // Show results
        if (matchingApps.length === 0) {
            appsContainer.innerHTML = '<div class="no-items-message">No matching apps found</div>';
        } else {
            matchingApps.forEach(app => {
                appsContainer.innerHTML += renderUtils.renderAppItem(app);
            });
        }
        
        // Refresh app listeners
        setupAppListeners();
    }
    
    function setupAppListeners() {
        if (!state.menuElement) return;
        
        // App click handlers
        state.menuElement.querySelectorAll('.menu-app-item').forEach(appItem => {
            // Get app ID
            const appId = appItem.dataset.appId;
            if (!appId || !state.registeredApps[appId]) return;
            
            const app = state.registeredApps[appId];
            
            // Run app on click
            appItem.addEventListener('click', function(e) {
                if (!e.target.closest('.app-actions')) {
                    launchApp(app);
                }
            });
            
            // Pin/unpin button
            const pinBtn = appItem.querySelector('.app-pin-button');
            if (pinBtn) {
                pinBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePinApp(appId);
                });
            }
            
            // More options button
            const moreBtn = appItem.querySelector('.app-more-button');
            if (moreBtn) {
                moreBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showAppContextMenu(app, this);
                });
            }
        });
    }
    
    function showAppContextMenu(app, buttonEl) {
        // Hide any existing submenus
        hideSubMenus();
        
        // Create context menu
        const contextMenu = document.createElement('div');
        contextMenu.innerHTML = renderUtils.renderAppContextMenu(app);
        contextMenu.className = 'menu-context-menu';
        
        // Position near the button
        const buttonRect = buttonEl.getBoundingClientRect();
        document.body.appendChild(contextMenu);
        
        const menuEl = contextMenu.firstElementChild;
        const menuRect = menuEl.getBoundingClientRect();
        
        // Position to the left of the button if it would go off-screen
        if (buttonRect.right + menuRect.width > window.innerWidth) {
            menuEl.style.right = (window.innerWidth - buttonRect.left) + 'px';
        } else {
            menuEl.style.left = buttonRect.right + 'px';
        }
        
        menuEl.style.top = buttonRect.top + 'px';
        
        // Set as current submenu
        state.subMenuOpen = contextMenu;
        
        // Add event listeners
        contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const action = this.dataset.action;
                
                switch (action) {
                    case 'run':
                        launchApp(app);
                        break;
                    case 'pin':
                        togglePinApp(app.id, true);
                        break;
                    case 'unpin':
                        togglePinApp(app.id, false);
                        break;
                    case 'newWindow':
                        launchApp(app, true);
                        break;
                    case 'runAsAdmin':
                        launchApp(app, false, true);
                        break;
                    case 'properties':
                        showAppProperties(app);
                        break;
                }
                
                hideSubMenus();
            });
        });
        
        // Close when clicking outside
        const closeHandler = function(e) {
            if (!e.target.closest('.menu-context-menu') && !e.target.closest('.app-more-button')) {
                hideSubMenus();
                document.removeEventListener('click', closeHandler);
            }
        };
        
        // Use setTimeout to avoid triggering the handler immediately
        setTimeout(() => {
            document.addEventListener('click', closeHandler);
        }, 0);
    }
    
    function showPowerMenu(buttonEl) {
        // Hide any existing submenus
        hideSubMenus();
        
        // Create power menu
        const powerMenu = document.createElement('div');
        powerMenu.innerHTML = renderUtils.renderPowerMenu();
        powerMenu.className = 'menu-power-submenu';
        
        // Position near the button
        const buttonRect = buttonEl.getBoundingClientRect();
        document.body.appendChild(powerMenu);
        
        const menuEl = powerMenu.firstElementChild;
        
        // Position above the button
        menuEl.style.bottom = (window.innerHeight - buttonRect.top) + 'px';
        menuEl.style.left = buttonRect.left + 'px';
        
        // Set as current submenu
        state.subMenuOpen = powerMenu;
        
        // Add event listeners
        powerMenu.querySelectorAll('.power-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const action = this.dataset.action;
                
                switch (action) {
                    case 'restart':
                        handlePowerAction('restart');
                        break;
                    case 'shutdown':
                        handlePowerAction('shutdown');
                        break;
                    case 'lock':
                        handlePowerAction('lock');
                        break;
                    case 'logout':
                        handlePowerAction('logout');
                        break;
                }
                
                hideSubMenus();
                hideMenu();
            });
        });
        
        // Close when clicking outside
        const closeHandler = function(e) {
            if (!e.target.closest('.menu-power-submenu') && !e.target.closest('.menu-power')) {
                hideSubMenus();
                document.removeEventListener('click', closeHandler);
            }
        };
        
        // Use setTimeout to avoid triggering the handler immediately
        setTimeout(() => {
            document.addEventListener('click', closeHandler);
        }, 0);
    }
    
    function showAppProperties(app) {
        // Create properties dialog
        const dialogContainer = document.createElement('div');
        dialogContainer.className = 'app-properties-container';
        dialogContainer.innerHTML = renderUtils.renderAppProperties(app);
        
        // Add to body
        document.body.appendChild(dialogContainer);
        
        // Add close handler
        const closeBtn = dialogContainer.querySelector('.properties-close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                dialogContainer.remove();
            });
        }
        
        // Close on click outside
        dialogContainer.addEventListener('click', function(e) {
            if (e.target === dialogContainer) {
                dialogContainer.remove();
            }
        });
        
        // Close on escape key
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                dialogContainer.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        
        document.addEventListener('keydown', escHandler);
    }
    
    // Menu action functions
    function launchApp(app, newWindow = false, asAdmin = false) {
        if (!app || !app.url) return;
        
        // Add to recent apps
        addToRecentApps(app.id);
        
        // Hide menu
        hideMenu();
        
        // Launch the app
        try {
            if (typeof cr8OS !== 'undefined' && cr8OS.createWindow) {
                // Use template if provided
                if (app.template && typeof cr8OS.createWindowFromTemplate === 'function') {
                    cr8OS.createWindowFromTemplate(app.template);
                } else {
                    // Standard window
                    cr8OS.createWindow(app.url, app.name);
                }
            } else {
                // Fallback: open in a new tab
                window.open(app.url, newWindow ? '_blank' : '_self');
            }
            
            // Show notification
            if (typeof addNotification === 'function') {
                addNotification('Application Launched', `${app.name} is starting...`);
            }
        } catch (error) {
            console.error('Error launching app:', error);
        }
    }
    
    function togglePinApp(appId, pinned) {
        if (!appId || !state.registeredApps[appId]) return;
        
        // If pinned is not explicitly provided, toggle the current state
        if (pinned === undefined) {
            pinned = !state.pinnedApps.includes(appId);
        }
        
        if (pinned) {
            // Add to pinned apps if not already there
            if (!state.pinnedApps.includes(appId)) {
                state.pinnedApps.push(appId);
            }
        } else {
            // Remove from pinned apps
            state.pinnedApps = state.pinnedApps.filter(id => id !== appId);
        }
        
        // Save changes
        savePinnedApps();
        
        // Update menu
        updateMenuContent();
    }
    
    function addToRecentApps(appId) {
        if (!appId || !state.registeredApps[appId]) return;
        
        // Remove if already exists
        state.recentApps = state.recentApps.filter(id => id !== appId);
        
        // Add to start of array
        state.recentApps.unshift(appId);
        
        // Limit to last 10
        state.recentApps = state.recentApps.slice(0, 10);
        
        // Save changes
        saveRecentApps();
    }
    
    function handlePowerAction(action) {
        switch (action) {
            case 'restart':
                if (confirm('Do you want to restart the application?')) {
                    window.location.reload();
                }
                break;
            case 'shutdown':
                if (confirm('Do you want to close the application?')) {
                    // First try to close all windows
                    if (typeof cr8OS !== 'undefined' && cr8OS.closeAllWindows) {
                        cr8OS.closeAllWindows();
                    }
                    
                    // Show goodbye message (simulated shutdown)
                    const shutdownScreen = document.createElement('div');
                    shutdownScreen.className = 'shutdown-screen';
                    shutdownScreen.innerHTML = `
                        <div class="shutdown-message">
                            <i class="fas fa-power-off"></i>
                            <p>Shutting down...</p>
                        </div>
                    `;
                    document.body.appendChild(shutdownScreen);
                    
                    // Simulate shutdown after delay
                    setTimeout(() => {
                        if (window.close) {
                            window.close();
                        } else {
                            // If window.close() doesn't work (common in browsers)
                            // Redirect to a blank page
                            window.location.href = 'about:blank';
                        }
                    }, 2000);
                }
                break;
            case 'lock':
                // Simulate lock screen
                const lockScreen = document.createElement('div');
                lockScreen.className = 'lock-screen';
                lockScreen.innerHTML = `
                    <div class="lock-content">
                        <div class="lock-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="lock-user">User</div>
                        <div class="lock-input">
                            <input type="password" placeholder="Password" class="lock-password">
                            <button class="lock-submit"><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                `;
                document.body.appendChild(lockScreen);
                
                // Focus password input
                const passwordInput = lockScreen.querySelector('.lock-password');
                if (passwordInput) {
                    setTimeout(() => passwordInput.focus(), 100);
                }
                
                // Unlock handler
                lockScreen.querySelector('.lock-submit').addEventListener('click', function() {
                    lockScreen.classList.add('unlocking');
                    setTimeout(() => lockScreen.remove(), 500);
                });
                
                // Also unlock on Enter key
                lockScreen.querySelector('.lock-password').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        lockScreen.classList.add('unlocking');
                        setTimeout(() => lockScreen.remove(), 500);
                    }
                });
                break;
            case 'logout':
                if (confirm('Log out? All unsaved changes will be lost.')) {
                    // Clear session data
                    if (typeof cr8OS !== 'undefined' && cr8OS.clearAllData) {
                        cr8OS.clearAllData();
                    }
                    
                    // Reload page
                    window.location.reload();
                }
                break;
        }
    }
    
    // Storage functions
    function savePinnedApps() {
        try {
            localStorage.setItem('cr8OS-pinned-apps', JSON.stringify(state.pinnedApps));
        } catch (error) {
            console.error('Error saving pinned apps:', error);
        }
    }
    
    function loadPinnedApps() {
        try {
            const saved = localStorage.getItem('cr8OS-pinned-apps');
            if (saved) {
                state.pinnedApps = JSON.parse(saved);
            }
        } catch (error) {
            console.error('Error loading pinned apps:', error);
        }
    }
    
    function saveRecentApps() {
        try {
            localStorage.setItem('cr8OS-recent-apps', JSON.stringify(state.recentApps));
        } catch (error) {
            console.error('Error saving recent apps:', error);
        }
    }
    
    function loadRecentApps() {
        try {
            const saved = localStorage.getItem('cr8OS-recent-apps');
            if (saved) {
                state.recentApps = JSON.parse(saved);
            }
        } catch (error) {
            console.error('Error loading recent apps:', error);
        }
    }
    
    // Auto-discovery of apps and windows
    function discoverInstalledApps() {
        // Default system apps
        const systemApps = [
            {
                id: 'settings',
                name: 'Settings',
                description: 'System settings and configuration',
                icon: 'cog',
                category: 'system',
                url: '#settings',
                run: function() {
                    if (typeof cr8OS !== 'undefined' && cr8OS.showSettingsWindow) {
                        cr8OS.showSettingsWindow();
                    }
                }
            },
            {
                id: 'file-explorer',
                name: 'File Explorer',
                description: 'Browse and manage files',
                icon: 'folder',
                category: 'system',
                url: '#file-explorer',
                template: 'explorer'
            },
            {
                id: 'task-manager',
                name: 'Task Manager',
                description: 'Monitor system resources and running applications',
                icon: 'tasks',
                category: 'system',
                url: '#task-manager'
            }
        ];
        
        // Register system apps
        systemApps.forEach(app => {
            registerApp(app);
        });
        
        // Look for button elements with URLs
        document.querySelectorAll('.create-window-button').forEach(button => {
            const url = button.getAttribute('data-url');
            const title = button.textContent.trim();
            
            if (url && title) {
                // Generate ID from title
                const id = title
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
                
                // Skip if already registered
                if (state.registeredApps[id]) return;
                
                // Register as an app
                registerApp({
                    id: id,
                    name: title,
                    description: 'Application',
                    url: url,
                    category: guessCategory(title, url),
                    icon: guessIcon(title, url)
                });
            }
        });
        
        // Look for iframes in existing windows
        document.querySelectorAll('.window-container').forEach(window => {
            const iframe = window.querySelector('iframe');
            const title = window.querySelector('.window-title')?.textContent.trim();
            
            if (iframe && iframe.src && title) {
                // Generate ID from title
                const id = title
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
                
                // Skip if already registered
                if (state.registeredApps[id]) return;
                
                // Register as an app
                registerApp({
                    id: id,
                    name: title,
                    description: 'Application',
                    url: iframe.src,
                    category: guessCategory(title, iframe.src),
                    icon: guessIcon(title, iframe.src)
                });
            }
        });
        
        // Look for window templates if available
        if (typeof cr8OS !== 'undefined' && cr8OS.settings && cr8OS.settings.templates) {
            Object.entries(cr8OS.settings.templates).forEach(([name, template]) => {
                // Generate template apps
                const id = 'template-' + name;
                
                // Skip if already registered
                if (state.registeredApps[id]) return;
                
                registerApp({
                    id: id,
                    name: name.charAt(0).toUpperCase() + name.slice(1),
                    description: `${name.charAt(0).toUpperCase() + name.slice(1)} template`,
                    template: name,
                    url: '#' + name,
                    category: guessCategory(name),
                    icon: template.icon || guessIcon(name)
                });
            });
        }
    }
    
    function guessCategory(title, url) {
        // Try to guess category based on title and URL
        title = title.toLowerCase();
        
        // Check URL first
        if (url) {
            url = url.toLowerCase();
            
            if (url.includes('media') || url.includes('video') || url.includes('audio') || url.includes('photo')) {
                return 'media';
            }
            
            if (url.includes('chat') || url.includes('social') || url.includes('message')) {
                return 'social';
            }
            
            if (url.includes('code') || url.includes('dev') || url.includes('editor')) {
                return 'development';
            }
            
            if (url.includes('doc') || url.includes('text') || url.includes('sheet') || url.includes('slide')) {
                return 'productivity';
            }
        }
        
        // Check title
        if (title.includes('edit') || title.includes('note') || title.includes('doc') || 
            title.includes('word') || title.includes('text') || title.includes('write')) {
            return 'productivity';
        }
        
        if (title.includes('media') || title.includes('video') || title.includes('audio') || 
            title.includes('music') || title.includes('photo') || title.includes('image')) {
            return 'media';
        }
        
        if (title.includes('chat') || title.includes('social') || title.includes('message') || 
            title.includes('mail') || title.includes('team')) {
            return 'social';
        }
        
        if (title.includes('code') || title.includes('dev') || title.includes('program') || 
            title.includes('terminal') || title.includes('console')) {
            return 'development';
        }
        
        if (title.includes('game') || title.includes('play')) {
            return 'games';
        }
        
        if (title.includes('settings') || title.includes('config') || title.includes('system') || 
            title.includes('control') || title.includes('admin')) {
            return 'system';
        }
        
        // Default to utilities
        return 'utilities';
    }
    
    function guessIcon(title, url) {
        // Try to guess icon based on title and URL
        title = title.toLowerCase();
        
        // Check specific keywords
        if (title.includes('settings') || title.includes('config') || title.includes('preferences')) {
            return 'cog';
        }
        
        if (title.includes('file') || title.includes('explorer') || title.includes('folder') || 
            title.includes('browse')) {
            return 'folder';
        }
        
        if (title.includes('note') || title.includes('text') || title.includes('edit') || 
            title.includes('doc') || title.includes('word')) {
            return 'file-alt';
        }
        
        if (title.includes('terminal') || title.includes('command') || title.includes('console') || 
            title.includes('shell')) {
            return 'terminal';
        }
        
        if (title.includes('browser') || title.includes('web') || title.includes('internet')) {
            return 'globe';
        }
        
        if (title.includes('media') || title.includes('video') || title.includes('player')) {
            return 'film';
        }
        
        if (title.includes('audio') || title.includes('music') || title.includes('sound')) {
            return 'music';
        }
        
        if (title.includes('photo') || title.includes('image') || title.includes('picture')) {
            return 'image';
        }
        
        if (title.includes('chat') || title.includes('message') || title.includes('talk')) {
            return 'comments';
        }
        
        if (title.includes('mail') || title.includes('email')) {
            return 'envelope';
        }
        
        if (title.includes('calendar') || title.includes('schedule') || title.includes('date')) {
            return 'calendar-alt';
        }
        
        if (title.includes('calculator') || title.includes('calc')) {
            return 'calculator';
        }
        
        if (title.includes('game') || title.includes('play')) {
            return 'gamepad';
        }
        
        if (title.includes('code') || title.includes('dev') || title.includes('program')) {
            return 'code';
        }
        
        // Default icon
        return 'window-maximize';
    }
    
    // Add CSS styles
    function addMenuStyles() {
        const styleEl = document.createElement('style');
        styleEl.id = 'cr8OS-menu-styles';
        styleEl.textContent = `
            /* Main menu */
            .cr8OS-menu {
                position: fixed;
                bottom: 40px;
                left: 0;
                width: 400px;
                max-height: 80vh;
                background: var(--window-bg, rgba(25, 25, 25, 0.9));
                backdrop-filter: blur(10px);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                display: none;
                color: var(--window-text, #fff);
                font-family: sans-serif;
                overflow: hidden;
                border: var(--window-border, 1px solid rgba(255, 255, 255, 0.1));
            }
            
            .cr8OS-menu-container {
                display: flex;
                flex-direction: column;
                height: 100%;
                max-height: 80vh;
            }
            
            /* Menu header */
            .cr8OS-menu-header {
                padding: 15px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .menu-search {
                position: relative;
                flex-grow: 1;
                margin-right: 15px;
            }
            
            .menu-search-input {
                width: 100%;
                padding: 8px 15px 8px 35px;
                border-radius: 20px;
                border: none;
                background: rgba(0, 0, 0, 0.2);
                color: var(--window-text, #fff);
                font-size: 14px;
                outline: none;
            }
            
            .menu-search i {
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: rgba(255, 255, 255, 0.5);
            }
            
            .menu-user-info {
                display: flex;
                align-items: center;
            }
            
            .user-avatar {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background: rgba(0, 0, 0, 0.2);
                display: flex;
                justify-content: center;
                align-items: center;
                margin-right: 8px;
                font-size: 18px;
            }
            
            .user-name {
                font-size: 14px;
                font-weight: 500;
            }
            
            /* Menu content */
            .cr8OS-menu-content {
                flex-grow: 1;
                overflow-y: auto;
                padding: 15px;
            }
            
            .menu-favorites-section,
            .menu-recent-section,
            .menu-all-apps-section {
                margin-bottom: 20px;
            }
            
            .cr8OS-menu-content h3 {
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.6);
                margin-top: 0;
                margin-bottom: 10px;
            }
            
            .menu-pinned-apps,
            .menu-recent-apps {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 10px;
            }
            
            .menu-category-tabs {
                display: flex;
                overflow-x: auto;
                margin-bottom: 15px;
                scrollbar-width: thin;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 5px;
            }
            
            .menu-category-tab {
                padding: 8px 15px;
                background: transparent;
                border: none;
                border-radius: 5px;
                color: var(--window-text, #fff);
                cursor: pointer;
                white-space: nowrap;
                display: flex;
                align-items: center;
                gap: 5px;
                opacity: 0.7;
                transition: opacity 0.2s, background 0.2s;
            }
            
            .menu-category-tab:hover {
                opacity: 1;
                background: rgba(255, 255, 255, 0.1);
            }
            
            .menu-category-tab.active {
                opacity: 1;
                background: var(--accent-color, rgba(52, 152, 219, 0.3));
            }
            
            .menu-apps-container {
                display: grid;
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            /* App items */
            .menu-app-item {
                display: flex;
                align-items: center;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .menu-app-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .app-icon {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                background: var(--accent-color, rgba(52, 152, 219, 0.3));
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 18px;
                margin-right: 12px;
                flex-shrink: 0;
            }
            
            .app-info {
                flex-grow: 1;
                overflow: hidden;
            }
            
            .app-name {
                font-weight: 500;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .app-description {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .app-actions {
                display: flex;
                gap: 5px;
                opacity: 0;
                transition: opacity 0.2s;
            }
            
            .menu-app-item:hover .app-actions {
                opacity: 1;
            }
            
            .app-pin-button,
            .app-more-button {
                background: transparent;
                border: none;
                color: var(--window-text, #fff);
                width: 28px;
                height: 28px;
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }
            
            .app-pin-button:hover,
            .app-more-button:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            /* Menu footer */
            .cr8OS-menu-footer {
                padding: 10px 15px;
                display: flex;
                justify-content: space-between;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .menu-footer-button {
                background: transparent;
                border: none;
                color: var(--window-text, #fff);
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .menu-footer-button:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            /* Context menus */
            .app-context-menu,
            .power-menu {
                position: fixed;
                background: var(--window-bg, rgba(25, 25, 25, 0.9));
                backdrop-filter: blur(10px);
                border-radius: 5px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                min-width: 180px;
                border: var(--window-border, 1px solid rgba(255, 255, 255, 0.1));
                overflow: hidden;
            }
            
            .context-menu-item,
            .power-menu-item {
                padding: 8px 15px;
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .context-menu-item:hover,
            .power-menu-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .context-menu-separator,
            .power-menu-separator {
                height: 1px;
                background: rgba(255, 255, 255, 0.1);
                margin: 5px 0;
            }
            
            /* Properties dialog */
            .app-properties-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
            }
            
            .app-properties-dialog {
                width: 400px;
                background: var(--window-bg, rgba(25, 25, 25, 0.9));
                backdrop-filter: blur(10px);
                border-radius: 8px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                border: var(--window-border, 1px solid rgba(255, 255, 255, 0.1));
            }
            
            .properties-header {
                padding: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .properties-header h3 {
                margin: 0;
                font-size: 16px;
            }
            
            .properties-close-btn {
                background: transparent;
                border: none;
                color: var(--window-text, #fff);
                cursor: pointer;
                font-size: 16px;
            }
            
            .properties-content {
                padding: 15px;
            }
            
            .property-item {
                display: flex;
                margin-bottom: 10px;
            }
            
            .property-label {
                width: 120px;
                font-weight: 500;
            }
            
            .property-value {
                flex-grow: 1;
                word-break: break-word;
            }
            
            /* No items message */
            .no-items-message {
                padding: 15px;
                text-align: center;
                color: rgba(255, 255, 255, 0.5);
                font-style: italic;
            }
            
            /* Power menu */
            .shutdown-screen,
            .lock-screen {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #000;
                z-index: 99999;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #fff;
            }
            
            .shutdown-message {
                text-align: center;
            }
            
            .shutdown-message i {
                font-size: 48px;
                margin-bottom: 15px;
                color: #e74c3c;
            }
            
            .shutdown-message p {
                font-size: 24px;
            }
            
            .lock-content {
                text-align: center;
            }
            
            .lock-avatar {
                font-size: 64px;
                margin-bottom: 15px;
            }
            
            .lock-user {
                font-size: 24px;
                margin-bottom: 15px;
            }
            
            .lock-input {
                display: flex;
                margin-top: 30px;
            }
            
            .lock-password {
                padding: 10px 15px;
                border: none;
                border-radius: 5px 0 0 5px;
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
                font-size: 16px;
            }
            
            .lock-submit {
                padding: 10px 15px;
                background: var(--accent-color, #3498db);
                border: none;
                border-radius: 0 5px 5px 0;
                color: #fff;
                cursor: pointer;
            }
            
            .lock-screen.unlocking {
                animation: fadeOut 0.5s forwards;
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        
        document.head.appendChild(styleEl);
    }
    
    // Add start button to taskbar
    function addStartButton() {
        // Check if taskbar exists
        const taskbar = document.getElementById('taskbar');
        if (!taskbar) return false;
        
        // Check if start button already exists
        if (document.getElementById('start-button')) return true;
        
        // Create start button
        const startButton = document.createElement('button');
        startButton.id = 'start-button';
        startButton.className = 'toggle-button';
        startButton.innerHTML = '<i class="fas fa-th-large"></i>';
        startButton.title = 'Start Menu';
        
        // Add to taskbar
        const leftSection = document.getElementById('taskbar-left');
        if (leftSection) {
            leftSection.insertBefore(startButton, leftSection.firstChild);
        } else {
            taskbar.insertBefore(startButton, taskbar.firstChild);
        }
        
        // Add click handler
        startButton.addEventListener('click', toggleMenu);
        
        return true;
    }
    
    // Initialize function
    function init() {
        if (state.initialized) return;
        
        // Add styles
        addMenuStyles();
        
        // Add start button to taskbar
        addStartButton();
        
        // Create menu element
        renderUtils.createMenuElement();
        
        // Load saved data
        loadPinnedApps();
        loadRecentApps();
        
        // Discover installed apps
        discoverInstalledApps();
        
        // Set up window creation event listener to auto-discover new windows
        document.addEventListener('windowCreated', function(event) {
            if (event.detail && event.detail.window) {
                const window = event.detail.window;
                const iframe = window.querySelector('iframe');
                const title = window.querySelector('.window-title')?.textContent.trim();
                
                if (iframe && iframe.src && title) {
                    // Generate ID from title
                    const id = title
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '');
                    
                    // Skip if already registered
                    if (state.registeredApps[id]) return;
                    
                    // Register as an app
                    registerApp({
                        id: id,
                        name: title,
                        description: 'Application',
                        url: iframe.src,
                        category: guessCategory(title, iframe.src),
                        icon: guessIcon(title, iframe.src)
                    });
                    
                    // Update menu if open
                    if (state.menuOpen) {
                        updateMenuContent();
                    }
                }
            }
        });
        
        // Set up keyboard shortcut for start menu
        document.addEventListener('keydown', function(e) {
            // Windows key (metaKey) or Alt + Space
            if (e.key === 'Meta' || (e.altKey && e.key === ' ')) {
                e.preventDefault();
                toggleMenu();
            }
        });
        
        state.initialized = true;
    }
    
    // Register an app
    function registerApp(app) {
        if (!app || !app.id || !app.name) return;
        
        // Add to registry
        state.registeredApps[app.id] = app;
        
        // Add to category
        const category = app.category || 'utilities';
        if (state.categories[category]) {
            if (!state.categories[category].items.includes(app.id)) {
                state.categories[category].items.push(app.id);
            }
        }
    }
    
    // Public API
    return {
        // Initialize the menu system
        init: function() {
            init();
            return this;
        },
        
        // Show the menu
        show: function(x, y) {
            showMenu(x, y);
            return this;
        },
        
        // Hide the menu
        hide: function() {
            hideMenu();
            return this;
        },
        
        // Toggle menu visibility
        toggle: function() {
            toggleMenu();
            return this;
        },
        
        // Register an app with the menu
        registerApp: function(app) {
            registerApp(app);
            
            // Update menu if open
            if (state.menuOpen) {
                updateMenuContent();
            }
            
            return this;
        },
        
        // Remove an app from the menu
        unregisterApp: function(appId) {
            if (!appId || !state.registeredApps[appId]) return this;
            
            // Remove from categories
            Object.values(state.categories).forEach(category => {
                category.items = category.items.filter(id => id !== appId);
            });
            
            // Remove from pinned
            state.pinnedApps = state.pinnedApps.filter(id => id !== appId);
            
            // Remove from recent
            state.recentApps = state.recentApps.filter(id => id !== appId);
            
            // Remove from registry
            delete state.registeredApps[appId];
            
            // Save changes
            savePinnedApps();
            saveRecentApps();
            
            // Update menu if open
            if (state.menuOpen) {
                updateMenuContent();
            }
            
            return this;
        },
        
        // Refresh app discovery
        refreshApps: function() {
            discoverInstalledApps();
            
            // Update menu if open
            if (state.menuOpen) {
                updateMenuContent();
            }
            
            return this;
        },
        
        // Pin an app to the menu
        pinApp: function(appId) {
            togglePinApp(appId, true);
            return this;
        },
        
        // Unpin an app from the menu
        unpinApp: function(appId) {
            togglePinApp(appId, false);
            return this;
        },
        
        // Launch an app
        launchApp: function(appId) {
            const app = state.registeredApps[appId];
            if (app) {
                launchApp(app);
            }
            return this;
        },
        
        // Get list of registered apps
        getApps: function() {
            return Object.values(state.registeredApps);
        },
        
        // Get a specific app
        getApp: function(appId) {
            return state.registeredApps[appId];
        }
    };
})();

/**
 * cr8OS CMS Module
 * A comprehensive content management system for cr8OS
 */

const cr8OSCMS = (function() {
    // Private state
    const state = {
        contentLibrary: {
            pages: [], // Static pages
            posts: [], // Blog posts or articles
            media: [], // Images, videos, files
            categories: [], // Content categories
            tags: [] // Content tags
        },
        settings: {
            siteTitle: 'My cr8OS Site',
            siteDescription: 'Built with cr8OS',
            permalinkStructure: '/%year%/%month%/%slug%/',
            defaultCategory: 'Uncategorized',
            postsPerPage: 10,
            mediaLibraryViewMode: 'grid', // 'grid' or 'list'
            autoSave: true,
            autoSaveInterval: 60000 // 1 minute in ms
        },
        users: [],
        currentUser: null,
        contentWindow: null,
        editorState: {
            currentContent: null,
            contentType: null, // 'page', 'post', etc.
            isDirty: false,
            autosaveTimerId: null,
            lastSaved: null
        },
        initialized: false
    };
    
    // Content models
    const models = {
        // Base content model
        BaseContent: class {
            constructor(data = {}) {
                this.id = data.id || generateId();
                this.title = data.title || 'Untitled';
                this.slug = data.slug || this.generateSlug();
                this.status = data.status || 'draft'; // draft, published, private, trash
                this.createdAt = data.createdAt || new Date();
                this.updatedAt = data.updatedAt || new Date();
                this.authorId = data.authorId || (state.currentUser ? state.currentUser.id : null);
            }
            
            generateSlug() {
                return this.title
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
            }
            
            update(data) {
                Object.assign(this, data);
                this.updatedAt = new Date();
                return this;
            }
        },
        
        // Page model
        Page: class extends models.BaseContent {
            constructor(data = {}) {
                super(data);
                this.content = data.content || '';
                this.template = data.template || 'default';
                this.featured_image = data.featured_image || null;
                this.parent = data.parent || null; // Parent page ID
                this.order = data.order || 0;
                this.meta = data.meta || {};
            }
        },
        
        // Post model
        Post: class extends models.BaseContent {
            constructor(data = {}) {
                super(data);
                this.content = data.content || '';
                this.excerpt = data.excerpt || '';
                this.featured_image = data.featured_image || null;
                this.categories = data.categories || [state.settings.defaultCategory];
                this.tags = data.tags || [];
                this.comments = data.comments || [];
                this.commentStatus = data.commentStatus || 'open'; // open, closed
                this.meta = data.meta || {};
            }
        },
        
        // Media model
        Media: class extends models.BaseContent {
            constructor(data = {}) {
                super(data);
                this.type = data.type || 'image'; // image, video, audio, document, etc.
                this.url = data.url || '';
                this.filePath = data.filePath || '';
                this.fileSize = data.fileSize || 0; // in bytes
                this.width = data.width || null; // for images and videos
                this.height = data.height || null; // for images and videos
                this.duration = data.duration || null; // for audio and video
                this.alt = data.alt || '';
                this.description = data.description || '';
                this.meta = data.meta || {};
            }
        },
        
        // User model
        User: class {
            constructor(data = {}) {
                this.id = data.id || generateId();
                this.username = data.username || '';
                this.firstName = data.firstName || '';
                this.lastName = data.lastName || '';
                this.email = data.email || '';
                this.avatar = data.avatar || null;
                this.role = data.role || 'editor'; // admin, editor, author, contributor
                this.createdAt = data.createdAt || new Date();
                this.meta = data.meta || {};
            }
            
            getFullName() {
                if (this.firstName && this.lastName) {
                    return `${this.firstName} ${this.lastName}`;
                } else if (this.firstName) {
                    return this.firstName;
                } else {
                    return this.username;
                }
            }
        },
        
        // Category model
        Category: class {
            constructor(data = {}) {
                this.id = data.id || generateId();
                this.name = data.name || '';
                this.slug = data.slug || this.generateSlug();
                this.description = data.description || '';
                this.parent = data.parent || null; // Parent category ID
                this.count = data.count || 0; // Number of posts
            }
            
            generateSlug() {
                return this.name
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
            }
        },
        
        // Tag model
        Tag: class {
            constructor(data = {}) {
                this.id = data.id || generateId();
                this.name = data.name || '';
                this.slug = data.slug || this.generateSlug();
                this.description = data.description || '';
                this.count = data.count || 0; // Number of posts
            }
            
            generateSlug() {
                return this.name
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
            }
        },
        
        // Comment model
        Comment: class {
            constructor(data = {}) {
                this.id = data.id || generateId();
                this.postId = data.postId || null;
                this.author = data.author || '';
                this.email = data.email || '';
                this.website = data.website || '';
                this.content = data.content || '';
                this.status = data.status || 'pending'; // pending, approved, spam, trash
                this.parent = data.parent || null; // Parent comment ID
                this.createdAt = data.createdAt || new Date();
                this.authorIp = data.authorIp || '';
                this.authorUserAgent = data.authorUserAgent || '';
            }
        }
    };
    
    // Helper functions
    const generateId = function() {
        return 'id_' + Math.random().toString(36).substr(2, 9);
    };
    
    const formatDate = function(date) {
        if (!date) return '';
        const d = new Date(date);
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    };
    
    const debounce = function(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    };
    
    // Storage utilities
    const storage = {
        save: function() {
            try {
                // Save content library
                localStorage.setItem('cr8os-cms-content', JSON.stringify(state.contentLibrary));
                
                // Save settings
                localStorage.setItem('cr8os-cms-settings', JSON.stringify(state.settings));
                
                // Save users
                localStorage.setItem('cr8os-cms-users', JSON.stringify(state.users));
                
                return true;
            } catch (error) {
                console.error('CMS: Error saving data to localStorage', error);
                return false;
            }
        },
        
        load: function() {
            try {
                // Load content library
                const contentData = localStorage.getItem('cr8os-cms-content');
                if (contentData) {
                    state.contentLibrary = JSON.parse(contentData);
                }
                
                // Load settings
                const settingsData = localStorage.getItem('cr8os-cms-settings');
                if (settingsData) {
                    state.settings = JSON.parse(settingsData);
                }
                
                // Load users
                const usersData = localStorage.getItem('cr8os-cms-users');
                if (usersData) {
                    state.users = JSON.parse(usersData);
                }
                
                return true;
            } catch (error) {
                console.error('CMS: Error loading data from localStorage', error);
                return false;
            }
        },
        
        export: function() {
            try {
                const exportData = {
                    contentLibrary: state.contentLibrary,
                    settings: state.settings,
                    users: state.users,
                    exportDate: new Date()
                };
                
                // Create a download link
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileName = `cr8os-cms-export-${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                return true;
            } catch (error) {
                console.error('CMS: Error exporting data', error);
                return false;
            }
        },
        
        import: function(jsonData) {
            try {
                const importData = JSON.parse(jsonData);
                
                if (importData.contentLibrary) {
                    state.contentLibrary = importData.contentLibrary;
                }
                
                if (importData.settings) {
                    state.settings = importData.settings;
                }
                
                if (importData.users) {
                    state.users = importData.users;
                }
                
                // Save imported data
                this.save();
                
                return true;
            } catch (error) {
                console.error('CMS: Error importing data', error);
                return false;
            }
        }
    };
    
    // Content service - CRUD operations for content types
    const contentService = {
        // Generic get method
        get: function(type, id) {
            if (!state.contentLibrary[type]) return null;
            return state.contentLibrary[type].find(item => item.id === id) || null;
        },
        
        // Generic getAll method
        getAll: function(type, filters = {}) {
            if (!state.contentLibrary[type]) return [];
            
            let items = [...state.contentLibrary[type]];
            
            // Apply filters
            Object.keys(filters).forEach(key => {
                const value = filters[key];
                items = items.filter(item => {
                    if (Array.isArray(item[key])) {
                        return item[key].includes(value);
                    } else {
                        return item[key] === value;
                    }
                });
            });
            
            return items;
        },
        
        // Generic create method
        create: function(type, data) {
            if (!state.contentLibrary[type]) return null;
            
            let newItem;
            
            // Create appropriate model instance
            switch (type) {
                case 'pages':
                    newItem = new models.Page(data);
                    break;
                case 'posts':
                    newItem = new models.Post(data);
                    break;
                case 'media':
                    newItem = new models.Media(data);
                    break;
                case 'categories':
                    newItem = new models.Category(data);
                    break;
                case 'tags':
                    newItem = new models.Tag(data);
                    break;
                default:
                    return null;
            }
            
            // Add to collection
            state.contentLibrary[type].push(newItem);
            
            // Save changes
            storage.save();
            
            return newItem;
        },
        
        // Generic update method
        update: function(type, id, data) {
            if (!state.contentLibrary[type]) return null;
            
            const index = state.contentLibrary[type].findIndex(item => item.id === id);
            if (index === -1) return null;
            
            // Update item
            const updatedItem = { ...state.contentLibrary[type][index], ...data, updatedAt: new Date() };
            state.contentLibrary[type][index] = updatedItem;
            
            // Save changes
            storage.save();
            
            return updatedItem;
        },
        
        // Generic delete method
        delete: function(type, id) {
            if (!state.contentLibrary[type]) return false;
            
            const index = state.contentLibrary[type].findIndex(item => item.id === id);
            if (index === -1) return false;
            
            // Remove item
            state.contentLibrary[type].splice(index, 1);
            
            // Save changes
            storage.save();
            
            return true;
        },
        
        // Search across content types
        search: function(query, types = ['pages', 'posts']) {
            if (!query) return [];
            
            query = query.toLowerCase();
            const results = [];
            
            types.forEach(type => {
                if (!state.contentLibrary[type]) return;
                
                const matches = state.contentLibrary[type].filter(item => {
                    // Search in title
                    if (item.title && item.title.toLowerCase().includes(query)) return true;
                    
                    // Search in content
                    if (item.content && item.content.toLowerCase().includes(query)) return true;
                    
                    // Search in excerpt (for posts)
                    if (item.excerpt && item.excerpt.toLowerCase().includes(query)) return true;
                    
                    return false;
                });
                
                // Add content type info to results
                matches.forEach(match => results.push({
                    ...match,
                    contentType: type
                }));
            });
            
            return results;
        }
    };
    
    // User service - CRUD operations for users
    const userService = {
        // Get user by ID
        get: function(id) {
            return state.users.find(user => user.id === id) || null;
        },
        
        // Get all users
        getAll: function() {
            return [...state.users];
        },
        
        // Create new user
        create: function(data) {
            const newUser = new models.User(data);
            state.users.push(newUser);
            
            // Save changes
            storage.save();
            
            return newUser;
        },
        
        // Update user
        update: function(id, data) {
            const index = state.users.findIndex(user => user.id === id);
            if (index === -1) return null;
            
            // Update user
            const updatedUser = { ...state.users[index], ...data };
            state.users[index] = updatedUser;
            
            // Save changes
            storage.save();
            
            return updatedUser;
        },
        
        // Delete user
        delete: function(id) {
            const index = state.users.findIndex(user => user.id === id);
            if (index === -1) return false;
            
            // Remove user
            state.users.splice(index, 1);
            
            // Save changes
            storage.save();
            
            return true;
        },
        
        // Set current user
        setCurrentUser: function(user) {
            state.currentUser = user;
            return user;
        }
    };
    
    // UI component templates
    const templates = {
        // Main CMS layout
        cmsLayout: `
            <div class="cr8os-cms-container">
                <div class="cms-sidebar">
                    <div class="cms-logo">
                        <i class="fas fa-cubes"></i>
                        <span>cr8OS CMS</span>
                    </div>
                    <div class="cms-navigation">
                        <div class="nav-section">
                            <div class="nav-title">Content</div>
                            <ul class="nav-items">
                                <li class="nav-item" data-route="dashboard">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span>Dashboard</span>
                                </li>
                                <li class="nav-item" data-route="posts">
                                    <i class="fas fa-file-alt"></i>
                                    <span>Posts</span>
                                </li>
                                <li class="nav-item" data-route="pages">
                                    <i class="fas fa-file"></i>
                                    <span>Pages</span>
                                </li>
                                <li class="nav-item" data-route="media">
                                    <i class="fas fa-images"></i>
                                    <span>Media</span>
                                </li>
                                <li class="nav-item" data-route="categories">
                                    <i class="fas fa-folder"></i>
                                    <span>Categories</span>
                                </li>
                                <li class="nav-item" data-route="tags">
                                    <i class="fas fa-tags"></i>
                                    <span>Tags</span>
                                </li>
                            </ul>
                        </div>
                        <div class="nav-section">
                            <div class="nav-title">Management</div>
                            <ul class="nav-items">
                                <li class="nav-item" data-route="users">
                                    <i class="fas fa-users"></i>
                                    <span>Users</span>
                                </li>
                                <li class="nav-item" data-route="comments">
                                    <i class="fas fa-comments"></i>
                                    <span>Comments</span>
                                </li>
                                <li class="nav-item" data-route="settings">
                                    <i class="fas fa-cog"></i>
                                    <span>Settings</span>
                                </li>
                            </ul>
                        </div>
                        <div class="nav-section">
                            <div class="nav-title">Utilities</div>
                            <ul class="nav-items">
                                <li class="nav-item" data-route="tools">
                                    <i class="fas fa-tools"></i>
                                    <span>Tools</span>
                                </li>
                                <li class="nav-item" data-route="help">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Help</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="cms-user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name">{{userName}}</div>
                            <div class="user-role">{{userRole}}</div>
                        </div>
                        <button class="user-menu-button">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <div class="cms-main">
                    <div class="cms-header">
                        <div class="header-title">
                            <h1>{{pageTitle}}</h1>
                        </div>
                        <div class="header-actions">
                            <div class="search-box">
                                <input type="text" placeholder="Search...">
                                <i class="fas fa-search"></i>
                            </div>
                            <button class="action-button" id="new-content-button">
                                <i class="fas fa-plus"></i>
                                <span>New</span>
                            </button>
                        </div>
                    </div>
                    <div class="cms-content">
                        <!-- Dynamic content goes here -->
                    </div>
                </div>
            </div>
        `,
        
        // Dashboard
        dashboard: `
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-file-alt"></i></div>
                    <div class="card-stats">
                        <div class="stats-number">{{postCount}}</div>
                        <div class="stats-label">Posts</div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-file"></i></div>
                    <div class="card-stats">
                        <div class="stats-number">{{pageCount}}</div>
                        <div class="stats-label">Pages</div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-images"></i></div>
                    <div class="card-stats">
                        <div class="stats-number">{{mediaCount}}</div>
                        <div class="stats-label">Media Items</div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-comments"></i></div>
                    <div class="card-stats">
                        <div class="stats-number">{{commentCount}}</div>
                        <div class="stats-label">Comments</div>
                    </div>
                </div>
            </div>
            <div class="dashboard-recent">
                <div class="dashboard-section">
                    <h2>Recent Activity</h2>
                    <div class="activity-list">
                        {{#recentActivity}}
                        <div class="activity-item">
                            <div class="activity-icon"><i class="fas fa-{{icon}}"></i></div>
                            <div class="activity-details">
                                <div class="activity-title">{{title}}</div>
                                <div class="activity-meta">{{meta}}</div>
                            </div>
                            <div class="activity-time">{{time}}</div>
                        </div>
                        {{/recentActivity}}
                    </div>
                </div>
                <div class="dashboard-section">
                    <h2>Quick Draft</h2>
                    <div class="quick-draft-form">
                        <input type="text" placeholder="Title" class="draft-title">
                        <textarea placeholder="What's on your mind?" class="draft-content"></textarea>
                        <button class="save-draft-button">Save Draft</button>
                    </div>
                </div>
            </div>
        `,
        
        // Content list (posts, pages, etc.)
        contentList: `
            <div class="content-list-container">
                <div class="list-header">
                    <div class="bulk-actions">
                        <select class="bulk-action-select">
                            <option value="">Bulk Actions</option>
                            <option value="trash">Move to Trash</option>
                            <option value="publish">Publish</option>
                            <option value="draft">Move to Draft</option>
                        </select>
                        <button class="apply-bulk-button">Apply</button>
                    </div>
                    <div class="list-filters">
                        <div class="filter-links">
                            <a href="#" class="filter-link active" data-filter="all">All ({{totalCount}})</a>
                            <a href="#" class="filter-link" data-filter="published">Published ({{publishedCount}})</a>
                            <a href="#" class="filter-link" data-filter="draft">Draft ({{draftCount}})</a>
                            <a href="#" class="filter-link" data-filter="trash">Trash ({{trashCount}})</a>
                        </div>
                        <div class="filter-dropdowns">
                            {{#filterOptions}}
                            <select class="filter-select" data-filter="{{name}}">
                                <option value="">{{label}}</option>
                                {{#options}}
                                <option value="{{value}}">{{label}}</option>
                                {{/options}}
                            </select>
                            {{/filterOptions}}
                            <button class="filter-button">Filter</button>
                        </div>
                    </div>
                </div>
                <div class="content-table">
                    <table>
                        <thead>
                            <tr>
                                <th class="check-column">
                                    <input type="checkbox" class="select-all-checkbox">
                                </th>
                                <th class="title-column">Title</th>
                                <th class="author-column">Author</th>
                                {{#columns}}
                                <th class="{{class}}">{{label}}</th>
                                {{/columns}}
                                <th class="date-column">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#items}}
                            <tr data-id="{{id}}" class="content-row {{status}}">
                                <td class="check-column">
                                    <input type="checkbox" class="row-checkbox" value="{{id}}">
                                </td>
                                <td class="title-column">
                                    <div class="content-title">
                                        <a href="#" class="edit-link">{{title}}</a>
                                    </div>
                                    <div class="row-actions">
                                        <span class="edit"><a href="#" data-action="edit" data-id="{{id}}">Edit</a> | </span>
                                        <span class="view"><a href="#" data-action="view" data-id="{{id}}">View</a> | </span>
                                        <span class="trash"><a href="#" data-action="trash" data-id="{{id}}">Trash</a></span>
                                    </div>
                                </td>
                                <td class="author-column">{{author}}</td>
                                {{#columnData}}
                                <td class="{{class}}">{{{value}}}</td>
                                {{/columnData}}
                                <td class="date-column">
                                    <div class="date-published">{{date}}</div>
                                    <div class="content-status">{{statusText}}</div>
                                </td>
                            </tr>
                            {{/items}}
                        </tbody>
                    </table>
                </div>
                <div class="list-pagination">
                    <div class="pagination-info">
                        Showing {{start}} - {{end}} of {{total}} items
                    </div>
                    <div class="pagination-links">
                        <a href="#" class="pagination-link {{prevDisabled}}" data-page="prev">&laquo; Previous</a>
                        {{#pages}}
                        <a href="#" class="pagination-link {{active}}" data-page="{{number}}">{{number}}</a>
                        {{/pages}}
                        <a href="#" class="pagination-link {{nextDisabled}}" data-page="next">Next &raquo;</a>
                    </div>
                </div>
            </div>
        `,
        
        // Media library grid view
        mediaGrid: `
            <div class="media-library-container">
                <div class="media-toolbar">
                    <div class="media-view-options">
                        <button class="view-option-button active" data-view="grid">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-option-button" data-view="list">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                    <div class="media-upload">
                        <button class="upload-media-button">
                            <i class="fas fa-upload"></i>
                            <span>Upload Media</span>
                        </button>
                        <input type="file" id="media-upload-input" class="media-upload-input" multiple style="display: none;">
                    </div>
                    <div class="media-filters">
                        <select class="media-type-filter">
                            <option value="all">All Media Items</option>
                            <option value="image">Images</option>
                            <option value="video">Videos</option>
                            <option value="audio">Audio</option>
                            <option value="document">Documents</option>
                        </select>
                        <select class="media-date-filter">
                            <option value="all">All Dates</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>
                <div class="media-grid-view">
                    {{#items}}
                    <div class="media-item" data-id="{{id}}" data-type="{{type}}">
                        <div class="media-preview">
                            {{#isImage}}
                            <img src="{{url}}" alt="{{title}}">
                            {{/isImage}}
                            {{#isVideo}}
                            <div class="video-preview">
                                <i class="fas fa-film"></i>
                            </div>
                            {{/isVideo}}
                            {{#isAudio}}
                            <div class="audio-preview">
                                <i class="fas fa-music"></i>
                            </div>
                            {{/isAudio}}
                            {{#isDocument}}
                            <div class="document-preview">
                                <i class="fas fa-file"></i>
                            </div>
                            {{/isDocument}}
                        </div>
                        <div class="media-info">
                            <div class="media-title" title="{{title}}">{{title}}</div>
                            <div class="media-date">{{date}}</div>
                        </div>
                        <div class="media-actions">
                            <button class="media-action-button" data-action="edit" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="media-action-button" data-action="view" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="media-action-button" data-action="delete" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {{/items}}
                </div>
                <div class="media-list-view" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th class="file-column">File</th>
                                <th class="author-column">Author</th>
                                <th class="date-column">Date</th>
                                <th class="actions-column">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#items}}
                            <tr data-id="{{id}}">
                                <td class="file-column">
                                    <div class="file-preview">
                                        {{#isImage}}
                                        <img src="{{url}}" alt="{{title}}">
                                        {{/isImage}}
                                        {{#isVideo}}
                                        <i class="fas fa-film"></i>
                                        {{/isVideo}}
                                        {{#isAudio}}
                                        <i class="fas fa-music"></i>
                                        {{/isAudio}}
                                        {{#isDocument}}
                                        <i class="fas fa-file"></i>
                                        {{/isDocument}}
                                    </div>
                                    <div class="file-details">
                                        <div class="file-title">{{title}}</div>
                                        <div class="file-meta">{{type}}  {{fileSize}}</div>
                                    </div>
                                </td>
                                <td class="author-column">{{author}}</td>
                                <td class="date-column">{{date}}</td>
                                <td class="actions-column">
                                    <button class="media-action-button" data-action="edit" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="media-action-button" data-action="view" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="media-action-button" data-action="delete" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {{/items}}
                        </tbody>
                    </table>
                </div>
                <div class="media-pagination">
                    <div class="pagination-info">
                        Showing {{start}} - {{end}} of {{total}} items
                    </div>
                    <div class="pagination-links">
                        <a href="#" class="pagination-link {{prevDisabled}}" data-page="prev">&laquo; Previous</a>
                        {{#pages}}
                        <a href="#" class="pagination-link {{active}}" data-page="{{number}}">{{number}}</a>
                        {{/pages}}
                        <a href="#" class="pagination-link {{nextDisabled}}" data-page="next">Next &raquo;</a>
                    </div>
                </div>
            </div>
        `,
        
        // Content editor
        contentEditor: `
            <div class="content-editor">
                <div class="editor-header">
                    <div class="editor-title">
                        <input type="text" placeholder="Enter title here" value="{{title}}" class="title-input">
                    </div>
                    <div class="editor-actions">
                        <button class="action-button preview-button">
                            <i class="fas fa-eye"></i>
                            <span>Preview</span>
                        </button>
                        <button class="action-button save-draft-button">
                            <i class="fas fa-save"></i>
                            <span>Save Draft</span>
                        </button>
                        <button class="action-button publish-button">
                            <i class="fas fa-paper-plane"></i>
                            <span>{{publishText}}</span>
                        </button>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="editor-main">
                        <div class="toolbar">
                            <div class="toolbar-group">
                                <button class="toolbar-button" data-command="bold" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="toolbar-button" data-command="italic" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="toolbar-button" data-command="underline" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button class="toolbar-button" data-command="strikeThrough" title="Strikethrough">
                                    <i class="fas fa-strikethrough"></i>
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <button class="toolbar-button" data-command="justifyLeft" title="Align Left">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button class="toolbar-button" data-command="justifyCenter" title="Align Center">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button class="toolbar-button" data-command="justifyRight" title="Align Right">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <button class="toolbar-button" data-command="justifyFull" title="Justify">
                                    <i class="fas fa-align-justify"></i>
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <button class="toolbar-button" data-command="insertUnorderedList" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button class="toolbar-button" data-command="insertOrderedList" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button class="toolbar-button" data-command="outdent" title="Decrease Indent">
                                    <i class="fas fa-outdent"></i>
                                </button>
                                <button class="toolbar-button" data-command="indent" title="Increase Indent">
                                    <i class="fas fa-indent"></i>
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <button class="toolbar-button" data-command="createLink" title="Insert Link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="toolbar-button" data-command="insertImage" title="Insert Image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="toolbar-button" data-command="formatBlock" data-value="blockquote" title="Blockquote">
                                    <i class="fas fa-quote-right"></i>
                                </button>
                                <button class="toolbar-button" data-command="codeBlock" title="Code Block">
                                    <i class="fas fa-code"></i>
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <select class="toolbar-select heading-select">
                                    <option value="">Paragraph</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                    <option value="h4">Heading 4</option>
                                    <option value="h5">Heading 5</option>
                                    <option value="h6">Heading 6</option>
                                </select>
                            </div>
                        </div>
                        <div class="editor-content" contenteditable="true">{{content}}</div>
                    </div>
                    <div class="editor-sidebar">
                        <div class="sidebar-panel">
                            <div class="panel-header">
                                <h3>Publish</h3>
                                <button class="panel-toggle-button">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <div class="form-group">
                                    <label>Status</label>
                                    <select class="status-select">
                                        <option value="draft" {{draftSelected}}>Draft</option>
                                        <option value="published" {{publishedSelected}}>Published</option>
                                        <option value="private" {{privateSelected}}>Private</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Visibility</label>
                                    <div class="radio-options">
                                        <label>
                                            <input type="radio" name="visibility" value="public" {{publicChecked}}>
                                            Public
                                        </label>
                                        <label>
                                            <input type="radio" name="visibility" value="password" {{passwordChecked}}>
                                            Password Protected
                                        </label>
                                        <label>
                                            <input type="radio" name="visibility" value="private" {{privateChecked}}>
                                            Private
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Publish Date</label>
                                    <input type="datetime-local" class="publish-date" value="{{publishDate}}">
                                </div>
                                <div class="panel-actions">
                                    <button class="action-button save-draft-button">
                                        <i class="fas fa-save"></i>
                                        <span>Save Draft</span>
                                    </button>
                                    <button class="action-button publish-button">
                                        <i class="fas fa-paper-plane"></i>
                                        <span>{{publishText}}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {{#isPost}}
                        <div class="sidebar-panel">
                            <div class="panel-header">
                                <h3>Categories</h3>
                                <button class="panel-toggle-button">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <div class="categories-list">
                                    {{#categories}}
                                    <label class="category-item">
                                        <input type="checkbox" value="{{id}}" {{checked}}>
                                        {{name}}
                                    </label>
                                    {{/categories}}
                                </div>
                                <button class="add-category-button">
                                    <i class="fas fa-plus"></i>
                                    <span>Add New Category</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="sidebar-panel">
                            <div class="panel-header">
                                <h3>Tags</h3>
                                <button class="panel-toggle-button">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <div class="tags-input-container">
                                    <input type="text" class="tags-input" placeholder="Add tags...">
                                    <div class="tags-suggestions"></div>
                                </div>
                                <div class="current-tags">
                                    {{#tags}}
                                    <span class="tag-item">
                                        {{name}}
                                        <button class="remove-tag-button" data-id="{{id}}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </span>
                                    {{/tags}}
                                </div>
                            </div>
                        </div>
                        {{/isPost}}
                        
                        <div class="sidebar-panel">
                            <div class="panel-header">
                                <h3>Featured Image</h3>
                                <button class="panel-toggle-button">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <div class="featured-image-container">
                                    {{#hasFeaturedImage}}
                                    <img src="{{featuredImageUrl}}" alt="Featured Image" class="featured-image">
                                    <button class="remove-featured-image-button">
                                        <i class="fas fa-times"></i>
                                        <span>Remove Featured Image</span>
                                    </button>
                                    {{/hasFeaturedImage}}
                                    {{^hasFeaturedImage}}
                                    <div class="featured-image-placeholder">
                                        <i class="fas fa-image"></i>
                                        <span>No image selected</span>
                                    </div>
                                    {{/hasFeaturedImage}}
                                </div>
                                <button class="set-featured-image-button">
                                    <i class="fas fa-upload"></i>
                                    <span>Set Featured Image</span>
                                </button>
                            </div>
                        </div>
                        
                        {{#isPage}}
                        <div class="sidebar-panel">
                            <div class="panel-header">
                                <h3>Page Attributes</h3>
                                <button class="panel-toggle-button">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <div class="form-group">
                                    <label>Parent</label>
                                    <select class="parent-page-select">
                                        <option value="">No Parent</option>
                                        {{#pages}}
                                        <option value="{{id}}" {{selected}}>{{title}}</option>
                                        {{/pages}}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Template</label>
                                    <select class="template-select">
                                        <option value="default" {{defaultSelected}}>Default Template</option>
                                        {{#templates}}
                                        <option value="{{id}}" {{selected}}>{{name}}</option>
                                        {{/templates}}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Order</label>
                                    <input type="number" class="page-order" value="{{order}}" min="0">
                                </div>
                            </div>
                        </div>
                        {{/isPage}}
                        
                        <div class="sidebar-panel">
                            <div class="panel-header">
                                <h3>Excerpt</h3>
                                <button class="panel-toggle-button">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <textarea class="excerpt-textarea" placeholder="Write an excerpt (optional)">{{excerpt}}</textarea>
                                <p class="excerpt-description">
                                    Excerpts are optional hand-crafted summaries of your content.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        
        // Media editor modal
        mediaEditor: `
            <div class="media-editor-modal">
                <div class="modal-header">
                    <h2>{{title}}</h2>
                    <button class="close-modal-button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="media-preview-pane">
                        <div class="media-preview">
                            {{#isImage}}
                            <img src="{{url}}" alt="{{title}}">
                            {{/isImage}}
                            {{#isVideo}}
                            <video controls>
                                <source src="{{url}}" type="{{mimeType}}">
                                Your browser doesn't support video playback.
                            </video>
                            {{/isVideo}}
                            {{#isAudio}}
                            <audio controls>
                                <source src="{{url}}" type="{{mimeType}}">
                                Your browser doesn't support audio playback.
                            </audio>
                            {{/isAudio}}
                            {{#isDocument}}
                            <div class="document-preview">
                                <i class="fas fa-file-{{fileIcon}}"></i>
                                <div class="document-name">{{filename}}</div>
                            </div>
                            {{/isDocument}}
                        </div>
                    </div>
                    <div class="media-details-pane">
                        <div class="media-details-form">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" class="media-title-input" value="{{title}}">
                            </div>
                            <div class="form-group">
                                <label>Alternative Text</label>
                                <input type="text" class="media-alt-input" value="{{alt}}">
                                <p class="input-description">
                                    Describe the purpose of the image. Leave empty if decorative.
                                </p>
                            </div>
                            <div class="form-group">
                                <label>Caption</label>
                                <textarea class="media-caption-input">{{caption}}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="media-description-input">{{description}}</textarea>
                            </div>
                            <div class="media-metadata">
                                <div class="metadata-item">
                                    <div class="metadata-label">File name:</div>
                                    <div class="metadata-value">{{filename}}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">File type:</div>
                                    <div class="metadata-value">{{mimeType}}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">Upload date:</div>
                                    <div class="metadata-value">{{uploadDate}}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">File size:</div>
                                    <div class="metadata-value">{{fileSize}}</div>
                                </div>
                                {{#isDimensional}}
                                <div class="metadata-item">
                                    <div class="metadata-label">Dimensions:</div>
                                    <div class="metadata-value">{{dimensions}}</div>
                                </div>
                                {{/isDimensional}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="action-button delete-button">
                        <i class="fas fa-trash"></i>
                        <span>Delete Permanently</span>
                    </button>
                    <button class="action-button update-button">
                        <i class="fas fa-save"></i>
                        <span>Update</span>
                    </button>
                </div>
            </div>
        `,
        
        // Settings page
        settingsPage: `
            <div class="settings-container">
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="general">General</button>
                    <button class="settings-tab" data-tab="writing">Writing</button>
                    <button class="settings-tab" data-tab="reading">Reading</button>
                    <button class="settings-tab" data-tab="media">Media</button>
                    <button class="settings-tab" data-tab="permalinks">Permalinks</button>
                    <button class="settings-tab" data-tab="export">Import/Export</button>
                </div>
                <div class="settings-content">
                    <div class="settings-panel active" id="general-settings">
                        <h2>General Settings</h2>
                        <div class="form-group">
                            <label>Site Title</label>
                            <input type="text" id="site-title" value="{{siteTitle}}">
                            <p class="input-description">
                                The name of your site, displayed in browser tabs and site header.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>Site Description</label>
                            <input type="text" id="site-description" value="{{siteDescription}}">
                            <p class="input-description">
                                A short tagline or description of your site.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>Language</label>
                            <select id="site-language">
                                <option value="en-US" {{langUS}}>English (United States)</option>
                                <option value="en-GB" {{langGB}}>English (UK)</option>
                                <option value="es" {{langES}}>Espaol</option>
                                <option value="fr" {{langFR}}>Franais</option>
                                <option value="de" {{langDE}}>Deutsch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Format</label>
                            <div class="radio-options date-format-options">
                                <label>
                                    <input type="radio" name="date-format" value="F j, Y" {{dateFormat1}}>
                                    <span>{{dateFormat1Example}}</span>
                                </label>
                                <label>
                                    <input type="radio" name="date-format" value="Y-m-d" {{dateFormat2}}>
                                    <span>{{dateFormat2Example}}</span>
                                </label>
                                <label>
                                    <input type="radio" name="date-format" value="m/d/Y" {{dateFormat3}}>
                                    <span>{{dateFormat3Example}}</span>
                                </label>
                                <label>
                                    <input type="radio" name="date-format" value="d/m/Y" {{dateFormat4}}>
                                    <span>{{dateFormat4Example}}</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Time Format</label>
                            <div class="radio-options time-format-options">
                                <label>
                                    <input type="radio" name="time-format" value="g:i a" {{timeFormat1}}>
                                    <span>{{timeFormat1Example}}</span>
                                </label>
                                <label>
                                    <input type="radio" name="time-format" value="g:i A" {{timeFormat2}}>
                                    <span>{{timeFormat2Example}}</span>
                                </label>
                                <label>
                                    <input type="radio" name="time-format" value="H:i" {{timeFormat3}}>
                                    <span>{{timeFormat3Example}}</span>
                                </label>
                            </div>
                        </div>
                        <button class="save-settings-button">Save Changes</button>
                    </div>
                    <div class="settings-panel" id="writing-settings">
                        <h2>Writing Settings</h2>
                        <div class="form-group">
                            <label>Default Post Category</label>
                            <select id="default-category">
                                {{#categories}}
                                <option value="{{id}}" {{selected}}>{{name}}</option>
                                {{/categories}}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Default Post Format</label>
                            <select id="default-post-format">
                                <option value="standard" {{formatStandard}}>Standard</option>
                                <option value="aside" {{formatAside}}>Aside</option>
                                <option value="gallery" {{formatGallery}}>Gallery</option>
                                <option value="link" {{formatLink}}>Link</option>
                                <option value="quote" {{formatQuote}}>Quote</option>
                                <option value="status" {{formatStatus}}>Status</option>
                                <option value="video" {{formatVideo}}>Video</option>
                                <option value="audio" {{formatAudio}}>Audio</option>
                            </select>
                        </div>
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" id="enable-auto-save" {{autoSaveChecked}}>
                                Enable auto-save while editing
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Auto-save Interval (seconds)</label>
                            <input type="number" id="auto-save-interval" value="{{autoSaveInterval}}" min="15" max="600">
                            <p class="input-description">
                                How often to automatically save your content while editing (in seconds).
                            </p>
                        </div>
                        <button class="save-settings-button">Save Changes</button>
                    </div>
                    <div class="settings-panel" id="reading-settings">
                        <h2>Reading Settings</h2>
                        <div class="form-group">
                            <label>Your homepage displays</label>
                            <div class="radio-options">
                                <label>
                                    <input type="radio" name="homepage-display" value="posts" {{homepagePosts}}>
                                    Latest posts
                                </label>
                                <label>
                                    <input type="radio" name="homepage-display" value="page" {{homepagePage}}>
                                    A static page
                                </label>
                            </div>
                        </div>
                        <div class="form-group homepage-options {{homepageOptionsDisplay}}">
                            <label>Homepage</label>
                            <select id="homepage-id">
                                <option value="">-- Select --</option>
                                {{#pages}}
                                <option value="{{id}}" {{selected}}>{{title}}</option>
                                {{/pages}}
                            </select>
                        </div>
                        <div class="form-group homepage-options {{homepageOptionsDisplay}}">
                            <label>Posts page</label>
                            <select id="posts-page-id">
                                <option value="">-- Select --</option>
                                {{#pages}}
                                <option value="{{id}}" {{postsSelected}}>{{title}}</option>
                                {{/pages}}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Blog pages show at most</label>
                            <input type="number" id="posts-per-page" value="{{postsPerPage}}" min="1" max="100">
                            <span>posts</span>
                        </div>
                        <div class="form-group">
                            <label>For each article in a feed, show</label>
                            <div class="radio-options">
                                <label>
                                    <input type="radio" name="feed-content" value="full" {{feedFull}}>
                                    Full text
                                </label>
                                <label>
                                    <input type="radio" name="feed-content" value="summary" {{feedSummary}}>
                                    Summary
                                </label>
                            </div>
                        </div>
                        <button class="save-settings-button">Save Changes</button>
                    </div>
                    <div class="settings-panel" id="media-settings">
                        <h2>Media Settings</h2>
                        <div class="form-group">
                            <label>Image sizes</label>
                            <div class="size-inputs">
                                <div class="size-input-group">
                                    <label>Thumbnail size</label>
                                    <div class="dimension-inputs">
                                        <div class="dimension-input">
                                            <input type="number" id="thumbnail-width" value="{{thumbnailWidth}}" min="0" max="2000">
                                            <span>px width</span>
                                        </div>
                                        <div class="dimension-input">
                                            <input type="number" id="thumbnail-height" value="{{thumbnailHeight}}" min="0" max="2000">
                                            <span>px height</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="size-input-group">
                                    <label>Medium size</label>
                                    <div class="dimension-inputs">
                                        <div class="dimension-input">
                                            <input type="number" id="medium-width" value="{{mediumWidth}}" min="0" max="2000">
                                            <span>px max width</span>
                                        </div>
                                        <div class="dimension-input">
                                            <input type="number" id="medium-height" value="{{mediumHeight}}" min="0" max="2000">
                                            <span>px max height</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="size-input-group">
                                    <label>Large size</label>
                                    <div class="dimension-inputs">
                                        <div class="dimension-input">
                                            <input type="number" id="large-width" value="{{largeWidth}}" min="0" max="2000">
                                            <span>px max width</span>
                                        </div>
                                        <div class="dimension-input">
                                            <input type="number" id="large-height" value="{{largeHeight}}" min="0" max="2000">
                                            <span>px max height</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" id="organize-uploads" {{organizeUploadsChecked}}>
                                Organize uploads into month- and year-based folders
                            </label>
                        </div>
                        <button class="save-settings-button">Save Changes</button>
                    </div>
                    <div class="settings-panel" id="permalinks-settings">
                        <h2>Permalink Settings</h2>
                        <p class="panel-description">
                            Customize the structure of permalinks on your site.
                        </p>
                        <div class="form-group">
                            <div class="radio-options permalink-options">
                                <label>
                                    <input type="radio" name="permalink-structure" value="plain" {{permalinkPlain}}>
                                    Plain
                                    <code class="permalink-example">{{siteUrl}}/?p=123</code>
                                </label>
                                <label>
                                    <input type="radio" name="permalink-structure" value="day-name" {{permalinkDayName}}>
                                    Day and name
                                    <code class="permalink-example">{{siteUrl}}/2022/10/15/sample-post/</code>
                                </label>
                                <label>
                                    <input type="radio" name="permalink-structure" value="month-name" {{permalinkMonthName}}>
                                    Month and name
                                    <code class="permalink-example">{{siteUrl}}/2022/10/sample-post/</code>
                                </label>
                                <label>
                                    <input type="radio" name="permalink-structure" value="numeric" {{permalinkNumeric}}>
                                    Numeric
                                    <code class="permalink-example">{{siteUrl}}/archives/123</code>
                                </label>
                                <label>
                                    <input type="radio" name="permalink-structure" value="post-name" {{permalinkPostName}}>
                                    Post name
                                    <code class="permalink-example">{{siteUrl}}/sample-post/</code>
                                </label>
                                <label>
                                    <input type="radio" name="permalink-structure" value="custom" {{permalinkCustom}}>
                                    Custom Structure
                                    <input type="text" id="custom-permalink" value="{{customPermalink}}" placeholder="/archives/%year%/%monthnum%/%post_id%">
                                </label>
                            </div>
                        </div>
                        <div class="available-tags">
                            <h4>Available tags:</h4>
                            <code>%year%</code> <code>%monthnum%</code> <code>%day%</code> <code>%hour%</code> <code>%minute%</code> <code>%second%</code> <code>%post_id%</code> <code>%postname%</code> <code>%category%</code> <code>%author%</code>
                        </div>
                        <button class="save-settings-button">Save Changes</button>
                    </div>
                    <div class="settings-panel" id="export-settings">
                        <h2>Import/Export Settings</h2>
                        <div class="export-section">
                            <h3>Export</h3>
                            <p>Export your content, settings, and users as a JSON file.</p>
                            <button class="export-button">
                                <i class="fas fa-download"></i>
                                <span>Export Data</span>
                            </button>
                        </div>
                        <div class="import-section">
                            <h3>Import</h3>
                            <p>Import content, settings, and users from a JSON file.</p>
                            <div class="import-file-container">
                                <input type="file" id="import-file" accept=".json">
                                <button class="import-file-button">
                                    <i class="fas fa-upload"></i>
                                    <span>Select File</span>
                                </button>
                                <span class="selected-file-name"></span>
                            </div>
                            <div class="import-options">
                                <label>
                                    <input type="checkbox" id="import-overwrite" checked>
                                    Overwrite existing content
                                </label>
                            </div>
                            <button class="import-button" disabled>
                                <i class="fas fa-file-import"></i>
                                <span>Import Data</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `,
        
        // Tools page
        toolsPage: `
            <div class="tools-container">
                <div class="tools-section">
                    <h2>Available Tools</h2>
                    <div class="tools-grid">
                        <div class="tool-card">
                            <div class="tool-icon"><i class="fas fa-sync"></i></div>
                            <div class="tool-details">
                                <h3>Regenerate Thumbnails</h3>
                                <p>Regenerate thumbnails for all or selected image uploads.</p>
                                <button class="tool-button" data-tool="regenerate-thumbnails">
                                    <span>Run Tool</span>
                                </button>
                            </div>
                        </div>
                        <div class="tool-card">
                            <div class="tool-icon"><i class="fas fa-database"></i></div>
                            <div class="tool-details">
                                <h3>Data Cleanup</h3>
                                <p>Remove unused tags, categories, and other data.</p>
                                <button class="tool-button" data-tool="data-cleanup">
                                    <span>Run Tool</span>
                                </button>
                            </div>
                        </div>
                        <div class="tool-card">
                            <div class="tool-icon"><i class="fas fa-file-export"></i></div>
                            <div class="tool-details">
                                <h3>Export Content</h3>
                                <p>Export content in various formats (HTML, Markdown, etc.).</p>
                                <button class="tool-button" data-tool="export-content">
                                    <span>Run Tool</span>
                                </button>
                            </div>
                        </div>
                        <div class="tool-card">
                            <div class="tool-icon"><i class="fas fa-link"></i></div>
                            <div class="tool-details">
                                <h3>Find and Replace</h3>
                                <p>Find and replace text across all content.</p>
                                <button class="tool-button" data-tool="find-replace">
                                    <span>Run Tool</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tools-modal" style="display: none;">
                    <div class="tools-modal-content">
                        <div class="modal-header">
                            <h2 class="tool-title">Tool Name</h2>
                            <button class="close-modal-button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="tool-form-container">
                            <!-- Dynamic tool form will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        `
    };
    
    // UI component templates for tool forms
    const toolForms = {
        'regenerate-thumbnails': `
            <div class="tool-form">
                <p class="tool-description">
                    This tool will regenerate thumbnails for all images in your media library.
                </p>
                <div class="form-group">
                    <label>Images to process</label>
                    <div class="radio-options">
                        <label>
                            <input type="radio" name="image-scope" value="all" checked>
                            All images
                        </label>
                        <label>
                            <input type="radio" name="image-scope" value="selected">
                            Selected images
                        </label>
                    </div>
                </div>
                <div class="form-group image-selector" style="display: none;">
                    <label>Select images</label>
                    <div class="image-selection-grid">
                        <!-- Images will be populated here -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Thumbnail sizes to regenerate</label>
                    <div class="checkbox-options">
                        <label>
                            <input type="checkbox" name="thumbnail-size" value="thumbnail" checked>
                            Thumbnail
                        </label>
                        <label>
                            <input type="checkbox" name="thumbnail-size" value="medium" checked>
                            Medium
                        </label>
                        <label>
                            <input type="checkbox" name="thumbnail-size" value="large" checked>
                            Large
                        </label>
                    </div>
                </div>
                <div class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text">0% complete</div>
                </div>
                <div class="tool-actions">
                    <button class="run-tool-button">
                        <i class="fas fa-play"></i>
                        <span>Start Regenerating</span>
                    </button>
                </div>
            </div>
        `,
        
        'data-cleanup': `
            <div class="tool-form">
                <p class="tool-description">
                    This tool will help you clean up unused data in your content management system.
                </p>
                <div class="form-group">
                    <label>Select items to clean up</label>
                    <div class="checkbox-options">
                        <label>
                            <input type="checkbox" name="cleanup-item" value="tags" checked>
                            Unused tags
                            <span class="item-count">({{unusedTagsCount}} found)</span>
                        </label>
                        <label>
                            <input type="checkbox" name="cleanup-item" value="categories" checked>
                            Unused categories
                            <span class="item-count">({{unusedCategoriesCount}} found)</span>
                        </label>
                        <label>
                            <input type="checkbox" name="cleanup-item" value="revisions" checked>
                            Old revisions
                            <span class="item-count">({{revisionsCount}} found)</span>
                        </label>
                        <label>
                            <input type="checkbox" name="cleanup-item" value="trash" checked>
                            Trash items
                            <span class="item-count">({{trashCount}} found)</span>
                        </label>
                    </div>
                </div>
                <div class="results-container" style="display: none;">
                    <h3>Results</h3>
                    <div class="results-list">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                <div class="tool-actions">
                    <button class="run-tool-button">
                        <i class="fas fa-broom"></i>
                        <span>Clean Up Data</span>
                    </button>
                </div>
            </div>
        `,
        
        'export-content': `
            <div class="tool-form">
                <p class="tool-description">
                    Export your content in various formats for backup or migration.
                </p>
                <div class="form-group">
                    <label>Content to export</label>
                    <div class="checkbox-options">
                        <label>
                            <input type="checkbox" name="export-content" value="posts" checked>
                            Posts
                        </label>
                        <label>
                            <input type="checkbox" name="export-content" value="pages" checked>
                            Pages
                        </label>
                        <label>
                            <input type="checkbox" name="export-content" value="media">
                            Media
                        </label>
                        <label>
                            <input type="checkbox" name="export-content" value="categories">
                            Categories
                        </label>
                        <label>
                            <input type="checkbox" name="export-content" value="tags">
                            Tags
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Export format</label>
                    <div class="radio-options">
                        <label>
                            <input type="radio" name="export-format" value="json" checked>
                            JSON
                        </label>
                        <label>
                            <input type="radio" name="export-format" value="markdown">
                            Markdown
                        </label>
                        <label>
                            <input type="radio" name="export-format" value="html">
                            HTML
                        </label>
                        <label>
                            <input type="radio" name="export-format" value="csv">
                            CSV
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Date range</label>
                    <div class="date-range-inputs">
                        <div class="date-input">
                            <label>From</label>
                            <input type="date" name="export-date-from">
                        </div>
                        <div class="date-input">
                            <label>To</label>
                            <input type="date" name="export-date-to">
                        </div>
                    </div>
                </div>
                <div class="tool-actions">
                    <button class="run-tool-button">
                        <i class="fas fa-file-export"></i>
                        <span>Export Content</span>
                    </button>
                </div>
            </div>
        `,
        
        'find-replace': `
            <div class="tool-form">
                <p class="tool-description">
                    Find and replace text across all your content. Use with caution!
                </p>
                <div class="form-group">
                    <label>Search for</label>
                    <input type="text" name="find-text" placeholder="Text to find">
                </div>
                <div class="form-group">
                    <label>Replace with</label>
                    <input type="text" name="replace-text" placeholder="Replacement text">
                </div>
                <div class="form-group">
                    <label>Where to search</label>
                    <div class="checkbox-options">
                        <label>
                            <input type="checkbox" name="search-in" value="posts" checked>
                            Posts
                        </label>
                        <label>
                            <input type="checkbox" name="search-in" value="pages" checked>
                            Pages
                        </label>
                        <label>
                            <input type="checkbox" name="search-in" value="titles">
                            Titles
                        </label>
                        <label>
                            <input type="checkbox" name="search-in" value="excerpts">
                            Excerpts
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Options</label>
                    <div class="checkbox-options">
                        <label>
                            <input type="checkbox" name="search-option" value="case-sensitive">
                            Case sensitive
                        </label>
                        <label>
                            <input type="checkbox" name="search-option" value="whole-word">
                            Match whole word only
                        </label>
                        <label>
                            <input type="checkbox" name="search-option" value="preview" checked>
                            Preview changes before replacing
                        </label>
                    </div>
                </div>
                <div class="preview-container" style="display: none;">
                    <h3>Preview Changes</h3>
                    <div class="preview-list">
                        <!-- Preview changes will be displayed here -->
                    </div>
                </div>
                <div class="tool-actions">
                    <button class="preview-tool-button">
                        <i class="fas fa-search"></i>
                        <span>Find Matches</span>
                    </button>
                    <button class="run-tool-button" disabled>
                        <i class="fas fa-exchange-alt"></i>
                        <span>Replace All</span>
                    </button>
                </div>
            </div>
        `
    };
    
    // UI rendering utility
    const renderer = {
        // Render template with data
        renderTemplate: function(template, data = {}) {
            let result = template;
            
            // Handle conditionals
            // Match {{#variable}}content{{/variable}} blocks
            const conditionalRegex = /{{#([^}]+)}}([\s\S]*?){{\/\1}}/g;
            result = result.replace(conditionalRegex, (match, variable, content) => {
                // Check if the variable exists and is truthy
                return data[variable] ? content : '';
            });
            
            // Handle variables
            // Match {{variable}} placeholders
            const variableRegex = /{{([^#^/{}]+)}}/g;
            result = result.replace(variableRegex, (match, variable) => {
                // Replace with corresponding value from data
                return data[variable] !== undefined ? data[variable] : '';
            });
            
            return result;
        },
        
        // Create CMS window
        createCMSWindow: function() {
            if (!state.contentWindow) {
                // Create CMS window using cr8OS window system
                if (typeof cr8OS !== 'undefined' && cr8OS.createWindow) {
                    state.contentWindow = cr8OS.createWindow(
                        '#cms', // URL placeholder
                        'Content Management', // Window title
                        { // Window options
                            width: 1200,
                            height: 800,
                            minWidth: 800,
                            minHeight: 600,
                            maximized: true,
                            resizable: true,
                            minimizable: true,
                            maximizable: true,
                            closable: true,
                            bodyClass: 'cms-window'
                        }
                    );
                    
                    // Set window content
                    this.renderCMSLayout();
                    
                    // Default to dashboard view
                    this.renderDashboard();
                } else {
                    console.error('CMS: cr8OS window system not available');
                    // Create standalone container as fallback
                    const container = document.createElement('div');
                    container.className = 'cr8os-cms-standalone';
                    container.innerHTML = this.renderTemplate(templates.cmsLayout, {
                        userName: state.currentUser ? state.currentUser.getFullName() : 'User',
                        userRole: state.currentUser ? state.currentUser.role : 'Editor',
                        pageTitle: 'Dashboard'
                    });
                    
                    document.body.appendChild(container);
                    state.contentWindow = container;
                    
                    // Default to dashboard view
                    this.renderDashboard();
                }
            } else {
                // Show existing window
                if (state.contentWindow.show) {
                    state.contentWindow.show();
                } else {
                    state.contentWindow.style.display = 'block';
                }
            }
            
            return state.contentWindow;
        },
        
        // Render main CMS layout
        renderCMSLayout: function() {
            const windowBody = state.contentWindow.querySelector('.window-content') || state.contentWindow;
            
            const layoutData = {
                userName: state.currentUser ? state.currentUser.getFullName() : 'User',
                userRole: state.currentUser ? state.currentUser.role : 'Editor',
                pageTitle: 'Dashboard'
            };
            
            windowBody.innerHTML = this.renderTemplate(templates.cmsLayout, layoutData);
            
            // Add event listeners
            this.setupCMSEventListeners();
        },
        
        // Set up CMS event listeners
        setupCMSEventListeners: function() {
            const cmsContainer = state.contentWindow.querySelector('.cr8os-cms-container');
            if (!cmsContainer) return;
            
            // Navigation menu clicks
            cmsContainer.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Get route
                    const route = item.dataset.route;
                    
                    // Update active state
                    cmsContainer.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Navigate to route
                    this.navigateTo(route);
                });
            });
            
            // Search box functionality
            const searchBox = cmsContainer.querySelector('.search-box input');
            if (searchBox) {
                searchBox.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const query = searchBox.value.trim();
                        if (query) {
                            this.renderSearchResults(query);
                        }
                    }
                });
            }
            
            // New content button
            const newContentButton = cmsContainer.querySelector('#new-content-button');
            if (newContentButton) {
                newContentButton.addEventListener('click', () => {
                    // Show new content menu
                    this.showNewContentMenu(newContentButton);
                });
            }
            
            // User menu
            const userMenuButton = cmsContainer.querySelector('.user-menu-button');
            if (userMenuButton) {
                userMenuButton.addEventListener('click', () => {
                    // Show user menu
                    this.showUserMenu(userMenuButton);
                });
            }
        },
        
        // Navigation handler
        navigateTo: function(route) {
            // Update header title
            const headerTitle = state.contentWindow.querySelector('.header-title h1');
            if (headerTitle) {
                let title = route.charAt(0).toUpperCase() + route.slice(1);
                headerTitle.textContent = title;
            }
            
            // Render correct view based on route
            switch (route) {
                case 'dashboard':
                    this.renderDashboard();
                    break;
                case 'posts':
                    this.renderContentList('posts');
                    break;
                case 'pages':
                    this.renderContentList('pages');
                    break;
                case 'media':
                    this.renderMediaLibrary();
                    break;
                case 'categories':
                    this.renderTaxonomyList('categories');
                    break;
                case 'tags':
                    this.renderTaxonomyList('tags');
                    break;
                case 'users':
                    this.renderUsersList();
                    break;
                case 'comments':
                    this.renderCommentsList();
                    break;
                case 'settings':
                    this.renderSettings();
                    break;
                case 'tools':
                    this.renderTools();
                    break;
                case 'help':
                    this.renderHelp();
                    break;
                default:
                    this.renderDashboard();
            }
        },
        
        // Render dashboard
        renderDashboard: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Prepare dashboard data
            const dashboardData = {
                postCount: state.contentLibrary.posts ? state.contentLibrary.posts.length : 0,
                pageCount: state.contentLibrary.pages ? state.contentLibrary.pages.length : 0,
                mediaCount: state.contentLibrary.media ? state.contentLibrary.media.length : 0,
                commentCount: state.contentLibrary.posts ? 
                    state.contentLibrary.posts.reduce((count, post) => count + (post.comments ? post.comments.length : 0), 0) : 0,
                recentActivity: this.getRecentActivity()
            };
            
            contentContainer.innerHTML = this.renderTemplate(templates.dashboard, dashboardData);
            
            // Add event listeners
            const saveDraftButton = contentContainer.querySelector('.save-draft-button');
            if (saveDraftButton) {
                saveDraftButton.addEventListener('click', () => {
                    const titleInput = contentContainer.querySelector('.draft-title');
                    const contentInput = contentContainer.querySelector('.draft-content');
                    
                    if (titleInput && contentInput) {
                        const title = titleInput.value.trim();
                        const content = contentInput.value.trim();
                        
                        if (title && content) {
                            // Create new draft post
                            contentService.create('posts', {
                                title: title,
                                content: content,
                                status: 'draft'
                            });
                            
                            // Clear form
                            titleInput.value = '';
                            contentInput.value = '';
                            
                            // Show success message
                            this.showNotification('Draft saved successfully!', 'success');
                            
                            // Refresh dashboard
                            this.renderDashboard();
                        } else {
                            // Show error message
                            this.showNotification('Please enter both title and content', 'error');
                        }
                    }
                });
            }
        },
        
        // Get recent activity data
        getRecentActivity: function() {
            const activity = [];
            
            // Get recent content updates
            ['posts', 'pages'].forEach(type => {
                if (state.contentLibrary[type]) {
                    const items = [...state.contentLibrary[type]]
                        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                        .slice(0, 3);
                    
                    items.forEach(item => {
                        activity.push({
                            icon: type === 'posts' ? 'file-alt' : 'file',
                            title: `${item.title} ${item.status === 'published' ? 'published' : 'updated'}`,
                            meta: type === 'posts' ? 'Post' : 'Page',
                            time: formatDate(item.updatedAt)
                        });
                    });
                }
            });
            
            // Sort by date
            activity.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            return activity.slice(0, 5); // Return the 5 most recent
        },
        
        // Show notification
        showNotification: function(message, type = 'info') {
            if (typeof cr8OS !== 'undefined' && cr8OS.addNotification) {
                // Use cr8OS notification system
                const title = type.charAt(0).toUpperCase() + type.slice(1);
                cr8OS.addNotification(title, message, {
                    type: type,
                    duration: 3000
                });
            } else {
                // Fallback to alert
                alert(message);
            }
        },
        
        // Show new content menu
        showNewContentMenu: function(buttonEl) {
            // Create menu element
            const menu = document.createElement('div');
            menu.className = 'new-content-menu';
            menu.innerHTML = `
                <div class="menu-item" data-type="post">
                    <i class="fas fa-file-alt"></i>
                    <span>New Post</span>
                </div>
                <div class="menu-item" data-type="page">
                    <i class="fas fa-file"></i>
                    <span>New Page</span>
                </div>
                <div class="menu-item" data-type="media">
                    <i class="fas fa-image"></i>
                    <span>Upload Media</span>
                </div>
                <div class="menu-item" data-type="category">
                    <i class="fas fa-folder"></i>
                    <span>New Category</span>
                </div>
                <div class="menu-item" data-type="tag">
                    <i class="fas fa-tag"></i>
                    <span>New Tag</span>
                </div>
                <div class="menu-item" data-type="user">
                    <i class="fas fa-user"></i>
                    <span>New User</span>
                </div>
            `;
            
            // Position menu relative to button
            const buttonRect = buttonEl.getBoundingClientRect();
            menu.style.position = 'absolute';
            menu.style.top = `${buttonRect.bottom + 5}px`;
            menu.style.right = `20px`;
            
            // Add to DOM
            document.body.appendChild(menu);
            
            // Add event listeners
            menu.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Hide menu
                    menu.remove();
                    
                    // Handle action based on type
                    const type = item.dataset.type;
                    this.createNewContent(type);
                });
            });
            
            // Close when clicking outside
            const handleClickOutside = function(e) {
                if (!menu.contains(e.target) && e.target !== buttonEl) {
                    menu.remove();
                    document.removeEventListener('click', handleClickOutside);
                }
            };
            
            // Add handler after a small delay to avoid immediate trigger
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        },
        
        // Create new content
        createNewContent: function(type) {
            switch (type) {
                case 'post':
                    // Create new post and open editor
                    const post = contentService.create('posts', {
                        title: 'New Post',
                        content: '',
                        status: 'draft'
                    });
                    
                    this.openContentEditor('posts', post.id);
                    break; // 
                    
                case 'page':
                    // Create new page and open editor
                    const page = contentService.create('pages', {
                        title: 'New Page',
                        content: '',
                        status: 'draft'
                    });
                    
                    this.openContentEditor('pages', page.id);
                    break;
                    
                 case 'media':
                    // Open media upload interface
                    this.openMediaUploader();
                    break;
                    
                case 'category':
                    // Show category creation form
                    this.showCategoryForm();
                    break;
                    
                case 'tag':
                    // Show tag creation form
                    this.showTagForm();
                    break;
                    
                case 'user':
                    // Show user creation form
                    this.showUserForm();
                    break;
            }
        },
        
        // Show user menu
        showUserMenu: function(buttonEl) {
            // Create menu element
            const menu = document.createElement('div');
            menu.className = 'user-menu';
            menu.innerHTML = `
                <div class="menu-item" data-action="profile">
                    <i class="fas fa-user-circle"></i>
                    <span>Edit Profile</span>
                </div>
                <div class="menu-item" data-action="preferences">
                    <i class="fas fa-sliders-h"></i>
                    <span>Preferences</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log Out</span>
                </div>
            `;
            
            // Position menu relative to button
            const buttonRect = buttonEl.getBoundingClientRect();
            menu.style.position = 'absolute';
            menu.style.top = `${buttonRect.bottom + 5}px`;
            menu.style.right = `20px`;
            
            // Add to DOM
            document.body.appendChild(menu);
            
            // Add event listeners
            menu.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Hide menu
                    menu.remove();
                    
                    // Handle action based on type
                    const action = item.dataset.action;
                    
                    switch (action) {
                        case 'profile':
                            this.showProfileEditor();
                            break;
                        case 'preferences':
                            this.showUserPreferences();
                            break;
                        case 'logout':
                            this.logoutUser();
                            break;
                    }
                });
            });
            
            // Close when clicking outside
            const handleClickOutside = function(e) {
                if (!menu.contains(e.target) && e.target !== buttonEl) {
                    menu.remove();
                    document.removeEventListener('click', handleClickOutside);
                }
            };
            
            // Add handler after a small delay to avoid immediate trigger
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        },
        
        // Render content list (posts, pages, etc.)
        renderContentList: function(contentType) {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get content items
            const items = contentService.getAll(contentType);
            
            // Count by status
            const totalCount = items.length;
            const publishedCount = items.filter(item => item.status === 'published').length;
            const draftCount = items.filter(item => item.status === 'draft').length;
            const trashCount = items.filter(item => item.status === 'trash').length;
            
            // Prepare custom columns based on content type
            let columns = [];
            let filterOptions = [];
            
            if (contentType === 'posts') {
                columns = [
                    { class: 'categories-column', label: 'Categories' },
                    { class: 'tags-column', label: 'Tags' }
                ];
                
                // Add category filter
                const categories = contentService.getAll('categories');
                if (categories.length > 0) {
                    filterOptions.push({
                        name: 'category',
                        label: 'Category',
                        options: categories.map(cat => ({
                            value: cat.id,
                            label: cat.name
                        }))
                    });
                }
            } else if (contentType === 'pages') {
                columns = [
                    { class: 'template-column', label: 'Template' },
                    { class: 'parent-column', label: 'Parent' }
                ];
            }
            
            // Prepare items for display
            const displayItems = items.map(item => {
                // Find author
                const author = userService.get(item.authorId);
                const authorName = author ? author.getFullName() : 'Unknown';
                
                // Prepare column data
                const columnData = [];
                
                if (contentType === 'posts') {
                    // Add categories
                    if (item.categories && Array.isArray(item.categories)) {
                        const categoryNames = item.categories.map(catId => {
                            const category = contentService.get('categories', catId);
                            return category ? category.name : '';
                        }).filter(Boolean);
                        
                        columnData.push({
                            class: 'categories-column',
                            value: categoryNames.join(', ') || ''
                        });
                    } else {
                        columnData.push({
                            class: 'categories-column',
                            value: ''
                        });
                    }
                    
                    // Add tags
                    if (item.tags && Array.isArray(item.tags)) {
                        const tagNames = item.tags.map(tagId => {
                            const tag = contentService.get('tags', tagId);
                            return tag ? tag.name : '';
                        }).filter(Boolean);
                        
                        columnData.push({
                            class: 'tags-column',
                            value: tagNames.join(', ') || ''
                        });
                    } else {
                        columnData.push({
                            class: 'tags-column',
                            value: ''
                        });
                    }
                } else if (contentType === 'pages') {
                    // Add template
                    columnData.push({
                        class: 'template-column',
                        value: item.template || 'Default'
                    });
                    
                    // Add parent
                    if (item.parent) {
                        const parent = contentService.get('pages', item.parent);
                        columnData.push({
                            class: 'parent-column',
                            value: parent ? parent.title : ''
                        });
                    } else {
                        columnData.push({
                            class: 'parent-column',
                            value: ''
                        });
                    }
                }
                
                // Status text
                let statusText = '';
                switch (item.status) {
                    case 'published':
                        statusText = 'Published';
                        break;
                    case 'draft':
                        statusText = 'Draft';
                        break;
                    case 'private':
                        statusText = 'Private';
                        break;
                    case 'trash':
                        statusText = 'Trash';
                        break;
                    default:
                        statusText = item.status;
                }
                
                return {
                    id: item.id,
                    title: item.title,
                    author: authorName,
                    date: formatDate(item.updatedAt),
                    status: item.status,
                    statusText: statusText,
                    columnData: columnData
                };
            });
            
            // Pagination data (placeholder)
            const paginationData = {
                start: 1,
                end: displayItems.length,
                total: displayItems.length,
                prevDisabled: 'disabled',
                nextDisabled: 'disabled',
                pages: [{ number: 1, active: 'active' }]
            };
            
            // Compile template data
            const templateData = {
                totalCount,
                publishedCount,
                draftCount,
                trashCount,
                columns,
                filterOptions,
                items: displayItems,
                ...paginationData
            };
            
            // Render the template
            contentContainer.innerHTML = this.renderTemplate(templates.contentList, templateData);
            
            // Add event listeners
            this.setupContentListListeners(contentType);
        },
        
        // Set up content list event listeners
        setupContentListListeners: function(contentType) {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Filter links
            contentContainer.querySelectorAll('.filter-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active state
                    contentContainer.querySelectorAll('.filter-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // TODO: Apply filter
                    const filter = this.dataset.filter;
                    console.log('Filter by:', filter);
                });
            });
            
            // Edit action
            contentContainer.querySelectorAll('[data-action="edit"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = link.dataset.id;
                    if (id) {
                        this.openContentEditor(contentType, id);
                    }
                });
            });
            
            // View action
            contentContainer.querySelectorAll('[data-action="view"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = link.dataset.id;
                    if (id) {
                        // Show preview
                        this.showContentPreview(contentType, id);
                    }
                });
            });
            
            // Trash action
            contentContainer.querySelectorAll('[data-action="trash"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = link.dataset.id;
                    if (id) {
                        // Confirm before trashing
                        if (confirm('Are you sure you want to move this item to trash?')) {
                            // Move to trash (update status)
                            contentService.update(contentType, id, { status: 'trash' });
                            
                            // Refresh list
                            this.renderContentList(contentType);
                            
                            // Show notification
                            this.showNotification('Item moved to trash.', 'info');
                        }
                    }
                });
            });
            
            // Bulk actions
            const bulkActionSelect = contentContainer.querySelector('.bulk-action-select');
            const applyBulkButton = contentContainer.querySelector('.apply-bulk-button');
            
            if (bulkActionSelect && applyBulkButton) {
                applyBulkButton.addEventListener('click', () => {
                    const action = bulkActionSelect.value;
                    if (!action) return;
                    
                    // Get selected items
                    const checkedBoxes = contentContainer.querySelectorAll('.row-checkbox:checked');
                    const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
                    
                    if (selectedIds.length === 0) {
                        this.showNotification('No items selected.', 'error');
                        return;
                    }
                    
                    // Confirm action
                    if (confirm(`Are you sure you want to ${action} ${selectedIds.length} item(s)?`)) {
                        // Apply action to each item
                        let newStatus = '';
                        switch (action) {
                            case 'trash':
                                newStatus = 'trash';
                                break;
                            case 'publish':
                                newStatus = 'published';
                                break;
                            case 'draft':
                                newStatus = 'draft';
                                break;
                        }
                        
                        if (newStatus) {
                            selectedIds.forEach(id => {
                                contentService.update(contentType, id, { status: newStatus });
                            });
                            
                            // Refresh list
                            this.renderContentList(contentType);
                            
                            // Show notification
                            this.showNotification(`${selectedIds.length} item(s) updated.`, 'success');
                        }
                    }
                });
            }
            
            // Select all checkbox
            const selectAllCheckbox = contentContainer.querySelector('.select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const rowCheckboxes = contentContainer.querySelectorAll('.row-checkbox');
                    rowCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                });
            }
        },
        
        // Render media library
        renderMediaLibrary: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get media items
            const items = contentService.getAll('media');
            
            // Prepare items for display
            const displayItems = items.map(item => {
                // Find author
                const author = userService.get(item.authorId);
                const authorName = author ? author.getFullName() : 'Unknown';
                
                // File size formatting
                const fileSizeFormatted = this.formatFileSize(item.fileSize);
                
                return {
                    id: item.id,
                    title: item.title,
                    url: item.url,
                    type: item.type,
                    date: formatDate(item.createdAt),
                    author: authorName,
                    fileSize: fileSizeFormatted,
                    isImage: item.type === 'image',
                    isVideo: item.type === 'video',
                    isAudio: item.type === 'audio',
                    isDocument: item.type === 'document'
                };
            });
            
            // Pagination data (placeholder)
            const paginationData = {
                start: 1,
                end: displayItems.length,
                total: displayItems.length,
                prevDisabled: 'disabled',
                nextDisabled: 'disabled',
                pages: [{ number: 1, active: 'active' }]
            };
            
            // Compile template data
            const templateData = {
                items: displayItems,
                ...paginationData
            };
            
            // Render the template
            contentContainer.innerHTML = this.renderTemplate(templates.mediaGrid, templateData);
            
            // Add event listeners
            this.setupMediaLibraryListeners();
        },
        
        // Format file size
        formatFileSize: function(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        // Set up media library event listeners
        setupMediaLibraryListeners: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // View toggle buttons
            const gridViewButton = contentContainer.querySelector('[data-view="grid"]');
            const listViewButton = contentContainer.querySelector('[data-view="list"]');
            const gridView = contentContainer.querySelector('.media-grid-view');
            const listView = contentContainer.querySelector('.media-list-view');
            
            if (gridViewButton && listViewButton && gridView && listView) {
                gridViewButton.addEventListener('click', function() {
                    gridViewButton.classList.add('active');
                    listViewButton.classList.remove('active');
                    gridView.style.display = 'grid';
                    listView.style.display = 'none';
                    
                    // Save preference
                    state.settings.mediaLibraryViewMode = 'grid';
                    storage.save();
                });
                
                listViewButton.addEventListener('click', function() {
                    listViewButton.classList.add('active');
                    gridViewButton.classList.remove('active');
                    listView.style.display = 'block';
                    gridView.style.display = 'none';
                    
                    // Save preference
                    state.settings.mediaLibraryViewMode = 'list';
                    storage.save();
                });
                
                // Set initial view based on preference
                if (state.settings.mediaLibraryViewMode === 'list') {
                    listViewButton.click();
                } else {
                    gridViewButton.click();
                }
            }
            
            // Upload button
            const uploadButton = contentContainer.querySelector('.upload-media-button');
            const uploadInput = contentContainer.querySelector('#media-upload-input');
            
            if (uploadButton && uploadInput) {
                uploadButton.addEventListener('click', function() {
                    uploadInput.click();
                });
                
                uploadInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files && files.length > 0) {
                        this.handleFileUpload(files);
                    }
                });
            }
            
            // Media item actions
            contentContainer.querySelectorAll('.media-action-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    const action = button.dataset.action;
                    const mediaItem = button.closest('[data-id]');
                    const mediaId = mediaItem ? mediaItem.dataset.id : null;
                    
                    if (!mediaId) return;
                    
                    switch (action) {
                        case 'edit':
                            this.openMediaEditor(mediaId);
                            break;
                        case 'view':
                            this.showMediaPreview(mediaId);
                            break;
                        case 'delete':
                            if (confirm('Are you sure you want to delete this media item?')) {
                                contentService.delete('media', mediaId);
                                this.renderMediaLibrary();
                                this.showNotification('Media item deleted.', 'info');
                            }
                            break;
                    }
                });
            });
            
            // Click on media item (for selection)
            contentContainer.querySelectorAll('.media-item').forEach(item => {
                item.addEventListener('click', () => {
                    const mediaId = item.dataset.id;
                    if (mediaId) {
                        // Toggle selection
                        item.classList.toggle('selected');
                    }
                });
                
                // Double click to edit
                item.addEventListener('dblclick', () => {
                    const mediaId = item.dataset.id;
                    if (mediaId) {
                        this.openMediaEditor(mediaId);
                    }
                });
            });
            
            // Media filters
            const typeFilter = contentContainer.querySelector('.media-type-filter');
            if (typeFilter) {
                typeFilter.addEventListener('change', () => {
                    const filterType = typeFilter.value;
                    
                    // Apply filter
                    if (filterType === 'all') {
                        // Show all items
                        contentContainer.querySelectorAll('.media-item').forEach(item => {
                            item.style.display = '';
                        });
                    } else {
                        // Filter by type
                        contentContainer.querySelectorAll('.media-item').forEach(item => {
                            if (item.dataset.type === filterType) {
                                item.style.display = '';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    }
                });
            }
        },
        
        // Handle file upload
        handleFileUpload: function(files) {
            Array.from(files).forEach(file => {
                // Determine file type
                let fileType = 'document';
                
                if (file.type.includes('image')) {
                    fileType = 'image';
                } else if (file.type.includes('video')) {
                    fileType = 'video';
                } else if (file.type.includes('audio')) {
                    fileType = 'audio';
                }
                
                // Create object URL
                const url = URL.createObjectURL(file);
                
                // Create media item
                const newMedia = contentService.create('media', {
                    title: file.name,
                    type: fileType,
                    url: url,
                    filePath: file.name,
                    fileSize: file.size,
                    alt: file.name
                });
                
                // If it's an image, get dimensions
                if (fileType === 'image') {
                    const img = new Image();
                    img.onload = () => {
                        contentService.update('media', newMedia.id, {
                            width: img.width,
                            height: img.height
                        });
                    };
                    img.src = url;
                }
            });
            
            // Refresh media library
            this.renderMediaLibrary();
            
            // Show notification
            this.showNotification(`${files.length} file(s) uploaded.`, 'success');
        },
        
        // Open content editor
        openContentEditor: function(contentType, contentId) {
            const content = contentService.get(contentType, contentId);
            if (!content) return;
            
            // Update editor state
            state.editorState.currentContent = content;
            state.editorState.contentType = contentType;
            state.editorState.isDirty = false;
            state.editorState.lastSaved = new Date();
            
            // Update header title
            const headerTitle = state.contentWindow.querySelector('.header-title h1');
            if (headerTitle) {
                headerTitle.textContent = `Edit ${contentType === 'posts' ? 'Post' : 'Page'}`;
            }
            
            // Prepare editor data
            const editorData = {
                title: content.title,
                content: content.content,
                publishText: content.status === 'published' ? 'Update' : 'Publish',
                draftSelected: content.status === 'draft' ? 'selected' : '',
                publishedSelected: content.status === 'published' ? 'selected' : '',
                privateSelected: content.status === 'private' ? 'selected' : '',
                publicChecked: content.visibility !== 'password' && content.visibility !== 'private' ? 'checked' : '',
                passwordChecked: content.visibility === 'password' ? 'checked' : '',
                privateChecked: content.visibility === 'private' ? 'checked' : '',
                publishDate: content.publishDate || '',
                excerpt: content.excerpt || '',
                hasFeaturedImage: content.featured_image ? true : false,
                featuredImageUrl: content.featured_image ? contentService.get('media', content.featured_image)?.url : '',
                isPost: contentType === 'posts',
                isPage: contentType === 'pages'
            };
            
            // Additional data for post/page specific fields
            if (contentType === 'posts') {
                // Get all categories
                const allCategories = contentService.getAll('categories');
                editorData.categories = allCategories.map(category => ({
                    id: category.id,
                    name: category.name,
                    checked: content.categories && content.categories.includes(category.id) ? 'checked' : ''
                }));
                
                // Get all tags
                const postTags = (content.tags || []).map(tagId => {
                    const tag = contentService.get('tags', tagId);
                    return tag ? { id: tag.id, name: tag.name } : null;
                }).filter(Boolean);
                
                editorData.tags = postTags;
            } else if (contentType === 'pages') {
                // Get all pages for parent selection
                const allPages = contentService.getAll('pages').filter(page => page.id !== content.id);
                editorData.pages = allPages.map(page => ({
                    id: page.id,
                    title: page.title,
                    selected: content.parent === page.id ? 'selected' : ''
                }));
                
                // Page templates
                editorData.defaultSelected = content.template === 'default' ? 'selected' : '';
                editorData.templates = [
                    { id: 'full-width', name: 'Full Width', selected: content.template === 'full-width' ? 'selected' : '' },
                    { id: 'sidebar', name: 'With Sidebar', selected: content.template === 'sidebar' ? 'selected' : '' },
                    { id: 'landing', name: 'Landing Page', selected: content.template === 'landing' ? 'selected' : '' }
                ];
                
                editorData.order = content.order || 0;
            }
            
            // Render editor
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (contentContainer) {
                contentContainer.innerHTML = this.renderTemplate(templates.contentEditor, editorData);
                this.setupEditorEventListeners();
                
                // Set up auto-save if enabled
                if (state.settings.autoSave) {
                    this.setupAutoSave();
                }
            }
        },
        
        // Set up editor event listeners
        setupEditorEventListeners: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Editor content changes
            const titleInput = contentContainer.querySelector('.title-input');
            const editorContent = contentContainer.querySelector('.editor-content');
            
            if (titleInput) {
                titleInput.addEventListener('input', () => {
                    state.editorState.isDirty = true;
                });
            }
            
            if (editorContent) {
                editorContent.addEventListener('input', () => {
                    state.editorState.isDirty = true;
                });
            }
            
            // Toolbar buttons
            contentContainer.querySelectorAll('.toolbar-button').forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    const value = button.dataset.value || '';
                    
                    if (command) {
                        // Execute command
                        document.execCommand(command, false, value);
                        
                        // Focus back on editor
                        editorContent.focus();
                    }
                });
            });
            
            // Heading select
            const headingSelect = contentContainer.querySelector('.heading-select');
            if (headingSelect) {
                headingSelect.addEventListener('change', function() {
                    if (this.value) {
                        document.execCommand('formatBlock', false, this.value);
                    }
                });
            }
            
            // Panel toggles
            contentContainer.querySelectorAll('.panel-toggle-button').forEach(button => {
                button.addEventListener('click', function() {
                    const panel = this.closest('.sidebar-panel');
                    if (panel) {
                        panel.classList.toggle('collapsed');
                        
                        // Update icon
                        const icon = this.querySelector('i');
                        if (icon) {
                            if (panel.classList.contains('collapsed')) {
                                icon.className = 'fas fa-chevron-down';
                            } else {
                                icon.className = 'fas fa-chevron-up';
                            }
                        }
                    }
                });
            });
            
            // Save draft button
            const saveDraftButtons = contentContainer.querySelectorAll('.save-draft-button');
            saveDraftButtons.forEach(button => {
                button.addEventListener('click', () => {
                    this.saveContent('draft');
                });
            });
            
            // Publish/update button
            const publishButtons = contentContainer.querySelectorAll('.publish-button');
            publishButtons.forEach(button => {
                button.addEventListener('click', () => {
                    this.saveContent('published');
                });
            });
            
            // Featured image
            const setFeaturedImageButton = contentContainer.querySelector('.set-featured-image-button');
            if (setFeaturedImageButton) {
                setFeaturedImageButton.addEventListener('click', () => {
                    this.openMediaSelector((mediaId) => {
                        // Update featured image
                        if (mediaId) {
                            const media = contentService.get('media', mediaId);
                            if (media && media.type === 'image') {
                                // Update content
                                state.editorState.currentContent.featured_image = mediaId;
                                state.editorState.isDirty = true;
                                
                                // Update UI
                                const featuredImageContainer = contentContainer.querySelector('.featured-image-container');
                                if (featuredImageContainer) {
                                    featuredImageContainer.innerHTML = `
                                        <img src="${media.url}" alt="Featured Image" class="featured-image">
                                        <button class="remove-featured-image-button">
                                            <i class="fas fa-times"></i>
                                            <span>Remove Featured Image</span>
                                        </button>
                                    `;
                                    
                                    // Add remove handler
                                    const removeButton = featuredImageContainer.querySelector('.remove-featured-image-button');
                                    if (removeButton) {
                                        removeButton.addEventListener('click', () => {
                                            // Remove featured image
                                            state.editorState.currentContent.featured_image = null;
                                            state.editorState.isDirty = true;
                                            
                                            // Update UI
                                            featuredImageContainer.innerHTML = `
                                                <div class="featured-image-placeholder">
                                                    <i class="fas fa-image"></i>
                                                    <span>No image selected</span>
                                                </div>
                                            `;
                                        });
                                    }
                                }
                            }
                        }
                    });
                });
            }
            
            // Remove featured image
            const removeFeaturedImageButton = contentContainer.querySelector('.remove-featured-image-button');
            if (removeFeaturedImageButton) {
                removeFeaturedImageButton.addEventListener('click', () => {
                    // Remove featured image
                    state.editorState.currentContent.featured_image = null;
                    state.editorState.isDirty = true;
                    
                    // Update UI
                    const featuredImageContainer = contentContainer.querySelector('.featured-image-container');
                    if (featuredImageContainer) {
                        featuredImageContainer.innerHTML = `
                            <div class="featured-image-placeholder">
                                <i class="fas fa-image"></i>
                                <span>No image selected</span>
                            </div>
                        `;
                    }
                });
            }
            
            // Insert image button
            const insertImageButton = contentContainer.querySelector('[data-command="insertImage"]');
            if (insertImageButton) {
                insertImageButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.openMediaSelector((mediaId) => {
                        // Insert image
                        if (mediaId) {
                            const media = contentService.get('media', mediaId);
                            if (media && media.type === 'image') {
                                document.execCommand('insertImage', false, media.url);
                            }
                        }
                    });
                });
            }
            
            // Tags input
            const tagsInput = contentContainer.querySelector('.tags-input');
            if (tagsInput) {
                // Handle tags input
                tagsInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        
                        const tagName = tagsInput.value.trim();
                        if (tagName) {
                            // Check if tag exists
                            let tagId = null;
                            let existingTag = contentService.getAll('tags').find(tag => 
                                tag.name.toLowerCase() === tagName.toLowerCase());
                            
                            if (existingTag) {
                                tagId = existingTag.id;
                            } else {
                                // Create new tag
                                const newTag = contentService.create('tags', {
                                    name: tagName
                                });
                                tagId = newTag.id;
                            }
                            
                            if (tagId) {
                                // Check if tag is already added
                                if (!state.editorState.currentContent.tags) {
                                    state.editorState.currentContent.tags = [];
                                }
                                
                                if (!state.editorState.currentContent.tags.includes(tagId)) {
                                    // Add tag
                                    state.editorState.currentContent.tags.push(tagId);
                                    state.editorState.isDirty = true;
                                    
                                    // Update UI
                                    const currentTags = contentContainer.querySelector('.current-tags');
                                    if (currentTags) {
                                        const tag = contentService.get('tags', tagId);
                                        const tagElement = document.createElement('span');
                                        tagElement.className = 'tag-item';
                                        tagElement.dataset.id = tagId;
                                        tagElement.innerHTML = `
                                            ${tag.name}
                                            <button class="remove-tag-button" data-id="${tagId}">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        `;
                                        
                                        // Add remove handler
                                        const removeButton = tagElement.querySelector('.remove-tag-button');
                                        if (removeButton) {
                                            removeButton.addEventListener('click', () => {
                                                // Remove tag
                                                state.editorState.currentContent.tags = 
                                                    state.editorState.currentContent.tags.filter(id => id !== tagId);
                                                state.editorState.isDirty = true;
                                                
                                                // Remove from UI
                                                tagElement.remove();
                                            });
                                        }
                                        
                                        currentTags.appendChild(tagElement);
                                    }
                                }
                                
                                // Clear input
                                tagsInput.value = '';
                            }
                        }
                    }
                });
            }
            
            // Category checkboxes
            contentContainer.querySelectorAll('.category-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Update categories
                    const categoryId = this.value;
                    if (!state.editorState.currentContent.categories) {
                        state.editorState.currentContent.categories = [];
                    }
                    
                    if (this.checked) {
                        // Add category
                        if (!state.editorState.currentContent.categories.includes(categoryId)) {
                            state.editorState.currentContent.categories.push(categoryId);
                            state.editorState.isDirty = true;
                        }
                    } else {
                        // Remove category
                        state.editorState.currentContent.categories = 
                            state.editorState.currentContent.categories.filter(id => id !== categoryId);
                        state.editorState.isDirty = true;
                    }
                });
            });
            
            // Page attributes
            if (state.editorState.contentType === 'pages') {
                // Parent page
                const parentSelect = contentContainer.querySelector('.parent-page-select');
                if (parentSelect) {
                    parentSelect.addEventListener('change', function() {
                        state.editorState.currentContent.parent = this.value || null;
                        state.editorState.isDirty = true;
                    });
                }
                
                // Template
                const templateSelect = contentContainer.querySelector('.template-select');
                if (templateSelect) {
                    templateSelect.addEventListener('change', function() {
                        state.editorState.currentContent.template = this.value;
                        state.editorState.isDirty = true;
                    });
                }
                
                // Order
                const orderInput = contentContainer.querySelector('.page-order');
                if (orderInput) {
                    orderInput.addEventListener('change', function() {
                        state.editorState.currentContent.order = parseInt(this.value) || 0;
                        state.editorState.isDirty = true;
                    });
                }
            }
            
            // Excerpt
            const excerptTextarea = contentContainer.querySelector('.excerpt-textarea');
            if (excerptTextarea) {
                excerptTextarea.addEventListener('input', function() {
                    state.editorState.currentContent.excerpt = this.value;
                    state.editorState.isDirty = true;
                });
            }
            
            // Preview button
            const previewButton = contentContainer.querySelector('.preview-button');
            if (previewButton) {
                previewButton.addEventListener('click', () => {
                    this.showContentPreview(state.editorState.contentType, state.editorState.currentContent.id);
                });
            }
        },
        
        // Set up auto-save
        setupAutoSave: function() {
            // Clear existing timer
            if (state.editorState.autosaveTimerId) {
                clearInterval(state.editorState.autosaveTimerId);
            }
            
            // Set new timer
            state.editorState.autosaveTimerId = setInterval(() => {
                if (state.editorState.isDirty) {
                    // Save content without changing status
                    this.saveContent(null, true);
                }
            }, state.settings.autoSaveInterval);
        },
        
        // Save content
        saveContent: function(newStatus = null, isAutoSave = false) {
            if (!state.editorState.currentContent) return;
            
            // Get current values
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const titleInput = contentContainer.querySelector('.title-input');
            const editorContent = contentContainer.querySelector('.editor-content');
            
            // Update content object
            const updatedContent = {
                title: titleInput ? titleInput.value : state.editorState.currentContent.title,
                content: editorContent ? editorContent.innerHTML : state.editorState.currentContent.content,
                updatedAt: new Date()
            };
            
            // Update status if provided
            if (newStatus) {
                updatedContent.status = newStatus;
            }
            
            // Save content
            contentService.update(
                state.editorState.contentType, 
                state.editorState.currentContent.id, 
                updatedContent
            );
            
            // Update editor state
            state.editorState.isDirty = false;
            state.editorState.lastSaved = new Date();
            
            // Show notification
            if (!isAutoSave) {
                this.showNotification('Content saved.', 'success');
                
                // Update publish button text if status changed
                if (newStatus === 'published') {
                    const publishButtons = contentContainer.querySelectorAll('.publish-button span');
                    publishButtons.forEach(button => {
                        button.textContent = 'Update';
                    });
                }
            }
        },
        
        // Open media selector
        openMediaSelector: function(callback) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'media-selector-modal';
            
            // Get media items (images only)
            const items = contentService.getAll('media').filter(item => item.type === 'image');
            
            // Prepare items for display
            const displayItems = items.map(item => {
                return {
                    id: item.id,
                    title: item.title,
                    url: item.url,
                    date: formatDate(item.createdAt)
                };
            });
            
            // Render modal
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Select Media</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="media-filter">
                            <input type="text" placeholder="Search media..." class="media-search-input">
                        </div>
                        <div class="media-grid">
                            ${displayItems.map(item => `
                                <div class="media-item" data-id="${item.id}">
                                    <div class="media-preview">
                                        <img src="${item.url}" alt="${item.title}">
                                    </div>
                                    <div class="media-info">
                                        <div class="media-title">${item.title}</div>
                                        <div class="media-date">${item.date}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="cancel-button">Cancel</button>
                        <button class="select-button" disabled>Select</button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Selected item
            let selectedItemId = null;
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const cancelButton = modal.querySelector('.cancel-button');
            const selectButton = modal.querySelector('.select-button');
            
            // Close/cancel
            const closeModal = () => {
                modal.remove();
            };
            
            if (closeButton) closeButton.addEventListener('click', closeModal);
            if (cancelButton) cancelButton.addEventListener('click', closeModal);
            
            // Select handler
            if (selectButton) {
                selectButton.addEventListener('click', () => {
                    closeModal();
                    if (callback && selectedItemId) {
                        callback(selectedItemId);
                    }
                });
            }
            
            // Media item selection
            const mediaItems = modal.querySelectorAll('.media-item');
            mediaItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Deselect previous
                    mediaItems.forEach(i => i.classList.remove('selected'));
                    
                    // Select this item
                    this.classList.add('selected');
                    selectedItemId = this.dataset.id;
                    
                    // Enable select button
                    if (selectButton) selectButton.disabled = false;
                });
                
                // Double click to select
                item.addEventListener('dblclick', function() {
                    selectedItemId = this.dataset.id;
                    closeModal();
                    if (callback && selectedItemId) {
                        callback(selectedItemId);
                    }
                });
            });
            
            // Search functionality
            const searchInput = modal.querySelector('.media-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    mediaItems.forEach(item => {
                        const title = item.querySelector('.media-title').textContent.toLowerCase();
                        if (title.includes(query)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
                
                // Focus search
                setTimeout(() => searchInput.focus(), 100);
            }
        },
        
        // Show content preview
        showContentPreview: function(contentType, contentId) {
            const content = contentService.get(contentType, contentId);
            if (!content) return;
            
            // Create preview window
            let previewWindow = null;
            
            if (typeof cr8OS !== 'undefined' && cr8OS.createWindow) {
                previewWindow = cr8OS.createWindow(
                    '#preview', // URL placeholder
                    `Preview: ${content.title}`, // Window title
                    { // Window options
                        width: 800,
                        height: 600,
                        resizable: true,
                        minimizable: true,
                        maximizable: true,
                        closable: true
                    }
                );
            } else {
                // Fallback to new window/tab
                previewWindow = window.open('', '_blank');
            }
            
            if (!previewWindow) return;
            
            // Generate preview HTML
            let previewHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${content.title}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        h1 {
                            border-bottom: 1px solid #eee;
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                        }
                        .featured-image {
                            margin-bottom: 20px;
                        }
                        .meta {
                            color: #666;
                            font-size: 0.9em;
                            margin-bottom: 20px;
                        }
                    </style>
                </head>
                <body>
                    <h1>${content.title}</h1>
                    <div class="meta">
                        Preview of ${contentType === 'posts' ? 'post' : 'page'}  
                        Last updated: ${formatDate(content.updatedAt)}
                    </div>
            `;
            
            // Add featured image if available
            if (content.featured_image) {
                const media = contentService.get('media', content.featured_image);
                if (media) {
                    previewHTML += `
                        <div class="featured-image">
                            <img src="${media.url}" alt="${content.title}">
                        </div>
                    `;
                }
            }
            
            // Add content
            previewHTML += `
                    <div class="content">
                        ${content.content}
                    </div>
                </body>
                </html>
            `;
            
            // Set preview content
            if (previewWindow.document) {
                previewWindow.document.open();
                previewWindow.document.write(previewHTML);
                previewWindow.document.close();
            } else {
                // Handle cr8OS window
                const windowContent = previewWindow.querySelector('.window-content');
                if (windowContent) {
                    windowContent.innerHTML = `
                        <div class="preview-container">
                            ${previewHTML}
                        </div>
                    `;
                }
            }
        },
        
        // Open media editor
        openMediaEditor: function(mediaId) {
            const media = contentService.get('media', mediaId);
            if (!media) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'media-editor-modal-container';
            
            // Determine media type specific data
            const isImage = media.type === 'image';
            const isVideo = media.type === 'video';
            const isAudio = media.type === 'audio';
            const isDocument = media.type === 'document';
            
            // File icon based on extension
            let fileIcon = 'alt';
            if (media.filePath) {
                const extension = media.filePath.split('.').pop().toLowerCase();
                
                if (['doc', 'docx'].includes(extension)) fileIcon = 'word';
                else if (['xls', 'xlsx'].includes(extension)) fileIcon = 'excel';
                else if (['ppt', 'pptx'].includes(extension)) fileIcon = 'powerpoint';
                else if (['pdf'].includes(extension)) fileIcon = 'pdf';
                else if (['txt', 'rtf'].includes(extension)) fileIcon = 'text';
                else if (['zip', 'rar', '7z'].includes(extension)) fileIcon = 'archive';
            }
            
            // Format file size
            const fileSize = this.formatFileSize(media.fileSize);
            
            // Dimensions if available
            const isDimensional = isImage || isVideo;
            const dimensions = isDimensional ? `${media.width || '?'}  ${media.height || '?'}` : '';
            
            // Prepare editor data
            const editorData = {
                title: media.title,
                alt: media.alt || '',
                caption: media.caption || '',
                description: media.description || '',
                url: media.url,
                filename: media.filePath,
                fileSize: fileSize,
                mimeType: media.mimeType || 'Unknown',
                uploadDate: formatDate(media.createdAt),
                isImage: isImage,
                isVideo: isVideo,
                isAudio: isAudio,
                isDocument: isDocument,
                fileIcon: fileIcon,
                isDimensional: isDimensional,
                dimensions: dimensions
            };
            
            // Render modal
            modal.innerHTML = this.renderTemplate(templates.mediaEditor, editorData);
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const updateButton = modal.querySelector('.update-button');
            const deleteButton = modal.querySelector('.delete-button');
            
            // Close handler
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Update handler
            if (updateButton) {
                updateButton.addEventListener('click', () => {
                    // Get form values
                    const titleInput = modal.querySelector('.media-title-input');
                    const altInput = modal.querySelector('.media-alt-input');
                    const captionInput = modal.querySelector('.media-caption-input');
                    const descriptionInput = modal.querySelector('.media-description-input');
                    
                    // Update media
                    contentService.update('media', mediaId, {
                        title: titleInput ? titleInput.value : media.title,
                        alt: altInput ? altInput.value : media.alt,
                        caption: captionInput ? captionInput.value : media.caption,
                        description: descriptionInput ? descriptionInput.value : media.description
                    });
                    
                    // Close modal and show notification
                    modal.remove();
                    this.showNotification('Media updated.', 'success');
                    
                    // Refresh media library if open
                    const contentContainer = state.contentWindow.querySelector('.cms-content');
                    if (contentContainer && contentContainer.querySelector('.media-library-container')) {
                        this.renderMediaLibrary();
                    }
                });
            }
            
            // Delete handler
            if (deleteButton) {
                deleteButton.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this media item permanently?')) {
                        contentService.delete('media', mediaId);
                        
                        // Close modal and show notification
                        modal.remove();
                        this.showNotification('Media deleted.', 'info');
                        
                        // Refresh media library if open
                        const contentContainer = state.contentWindow.querySelector('.cms-content');
                        if (contentContainer && contentContainer.querySelector('.media-library-container')) {
                            this.renderMediaLibrary();
                        }
                    }
                });
            }
        },
        
        // Show media preview
        showMediaPreview: function(mediaId) {
            const media = contentService.get('media', mediaId);
            if (!media) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'media-preview-modal';
            
            // Render based on media type
            let previewContent = '';
            
            if (media.type === 'image') {
                previewContent = `<img src="${media.url}" alt="${media.title}">`;
            } else if (media.type === 'video') {
                previewContent = `
                    <video controls>
                        <source src="${media.url}" type="${media.mimeType || 'video/mp4'}">
                        Your browser doesn't support video playback.
                    </video>
                `;
            } else if (media.type === 'audio') {
                previewContent = `
                    <audio controls>
                        <source src="${media.url}" type="${media.mimeType || 'audio/mpeg'}">
                        Your browser doesn't support audio playback.
                    </audio>
                `;
            } else {
                // Document preview (show icon and filename)
                const extension = media.filePath ? media.filePath.split('.').pop().toLowerCase() : '';
                let fileIcon = 'file-alt';
                
                if (['doc', 'docx'].includes(extension)) fileIcon = 'file-word';
                else if (['xls', 'xlsx'].includes(extension)) fileIcon = 'file-excel';
                else if (['ppt', 'pptx'].includes(extension)) fileIcon = 'file-powerpoint';
                else if (['pdf'].includes(extension)) fileIcon = 'file-pdf';
                else if (['txt', 'rtf'].includes(extension)) fileIcon = 'file-alt';
                else if (['zip', 'rar', '7z'].includes(extension)) fileIcon = 'file-archive';
                
                previewContent = `
                    <div class="document-preview">
                        <i class="fas fa-${fileIcon} fa-5x"></i>
                        <div class="document-name">${media.filePath || media.title}</div>
                        <a href="${media.url}" download class="download-link">Download</a>
                    </div>
                `;
            }
            
            // Render modal
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${media.title}</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="media-preview-container">
                            ${previewContent}
                        </div>
                        <div class="media-info">
                            ${media.description ? `<p class="media-description">${media.description}</p>` : ''}
                            <div class="media-metadata">
                                <div class="metadata-item">
                                    <span class="metadata-label">File name:</span>
                                    <span class="metadata-value">${media.filePath || 'Unknown'}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">File type:</span>
                                    <span class="metadata-value">${media.mimeType || 'Unknown'}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">File size:</span>
                                    <span class="metadata-value">${this.formatFileSize(media.fileSize)}</span>
                                </div>
                                ${media.width && media.height ? `
                                <div class="metadata-item">
                                    <span class="metadata-label">Dimensions:</span>
                                    <span class="metadata-value">${media.width}  ${media.height}</span>
                                </div>
                                ` : ''}
                                <div class="metadata-item">
                                    <span class="metadata-label">Uploaded:</span>
                                    <span class="metadata-value">${formatDate(media.createdAt)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add close handler
            const closeButton = modal.querySelector('.close-modal-button');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Close when clicking outside content
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        },
        
        // Render taxonomy list (categories or tags)
        renderTaxonomyList: function(taxonomyType) {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get items
            const items = contentService.getAll(taxonomyType);
            
            // Prepare items for display
            const displayItems = items.map(item => {
                // Count usage
                let count = 0;
                
                if (taxonomyType === 'categories') {
                    state.contentLibrary.posts.forEach(post => {
                        if (post.categories && post.categories.includes(item.id)) {
                            count++;
                        }
                    });
                } else if (taxonomyType === 'tags') {
                    state.contentLibrary.posts.forEach(post => {
                        if (post.tags && post.tags.includes(item.id)) {
                            count++;
                        }
                    });
                }
                
                return {
                    id: item.id,
                    name: item.name,
                    slug: item.slug,
                    description: item.description || '',
                    count: count
                };
            });
            
            // Render template
            contentContainer.innerHTML = `
                <div class="taxonomy-list-container">
                    <div class="taxonomy-form">
                        <h2>Add New ${taxonomyType === 'categories' ? 'Category' : 'Tag'}</h2>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" class="taxonomy-name" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label>Slug</label>
                            <input type="text" class="taxonomy-slug" placeholder="slug">
                            <p class="input-description">
                                The "slug" is the URL-friendly version of the name. It is usually all lowercase and contains only letters, numbers, and hyphens.
                            </p>
                        </div>
                        ${taxonomyType === 'categories' ? `
                        <div class="form-group">
                            <label>Parent Category</label>
                            <select class="taxonomy-parent">
                                <option value="">None</option>
                                ${displayItems.map(item => `
                                    <option value="${item.id}">${item.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="taxonomy-description" placeholder="Description"></textarea>
                        </div>
                        <button class="add-taxonomy-button">
                            Add ${taxonomyType === 'categories' ? 'Category' : 'Tag'}
                        </button>
                    </div>
                    <div class="taxonomy-list">
                        <h2>${taxonomyType === 'categories' ? 'Categories' : 'Tags'}</h2>
                        <table class="taxonomy-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Slug</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${displayItems.map(item => `
                                    <tr data-id="${item.id}">
                                        <td class="name-column">
                                            <div class="taxonomy-name-display">${item.name}</div>
                                            <div class="row-actions">
                                                <span class="edit"><a href="#" data-action="edit" data-id="${item.id}">Edit</a> | </span>
                                                <span class="view"><a href="#" data-action="view" data-id="${item.id}">View</a> | </span>
                                                <span class="delete"><a href="#" data-action="delete" data-id="${item.id}">Delete</a></span>
                                            </div>
                                        </td>
                                        <td>${item.description || ''}</td>
                                        <td>${item.slug}</td>
                                        <td>${item.count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const addButton = contentContainer.querySelector('.add-taxonomy-button');
            if (addButton) {
                addButton.addEventListener('click', () => {
                    const nameInput = contentContainer.querySelector('.taxonomy-name');
                    const slugInput = contentContainer.querySelector('.taxonomy-slug');
                    const descriptionInput = contentContainer.querySelector('.taxonomy-description');
                    
                    const name = nameInput ? nameInput.value.trim() : '';
                    if (!name) {
                        this.showNotification('Name is required.', 'error');
                        return;
                    }
                    
                    // Create data object
                    const data = {
                        name: name,
                        slug: slugInput && slugInput.value.trim() ? slugInput.value.trim() : null,
                        description: descriptionInput ? descriptionInput.value.trim() : ''
                    };
                    
                    // Add parent for categories
                    if (taxonomyType === 'categories') {
                        const parentSelect = contentContainer.querySelector('.taxonomy-parent');
                        if (parentSelect && parentSelect.value) {
                            data.parent = parentSelect.value;
                        }
                    }
                    
                    // Create taxonomy
                    contentService.create(taxonomyType, data);
                    
                    // Refresh list
                    this.renderTaxonomyList(taxonomyType);
                    
                    // Show notification
                    this.showNotification(`${taxonomyType === 'categories' ? 'Category' : 'Tag'} created.`, 'success');
                });
            }
            
            // Edit action
            contentContainer.querySelectorAll('[data-action="edit"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = link.dataset.id;
                    if (id) {
                        this.showTaxonomyEditor(taxonomyType, id);
                    }
                });
            });
            
            // Delete action
            contentContainer.querySelectorAll('[data-action="delete"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = link.dataset.id;
                    if (id) {
                        // Confirm before deleting
                        if (confirm(`Are you sure you want to delete this ${taxonomyType === 'categories' ? 'category' : 'tag'}?`)) {
                            contentService.delete(taxonomyType, id);
                            
                            // Refresh list
                            this.renderTaxonomyList(taxonomyType);
                            
                            // Show notification
                            this.showNotification(`${taxonomyType === 'categories' ? 'Category' : 'Tag'} deleted.`, 'info');
                        }
                    }
                });
            });
        },
        
        // Show taxonomy editor
        showTaxonomyEditor: function(taxonomyType, taxonomyId) {
            const taxonomy = contentService.get(taxonomyType, taxonomyId);
            if (!taxonomy) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'taxonomy-editor-modal';
            
            // Render modal
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit ${taxonomyType === 'categories' ? 'Category' : 'Tag'}</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" class="taxonomy-name" value="${taxonomy.name}">
                        </div>
                        <div class="form-group">
                            <label>Slug</label>
                            <input type="text" class="taxonomy-slug" value="${taxonomy.slug}">
                            <p class="input-description">
                                The "slug" is the URL-friendly version of the name. It is usually all lowercase and contains only letters, numbers, and hyphens.
                            </p>
                        </div>
                        ${taxonomyType === 'categories' ? `
                        <div class="form-group">
                            <label>Parent Category</label>
                            <select class="taxonomy-parent">
                                <option value="">None</option>
                                ${contentService.getAll('categories')
                                    .filter(category => category.id !== taxonomyId) // Exclude self
                                    .map(category => `
                                        <option value="${category.id}" ${taxonomy.parent === category.id ? 'selected' : ''}>
                                            ${category.name}
                                        </option>
                                    `).join('')}
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="taxonomy-description">${taxonomy.description || ''}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="update-taxonomy-button">
                            Update ${taxonomyType === 'categories' ? 'Category' : 'Tag'}
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const updateButton = modal.querySelector('.update-taxonomy-button');
            
            // Close handler
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Update handler
            if (updateButton) {
                updateButton.addEventListener('click', () => {
                    const nameInput = modal.querySelector('.taxonomy-name');
                    const slugInput = modal.querySelector('.taxonomy-slug');
                    const descriptionInput = modal.querySelector('.taxonomy-description');
                    
                    const name = nameInput ? nameInput.value.trim() : '';
                    if (!name) {
                        this.showNotification('Name is required.', 'error');
                        return;
                    }
                    
                    // Create data object
                    const data = {
                        name: name,
                        slug: slugInput && slugInput.value.trim() ? slugInput.value.trim() : taxonomy.generateSlug(),
                        description: descriptionInput ? descriptionInput.value.trim() : ''
                    };
                    
                    // Add parent for categories
                    if (taxonomyType === 'categories') {
                        const parentSelect = modal.querySelector('.taxonomy-parent');
                        data.parent = parentSelect && parentSelect.value ? parentSelect.value : null;
                    }
                    
                    // Update taxonomy
                    contentService.update(taxonomyType, taxonomyId, data);
                    
                    // Close modal
                    modal.remove();
                    
                    // Refresh taxonomy list
                    const contentContainer = state.contentWindow.querySelector('.cms-content');
                    if (contentContainer && contentContainer.querySelector('.taxonomy-list-container')) {
                        this.renderTaxonomyList(taxonomyType);
                    }
                    
                    // Show notification
                    this.showNotification(`${taxonomyType === 'categories' ? 'Category' : 'Tag'} updated.`, 'success');
                });
            }
        },
        
        // Render settings page
        renderSettings: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Prepare settings data
            const settingsData = {
                siteTitle: state.settings.siteTitle,
                siteDescription: state.settings.siteDescription,
                // Date formats
                dateFormat1: state.settings.dateFormat === 'F j, Y' ? 'checked' : '',
                dateFormat2: state.settings.dateFormat === 'Y-m-d' ? 'checked' : '',
                dateFormat3: state.settings.dateFormat === 'm/d/Y' ? 'checked' : '',
                dateFormat4: state.settings.dateFormat === 'd/m/Y' ? 'checked' : '',
                dateFormat1Example: '<?php echo date("F j, Y"); ?>',
                dateFormat2Example: '<?php echo date("Y-m-d"); ?>',
                dateFormat3Example: '<?php echo date("m/d/Y"); ?>',
                dateFormat4Example: '<?php echo date("d/m/Y"); ?>',
                // Time formats
                timeFormat1: state.settings.timeFormat === 'g:i a' ? 'checked' : '',
                timeFormat2: state.settings.timeFormat === 'g:i A' ? 'checked' : '',
                timeFormat3: state.settings.timeFormat === 'H:i' ? 'checked' : '',
                timeFormat1Example: '<?php echo date("g:i a"); ?>',
                timeFormat2Example: '<?php echo date("g:i A"); ?>',
                timeFormat3Example: '<?php echo date("H:i"); ?>',
                // Language
                langUS: state.settings.language === 'en-US' ? 'selected' : '',
                langGB: state.settings.language === 'en-GB' ? 'selected' : '',
                langES: state.settings.language === 'es' ? 'selected' : '',
                langFR: state.settings.language === 'fr' ? 'selected' : '',
                langDE: state.settings.language === 'de' ? 'selected' : '',
                // Writing settings
                autoSaveChecked: state.settings.autoSave ? 'checked' : '',
                autoSaveInterval: Math.round(state.settings.autoSaveInterval / 1000),
                // Reading settings
                postsPerPage: state.settings.postsPerPage,
                // Media settings
                mediaLibraryViewMode: state.settings.mediaLibraryViewMode
            };
            
            // Render settings template
            contentContainer.innerHTML = this.renderTemplate(templates.settingsPage, settingsData);
            
            // Add event listeners
            this.setupSettingsEventListeners();
        },
        
        // Set up settings event listeners
        setupSettingsEventListeners: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Settings tabs
            contentContainer.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Update active tab
                    contentContainer.querySelectorAll('.settings-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Show corresponding panel
                    const tabId = this.dataset.tab;
                    contentContainer.querySelectorAll('.settings-panel').forEach(panel => {
                        panel.classList.remove('active');
                    });
                    
                    const panel = contentContainer.querySelector(`#${tabId}-settings`);
                    if (panel) {
                        panel.classList.add('active');
                    }
                });
            });
            
            // Save settings buttons
            contentContainer.querySelectorAll('.save-settings-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Get active panel
                    const activePanel = contentContainer.querySelector('.settings-panel.active');
                    if (!activePanel) return;
                    
                    const panelId = activePanel.id;
                    
                    switch (panelId) {
                        case 'general-settings':
                            this.saveGeneralSettings();
                            break;
                        case 'writing-settings':
                            this.saveWritingSettings();
                            break;
                        case 'reading-settings':
                            this.saveReadingSettings();
                            break;
                        case 'media-settings':
                            this.saveMediaSettings();
                            break;
                        case 'permalinks-settings':
                            this.savePermalinkSettings();
                            break;
                    }
                });
            });
            
            // Export/import handlers
            const exportButton = contentContainer.querySelector('.export-button');
            if (exportButton) {
                exportButton.addEventListener('click', () => {
                    storage.export();
                });
            }
            
            // Import file selection
            const importFileButton = contentContainer.querySelector('.import-file-button');
            const importFileInput = contentContainer.querySelector('#import-file');
            const selectedFileName = contentContainer.querySelector('.selected-file-name');
            const importButton = contentContainer.querySelector('.import-button');
            
            if (importFileButton && importFileInput) {
                importFileButton.addEventListener('click', () => {
                    importFileInput.click();
                });
                
                importFileInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        // Show selected file name
                        if (selectedFileName) {
                            selectedFileName.textContent = this.files[0].name;
                        }
                        
                        // Enable import button
                        if (importButton) {
                            importButton.disabled = false;
                        }
                    }
                });
                
                // Import button handler
                if (importButton) {
                    importButton.addEventListener('click', () => {
                        if (importFileInput.files && importFileInput.files.length > 0) {
                            const file = importFileInput.files[0];
                            const reader = new FileReader();
                            
                            reader.onload = function(e) {
                                try {
                                    const jsonData = e.target.result;
                                    storage.import(jsonData);
                                    
                                    // Show notification
                                    this.showNotification('Data imported successfully.', 'success');
                                    
                                    // Refresh dashboard
                                    this.renderDashboard();
                                } catch (error) {
                                    console.error('Import error:', error);
                                    this.showNotification('Error importing data.', 'error');
                                }
                            }.bind(this);
                            
                            reader.readAsText(file);
                        }
                    });
                }
            }
        },
        
        // Save general settings
        saveGeneralSettings: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get form values
            const siteTitle = contentContainer.querySelector('#site-title').value;
            const siteDescription = contentContainer.querySelector('#site-description').value;
            const siteLanguage = contentContainer.querySelector('#site-language').value;
            
            // Date format
            let dateFormat = 'F j, Y'; // Default
            contentContainer.querySelectorAll('input[name="date-format"]').forEach(radio => {
                if (radio.checked) {
                    dateFormat = radio.value;
                }
            });
            
            // Time format
            let timeFormat = 'g:i a'; // Default
            contentContainer.querySelectorAll('input[name="time-format"]').forEach(radio => {
                if (radio.checked) {
                    timeFormat = radio.value;
                }
            });
            
            // Update settings
            state.settings.siteTitle = siteTitle;
            state.settings.siteDescription = siteDescription;
            state.settings.language = siteLanguage;
            state.settings.dateFormat = dateFormat;
            state.settings.timeFormat = timeFormat;
            
            // Save settings
            storage.save();
            
            // Show notification
            this.showNotification('General settings saved.', 'success');
        },
        
        // Save writing settings
        saveWritingSettings: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get form values
            const defaultCategory = contentContainer.querySelector('#default-category').value;
            const defaultPostFormat = contentContainer.querySelector('#default-post-format').value;
            const enableAutoSave = contentContainer.querySelector('#enable-auto-save').checked;
            const autoSaveInterval = parseInt(contentContainer.querySelector('#auto-save-interval').value) || 60;
            
            // Update settings
            state.settings.defaultCategory = defaultCategory;
            state.settings.defaultPostFormat = defaultPostFormat;
            state.settings.autoSave = enableAutoSave;
            state.settings.autoSaveInterval = autoSaveInterval * 1000; // Convert to milliseconds
            
            // Save settings
            storage.save();
            
            // Show notification
            this.showNotification('Writing settings saved.', 'success');
        },
        
        // Save reading settings
        saveReadingSettings: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get form values
            let homepageDisplay = 'posts';
            contentContainer.querySelectorAll('input[name="homepage-display"]').forEach(radio => {
                if (radio.checked) {
                    homepageDisplay = radio.value;
                }
            });
            
            const homepageId = contentContainer.querySelector('#homepage-id').value;
            const postsPageId = contentContainer.querySelector('#posts-page-id').value;
            const postsPerPage = parseInt(contentContainer.querySelector('#posts-per-page').value) || 10;
            
            let feedContent = 'summary';
            contentContainer.querySelectorAll('input[name="feed-content"]').forEach(radio => {
                if (radio.checked) {
                    feedContent = radio.value;
                }
            });
            
            // Update settings
            state.settings.homepageDisplay = homepageDisplay;
            state.settings.homepageId = homepageId;
            state.settings.postsPageId = postsPageId;
            state.settings.postsPerPage = postsPerPage;
            state.settings.feedContent = feedContent;
            
            // Save settings
            storage.save();
            
            // Show notification
            this.showNotification('Reading settings saved.', 'success');
        },
        
        // Save media settings
        saveMediaSettings: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get form values
            const thumbnailWidth = parseInt(contentContainer.querySelector('#thumbnail-width').value) || 150;
            const thumbnailHeight = parseInt(contentContainer.querySelector('#thumbnail-height').value) || 150;
            const mediumWidth = parseInt(contentContainer.querySelector('#medium-width').value) || 300;
            const mediumHeight = parseInt(contentContainer.querySelector('#medium-height').value) || 300;
            const largeWidth = parseInt(contentContainer.querySelector('#large-width').value) || 1024;
            const largeHeight = parseInt(contentContainer.querySelector('#large-height').value) || 1024;
            const organizeUploads = contentContainer.querySelector('#organize-uploads').checked;
            
            // Update settings
            state.settings.thumbnailWidth = thumbnailWidth;
            state.settings.thumbnailHeight = thumbnailHeight;
            state.settings.mediumWidth = mediumWidth;
            state.settings.mediumHeight = mediumHeight;
            state.settings.largeWidth = largeWidth;
            state.settings.largeHeight = largeHeight;
            state.settings.organizeUploads = organizeUploads;
            
            // Save settings
            storage.save();
            
            // Show notification
            this.showNotification('Media settings saved.', 'success');
        },
        
        // Save permalink settings
        savePermalinkSettings: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get form values
            let permalinkStructure = '';
            contentContainer.querySelectorAll('input[name="permalink-structure"]').forEach(radio => {
                if (radio.checked) {
                    permalinkStructure = radio.value;
                }
            });
            
            // Handle custom structure
            if (permalinkStructure === 'custom') {
                const customPermalink = contentContainer.querySelector('#custom-permalink').value;
                permalinkStructure = customPermalink;
            }
            
            // Update settings
            state.settings.permalinkStructure = permalinkStructure;
            
            // Save settings
            storage.save();
            
            // Show notification
            this.showNotification('Permalink settings saved.', 'success');
        },
        
        // Render tools page
        renderTools: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            contentContainer.innerHTML = templates.toolsPage;
            
            // Add event listeners
            const toolButtons = contentContainer.querySelectorAll('.tool-button');
            const toolModal = contentContainer.querySelector('.tools-modal');
            const closeModalButton = contentContainer.querySelector('.close-modal-button');
            
            if (toolButtons && toolModal) {
                toolButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const toolId = button.dataset.tool;
                        this.openToolDialog(toolId);
                    });
                });
            }
            
            if (closeModalButton) {
                closeModalButton.addEventListener('click', () => {
                    if (toolModal) {
                        toolModal.style.display = 'none';
                    }
                });
            }
        },
        
        // Open tool dialog
        openToolDialog: function(toolId) {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolModal = contentContainer.querySelector('.tools-modal');
            const toolTitle = toolModal.querySelector('.tool-title');
            const toolFormContainer = toolModal.querySelector('.tool-form-container');
            
            if (!toolModal || !toolTitle || !toolFormContainer) return;
            
            // Set tool title
            switch (toolId) {
                case 'regenerate-thumbnails':
                    toolTitle.textContent = 'Regenerate Thumbnails';
                    break;
                case 'data-cleanup':
                    toolTitle.textContent = 'Data Cleanup';
                    break;
                case 'export-content':
                    toolTitle.textContent = 'Export Content';
                    break;
                case 'find-replace':
                    toolTitle.textContent = 'Find and Replace';
                    break;
                default:
                    toolTitle.textContent = 'Tool';
            }
            
            // Get form template
            const formTemplate = toolForms[toolId];
            if (!formTemplate) {
                toolFormContainer.innerHTML = '<p>Tool not available.</p>';
                toolModal.style.display = 'block';
                return;
            }
            
            // Prepare form data
            let formData = {};
            
            switch (toolId) {
                case 'data-cleanup':
                    // Count unused tags
                    const unusedTags = contentService.getAll('tags').filter(tag => {
                        return !state.contentLibrary.posts.some(post => 
                            post.tags && post.tags.includes(tag.id));
                    });
                    
                    // Count unused categories
                    const unusedCategories = contentService.getAll('categories').filter(category => {
                        return !state.contentLibrary.posts.some(post => 
                            post.categories && post.categories.includes(category.id));
                    });
                    
                    // Count trash items
                    const trashPosts = contentService.getAll('posts').filter(post => post.status === 'trash');
                    const trashPages = contentService.getAll('pages').filter(page => page.status === 'trash');
                    
                    formData = {
                        unusedTagsCount: unusedTags.length,
                        unusedCategoriesCount: unusedCategories.length,
                        revisionsCount: 0, // Placeholder for future implementation
                        trashCount: trashPosts.length + trashPages.length
                    };
                    break;
            }
            
            // Render form
            toolFormContainer.innerHTML = this.renderTemplate(formTemplate, formData);
            
            // Show modal
            toolModal.style.display = 'block';
            
            // Add event listeners for the tool
            this.setupToolEventListeners(toolId);
        },
        
        // Set up tool event listeners
        setupToolEventListeners: function(toolId) {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolModal = contentContainer.querySelector('.tools-modal');
            const toolFormContainer = toolModal.querySelector('.tool-form-container');
            
            switch (toolId) {
                case 'regenerate-thumbnails':
                    // Image scope selection
                    const scopeRadios = toolFormContainer.querySelectorAll('input[name="image-scope"]');
                    const imageSelector = toolFormContainer.querySelector('.image-selector');
                    
                    if (scopeRadios && imageSelector) {
                        scopeRadios.forEach(radio => {
                            radio.addEventListener('change', function() {
                                if (this.value === 'selected') {
                                    imageSelector.style.display = 'block';
                                    
                                    // Populate image selection grid
                                    const imageGrid = imageSelector.querySelector('.image-selection-grid');
                                    if (imageGrid) {
                                        // Get images
                                        const images = contentService.getAll('media').filter(item => item.type === 'image');
                                        
                                        // Render images
                                        imageGrid.innerHTML = images.map(image => `
                                            <div class="image-selection-item">
                                                <label>
                                                    <input type="checkbox" name="selected-image" value="${image.id}">
                                                    <img src="${image.url}" alt="${image.title}">
                                                    <div class="image-name">${image.title}</div>
                                                </label>
                                            </div>
                                        `).join('');
                                    }
                                } else {
                                    imageSelector.style.display = 'none';
                                }
                            });
                        });
                    }
                    
                    // Run button
                    const runButton = toolFormContainer.querySelector('.run-tool-button');
                    if (runButton) {
                        runButton.addEventListener('click', () => {
                            this.runRegenerateThumbnails();
                        });
                    }
                    break;
                    
                case 'data-cleanup':
                    // Run button
                    const cleanupButton = toolFormContainer.querySelector('.run-tool-button');
                    if (cleanupButton) {
                        cleanupButton.addEventListener('click', () => {
                            this.runDataCleanup();
                        });
                    }
                    break;
                    
                case 'export-content':
                    // Run button
                    const exportButton = toolFormContainer.querySelector('.run-tool-button');
                    if (exportButton) {
                        exportButton.addEventListener('click', () => {
                            this.runContentExport();
                        });
                    }
                    break;
                    
                case 'find-replace':
                    // Preview button
                    const previewButton = toolFormContainer.querySelector('.preview-tool-button');
                    if (previewButton) {
                        previewButton.addEventListener('click', () => {
                            this.previewFindReplace();
                        });
                    }
                    
                    // Replace button
                    const replaceButton = toolFormContainer.querySelector('.run-tool-button');
                    if (replaceButton) {
                        replaceButton.addEventListener('click', () => {
                            this.runFindReplace();
                        });
                    }
                    break;
            }
        },
        
        // Run regenerate thumbnails tool
        runRegenerateThumbnails: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolFormContainer = contentContainer.querySelector('.tool-form-container');
            if (!toolFormContainer) return;
            
            // Get selected options
            let imageScope = 'all';
            toolFormContainer.querySelectorAll('input[name="image-scope"]').forEach(radio => {
                if (radio.checked) {
                    imageScope = radio.value;
                }
            });
            
            // Get selected sizes
            const selectedSizes = [];
            toolFormContainer.querySelectorAll('input[name="thumbnail-size"]').forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSizes.push(checkbox.value);
                }
            });
            
            if (selectedSizes.length === 0) {
                this.showNotification('Please select at least one thumbnail size.', 'error');
                return;
            }
            
            // Get images to process
            let imagesToProcess = [];
            
            if (imageScope === 'all') {
                // Get all images
                imagesToProcess = contentService.getAll('media').filter(item => item.type === 'image');
            } else {
                // Get selected images
                const selectedImages = toolFormContainer.querySelectorAll('input[name="selected-image"]:checked');
                const selectedIds = Array.from(selectedImages).map(cb => cb.value);
                
                if (selectedIds.length === 0) {
                    this.showNotification('Please select at least one image.', 'error');
                    return;
                }
                
                imagesToProcess = selectedIds.map(id => contentService.get('media', id)).filter(Boolean);
            }
            
            if (imagesToProcess.length === 0) {
                this.showNotification('No images to process.', 'info');
                return;
            }
            
            // Show progress
            const progressContainer = toolFormContainer.querySelector('.progress-container');
            const progressFill = toolFormContainer.querySelector('.progress-fill');
            const progressText = toolFormContainer.querySelector('.progress-text');
            
            if (progressContainer && progressFill && progressText) {
                progressContainer.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = '0% complete';
            }
            
            // Process images (in a real implementation, this would regenerate thumbnails)
            let processed = 0;
            
            // Simulate processing
            const processNextImage = () => {
                if (processed < imagesToProcess.length) {
                    // Update progress
                    const progress = Math.round((processed / imagesToProcess.length) * 100);
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${progress}% complete (${processed}/${imagesToProcess.length})`;
                    
                    // Process image (simulate)
                    setTimeout(() => {
                        processed++;
                        processNextImage();
                    }, 100);
                } else {
                    // Complete
                    progressFill.style.width = '100%';
                    progressText.textContent = 'Complete!';
                    
                    this.showNotification(`Regenerated thumbnails for ${imagesToProcess.length} images.`, 'success');
                }
            };
            
            // Start processing
            processNextImage();
        },
        
        // Run data cleanup tool
        runDataCleanup: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolFormContainer = contentContainer.querySelector('.tool-form-container');
            if (!toolFormContainer) return;
            
            // Get selected cleanup items
            const selectedItems = [];
            toolFormContainer.querySelectorAll('input[name="cleanup-item"]:checked').forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });
            
            if (selectedItems.length === 0) {
                this.showNotification('Please select at least one item to clean up.', 'error');
                return;
            }
            
            // Results container
            const resultsContainer = toolFormContainer.querySelector('.results-container');
            const resultsList = toolFormContainer.querySelector('.results-list');
            
            if (resultsContainer && resultsList) {
                resultsContainer.style.display = 'block';
                resultsList.innerHTML = '';
            }
            
            let totalCleaned = 0;
            
            // Process each selected item
            if (selectedItems.includes('tags')) {
                // Find unused tags
                const unusedTags = contentService.getAll('tags').filter(tag => {
                    return !state.contentLibrary.posts.some(post => 
                        post.tags && post.tags.includes(tag.id));
                });
                
                // Delete unused tags
                let tagsDeleted = 0;
                unusedTags.forEach(tag => {
                    if (contentService.delete('tags', tag.id)) {
                        tagsDeleted++;
                    }
                });
                
                // Add to results
                if (resultsList) {
                    resultsList.innerHTML += `
                        <div class="result-item">
                            <i class="fas fa-check"></i>
                            <span>Deleted ${tagsDeleted} unused tags</span>
                        </div>
                    `;
                }
                
                totalCleaned += tagsDeleted;
            }
            
            if (selectedItems.includes('categories')) {
                // Find unused categories
                const unusedCategories = contentService.getAll('categories').filter(category => {
                    return !state.contentLibrary.posts.some(post => 
                        post.categories && post.categories.includes(category.id));
                });
                
                // Delete unused categories
                let categoriesDeleted = 0;
                unusedCategories.forEach(category => {
                    // Don't delete the default category
                    if (category.id !== state.settings.defaultCategory) {
                        if (contentService.delete('categories', category.id)) {
                            categoriesDeleted++;
                        }
                    }
                });
                
                // Add to results
                if (resultsList) {
                    resultsList.innerHTML += `
                        <div class="result-item">
                            <i class="fas fa-check"></i>
                            <span>Deleted ${categoriesDeleted} unused categories</span>
                        </div>
                    `;
                }
                
                totalCleaned += categoriesDeleted;
            }
            
            if (selectedItems.includes('revisions')) {
                // Placeholder for revision cleanup
                // In a real implementation, this would delete old content revisions
                
                // Add to results
                if (resultsList) {
                    resultsList.innerHTML += `
                        <div class="result-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Revision cleanup not implemented</span>
                        </div>
                    `;
                }
            }
            
            if (selectedItems.includes('trash')) {
                // Delete trashed posts
                const trashPosts = contentService.getAll('posts').filter(post => post.status === 'trash');
                let postsDeleted = 0;
                
                trashPosts.forEach(post => {
                    if (contentService.delete('posts', post.id)) {
                        postsDeleted++;
                    }
                });
                
                // Delete trashed pages
                const trashPages = contentService.getAll('pages').filter(page => page.status === 'trash');
                let pagesDeleted = 0;
                
                trashPages.forEach(page => {
                    if (contentService.delete('pages', page.id)) {
                        pagesDeleted++;
                    }
                });
                
                // Add to results
                if (resultsList) {
                    resultsList.innerHTML += `
                        <div class="result-item">
                            <i class="fas fa-check"></i>
                            <span>Deleted ${postsDeleted} trashed posts and ${pagesDeleted} trashed pages</span>
                        </div>
                    `;
                }
                
                totalCleaned += postsDeleted + pagesDeleted;
            }
            
            // Show notification
            this.showNotification(`Cleanup complete. ${totalCleaned} items removed.`, 'success');
        },
        
        // Run content export tool
        runContentExport: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolFormContainer = contentContainer.querySelector('.tool-form-container');
            if (!toolFormContainer) return;
            
            // Get selected content types
            const contentTypes = [];
            toolFormContainer.querySelectorAll('input[name="export-content"]:checked').forEach(checkbox => {
                contentTypes.push(checkbox.value);
            });
            
            if (contentTypes.length === 0) {
                this.showNotification('Please select at least one content type to export.', 'error');
                return;
            }
            
            // Get export format
            let exportFormat = 'json';
            toolFormContainer.querySelectorAll('input[name="export-format"]').forEach(radio => {
                if (radio.checked) {
                    exportFormat = radio.value;
                }
            });
            
            // Get date range
            const dateFrom = toolFormContainer.querySelector('input[name="export-date-from"]').value;
            const dateTo = toolFormContainer.querySelector('input[name="export-date-to"]').value;
            
            // Collect content to export
            const exportData = {
                meta: {
                    exportDate: new Date(),
                    exportFormat,
                    contentTypes
                },
                content: {}
            };
            
            // Add each content type
            contentTypes.forEach(type => {
                if (state.contentLibrary[type]) {
                    // Filter by date if provided
                    let items = [...state.contentLibrary[type]];
                    
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        items = items.filter(item => new Date(item.createdAt) >= fromDate);
                    }
                    
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        items = items.filter(item => new Date(item.createdAt) <= toDate);
                    }
                    
                    exportData.content[type] = items;
                }
            });
            
            // Create export file based on format
            let exportContent;
            let mimeType;
            let fileExtension;
            
            switch (exportFormat) {
                case 'json':
                    exportContent = JSON.stringify(exportData, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                case 'markdown':
                    exportContent = this.convertToMarkdown(exportData);
                    mimeType = 'text/markdown';
                    fileExtension = 'md';
                    break;
                case 'html':
                    exportContent = this.convertToHTML(exportData);
                    mimeType = 'text/html';
                    fileExtension = 'html';
                    break;
                case 'csv':
                    exportContent = this.convertToCSV(exportData);
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                default:
                    exportContent = JSON.stringify(exportData, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
            }
            
            // Create download link
            const dataURI = `data:${mimeType};charset=utf-8,${encodeURIComponent(exportContent)}`;
            const exportFileName = `cr8os-cms-export-${new Date().toISOString().slice(0, 10)}.${fileExtension}`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataURI);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
            
            // Show notification
            this.showNotification('Content exported successfully.', 'success');
        },
        
        // Convert export data to Markdown
        convertToMarkdown: function(exportData) {
            let markdown = `# cr8OS CMS Export\n\nExport Date: ${formatDate(exportData.meta.exportDate)}\n\n`;
            
            // Process each content type
            Object.keys(exportData.content).forEach(type => {
                const items = exportData.content[type];
                
                markdown += `## ${type.charAt(0).toUpperCase() + type.slice(1)}\n\n`;
                
                items.forEach(item => {
                    markdown += `### ${item.title}\n\n`;
                    
                    if (item.content) {
                        // Simple HTML to Markdown conversion
                        let content = item.content
                            .replace(/<h1[^>]*>(.*?)<\/h1>/g, '# $1\n\n')
                            .replace(/<h2[^>]*>(.*?)<\/h2>/g, '## $1\n\n')
                            .replace(/<h3[^>]*>(.*?)<\/h3>/g, '### $1\n\n')
                            .replace(/<h4[^>]*>(.*?)<\/h4>/g, '#### $1\n\n')
                            .replace(/<h5[^>]*>(.*?)<\/h5>/g, '##### $1\n\n')
                            .replace(/<h6[^>]*>(.*?)<\/h6>/g, '###### $1\n\n')
                            .replace(/<p[^>]*>(.*?)<\/p>/g, '$1\n\n')
                            .replace(/<strong[^>]*>(.*?)<\/strong>/g, '**$1**')
                            .replace(/<em[^>]*>(.*?)<\/em>/g, '*$1*')
                            .replace(/<a[^>]*href=["'](.*?)["'][^>]*>(.*?)<\/a>/g, '[$2]($1)')
                            .replace(/<ul[^>]*>(.*?)<\/ul>/g, '$1\n')
                            .replace(/<ol[^>]*>(.*?)<\/ol>/g, '$1\n')
                            .replace(/<li[^>]*>(.*?)<\/li>/g, '- $1\n')
                            .replace(/<br[^>]*>/g, '\n')
                            .replace(/<img[^>]*src=["'](.*?)["'][^>]*>/g, '![]($1)')
                            .replace(/<blockquote[^>]*>(.*?)<\/blockquote>/g, '> $1\n\n')
                            .replace(/<code[^>]*>(.*?)<\/code>/g, '`$1`')
                            .replace(/<pre[^>]*>(.*?)<\/pre>/g, '```\n$1\n```\n\n')
                            .replace(/<[^>]+>/g, ''); // Remove remaining HTML tags
                        
                        markdown += `${content}\n\n`;
                    }
                    
                    markdown += `Date: ${formatDate(item.createdAt)}\n`;
                    markdown += `Status: ${item.status}\n`;
                    
                    if (type === 'posts' && item.categories) {
                        const categoryNames = item.categories.map(catId => {
                            const category = contentService.get('categories', catId);
                            return category ? category.name : '';
                        }).filter(Boolean);
                        
                        if (categoryNames.length > 0) {
                            markdown += `Categories: ${categoryNames.join(', ')}\n`;
                        }
                    }
                    
                    if (type === 'posts' && item.tags) {
                        const tagNames = item.tags.map(tagId => {
                            const tag = contentService.get('tags', tagId);
                            return tag ? tag.name : '';
                        }).filter(Boolean);
                        
                        if (tagNames.length > 0) {
                            markdown += `Tags: ${tagNames.join(', ')}\n`;
                        }
                    }
                    
                    markdown += '\n---\n\n';
                });
            });
            
            return markdown;
        },
        
        // Convert export data to HTML
        convertToHTML: function(exportData) {
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>cr8OS CMS Export</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        h1, h2, h3 {
                            margin-top: 20px;
                        }
                        .item {
                            margin-bottom: 40px;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 20px;
                        }
                        .meta {
                            color: #666;
                            font-size: 0.9em;
                            margin-top: 20px;
                        }
                    </style>
                </head>
                <body>
                    <h1>cr8OS CMS Export</h1>
                    <p>Export Date: ${formatDate(exportData.meta.exportDate)}</p>
            `;
            
            // Process each content type
            Object.keys(exportData.content).forEach(type => {
                const items = exportData.content[type];
                
                html += `<h2>${type.charAt(0).toUpperCase() + type.slice(1)}</h2>`;
                
                items.forEach(item => {
                    html += `
                        <div class="item">
                            <h3>${item.title}</h3>
                            <div class="content">
                                ${item.content || ''}
                            </div>
                            <div class="meta">
                                <p>Date: ${formatDate(item.createdAt)}</p>
                                <p>Status: ${item.status}</p>
                    `;
                    
                    if (type === 'posts' && item.categories) {
                        const categoryNames = item.categories.map(catId => {
                            const category = contentService.get('categories', catId);
                            return category ? category.name : '';
                        }).filter(Boolean);
                        
                        if (categoryNames.length > 0) {
                            html += `<p>Categories: ${categoryNames.join(', ')}</p>`;
                        }
                    }
                    
                    if (type === 'posts' && item.tags) {
                        const tagNames = item.tags.map(tagId => {
                            const tag = contentService.get('tags', tagId);
                            return tag ? tag.name : '';
                        }).filter(Boolean);
                        
                        if (tagNames.length > 0) {
                            html += `<p>Tags: ${tagNames.join(', ')}</p>`;
                        }
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            });
            
            html += `
                </body>
                </html>
            `;
            
            return html;
        },
        
        // Convert export data to CSV
        convertToCSV: function(exportData) {
            // CSV headers based on content types
            const headers = {
                posts: ['id', 'title', 'content', 'excerpt', 'status', 'created_date', 'updated_date', 'categories', 'tags'],
                pages: ['id', 'title', 'content', 'status', 'template', 'parent', 'order', 'created_date', 'updated_date'],
                media: ['id', 'title', 'type', 'url', 'file_size', 'alt', 'description', 'created_date'],
                categories: ['id', 'name', 'slug', 'description', 'parent', 'count'],
                tags: ['id', 'name', 'slug', 'description', 'count']
            };
            
            let csv = '';
            
            // Process each content type
            Object.keys(exportData.content).forEach(type => {
                const items = exportData.content[type];
                
                if (items.length > 0) {
                    csv += `# ${type.toUpperCase()}\n`;
                    
                    // Add headers
                    csv += (headers[type] || []).join(',') + '\n';
                    
                    // Add rows
                    items.forEach(item => {
                        let row = [];
                        
                        (headers[type] || []).forEach(header => {
                            let value = '';
                            
                            switch (header) {
                                case 'id':
                                    value = item.id || '';
                                    break;
                                case 'title':
                                    value = item.title || '';
                                    break;
                                case 'content':
                                    value = item.content ? item.content.replace(/"/g, '""').replace(/\n/g, ' ') : '';
                                    break;
                                case 'excerpt':
                                    value = item.excerpt ? item.excerpt.replace(/"/g, '""').replace(/\n/g, ' ') : '';
                                    break;
                                case 'status':
                                    value = item.status || '';
                                    break;
                                case 'created_date':
                                    value = item.createdAt ? formatDate(item.createdAt) : '';
                                    break;
                                case 'updated_date':
                                    value = item.updatedAt ? formatDate(item.updatedAt) : '';
                                    break;
                                case 'categories':
                                    if (item.categories) {
                                        const categoryNames = item.categories.map(catId => {
                                            const category = contentService.get('categories', catId);
                                            return category ? category.name : '';
                                        }).filter(Boolean);
                                        value = categoryNames.join(';');
                                    }
                                    break;
                                case 'tags':
                                    if (item.tags) {
                                        const tagNames = item.tags.map(tagId => {
                                            const tag = contentService.get('tags', tagId);
                                            return tag ? tag.name : '';
                                        }).filter(Boolean);
                                        value = tagNames.join(';');
                                    }
                                    break;
                                case 'type':
                                    value = item.type || '';
                                    break;
                                case 'url':
                                    value = item.url || '';
                                    break;
                                case 'file_size':
                                    value = item.fileSize ? this.formatFileSize(item.fileSize) : '';
                                    break;
                                case 'alt':
                                    value = item.alt || '';
                                    break;
                                case 'description':
                                    value = item.description ? item.description.replace(/"/g, '""').replace(/\n/g, ' ') : '';
                                    break;
                                case 'template':
                                    value = item.template || '';
                                    break;
                                case 'parent':
                                    if (item.parent) {
                                        const parent = contentService.get('pages', item.parent);
                                        value = parent ? parent.title : '';
                                    }
                                    break;
                                case 'order':
                                    value = item.order !== undefined ? item.order.toString() : '';
                                    break;
                                case 'name':
                                    value = item.name || '';
                                    break;
                                case 'slug':
                                    value = item.slug || '';
                                    break;
                                case 'count':
                                    value = item.count !== undefined ? item.count.toString() : '0';
                                    break;
                            }
                            
                            // Quote values containing commas or quotes
                            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                value = `"${value}"`;
                            }
                            
                            row.push(value);
                        });
                        
                        csv += row.join(',') + '\n';
                    });
                    
                    csv += '\n'; // Add blank line between content types
                }
            });
            
            return csv;
        },
        
        // Preview find and replace
        previewFindReplace: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolFormContainer = contentContainer.querySelector('.tool-form-container');
            if (!toolFormContainer) return;
            
            // Get form values
            const findText = toolFormContainer.querySelector('input[name="find-text"]').value;
            const replaceText = toolFormContainer.querySelector('input[name="replace-text"]').value;
            
            if (!findText) {
                this.showNotification('Please enter text to find.', 'error');
                return;
            }
            
            // Get search options
            const searchIn = [];
            toolFormContainer.querySelectorAll('input[name="search-in"]:checked').forEach(checkbox => {
                searchIn.push(checkbox.value);
            });
            
            if (searchIn.length === 0) {
                this.showNotification('Please select at least one content type to search in.', 'error');
                return;
            }
            
            // Get search options
            const caseSensitive = toolFormContainer.querySelector('input[value="case-sensitive"]').checked;
            const wholeWord = toolFormContainer.querySelector('input[value="whole-word"]').checked;
            
            // Create regex for find
            let findRegex;
            try {
                let pattern = findText;
                
                if (wholeWord) {
                    pattern = `\\b${pattern}\\b`;
                }
                
                findRegex = new RegExp(pattern, caseSensitive ? 'g' : 'gi');
            } catch (error) {
                this.showNotification('Invalid search pattern.', 'error');
                return;
            }
            
            // Find matches
            const matches = [];
            
            // Search in posts
            if (searchIn.includes('posts')) {
                state.contentLibrary.posts.forEach(post => {
                    // Search in content
                    if (post.content) {
                        const contentMatches = this.findMatches(post.content, findRegex);
                        
                        if (contentMatches.length > 0) {
                            matches.push({
                                id: post.id,
                                title: post.title,
                                type: 'post',
                                field: 'content',
                                matches: contentMatches
                            });
                        }
                    }
                    
                    // Search in title if selected
                    if (searchIn.includes('titles') && post.title) {
                        const titleMatches = this.findMatches(post.title, findRegex);
                        
                        if (titleMatches.length > 0) {
                            matches.push({
                                id: post.id,
                                title: post.title,
                                type: 'post',
                                field: 'title',
                                matches: titleMatches
                            });
                        }
                    }
                    
                    // Search in excerpt if selected
                    if (searchIn.includes('excerpts') && post.excerpt) {
                        const excerptMatches = this.findMatches(post.excerpt, findRegex);
                        
                        if (excerptMatches.length > 0) {
                            matches.push({
                                id: post.id,
                                title: post.title,
                                type: 'post',
                                field: 'excerpt',
                                matches: excerptMatches
                            });
                        }
                    }
                });
            }
            
            // Search in pages
            if (searchIn.includes('pages')) {
                state.contentLibrary.pages.forEach(page => {
                    // Search in content
                    if (page.content) {
                        const contentMatches = this.findMatches(page.content, findRegex);
                        
                        if (contentMatches.length > 0) {
                            matches.push({
                                id: page.id,
                                title: page.title,
                                type: 'page',
                                field: 'content',
                                matches: contentMatches
                            });
                        }
                    }
                    
                    // Search in title if selected
                    if (searchIn.includes('titles') && page.title) {
                        const titleMatches = this.findMatches(page.title, findRegex);
                        
                        if (titleMatches.length > 0) {
                            matches.push({
                                id: page.id,
                                title: page.title,
                                type: 'page',
                                field: 'title',
                                matches: titleMatches
                            });
                        }
                    }
                });
            }
            
            // Show preview
            const previewContainer = toolFormContainer.querySelector('.preview-container');
            const previewList = toolFormContainer.querySelector('.preview-list');
            
            if (previewContainer && previewList) {
                previewContainer.style.display = 'block';
                
                if (matches.length === 0) {
                    previewList.innerHTML = '<div class="no-matches">No matches found.</div>';
                    
                    // Disable replace button
                    const replaceButton = toolFormContainer.querySelector('.run-tool-button');
                    if (replaceButton) {
                        replaceButton.disabled = true;
                    }
                } else {
                    // Group matches by content item
                    let html = '';
                    
                    matches.forEach(match => {
                        html += `
                            <div class="preview-item">
                                <div class="preview-header">
                                    <strong>${match.title}</strong> (${match.type})
                                    <span class="preview-field">${match.field}</span>
                                </div>
                                <div class="preview-matches">
                        `;
                        
                        match.matches.forEach(m => {
                            const before = m.context.substring(0, m.index);
                            const matched = m.context.substring(m.index, m.index + m.text.length);
                            const after = m.context.substring(m.index + m.text.length);
                            
                            html += `
                                <div class="match-context">
                                    <span class="match-before">${before}</span>
                                    <span class="match-highlight">${matched}</span>
                                    <span class="match-after">${after}</span>
                                </div>
                                <div class="match-replacement">
                                    <span class="match-before">${before}</span>
                                    <span class="match-replace">${replaceText}</span>
                                    <span class="match-after">${after}</span>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    previewList.innerHTML = html;
                    
                    // Enable replace button
                    const replaceButton = toolFormContainer.querySelector('.run-tool-button');
                    if (replaceButton) {
                        replaceButton.disabled = false;
                    }
                }
            }
        },
        
        // Find matches with context
        findMatches: function(text, regex) {
            const matches = [];
            let match;
            
            // Reset regex state
            regex.lastIndex = 0;
            
            while ((match = regex.exec(text)) !== null) {
                // Get context (text before and after match)
                const startIndex = Math.max(0, match.index - 20);
                const endIndex = Math.min(text.length, match.index + match[0].length + 20);
                const context = text.substring(startIndex, endIndex);
                
                // Adjust match index for context
                const contextIndex = match.index - startIndex;
                
                matches.push({
                    text: match[0],
                    index: contextIndex,
                    context: context
                });
            }
            
            return matches;
        },
        
        // Run find and replace
        runFindReplace: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            const toolFormContainer = contentContainer.querySelector('.tool-form-container');
            if (!toolFormContainer) return;
            
            // Get form values
            const findText = toolFormContainer.querySelector('input[name="find-text"]').value;
            const replaceText = toolFormContainer.querySelector('input[name="replace-text"]').value;
            
            if (!findText) {
                this.showNotification('Please enter text to find.', 'error');
                return;
            }
            
            // Get search options
            const searchIn = [];
            toolFormContainer.querySelectorAll('input[name="search-in"]:checked').forEach(checkbox => {
                searchIn.push(checkbox.value);
            });
            
            if (searchIn.length === 0) {
                this.showNotification('Please select at least one content type to search in.', 'error');
                return;
            }
            
            // Get search options
            const caseSensitive = toolFormContainer.querySelector('input[value="case-sensitive"]').checked;
            const wholeWord = toolFormContainer.querySelector('input[value="whole-word"]').checked;
            
            // Create regex for find
            let findRegex;
            try {
                let pattern = findText;
                
                if (wholeWord) {
                    pattern = `\\b${pattern}\\b`;
                }
                
                findRegex = new RegExp(pattern, caseSensitive ? 'g' : 'gi');
            } catch (error) {
                this.showNotification('Invalid search pattern.', 'error');
                return;
            }
            
            // Track replacements
            let totalReplacements = 0;
            let itemsUpdated = 0;
            
            // Replace in posts
            if (searchIn.includes('posts')) {
                state.contentLibrary.posts.forEach(post => {
                    let updated = false;
                    
                    // Replace in content
                    if (post.content) {
                        // Reset regex state
                        findRegex.lastIndex = 0;
                        
                        const newContent = post.content.replace(findRegex, match => {
                            totalReplacements++;
                            return replaceText;
                        });
                        
                        if (newContent !== post.content) {
                            post.content = newContent;
                            updated = true;
                        }
                    }
                    
                    // Replace in title if selected
                    if (searchIn.includes('titles') && post.title) {
                        // Reset regex state
                        findRegex.lastIndex = 0;
                        
                        const newTitle = post.title.replace(findRegex, match => {
                            totalReplacements++;
                            return replaceText;
                        });
                        
                        if (newTitle !== post.title) {
                            post.title = newTitle;
                            updated = true;
                        }
                    }
                    
                    // Replace in excerpt if selected
                    if (searchIn.includes('excerpts') && post.excerpt) {
                        // Reset regex state
                        findRegex.lastIndex = 0;
                        
                        const newExcerpt = post.excerpt.replace(findRegex, match => {
                            totalReplacements++;
                            return replaceText;
                        });
                        
                        if (newExcerpt !== post.excerpt) {
                            post.excerpt = newExcerpt;
                            updated = true;
                        }
                    }
                    
                    // Update post if changed
                    if (updated) {
                        post.updatedAt = new Date();
                        itemsUpdated++;
                    }
                });
            }
            
            // Replace in pages
            if (searchIn.includes('pages')) {
                state.contentLibrary.pages.forEach(page => {
                    let updated = false;
                    
                    // Replace in content
                    if (page.content) {
                        // Reset regex state
                        findRegex.lastIndex = 0;
                        
                        const newContent = page.content.replace(findRegex, match => {
                            totalReplacements++;
                            return replaceText;
                        });
                        
                        if (newContent !== page.content) {
                            page.content = newContent;
                            updated = true;
                        }
                    }
                    
                    // Replace in title if selected
                    if (searchIn.includes('titles') && page.title) {
                        // Reset regex state
                        findRegex.lastIndex = 0;
                        
                        const newTitle = page.title.replace(findRegex, match => {
                            totalReplacements++;
                            return replaceText;
                        });
                        
                        if (newTitle !== page.title) {
                            page.title = newTitle;
                            updated = true;
                        }
                    }
                    
                    // Update page if changed
                    if (updated) {
                        page.updatedAt = new Date();
                        itemsUpdated++;
                    }
                });
            }
            
            // Save changes
            storage.save();
            
            // Show notification
            this.showNotification(`Replaced ${totalReplacements} occurrences in ${itemsUpdated} items.`, 'success');
            
            // Hide preview
            const previewContainer = toolFormContainer.querySelector('.preview-container');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
            
            // Disable replace button again
            const replaceButton = toolFormContainer.querySelector('.run-tool-button');
            if (replaceButton) {
                replaceButton.disabled = true;
            }
        },
        
        // Render search results
        renderSearchResults: function(query) {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Update header title
            const headerTitle = state.contentWindow.querySelector('.header-title h1');
            if (headerTitle) {
                headerTitle.textContent = `Search Results for "${query}"`;
            }
            
            // Search for content
            const results = contentService.search(query);
            
            // Render results
            contentContainer.innerHTML = `
                <div class="search-results-container">
                    <div class="search-results-header">
                        <h2>Search Results</h2>
                        <p class="search-query">Search query: "${query}"</p>
                        <p class="results-count">${results.length} results found</p>
                    </div>
                    <div class="search-results-list">
                        ${results.length === 0 ? `
                            <div class="no-results">
                                <i class="fas fa-search"></i>
                                <p>No results found for "${query}"</p>
                                <p>Try different keywords or check your spelling.</p>
                            </div>
                        ` : ''}
                        ${results.map(item => `
                            <div class="search-result-item" data-id="${item.id}" data-type="${item.contentType}">
                                <div class="result-type">
                                    <i class="fas fa-${item.contentType === 'posts' ? 'file-alt' : 'file'}"></i>
                                    <span>${item.contentType === 'posts' ? 'Post' : 'Page'}</span>
                                </div>
                                <div class="result-content">
                                    <h3 class="result-title">${item.title}</h3>
                                    <div class="result-excerpt">
                                        ${this.generateExcerpt(item.content, query)}
                                    </div>
                                    <div class="result-meta">
                                        <span class="result-date">${formatDate(item.updatedAt)}</span>
                                        <span class="result-status">${item.status}</span>
                                    </div>
                                </div>
                                <div class="result-actions">
                                    <button class="action-button" data-action="edit" data-id="${item.id}" data-type="${item.contentType}">
                                        <i class="fas fa-edit"></i>
                                        <span>Edit</span>
                                    </button>
                                    <button class="action-button" data-action="view" data-id="${item.id}" data-type="${item.contentType}">
                                        <i class="fas fa-eye"></i>
                                        <span>View</span>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add event listeners
            contentContainer.querySelectorAll('[data-action="edit"]').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.dataset.id;
                    const type = button.dataset.type;
                    
                    if (id && type) {
                        this.openContentEditor(type, id);
                    }
                });
            });
            
            contentContainer.querySelectorAll('[data-action="view"]').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.dataset.id;
                    const type = button.dataset.type;
                    
                    if (id && type) {
                        this.showContentPreview(type, id);
                    }
                });
            });
            
            // Result item click
            contentContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Skip if clicking on a button
                    if (e.target.closest('.action-button')) return;
                    
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    
                    if (id && type) {
                        this.openContentEditor(type, id);
                    }
                }.bind(this));
            });
        },
        
        // Generate excerpt with highlighted query
        generateExcerpt: function(content, query) {
            if (!content) return '';
            
            // Strip HTML tags
            const strippedContent = content.replace(/<[^>]+>/g, '');
            
            // Find query in content
            const index = strippedContent.toLowerCase().indexOf(query.toLowerCase());
            
            if (index === -1) {
                // Query not found in content, return first 150 characters
                return strippedContent.substring(0, 150) + '...';
            }
            
            // Generate excerpt around query
            const startIndex = Math.max(0, index - 60);
            const endIndex = Math.min(strippedContent.length, index + query.length + 60);
            let excerpt = strippedContent.substring(startIndex, endIndex);
            
            // Add ellipsis if excerpt doesn't start/end at the beginning/end of content
            if (startIndex > 0) {
                excerpt = '... ' + excerpt;
            }
            
            if (endIndex < strippedContent.length) {
                excerpt = excerpt + ' ...';
            }
            
            // Highlight query
            const queryRegex = new RegExp(`(${query})`, 'gi');
            excerpt = excerpt.replace(queryRegex, '<mark>$1</mark>');
            
            return excerpt;
        },
        
        // Render help page
        renderHelp: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            contentContainer.innerHTML = `
                <div class="help-container">
                    <div class="help-sidebar">
                        <h3>Help Topics</h3>
                        <ul class="help-topics">
                            <li class="help-topic active" data-topic="getting-started">Getting Started</li>
                            <li class="help-topic" data-topic="posts">Posts</li>
                            <li class="help-topic" data-topic="pages">Pages</li>
                            <li class="help-topic" data-topic="media">Media Library</li>
                            <li class="help-topic" data-topic="categories">Categories & Tags</li>
                            <li class="help-topic" data-topic="settings">Settings</li>
                            <li class="help-topic" data-topic="tools">Tools</li>
                            <li class="help-topic" data-topic="keyboard-shortcuts">Keyboard Shortcuts</li>
                        </ul>
                    </div>
                    <div class="help-content">
                        <div class="help-topic-content active" id="getting-started">
                            <h2>Getting Started with cr8OS CMS</h2>
                            <p>Welcome to the cr8OS Content Management System! This guide will help you get started with managing your content.</p>
                            
                            <h3>What is cr8OS CMS?</h3>
                            <p>cr8OS CMS is a powerful content management system built into the cr8OS environment. It allows you to create, edit, and manage various types of content such as posts, pages, media, and more.</p>
                            
                            <h3>Dashboard Overview</h3>
                            <p>The dashboard is your starting point. Here you can see:</p>
                            <ul>
                                <li><strong>Content statistics</strong> - Quick overview of your posts, pages, and media</li>
                                <li><strong>Recent activity</strong> - Latest updates to your content</li>
                                <li><strong>Quick draft</strong> - Create a quick draft post</li>
                            </ul>
                            
                            <h3>Navigation</h3>
                            <p>The sidebar navigation menu is organized into sections:</p>
                            <ul>
                                <li><strong>Content</strong> - Manage posts, pages, media, categories, and tags</li>
                                <li><strong>Management</strong> - User management, comments, and settings</li>
                                <li><strong>Utilities</strong> - Tools and help</li>
                            </ul>
                        </div>
                        
                        <div class="help-topic-content" id="posts">
                            <h2>Working with Posts</h2>
                            <p>Posts are typically used for blog entries, news articles, or other time-based content.</p>
                            
                            <h3>Creating a New Post</h3>
                            <ol>
                                <li>Click the "New" button in the header and select "New Post"</li>
                                <li>Enter a title for your post</li>
                                <li>Use the content editor to write and format your post</li>
                                <li>Add categories and tags to organize your content</li>
                                <li>Set a featured image (optional)</li>
                                <li>Add an excerpt (optional)</li>
                                <li>Click "Publish" to make the post live, or "Save Draft" to save it for later</li>
                            </ol>
                            
                            <h3>Managing Posts</h3>
                            <p>From the Posts page, you can:</p>
                            <ul>
                                <li>View all posts</li>
                                <li>Filter posts by status (published, draft, trash)</li>
                                <li>Perform bulk actions on multiple posts</li>
                                <li>Search for specific posts</li>
                            </ul>
                        </div>
                        
                        <div class="help-topic-content" id="pages">
                            <h2>Working with Pages</h2>
                            <p>Pages are static content that typically don't change often, such as About, Contact, or Services pages.</p>
                            
                            <h3>Creating a New Page</h3>
                            <ol>
                                <li>Click the "New" button in the header and select "New Page"</li>
                                <li>Enter a title for your page</li>
                                <li>Use the content editor to write and format your page</li>
                                <li>Set page attributes such as parent page and template</li>
                                <li>Set a featured image (optional)</li>
                                <li>Click "Publish" to make the page live, or "Save Draft" to save it for later</li>
                            </ol>
                            
                            <h3>Page Hierarchy</h3>
                            <p>Pages can be organized in a hierarchy by setting a parent page. This creates a structure like:</p>
                            <pre>
- Services (parent)
  - Web Design (child)
  - App Development (child)
  - Consulting (child)
                            </pre>
                        </div>
                        
                        <div class="help-topic-content" id="media">
                            <h2>Media Library</h2>
                            <p>The Media Library is where you manage all your images, videos, audio files, and documents.</p>
                            
                            <h3>Uploading Media</h3>
                            <ol>
                                <li>Go to the Media section</li>
                                <li>Click the "Upload Media" button</li>
                                <li>Select one or more files from your computer</li>
                                <li>The files will be uploaded and added to your Media Library</li>
                            </ol>
                            
                            <h3>Using Media</h3>
                            <p>You can use media in your content by:</p>
                            <ul>
                                <li>Setting a featured image for posts or pages</li>
                                <li>Inserting images in the content editor</li>
                                <li>Creating galleries</li>
                                <li>Adding downloadable files</li>
                            </ul>
                            
                            <h3>Managing Media</h3>
                            <p>From the Media Library, you can:</p>
                            <ul>
                                <li>Edit media details (title, alt text, description)</li>
                                <li>Delete unwanted media</li>
                                <li>Filter media by type (image, video, audio, document)</li>
                                <li>Search for specific media</li>
                            </ul>
                        </div>
                        
                        <div class="help-topic-content" id="categories">
                            <h2>Categories & Tags</h2>
                            <p>Categories and tags help you organize your content and make it easier for users to find related content.</p>
                            
                            <h3>Categories</h3>
                            <p>Categories are hierarchical and are typically used for broad grouping of posts.</p>
                            <ul>
                                <li>Categories can have parent-child relationships</li>
                                <li>Each post should have at least one category</li>
                                <li>Example categories: News, Tutorials, Reviews</li>
                            </ul>
                            
                            <h3>Tags</h3>
                            <p>Tags are non-hierarchical and are used for more specific grouping of posts.</p>
                            <ul>
                                <li>Tags can be added freely to any post</li>
                                <li>Tags are optional</li>
                                <li>Example tags: JavaScript, Design, Performance, Mobile</li>
                            </ul>
                            
                            <h3>Managing Categories & Tags</h3>
                            <p>From their respective pages, you can:</p>
                            <ul>
                                <li>Add new categories or tags</li>
                                <li>Edit existing ones</li>
                                <li>Delete unused ones</li>
                            </ul>
                        </div>
                        
                        <div class="help-topic-content" id="settings">
                            <h2>Settings</h2>
                            <p>The Settings page allows you to configure various aspects of your CMS.</p>
                            
                            <h3>General Settings</h3>
                            <ul>
                                <li>Site title and description</li>
                                <li>Language preferences</li>
                                <li>Date and time formats</li>
                            </ul>
                            
                            <h3>Writing Settings</h3>
                            <ul>
                                <li>Default post category</li>
                                <li>Default post format</li>
                                <li>Auto-save settings</li>
                            </ul>
                            
                            <h3>Reading Settings</h3>
                            <ul>
                                <li>Homepage display (latest posts or static page)</li>
                                <li>Posts per page</li>
                                <li>Feed content settings</li>
                            </ul>
                            
                            <h3>Media Settings</h3>
                            <ul>
                                <li>Image sizes (thumbnail, medium, large)</li>
                                <li>Upload organization options</li>
                            </ul>
                            
                            <h3>Permalink Settings</h3>
                            <ul>
                                <li>URL structure for posts and pages</li>
                                <li>Custom permalink structures</li>
                            </ul>
                        </div>
                        
                        <div class="help-topic-content" id="tools">
                            <h2>Tools</h2>
                            <p>The Tools page provides utilities to help manage your content.</p>
                            
                            <h3>Available Tools</h3>
                            <ul>
                                <li><strong>Regenerate Thumbnails</strong> - Recreate image thumbnails</li>
                                <li><strong>Data Cleanup</strong> - Remove unused tags, categories, and other data</li>
                                <li><strong>Export Content</strong> - Export content in various formats</li>
                                <li><strong>Find and Replace</strong> - Search and replace text across all content</li>
                            </ul>
                            
                            <h3>Import/Export</h3>
                            <p>The Import/Export tool allows you to:</p>
                            <ul>
                                <li>Export your content and settings for backup</li>
                                <li>Import content from another system</li>
                            </ul>
                        </div>
                        
                        <div class="help-topic-content" id="keyboard-shortcuts">
                            <h2>Keyboard Shortcuts</h2>
                            <p>These keyboard shortcuts can help you work more efficiently in the CMS.</p>
                            
                            <h3>Editor Shortcuts</h3>
                            <table class="shortcuts-table">
                                <tr>
                                    <th>Shortcut</th>
                                    <th>Action</th>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>B</kbd></td>
                                    <td>Bold text</td>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>I</kbd></td>
                                    <td>Italic text</td>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>U</kbd></td>
                                    <td>Underline text</td>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>K</kbd></td>
                                    <td>Insert link</td>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>S</kbd></td>
                                    <td>Save draft</td>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>P</kbd></td>
                                    <td>Preview</td>
                                </tr>
                                <tr>
                                    <td><kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>P</kbd></td>
                                    <td>Publish</td>
                                </tr>
                            </table>
                            
                            <h3>Navigation Shortcuts</h3>
                            <table class="shortcuts-table">
                                <tr>
                                    <th>Shortcut</th>
                                    <th>Action</th>
                                </tr>
                                <tr>
                                    <td><kbd>Alt</kbd> + <kbd>D</kbd></td>
                                    <td>Go to Dashboard</td>
                                </tr>
                                <tr>
                                    <td><kbd>Alt</kbd> + <kbd>P</kbd></td>
                                    <td>Go to Posts</td>
                                </tr>
                                <tr>
                                    <td><kbd>Alt</kbd> + <kbd>G</kbd></td>
                                    <td>Go to Pages</td>
                                </tr>
                                <tr>
                                    <td><kbd>Alt</kbd> + <kbd>M</kbd></td>
                                    <td>Go to Media</td>
                                </tr>
                                <tr>
                                    <td><kbd>Alt</kbd> + <kbd>N</kbd></td>
                                    <td>Create New</td>
                                </tr>
                                <tr>
                                    <td><kbd>/</kbd></td>
                                    <td>Focus search</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for help topics
            contentContainer.querySelectorAll('.help-topic').forEach(topic => {
                topic.addEventListener('click', function() {
                    // Update active state
                    contentContainer.querySelectorAll('.help-topic').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const topicId = this.dataset.topic;
                    contentContainer.querySelectorAll('.help-topic-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const topicContent = contentContainer.querySelector(`#${topicId}`);
                    if (topicContent) {
                        topicContent.classList.add('active');
                    }
                });
            });
        },
        
        // Render users list
        renderUsersList: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get users
            const users = userService.getAll();
            
            // Render users list
            contentContainer.innerHTML = `
                <div class="users-list-container">
                    <div class="users-header">
                        <h2>Users</h2>
                        <button class="add-user-button">
                            <i class="fas fa-user-plus"></i>
                            <span>Add New User</span>
                        </button>
                    </div>
                    <div class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th class="user-avatar-column"></th>
                                    <th class="user-name-column">Name</th>
                                    <th class="user-username-column">Username</th>
                                    <th class="user-email-column">Email</th>
                                    <th class="user-role-column">Role</th>
                                    <th class="user-actions-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr data-id="${user.id}">
                                        <td class="user-avatar-column">
                                            <div class="user-avatar">
                                                <i class="fas fa-user-circle"></i>
                                            </div>
                                        </td>
                                        <td class="user-name-column">
                                            <div class="user-name">${user.firstName} ${user.lastName}</div>
                                        </td>
                                        <td class="user-username-column">${user.username}</td>
                                        <td class="user-email-column">${user.email}</td>
                                        <td class="user-role-column">
                                            <span class="user-role ${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
                                        </td>
                                        <td class="user-actions-column">
                                            <button class="user-action-button" data-action="edit" data-id="${user.id}" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="user-action-button" data-action="delete" data-id="${user.id}" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const addUserButton = contentContainer.querySelector('.add-user-button');
            if (addUserButton) {
                addUserButton.addEventListener('click', () => {
                    this.showUserForm();
                });
            }
            
            // Edit user
            contentContainer.querySelectorAll('[data-action="edit"]').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = button.dataset.id;
                    if (userId) {
                        this.showUserForm(userId);
                    }
                });
            });
            
            // Delete user
            contentContainer.querySelectorAll('[data-action="delete"]').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = button.dataset.id;
                    if (userId) {
                        if (confirm('Are you sure you want to delete this user?')) {
                            userService.delete(userId);
                            this.renderUsersList();
                            this.showNotification('User deleted.', 'info');
                        }
                    }
                });
            });
        },
        
        // Show user form (add/edit)
        showUserForm: function(userId = null) {
            // Get user if editing
            let user = null;
            if (userId) {
                user = userService.get(userId);
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'user-form-modal';
            
            // Render form
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${user ? 'Edit User' : 'Add New User'}</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="user-username" value="${user ? user.username : ''}" ${user ? 'readonly' : ''}>
                            ${user ? '<p class="input-description">Username cannot be changed.</p>' : ''}
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" class="user-firstname" value="${user ? user.firstName : ''}">
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" class="user-lastname" value="${user ? user.lastName : ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="user-email" value="${user ? user.email : ''}">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select class="user-role">
                                <option value="admin" ${user && user.role === 'admin' ? 'selected' : ''}>Administrator</option>
                                <option value="editor" ${!user || user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="author" ${user && user.role === 'author' ? 'selected' : ''}>Author</option>
                                <option value="contributor" ${user && user.role === 'contributor' ? 'selected' : ''}>Contributor</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="save-user-button">
                            ${user ? 'Update User' : 'Add User'}
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const saveButton = modal.querySelector('.save-user-button');
            
            // Close handler
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Save handler
            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    // Get form values
                    const username = modal.querySelector('.user-username').value.trim();
                    const firstName = modal.querySelector('.user-firstname').value.trim();
                    const lastName = modal.querySelector('.user-lastname').value.trim();
                    const email = modal.querySelector('.user-email').value.trim();
                    const role = modal.querySelector('.user-role').value;
                    
                    // Validate
                    if (!username || !email) {
                        this.showNotification('Username and email are required.', 'error');
                        return;
                    }
                    
                    // Create user data
                    const userData = {
                        username,
                        firstName,
                        lastName,
                        email,
                        role
                    };
                    
                    if (user) {
                        // Update existing user
                        userService.update(userId, userData);
                        this.showNotification('User updated.', 'success');
                    } else {
                        // Create new user
                        userService.create(userData);
                        this.showNotification('User created.', 'success');
                    }
                    
                    // Close modal
                    modal.remove();
                    
                    // Refresh users list
                    this.renderUsersList();
                });
            }
        },
        
        // Render comments list
        renderCommentsList: function() {
            const contentContainer = state.contentWindow.querySelector('.cms-content');
            if (!contentContainer) return;
            
            // Get all comments from all posts
            const allComments = [];
            
            state.contentLibrary.posts.forEach(post => {
                if (post.comments && Array.isArray(post.comments)) {
                    post.comments.forEach(comment => {
                        allComments.push({
                            ...comment,
                            postTitle: post.title,
                            postId: post.id
                        });
                    });
                }
            });
            
            // Sort by date (newest first)
            allComments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Render comments list
            contentContainer.innerHTML = `
                <div class="comments-list-container">
                    <div class="comments-header">
                        <h2>Comments</h2>
                        <div class="comments-filter">
                            <select class="comment-status-filter">
                                <option value="all">All Comments</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="spam">Spam</option>
                                <option value="trash">Trash</option>
                            </select>
                        </div>
                    </div>
                    <div class="comments-table">
                        ${allComments.length === 0 ? `
                            <div class="no-comments">
                                <i class="fas fa-comments"></i>
                                <p>No comments found.</p>
                            </div>
                        ` : `
                            <table>
                                <thead>
                                    <tr>
                                        <th class="comment-author-column">Author</th>
                                        <th class="comment-content-column">Comment</th>
                                        <th class="comment-post-column">In Response To</th>
                                        <th class="comment-date-column">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allComments.map(comment => `
                                        <tr data-id="${comment.id}" class="comment-row ${comment.status}">
                                            <td class="comment-author-column">
                                                <div class="comment-author-avatar">
                                                    <i class="fas fa-user-circle"></i>
                                                </div>
                                                <div class="comment-author-info">
                                                    <div class="comment-author-name">${comment.author}</div>
                                                    <div class="comment-author-email">${comment.email}</div>
                                                    ${comment.website ? `
                                                        <div class="comment-author-website">
                                                            <a href="${comment.website}" target="_blank">${comment.website}</a>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </td>
                                            <td class="comment-content-column">
                                                <div class="comment-content">${comment.content}</div>
                                                <div class="comment-actions">
                                                    ${comment.status === 'pending' ? `
                                                        <button class="comment-action-button" data-action="approve" data-id="${comment.id}" data-post-id="${comment.postId}">
                                                            <i class="fas fa-check"></i>
                                                            <span>Approve</span>
                                                        </button>
                                                    ` : ''}
                                                    ${comment.status !== 'spam' ? `
                                                        <button class="comment-action-button" data-action="spam" data-id="${comment.id}" data-post-id="${comment.postId}">
                                                            <i class="fas fa-ban"></i>
                                                            <span>Spam</span>
                                                        </button>
                                                    ` : ''}
                                                    ${comment.status !== 'trash' ? `
                                                        <button class="comment-action-button" data-action="trash" data-id="${comment.id}" data-post-id="${comment.postId}">
                                                            <i class="fas fa-trash"></i>
                                                            <span>Trash</span>
                                                        </button>
                                                    ` : ''}
                                                    <button class="comment-action-button" data-action="reply" data-id="${comment.id}" data-post-id="${comment.postId}">
                                                        <i class="fas fa-reply"></i>
                                                        <span>Reply</span>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="comment-post-column">
                                                <a href="#" data-action="view-post" data-id="${comment.postId}">${comment.postTitle}</a>
                                            </td>
                                            <td class="comment-date-column">
                                                <div class="comment-date">${formatDate(comment.createdAt)}</div>
                                                <div class="comment-status-label">${comment.status.charAt(0).toUpperCase() + comment.status.slice(1)}</div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;
            
            // Add event listeners
            if (allComments.length > 0) {
                // Status filter
                const statusFilter = contentContainer.querySelector('.comment-status-filter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', function() {
                        const status = this.value;
                        const commentRows = contentContainer.querySelectorAll('.comment-row');
                        
                        commentRows.forEach(row => {
                            if (status === 'all' || row.classList.contains(status)) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        });
                    });
                }
                
                // Comment actions
                contentContainer.querySelectorAll('.comment-action-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const action = button.dataset.action;
                        const commentId = button.dataset.id;
                        const postId = button.dataset.postId;
                        
                        if (commentId && postId) {
                            this.handleCommentAction(postId, commentId, action);
                        }
                    });
                });
                
                // View post
                contentContainer.querySelectorAll('[data-action="view-post"]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const postId = link.dataset.id;
                        if (postId) {
                            this.showContentPreview('posts', postId);
                        }
                    });
                });
            }
        },
        
        // Handle comment action
        handleCommentAction: function(postId, commentId, action) {
            const post = contentService.get('posts', postId);
            if (!post || !post.comments) return;
            
            // Find comment index
            const commentIndex = post.comments.findIndex(c => c.id === commentId);
            if (commentIndex === -1) return;
            
            // Get comment
            const comment = post.comments[commentIndex];
            
            // Process action
            switch (action) {
                case 'approve':
                    comment.status = 'approved';
                    this.showNotification('Comment approved.', 'success');
                    break;
                case 'spam':
                    comment.status = 'spam';
                    this.showNotification('Comment marked as spam.', 'info');
                    break;
                case 'trash':
                    comment.status = 'trash';
                    this.showNotification('Comment moved to trash.', 'info');
                    break;
                case 'reply':
                    this.showCommentReplyForm(post, comment);
                    return; // Don't save yet
            }
            
            // Update post
            post.comments[commentIndex] = comment;
            
            // Save changes
            contentService.update('posts', postId, { comments: post.comments });
            
            // Refresh comments list
            this.renderCommentsList();
        },
        
        // Show comment reply form
        showCommentReplyForm: function(post, comment) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'comment-reply-modal';
            
            // Render form
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Reply to Comment</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="original-comment">
                            <div class="comment-author">${comment.author} said:</div>
                            <div class="comment-content">${comment.content}</div>
                        </div>
                        <div class="reply-form">
                            <textarea class="reply-content" placeholder="Write your reply here..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="submit-reply-button">
                            <i class="fas fa-reply"></i>
                            <span>Submit Reply</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const submitButton = modal.querySelector('.submit-reply-button');
            
            // Close handler
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Submit handler
            if (submitButton) {
                submitButton.addEventListener('click', () => {
                    const replyContent = modal.querySelector('.reply-content').value.trim();
                    
                    if (!replyContent) {
                        this.showNotification('Reply content is required.', 'error');
                        return;
                    }
                    
                    // Create reply comment
                    const reply = new models.Comment({
                        postId: post.id,
                        author: state.currentUser ? state.currentUser.getFullName() : 'Admin',
                        email: state.currentUser ? state.currentUser.email : '',
                        content: replyContent,
                        status: 'approved',
                        parent: comment.id
                    });
                    
                    // Add to post comments
                    if (!post.comments) {
                        post.comments = [];
                    }
                    
                    post.comments.push(reply);
                    
                    // Save changes
                    contentService.update('posts', post.id, { comments: post.comments });
                    
                    // Close modal
                    modal.remove();
                    
                    // Refresh comments list
                    this.renderCommentsList();
                    
                    // Show notification
                    this.showNotification('Reply added.', 'success');
                });
            }
        },
        
        // Show profile editor
        showProfileEditor: function() {
            if (!state.currentUser) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'profile-editor-modal';
            
            // Render form
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Profile</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-avatar">
                            <div class="avatar-preview">
                                <i class="fas fa-user-circle fa-4x"></i>
                            </div>
                            <button class="change-avatar-button">
                                <i class="fas fa-camera"></i>
                                <span>Change Avatar</span>
                            </button>
                        </div>
                        <div class="profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" class="profile-firstname" value="${state.currentUser.firstName}">
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" class="profile-lastname" value="${state.currentUser.lastName}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="profile-email" value="${state.currentUser.email}">
                            </div>
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" class="profile-username" value="${state.currentUser.username}" readonly>
                                <p class="input-description">Username cannot be changed.</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="save-profile-button">
                            <i class="fas fa-save"></i>
                            <span>Save Profile</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const saveButton = modal.querySelector('.save-profile-button');
            
            // Close handler
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Save handler
            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    // Get form values
                    const firstName = modal.querySelector('.profile-firstname').value.trim();
                    const lastName = modal.querySelector('.profile-lastname').value.trim();
                    const email = modal.querySelector('.profile-email').value.trim();
                    
                    // Validate
                    if (!email) {
                        this.showNotification('Email is required.', 'error');
                        return;
                    }
                    
                    // Update user
                    userService.update(state.currentUser.id, {
                        firstName,
                        lastName,
                        email
                    });
                    
                    // Update current user
                    state.currentUser = userService.get(state.currentUser.id);
                    
                    // Close modal
                    modal.remove();
                    
                    // Show notification
                    this.showNotification('Profile updated.', 'success');
                    
                    // Update user info in sidebar
                    const userNameEl = state.contentWindow.querySelector('.user-name');
                    if (userNameEl) {
                        userNameEl.textContent = state.currentUser.getFullName();
                    }
                });
            }
        },
        
        // Show user preferences
        showUserPreferences: function() {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'user-preferences-modal';
            
            // Render form
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Preferences</h2>
                        <button class="close-modal-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="preferences-section">
                            <h3>Interface</h3>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" class="pref-auto-save" ${state.settings.autoSave ? 'checked' : ''}>
                                    Enable auto-save while editing
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Media library view</label>
                                <div class="radio-options">
                                    <label>
                                        <input type="radio" name="media-view" value="grid" ${state.settings.mediaLibraryViewMode === 'grid' ? 'checked' : ''}>
                                        Grid
                                    </label>
                                    <label>
                                        <input type="radio" name="media-view" value="list" ${state.settings.mediaLibraryViewMode === 'list' ? 'checked' : ''}>
                                        List
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="preferences-section">
                            <h3>Content</h3>
                            <div class="form-group">
                                <label>Default post category</label>
                                <select class="pref-default-category">
                                    ${state.contentLibrary.categories.map(category => `
                                        <option value="${category.id}" ${state.settings.defaultCategory === category.id ? 'selected' : ''}>
                                            ${category.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Posts per page</label>
                                <input type="number" class="pref-posts-per-page" value="${state.settings.postsPerPage}" min="1" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="save-preferences-button">
                            <i class="fas fa-save"></i>
                            <span>Save Preferences</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(modal);
            
            // Add event listeners
            const closeButton = modal.querySelector('.close-modal-button');
            const saveButton = modal.querySelector('.save-preferences-button');
            
            // Close handler
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            // Save handler
            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    // Get form values
                    const autoSave = modal.querySelector('.pref-auto-save').checked;
                    const mediaViewMode = modal.querySelector('input[name="media-view"]:checked').value;
                    const defaultCategory = modal.querySelector('.pref-default-category').value;
                    const postsPerPage = parseInt(modal.querySelector('.pref-posts-per-page').value) || 10;
                    
                    // Update settings
                    state.settings.autoSave = autoSave;
                    state.settings.mediaLibraryViewMode = mediaViewMode;
                    state.settings.defaultCategory = defaultCategory;
                    state.settings.postsPerPage = postsPerPage;
                    
                    // Save settings
                    storage.save();
                    
                    // Close modal
                    modal.remove();
                    
                    // Show notification
                    this.showNotification('Preferences saved.', 'success');
                });
            }
        },
        
        // Logout user
        logoutUser: function() {
            // Clear current user
            state.currentUser = null;
            
            // Stop autosave if active
            if (state.editorState.autosaveTimerId) {
                clearInterval(state.editorState.autosaveTimerId);
                state.editorState.autosaveTimerId = null;
            }
            
            // Close CMS window
            if (state.contentWindow) {
                if (state.contentWindow.close) {
                    state.contentWindow.close();
                } else {
                    state.contentWindow.style.display = 'none';
                }
                
                state.contentWindow = null;
            }
            
            // Show login form or redirect to login page
            this.showLoginForm();
        },
        
        // Show login form
        showLoginForm: function() {
            // Create login container
            const loginContainer = document.createElement('div');
            loginContainer.className = 'cr8os-cms-login';
            
            // Render login form
            loginContainer.innerHTML = `
                <div class="login-form-container">
                    <div class="login-header">
                        <div class="login-logo">
                            <i class="fas fa-cubes"></i>
                            <span>cr8OS CMS</span>
                        </div>
                        <h2>Login</h2>
                    </div>
                    <div class="login-form">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="login-username" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="login-password" placeholder="Password">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" class="login-remember">
                                Remember me
                            </label>
                        </div>
                        <button class="login-button">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Login</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(loginContainer);
            
            // Add event listeners
            const loginButton = loginContainer.querySelector('.login-button');
            
            if (loginButton) {
                loginButton.addEventListener('click', () => {
                    // Get form values
                    const username = loginContainer.querySelector('.login-username').value.trim();
                    const password = loginContainer.querySelector('.login-password').value;
                    
                    // In a real implementation, this would validate against the server
                    // For demo purposes, just check if a user with this username exists
                    const user = state.users.find(u => u.username === username);
                    
                    if (user) {
                        // Set current user
                        state.currentUser = user;
                        
                        // Remove login form
                        loginContainer.remove();
                        
                        // Show CMS
                        this.createCMSWindow();
                    } else {
                        this.showNotification('Invalid username or password.', 'error');
                    }
                });
            }
        }
    };
    
    // Initialize CMS
    const initialize = function() {
        if (state.initialized) return;
        
        // Create default admin user if none exists
        if (state.users.length === 0) {
            state.users.push(new models.User({
                username: 'admin',
                firstName: 'Admin',
                lastName: 'User',
                email: 'admin@example.com',
                role: 'admin'
            }));
        }
        
        // Create default category if none exists
        if (state.contentLibrary.categories.length === 0) {
            const uncategorized = new models.Category({
                name: 'Uncategorized',
                description: 'Default category'
            });
            
            state.contentLibrary.categories.push(uncategorized);
            state.settings.defaultCategory = uncategorized.id;
        }
        
        // Set current user to first admin for demo
        const adminUser = state.users.find(user => user.role === 'admin');
        if (adminUser) {
            state.currentUser = adminUser;
        }
        
        // Load saved data
        storage.load();
        
        state.initialized = true;
    };
    
    // Public API
    return {
        // Initialize the CMS
        init: function() {
            initialize();
            return this;
        },
        
        // Open CMS window
        open: function() {
            if (!state.initialized) {
                this.init();
            }
            
            // Check if user is logged in
            if (!state.currentUser) {
                renderer.showLoginForm();
            } else {
                renderer.createCMSWindow();
            }
            
            return this;
        },
        
        // Close CMS window
        close: function() {
            if (state.contentWindow) {
                if (state.contentWindow.close) {
                    state.contentWindow.close();
                } else {
                    state.contentWindow.style.display = 'none';
                }
            }
            
            return this;
        },
        
        // Navigate to a specific route
        navigate: function(route) {
            if (!state.initialized || !state.contentWindow) {
                this.open();
            }
            
            renderer.navigateTo(route);
            
            return this;
        },
        
        // Register new content type
        registerContentType: function(type, modelClass) {
            if (!state.initialized) {
                this.init();
            }
            
            if (!state.contentLibrary[type]) {
                state.contentLibrary[type] = [];
                models[type] = modelClass;
            }
            
            return this;
        },
        
        // Get content service API
        getContentService: function() {
            return contentService;
        },
        
        // Get user service API
        getUserService: function() {
            return userService;
        },
        
        // Get settings
        getSettings: function() {
            return { ...state.settings };
        },
        
        // Update settings
        updateSettings: function(newSettings) {
            state.settings = { ...state.settings, ...newSettings };
            storage.save();
            return this;
        },
        
        // Export data
        exportData: function() {
            storage.export();
            return this;
        },
        
        // Import data
        importData: function(jsonData) {
            storage.import(jsonData);
            return this;
        }
    };
})();

// Initialize the CMS when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize CMS
    cr8OSCMS.init();
    
    // Register with cr8OS if available
    if (typeof cr8OS !== 'undefined' && cr8OS.registerApp) {
        cr8OS.registerApp({
            id: 'cms',
            name: 'Content Manager',
            description: 'Manage your content, media, and more',
            icon: 'newspaper',
            category: 'productivity',
            url: '#cms',
            run: function() {
                cr8OSCMS.open();
            }
        });
    }
});

// Add CMS styles
(function() {
    const styleEl = document.createElement('style');
    styleEl.id = 'cr8os-cms-styles';
    styleEl.textContent = `
        /* CMS Container */
        .cr8os-cms-container {
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #f4f7fa;
            color: #333;
            font-family: Arial, sans-serif;
        }
        
        /* CMS Sidebar */
        .cms-sidebar {
            width: 240px;
            background: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .cms-logo {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cms-logo i {
            font-size: 24px;
            margin-right: 10px;
            color: #3498db;
        }
        
        .cms-logo span {
            font-size: 18px;
            font-weight: bold;
        }
        
        .cms-navigation {
            flex-grow: 1;
            padding: 15px 0;
        }
        
        .nav-section {
            margin-bottom: 20px;
        }
        
        .nav-title {
            padding: 5px 20px;
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
        }
        
        .nav-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background: #3498db;
            color: white;
        }
        
        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .cms-user-info {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .user-details {
            flex-grow: 1;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .user-role {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .user-menu-button {
        background: transparent;
        border: none;
        color: #ecf0f1;
        cursor: pointer;
        font-size: 14px;
    }
    
    /* CMS Main Content */
    .cms-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .cms-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: white;
        border-bottom: 1px solid #e1e5eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .header-title h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 500;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
    }
    
    .search-box {
        position: relative;
        margin-right: 15px;
    }
    
    .search-box input {
        padding: 8px 15px 8px 35px;
        border: 1px solid #e1e5eb;
        border-radius: 20px;
        width: 200px;
        font-size: 14px;
    }
    
    .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0a0a0;
    }
    
    .action-button {
        display: flex;
        align-items: center;
        padding: 8px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .action-button i {
        margin-right: 8px;
    }
    
    .cms-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    /* Dashboard styles */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .dashboard-card {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        align-items: center;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: #3498db;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        margin-right: 15px;
    }
    
    .card-stats {
        flex-grow: 1;
    }
    
    .stats-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stats-label {
        color: #7f8c8d;
        font-size: 14px;
    }
    
    .dashboard-recent {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }
    
    .dashboard-section {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }
    
    .dashboard-section h2 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
        font-weight: 500;
    }
    
    .activity-list {
        margin-top: 15px;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        margin-right: 15px;
    }
    
    .activity-details {
        flex-grow: 1;
    }
    
    .activity-title {
        font-size: 14px;
        margin-bottom: 3px;
    }
    
    .activity-meta {
        font-size: 12px;
        color: #7f8c8d;
    }
    
    .activity-time {
        font-size: 12px;
        color: #7f8c8d;
    }
    
    .quick-draft-form {
        margin-top: 15px;
    }
    
    .draft-title {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .draft-content {
        width: 100%;
        height: 120px;
        padding: 8px 12px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 14px;
        resize: vertical;
    }
    
    .save-draft-button {
        background: #2ecc71;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
    }
    
    /* Content list styles */
    .content-list-container {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .list-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .bulk-actions {
        display: flex;
        align-items: center;
    }
    
    .bulk-action-select {
        padding: 6px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        margin-right: 10px;
    }
    
    .apply-bulk-button {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .list-filters {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    
    .filter-links {
        margin-bottom: 10px;
    }
    
    .filter-link {
        margin-left: 15px;
        color: #3498db;
        text-decoration: none;
    }
    
    .filter-link.active {
        font-weight: bold;
    }
    
    .filter-dropdowns {
        display: flex;
        align-items: center;
    }
    
    .filter-select {
        padding: 6px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        margin-left: 10px;
    }
    
    .filter-button {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .content-table {
        overflow-x: auto;
    }
    
    .content-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .content-table th, 
    .content-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .content-table th {
        background: #f5f7fa;
        font-weight: 500;
    }
    
    .check-column {
        width: 40px;
    }
    
    .title-column {
        width: 30%;
    }
    
    .content-title {
        font-weight: 500;
    }
    
    .content-title a {
        color: #3498db;
        text-decoration: none;
    }
    
    .row-actions {
        display: none;
        font-size: 12px;
        margin-top: 5px;
    }
    
    .content-row:hover .row-actions {
        display: block;
    }
    
    .row-actions span {
        margin-right: 8px;
    }
    
    .row-actions a {
        color: #3498db;
        text-decoration: none;
    }
    
    .row-actions a:hover {
        text-decoration: underline;
    }
    
    .content-row.draft .content-status {
        color: #e67e22;
    }
    
    .content-row.published .content-status {
        color: #27ae60;
    }
    
    .content-row.trash .content-status {
        color: #e74c3c;
    }
    
    .list-pagination {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #e1e5eb;
    }
    
    .pagination-info {
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .pagination-links {
        display: flex;
        align-items: center;
    }
    
    .pagination-link {
        margin: 0 5px;
        padding: 6px 12px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        color: #3498db;
        text-decoration: none;
    }
    
    .pagination-link.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .pagination-link.disabled {
        color: #bdc3c7;
        cursor: not-allowed;
    }
    
    /* Media library styles */
    .media-library-container {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .media-toolbar {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .media-view-options {
        display: flex;
    }
    
    .view-option-button {
        width: 36px;
        height: 36px;
        border: 1px solid #e1e5eb;
        background: white;
        color: #7f8c8d;
        border-radius: 4px;
        margin-right: 5px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .view-option-button.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .upload-media-button {
        display: flex;
        align-items: center;
        padding: 8px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .upload-media-button i {
        margin-right: 8px;
    }
    
    .media-filters {
        display: flex;
    }
    
    .media-type-filter,
    .media-date-filter {
        padding: 6px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        margin-left: 10px;
    }
    
    .media-grid-view {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 15px;
        padding: 20px;
        min-height: 400px;
    }
    
    .media-item {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .media-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .media-item.selected {
        border: 2px solid #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
    }
    
    .media-preview {
        height: 120px;
        background: #f5f7fa;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }
    
    .media-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .video-preview,
    .audio-preview,
    .document-preview {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 36px;
    }
    
    .video-preview {
        background: #9b59b6;
        color: white;
    }
    
    .audio-preview {
        background: #e67e22;
        color: white;
    }
    
    .document-preview {
        background: #3498db;
        color: white;
    }
    
    .media-info {
        padding: 10px;
    }
    
    .media-title {
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 3px;
    }
    
    .media-date {
        font-size: 12px;
        color: #7f8c8d;
    }
    
    .media-actions {
        display: none;
        padding: 5px 10px;
        border-top: 1px solid #e1e5eb;
        text-align: right;
    }
    
    .media-item:hover .media-actions {
        display: block;
    }
    
    .media-action-button {
        background: transparent;
        border: none;
        color: #7f8c8d;
        cursor: pointer;
        padding: 5px;
        margin-left: 5px;
    }
    
    .media-action-button:hover {
        color: #3498db;
    }
    
    .media-list-view {
        padding: 20px;
    }
    
    .media-list-view table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .media-list-view th, 
    .media-list-view td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .media-list-view th {
        background: #f5f7fa;
        font-weight: 500;
    }
    
    .file-column {
        width: 40%;
    }
    
    .file-preview {
        width: 40px;
        height: 40px;
        background: #f5f7fa;
        border-radius: 4px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 10px;
        float: left;
    }
    
    .file-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .file-details {
        margin-left: 50px;
    }
    
    .file-title {
        font-weight: 500;
        margin-bottom: 3px;
    }
    
    .file-meta {
        font-size: 12px;
        color: #7f8c8d;
    }
    
    .media-pagination {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #e1e5eb;
    }
    
    /* Content editor styles */
    .content-editor {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .editor-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .editor-title {
        flex-grow: 1;
    }
    
    .title-input {
        width: 100%;
        padding: 10px 0;
        font-size: 20px;
        border: none;
        background: transparent;
    }
    
    .title-input:focus {
        outline: none;
    }
    
    .editor-actions {
        display: flex;
        align-items: center;
    }
    
    .editor-container {
        flex-grow: 1;
        display: flex;
        overflow: hidden;
    }
    
    .editor-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e1e5eb;
    }
    
    .toolbar {
        padding: 10px;
        border-bottom: 1px solid #e1e5eb;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .toolbar-group {
        display: flex;
        margin-right: 10px;
    }
    
    .toolbar-button {
        width: 30px;
        height: 30px;
        background: white;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        color: #7f8c8d;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    
    .toolbar-button:hover {
        background: #f5f7fa;
    }
    
    .toolbar-select {
        padding: 5px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        color: #7f8c8d;
    }
    
    .editor-content {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        min-height: 300px;
    }
    
    .editor-content:focus {
        outline: none;
    }
    
    .editor-sidebar {
        width: 280px;
        overflow-y: auto;
        background: #f5f7fa;
    }
    
    .sidebar-panel {
        margin-bottom: 15px;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .sidebar-panel.collapsed .panel-content {
        display: none;
    }
    
    .panel-header {
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .panel-header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
    }
    
    .panel-toggle-button {
        background: transparent;
        border: none;
        color: #7f8c8d;
        cursor: pointer;
    }
    
    .panel-content {
        padding: 15px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="datetime-local"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .radio-options,
    .checkbox-options {
        margin-top: 5px;
    }
    
    .radio-options label,
    .checkbox-options label {
        display: block;
        margin-bottom: 8px;
        font-weight: normal;
    }
    
    .categories-list {
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 10px;
    }
    
    .category-item {
        display: block;
        margin-bottom: 8px;
    }
    
    .add-category-button {
        display: flex;
        align-items: center;
        padding: 6px 10px;
        background: transparent;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        color: #3498db;
        cursor: pointer;
        font-size: 13px;
    }
    
    .add-category-button i {
        margin-right: 5px;
    }
    
    .tags-input-container {
        position: relative;
        margin-bottom: 10px;
    }
    
    .tags-input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .tags-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e1e5eb;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 100;
        display: none;
    }
    
    .tag-suggestion {
        padding: 8px 10px;
        cursor: pointer;
    }
    
    .tag-suggestion:hover {
        background: #f5f7fa;
    }
    
    .current-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .tag-item {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        background: #e1e5eb;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .remove-tag-button {
        background: transparent;
        border: none;
        margin-left: 5px;
        cursor: pointer;
        font-size: 10px;
        color: #7f8c8d;
    }
    
    .featured-image-container {
        margin-bottom: 10px;
    }
    
    .featured-image {
        width: 100%;
        height: auto;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .featured-image-placeholder {
        width: 100%;
        height: 150px;
        background: #f5f7fa;
        border: 1px dashed #bdc3c7;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #7f8c8d;
    }
    
    .featured-image-placeholder i {
        font-size: 24px;
        margin-bottom: 5px;
    }
    
    .set-featured-image-button {
        display: flex;
        align-items: center;
        padding: 6px 10px;
        background: transparent;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        color: #3498db;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
        justify-content: center;
    }
    
    .set-featured-image-button i {
        margin-right: 5px;
    }
    
    .remove-featured-image-button {
        display: flex;
        align-items: center;
        padding: 6px 10px;
        background: #e74c3c;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
        justify-content: center;
    }
    
    .remove-featured-image-button i {
        margin-right: 5px;
    }
    
    .excerpt-textarea {
        width: 100%;
        height: 80px;
        padding: 8px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        font-size: 14px;
        resize: vertical;
    }
    
    .excerpt-description {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }
    
    .panel-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    /* Modals and dialogs */
    .media-editor-modal-container,
    .media-preview-modal,
    .user-form-modal,
    .profile-editor-modal,
    .user-preferences-modal,
    .taxonomy-editor-modal,
    .comment-reply-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: white;
        border-radius: 5px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        width: 600px;
        max-width: 90%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .modal-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 500;
    }
    
    .close-modal-button {
        background: transparent;
        border: none;
        color: #7f8c8d;
        cursor: pointer;
        font-size: 18px;
    }
    
    .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
    }
    
    .modal-footer {
        padding: 15px 20px;
        display: flex;
        justify-content: flex-end;
        border-top: 1px solid #e1e5eb;
    }
    
    /* Media editor/preview specific */
    .media-editor-modal .modal-content {
        width: 800px;
        height: 600px;
    }
    
    .media-preview-pane {
        width: 40%;
        padding-right: 20px;
    }
    
    .media-details-pane {
        width: 60%;
    }
    
    .media-preview-container {
        max-width: 100%;
        max-height: 400px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .media-preview-container img {
        max-width: 100%;
        max-height: 400px;
    }
    
    .media-preview-container video,
    .media-preview-container audio {
        width: 100%;
    }
    
    .media-metadata {
        margin-top: 20px;
        border-top: 1px solid #e1e5eb;
        padding-top: 15px;
    }
    
    .metadata-item {
        display: flex;
        margin-bottom: 8px;
    }
    
    .metadata-label {
        width: 100px;
        color: #7f8c8d;
    }
    
    .delete-button {
        background: #e74c3c;
        margin-right: auto;
    }
    
    /* Media selector modal */
    .media-selector-modal .modal-content {
        width: 800px;
        height: 600px;
    }
    
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Taxonomy editor specific */
    .taxonomy-list-container {
        display: flex;
        gap: 20px;
    }
    
    .taxonomy-form {
        width: 300px;
        background: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .taxonomy-list {
        flex-grow: 1;
        background: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .taxonomy-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .taxonomy-table th, 
    .taxonomy-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .taxonomy-table th {
        background: #f5f7fa;
        font-weight: 500;
    }
    
    .name-column {
        width: 30%;
    }
    
    /* Comments list specific */
    .comments-list-container {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .comments-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .comment-status-filter {
        padding: 6px 10px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
    }
    
    .comments-table {
        padding: 20px;
    }
    
    .comment-row {
        transition: background 0.2s;
    }
    
    .comment-row:hover {
        background: #f5f7fa;
    }
    
    .comment-row.pending .comment-status-label {
        color: #e67e22;
    }
    
    .comment-row.approved .comment-status-label {
        color: #27ae60;
    }
    
    .comment-row.spam .comment-status-label {
        color: #e74c3c;
    }
    
    .comment-row.trash .comment-status-label {
        color: #7f8c8d;
    }
    
    .comment-author-column {
        width: 20%;
    }
    
    .comment-content-column {
        width: 50%;
    }
    
    .comment-post-column {
        width: 15%;
    }
    
    .comment-date-column {
        width: 15%;
    }
    
    .comment-author-avatar {
        font-size: 24px;
        margin-bottom: 5px;
    }
    
    .comment-author-info {
        font-size: 14px;
    }
    
    .comment-author-name {
        font-weight: 500;
        margin-bottom: 3px;
    }
    
    .comment-author-email,
    .comment-author-website {
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 2px;
    }
    
    .comment-content {
        margin-bottom: 10px;
    }
    
    .comment-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .comment-action-button {
        font-size: 12px;
        padding: 3px 8px;
        background: #f5f7fa;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        color: #3498db;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    
    .comment-action-button i {
        margin-right: 5px;
    }
    
    /* Settings styles */
    .settings-container {
        display: flex;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .settings-tabs {
        width: 200px;
        border-right: 1px solid #e1e5eb;
        padding: 20px 0;
    }
    
    .settings-tab {
        display: block;
        width: 100%;
        padding: 10px 20px;
        text-align: left;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 14px;
    }
    
    .settings-tab:hover {
        background: #f5f7fa;
    }
    
    .settings-tab.active {
        background: #f5f7fa;
        font-weight: 500;
        border-left: 3px solid #3498db;
        padding-left: 17px;
    }
    
    .settings-content {
        flex-grow: 1;
        padding: 20px;
    }
    
    .settings-panel {
        display: none;
    }
    
    .settings-panel.active {
        display: block;
    }
    
    .settings-panel h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 500;
    }
    
    .date-format-options span,
    .time-format-options span {
        margin-left: 10px;
    }
    
    .save-settings-button {
        margin-top: 20px;
        padding: 8px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .size-inputs {
        margin-top: 10px;
    }
    
    .size-input-group {
        margin-bottom: 15px;
    }
    
    .dimension-inputs {
        display: flex;
        gap: 10px;
    }
    
    .dimension-input {
        display: flex;
        align-items: center;
    }
    
    .dimension-input input {
        width: 80px;
        margin-right: 5px;
    }
    
    .permalink-options {
        margin-top: 10px;
    }
    
    .permalink-example {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #7f8c8d;
    }
    
    #custom-permalink {
        width: 300px;
        margin-top: 5px;
    }
    
    .available-tags {
        margin-top: 15px;
        font-size: 12px;
        color: #7f8c8d;
    }
    
    .available-tags code {
        background: #f5f7fa;
        padding: 2px 5px;
        border-radius: 3px;
        margin: 2px;
        display: inline-block;
    }
    
    .export-section,
    .import-section {
        margin-bottom: 30px;
    }
    
    .export-section h3,
    .import-section h3 {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 10px;
    }
    
    .import-file-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    
    .import-file-button {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }
    
    .selected-file-name {
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .import-options {
        margin: 10px 0;
    }
    
    /* Tools page */
    .tools-container {
        padding: 20px;
    }
    
    .tools-section h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 500;
    }
    
    .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .tool-card {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        padding: 20px;
    }
    
    .tool-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #3498db;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        margin-right: 15px;
    }
    
    .tool-details {
        flex-grow: 1;
    }
    
    .tool-details h3 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 16px;
        font-weight: 500;
    }
    
    .tool-details p {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .tool-button {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .tools-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .tools-modal-content {
        background: white;
        border-radius: 5px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        width: 600px;
        max-width: 90%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .tool-form {
        padding: 20px;
    }
    
    .tool-description {
        margin-bottom: 20px;
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .progress-container {
        margin: 20px 0;
    }
    
    .progress-bar {
        height: 10px;
        background: #f5f7fa;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: #3498db;
        width: 0%;
        transition: width 0.3s;
    }
    
    .progress-text {
        text-align: center;
        margin-top: 5px;
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .tool-actions {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .run-tool-button {
        padding: 8px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    
    .run-tool-button i {
        margin-right: 8px;
    }
    
    .preview-tool-button {
        padding: 8px 15px;
        background: white;
        color: #3498db;
        border: 1px solid #3498db;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    
    .preview-tool-button i {
        margin-right: 8px;
    }
    
    .results-container,
    .preview-container {
        margin-top: 20px;
        padding: 15px;
        background: #f5f7fa;
        border-radius: 5px;
    }
    
    .results-container h3,
    .preview-container h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 500;
    }
    
    /* Help page */
    .help-container {
        display: flex;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .help-sidebar {
        width: 200px;
        border-right: 1px solid #e1e5eb;
        padding: 20px 0;
    }
    
    .help-sidebar h3 {
        padding: 0 20px;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 500;
    }
    
    .help-topics {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .help-topic {
        padding: 10px 20px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 14px;
    }
    
    .help-topic:hover {
        background: #f5f7fa;
    }
    
    .help-topic.active {
        background: #f5f7fa;
        font-weight: 500;
        border-left: 3px solid #3498db;
        padding-left: 17px;
    }
    
    .help-content {
        flex-grow: 1;
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .help-topic-content {
        display: none;
    }
    
    .help-topic-content.active {
        display: block;
    }
    
    .help-topic-content h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 500;
    }
    
    .help-topic-content h3 {
        margin-top: 30px;
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 500;
    }
    
    .help-topic-content p {
        line-height: 1.6;
        margin-bottom: 15px;
    }
    
    .help-topic-content ul,
    .help-topic-content ol {
        margin-bottom: 15px;
        padding-left: 20px;
    }
    
    .help-topic-content li {
        margin-bottom: 5px;
    }
    
    .shortcuts-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
    }
    
    .shortcuts-table th,
    .shortcuts-table td {
        padding: 8px 15px;
        text-align: left;
        border-bottom: 1px solid #e1e5eb;
    }
    
    .shortcuts-table th {
        background: #f5f7fa;
        font-weight: 500;
    }
    
    kbd {
        background-color: #f5f7fa;
        border: 1px solid #e1e5eb;
        border-radius: 3px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        color: #333;
        display: inline-block;
        font-family: monospace;
        font-size: 12px;
        line-height: 1;
        padding: 3px 5px;
        margin: 0 2px;
    }
    
    /* Search results */
    .search-results-container {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        padding: 20px;
    }
    
    .search-results-header {
        margin-bottom: 20px;
    }
    
    .search-results-header h2 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 20px;
        font-weight: 500;
    }
    
    .search-query {
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .results-count {
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .search-result-item {
        display: flex;
        padding: 15px;
        border-bottom: 1px solid #e1e5eb;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .search-result-item:hover {
        background: #f5f7fa;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .result-type {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 50px;
        font-size: 12px;
        color: #7f8c8d;
        margin-right: 15px;
    }
    
    .result-type i {
        font-size: 24px;
        margin-bottom: 5px;
        color: #3498db;
    }
    
    .result-content {
        flex-grow: 1;
    }
    
    .result-title {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 500;
    }
    
    .result-excerpt {
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .result-excerpt mark {
        background: #ffffb3;
        padding: 0 2px;
    }
    
    .result-meta {
        font-size: 12px;
        color: #7f8c8d;
    }
    
    .result-actions {
        display: flex;
        align-items: flex-start;
        gap: 5px;
    }
    
    .no-results {
        text-align: center;
        padding: 40px 0;
    }
    
    .no-results i {
        font-size: 48px;
        color: #bdc3c7;
        margin-bottom: 15px;
    }
    
    .no-results p {
        color: #7f8c8d;
        margin: 5px 0;
    }
    
    /* Login form */
    .cr8os-cms-login {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #3498db, #2c3e50);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .login-form-container {
        background: white;
        border-radius: 5px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        width: 400px;
        padding: 30px;
    }
    
    .login-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .login-logo {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .login-logo i {
        font-size: 36px;
        margin-right: 10px;
        color: #3498db;
    }
    
    .login-logo span {
        font-size: 24px;
        font-weight: bold;
    }
    
    .login-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 500;
    }
    
    .login-form {
        margin-top: 20px;
    }
    
    .login-username,
    .login-password {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #e1e5eb;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .login-button {
        width: 100%;
        padding: 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }
    
    .login-button i {
        margin-right: 8px;
    }
    
    /* Media query for responsive layout */
    @media screen and (max-width: 768px) {
        .cms-sidebar {
            width: 60px;
        }
        
        .cms-logo span,
        .nav-item span,
        .nav-title,
        .user-details {
            display: none;
        }
        
        .nav-item {
            justify-content: center;
        }
        
        .nav-item i {
            margin-right: 0;
        }
        
        .dashboard-recent {
            grid-template-columns: 1fr;
        }
        
        .taxonomy-list-container {
            flex-direction: column;
        }
        
        .taxonomy-form {
            width: 100%;
        }
        
        .settings-container {
            flex-direction: column;
        }
        
        .settings-tabs {
            width: 100%;
            display: flex;
            overflow-x: auto;
            padding: 10px;
            border-right: none;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .settings-tab {
            padding: 8px 15px;
            white-space: nowrap;
            border-left: none;
        }
        
        .settings-tab.active {
            border-left: none;
            border-bottom: 3px solid #3498db;
            padding-left: 15px;
        }
        
        .help-container {
            flex-direction: column;
        }
        
        .help-sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #e1e5eb;
        }
    }
`;

// Add the styles to the document
document.head.appendChild(styleEl);

// Integration with cr8OS taskbar placement and visibility
const integrateCMSWithTaskbar = function() {
    // Check if cr8OS is available
    if (typeof cr8OS === 'undefined' || !cr8OS.getTaskbarSettings) return;
    
    // Get current taskbar settings
    const taskbarSettings = cr8OS.getTaskbarSettings();
    
    // Apply appropriate styles based on taskbar position
    const cmsContainer = document.querySelector('.cr8os-cms-container');
    if (!cmsContainer) return;
    
    // Set appropriate window padding based on taskbar position
    switch (taskbarSettings.position) {
        case 'bottom': 
            cmsContainer.style.paddingBottom = taskbarSettings.visible ? '40px' : '0';
            break;
        case 'top':
            cmsContainer.style.paddingTop = taskbarSettings.visible ? '40px' : '0';
            break;
        case 'left':
            cmsContainer.style.paddingLeft = taskbarSettings.visible ? '40px' : '0';
            break;
        case 'right':
            cmsContainer.style.paddingRight = taskbarSettings.visible ? '40px' : '0';
            break;
    }
    
    // Listen for taskbar settings changes
    document.addEventListener('taskbarSettingsChanged', function(e) {
        const newSettings = e.detail;
        
        // Update CMS container padding
        switch (newSettings.position) {
            case 'bottom': 
                cmsContainer.style.paddingBottom = newSettings.visible ? '40px' : '0';
                cmsContainer.style.paddingTop = '0';
                cmsContainer.style.paddingLeft = '0';
                cmsContainer.style.paddingRight = '0';
                break;
            case 'top':
                cmsContainer.style.paddingTop = newSettings.visible ? '40px' : '0';
                cmsContainer.style.paddingBottom = '0';
                cmsContainer.style.paddingLeft = '0';
                cmsContainer.style.paddingRight = '0';
                break;
            case 'left':
                cmsContainer.style.paddingLeft = newSettings.visible ? '40px' : '0';
                cmsContainer.style.paddingTop = '0';
                cmsContainer.style.paddingBottom = '0';
                cmsContainer.style.paddingRight = '0';
                break;
            case 'right':
                cmsContainer.style.paddingRight = newSettings.visible ? '40px' : '0';
                cmsContainer.style.paddingTop = '0';
                cmsContainer.style.paddingBottom = '0';
                cmsContainer.style.paddingLeft = '0';
                break;
        }
    });
};

// Public API
    return {
        // Initialize the CMS
        init: function() {
            initialize();
            return this;
        },
        
        // Open CMS window
        open: function() {
            if (!state.initialized) {
                this.init();
            }
            
            // Check if user is logged in
            if (!state.currentUser) {
                renderer.showLoginForm();
            } else {
                renderer.createCMSWindow();
            }
            
            return this;
        },
        
        // Close CMS window
        close: function() {
            if (state.contentWindow) {
                if (state.contentWindow.close) {
                    state.contentWindow.close();
                } else {
                    state.contentWindow.style.display = 'none';
                }
            }
            
            return this;
        },
        
        // Navigate to a specific route
        navigate: function(route) {
            if (!state.initialized || !state.contentWindow) {
                this.open();
            }
            
            renderer.navigateTo(route);
            
            return this;
        },
        
        // Register new content type
        registerContentType: function(type, modelClass) {
            if (!state.initialized) {
                this.init();
            }
            
            if (!state.contentLibrary[type]) {
                state.contentLibrary[type] = [];
                models[type] = modelClass;
            }
            
            return this;
        },
        
        // Get content service API
        getContentService: function() {
            return contentService;
        },
        
        // Get user service API
        getUserService: function() {
            return userService;
        },
        
        // Get settings
        getSettings: function() {
            return { ...state.settings };
        },
        
        // Update settings
        updateSettings: function(newSettings) {
            state.settings = { ...state.settings, ...newSettings };
            storage.save();
            return this;
        },
        
        // Export data
        exportData: function() {
            storage.export();
            return this;
        },
        
        // Import data
        importData: function(jsonData) {
            storage.import(jsonData);
            return this;
        }
    };
})(); //  THIS CLOSING PARENTHESIS WAS MISSING!

// Initialize the CMS when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize CMS
    cr8OSCMS.init();
    
    // Register with cr8OS if available
    if (typeof cr8OS !== 'undefined' && cr8OS.registerApp) {
        cr8OS.registerApp({
            id: 'cms',
            name: 'Content Manager',
            description: 'Manage your content, media, and more',
            icon: 'newspaper',
            category: 'productivity',
            url: '#cms',
            run: function() {
                cr8OSCMS.open();
            }
        });
    }
});

// Initialize cr8OS integration
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for cr8OS to initialize
    setTimeout(integrateCMSWithTaskbar, 500);
});

// Export the CMS module for use with cr8OS
window.cr8OSCMS = cr8OSCMS;

// Add keyboard shortcuts for CMS navigation
document.addEventListener('keydown', function(e) {
    // Only handle shortcuts when CMS is open
    const cmsContainer = document.querySelector('.cr8os-cms-container');
    if (!cmsContainer) return;
    
    // Alt + D = Dashboard
    if (e.altKey && e.key === 'd') {
        cr8OSCMS.navigate('dashboard');
    }
    
    // Alt + P = Posts
    if (e.altKey && e.key === 'p') {
        cr8OSCMS.navigate('posts');
    }
    
    // Alt + G = Pages
    if (e.altKey && e.key === 'g') {
        cr8OSCMS.navigate('pages');
    }
    
    // Alt + M = Media
    if (e.altKey && e.key === 'm') {
        cr8OSCMS.navigate('media');
    }
    
    // Alt + S = Settings
    if (e.altKey && e.key === 's') {
        cr8OSCMS.navigate('settings');
    }
    
    // Alt + N = New
    if (e.altKey && e.key === 'n') {
        const newContentButton = document.getElementById('new-content-button');
        if (newContentButton) newContentButton.click();
    }
    
    // / = Focus search
    if (e.key === '/' && !e.ctrlKey && !e.altKey && !e.metaKey) {
        const searchInput = document.querySelector('.search-box input');
        if (searchInput) {
            e.preventDefault();
            searchInput.focus();
        }
    }
});


// Initialize the menu when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    cr8OSMenu.init();
});

// Initialize when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with default settings
    NaraUI.init({
        intensity: 0.7,
        reflectionFrequency: 0.3,
        blurStrength: 10
    });
});

        </script>
        
</body>
</html>